<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin - J'vend tout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #8b00ff 0%, #9932cc 25%, #ba55d3 50%, #da70d6 75%, #ff00ff 100%);
      color: #fff;
      font-family: 'Inter', 'Poppins', sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: rgba(45,0,75,0.92);
      border-radius: 18px;
      box-shadow: 0 8px 32px #0006;
      padding: 32px;
    }
    h1 {
      text-align: center;
      font-weight: 700;
      margin-bottom: 32px;
      letter-spacing: 1px;
    }
    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      background: #4a1a5c;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: 0 2px 8px #0004;
    }

    #addArnaqueForm {
      grid-template-columns: 1fr 1fr;
    }
    form label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
      color: #ffd369;
    }
    form input, form textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin-bottom: 8px;
      font-size: 1em;
      background: #6a0572;
      color: #fff;
      box-shadow: 0 1px 4px #0002;
    }
    form input[type="number"] {
      text-align: right;
    }
    form button {
      grid-column: span 2;
      background: #d72660;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 0;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      margin-top: 12px;
      transition: background 0.2s;
    }
    form button:hover {
      background: #a80038;
    }
    .preview-box {
      grid-column: span 2;
      background: #2e004f;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      text-align: center;
      min-height: 120px;
    }
    .preview-box img, .preview-box video {
      max-width: 120px;
      max-height: 120px;
      border-radius: 8px;
      margin: 8px;
      background: #222;
      display: inline-block;
    }
    .article-list {
      margin-top: 24px;
    }
    .article-card {
      background: #3a0066;
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 18px;
      box-shadow: 0 2px 8px #0004;
      transition: background 0.2s;
    }
    .article-card:hover {
      background: #6a0572;
    }
        .product-card img, .product-card video {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
      display: block;
    }

    .article-info {
      flex: 1;
      min-width: 0;
    }
    .article-info strong {
      color: #ffd369;
      font-size: 1.1em;
    }
    .article-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .article-actions button {
      background: #d72660;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.95em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .article-actions button:hover {
      background: #a80038;
    }
    
    /* Styles pour l'explorateur de cat√©gories */
    .category-item {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .category-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    }
    
    .category-item span {
      pointer-events: auto !important;
      z-index: 10;
    }
    
    .category-item button {
      pointer-events: auto !important;
      z-index: 10;
    }
    
    /* Styles pour la nouvelle interface media-list */
    .media-item {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .media-item:hover {
      transform: translateX(4px);
      box-shadow: 0 8px 25px rgba(139,245,142,0.2);
      border-color: rgba(139,245,142,0.3) !important;
    }
    
    .media-item button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .media-item.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
      z-index: 1000;
    }
    
    .media-item.drag-over {
      border-top: 3px solid #ffd369 !important;
      margin-top: 4px;
    }
    
    /* Animation pour les compteurs */
    #media-count-badge {
      transition: all 0.3s ease;
    }
    
    /* Am√©lioration des boutons */
    button[onclick*="moveMedia"]:hover,
    button[onclick*="setAsThumbnail"]:hover,
    button[onclick*="removeMediaFromArticle"]:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 15px rgba(0,0,0,0.3) !important;
    }
    
    /* Responsive pour les √©l√©ments m√©dia */
    @media (max-width: 768px) {
      .media-item {
        flex-direction: column !important;
        gap: 8px !important;
        text-align: center;
      }
      
      .media-item > div:first-of-type {
        width: 80px !important;
        height: 80px !important;
      }
      
      .media-item > div:last-of-type {
        flex-direction: row !important;
        justify-content: center !important;
        flex-wrap: wrap !important;
      }
    }
    
    /* --- Modal / drawer identique √† index --- */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(30,0,60,0.85);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .modal.show { 
      display: flex; 
    }
    /* Ne rien ajouter ici */
    /* drawer (lat√©ral) */
    .side-modal.show {
      display: flex;
      justify-content: flex-end !important;
      align-items: flex-start !important;
      background: rgba(30,0,60,0.35);
    }
.side-modal .modal-content {
  width: 400px; /* Largeur identique √† index */
  height: 100vh; /* Hauteur plein √©cran pour toucher le sol */
  border-radius: 0; /* Pas d'arrondi pour coller aux bords */
  border-top-left-radius: 18px; /* Arrondi uniquement en haut √† gauche */
  border-bottom-left-radius: 18px; /* Arrondi uniquement en bas √† gauche */
  background: #2e004f; /* Couleur identique */
  color: #fff; /* Texte blanc */
  padding: 24px; /* Espacement interne */
  box-shadow: -8px 0 32px rgba(0, 0, 0, 0.4); /* Ombre √† gauche */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  position: relative;
  margin: 0; /* Supprime les marges pour coller aux bords */
}
    .side-modal .modal-content .media {
      display:flex;
      align-items:center;
      justify-content:center;

    }
.side-modal .modal-content img,
.side-modal .modal-content video {
  width: 100%; /* Prend toute la largeur */
  max-height: 300px; /* Limite la hauteur */
  object-fit: contain; /* Contient l'image/vid√©o sans d√©formation */
  border-radius: 12px; /* Coins arrondis */
  margin-top: 16px; /* Espacement avec le contenu au-dessus */
}
.side-modal h2 {
  font-size: 1.5em; /* Taille du titre */
  margin-bottom: 12px; /* Espacement avec la description */
  color: #ffd369; /* Couleur du titre */
}
.side-modal .meta {
  font-size: 1em; /* Taille du texte cat√©gorie */
  color: #8ef58e; /* Couleur verte */
  margin-bottom: 12px; /* Espacement avec le prix */
}
.side-modal .price {
  font-size: 1.2em; /* Taille du prix */
  font-weight: bold;
  color: #ffd369; /* Couleur jaune */
}
.side-modal .close {
  position: absolute;
  top: 16px;
  right: 16px;
  font-size: 24px; /* Taille du bouton fermer */
  color: #ffd369; /* Couleur jaune */
  cursor: pointer;
}

.reseau-btn {
  background: #4b1a7f;
  color: #8ef58e;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.2s;
}

.reseau-btn:hover {
  background: #6a2a9f;
}

.reseau-btn.selected {
  background: #8ef58e;
  color: #2e004f;
  font-weight: bold;
}

.technique-btn {
  background: #6f42c1;
  color: white;
  border: 1px solid #6f42c1;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.2s;
}

.technique-btn:hover {
  background: #8a5cd6;
}

.technique-btn.selected {
  background: #ffd369;
  color: #2e004f;
  font-weight: bold;
  border-color: #ffd369;
}

.selected-technique-tag {
  background: #28a745;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.selected-technique-tag .remove-btn {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 0.9em;
  padding: 0;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.selected-technique-tag .remove-btn:hover {
  background: rgba(255,255,255,0.2);
}

.admin-section {
  display: none;
}

/* Styles pour la modale d'ordre */
.ordering-item {
  display: flex;
  align-items: center;
  padding: 15px;
  margin-bottom: 10px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  cursor: move;
  transition: all 0.2s ease;
}

.ordering-item:hover {
  background: #e9ecef;
  transform: translateX(2px);
}

.ordering-item.dragging {
  opacity: 0.5;
  transform: rotate(2deg);
}

.ordering-handle {
  font-size: 18px;
  color: #6c757d;
  margin-right: 15px;
  cursor: grab;
}

.ordering-handle:active {
  cursor: grabbing;
}

.ordering-content {
  flex: 1;
}

.ordering-title {
  font-weight: bold;
  margin-bottom: 4px;
  color: #2c3e50;
}

.ordering-subtitle {
  font-size: 0.9em;
  color: #6c757d;
}

.ordering-position {
  background: #007bff;
  color: white;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.9em;
}

.no-items {
  text-align: center;
  padding: 40px 20px;
  color: #6c757d;
  font-style: italic;
}

#ordering-grid {
  max-height: 400px;
  overflow-y: auto;
}

.admin-section.active {
  display: block;
}

/* Styles pour les onglets */
.tab-button.active {
  background: #ff6b6b !important;
  color: white !important;
}

.tab-button:not(.active) {
  background: #4b1a7f !important;
  color: #8ef58e !important;
}

.tab-content {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Styles responsive pour les modales */
@media screen and (max-width: 768px) {
  .modal-content {
    width: 95% !important;
    max-width: none !important;
    margin: 10px auto !important;
    max-height: 95vh !important;
  }
  
  /* Modal cat√©gories responsive */
  #category-explorer-modal {
    /* Force le plein √©cran */
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 10000 !important;
  }
  
  #category-explorer-modal .modal-content {
    padding: 15px !important;
    width: 95vw !important;
    height: 95vh !important;
    max-width: none !important;
    max-height: none !important;
    border-radius: 8px !important;
    overflow-y: auto !important;
  }
  
  #category-explorer-modal h2 {
    font-size: 1.1em !important;
  }
  
  /* Boutons responsive */
  #category-explorer-modal [style*="display:flex"] {
    flex-direction: column !important;
    gap: 8px !important;
  }
  
  #category-explorer-modal button {
    width: 100% !important;
    min-width: auto !important;
  }
  
  /* Modal gestion cat√©gories responsive */
  #category-management-modal .modal-content {
    width: 98% !important;
    height: 95vh !important;
    max-height: 95vh !important;
    margin: 2.5vh auto !important;
  }
  
  /* Explorateur de fichiers responsive */
  #file-explorer-modal .modal-content {
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    margin: 0 !important;
    border-radius: 0 !important;
  }
  /* Emp√™cher que les boutons sortent de l'√©cran sur mobile */
  #file-explorer-modal .modal-content { display:flex; flex-direction:column; }
  #file-explorer-modal .modal-content > div[style*="display:flex"][style*="height:calc(100vh"] { flex:1 1 auto; min-height:0; }
  #file-explorer-modal .modal-content > div:last-of-type { position:sticky; bottom:0; background:#2e003e; z-index:20; }
  #file-explorer-modal .modal-content > div:last-of-type button { flex:0 0 auto; }
  
  /* Ajustement du layout pour mobile */
  #file-explorer-modal [style*="display:flex"][style*="width:70%"] {
    width: 100% !important;
  }
  
  #file-explorer-modal [style*="width:30%"] {
    display: none !important; /* Masquer le panel de s√©lection sur mobile */
  }
  
  /* Breadcrumbs responsive */
  #admin-cat-breadcrumbs {
    flex-direction: row !important;
    flex-wrap: wrap !important;
  }
  
  /* Grille de fichiers responsive */
  #file-list {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) !important;
    gap: 15px !important;
  }
}

@media screen and (max-width: 480px) {
  #file-list {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)) !important;
    gap: 10px !important;
  }
  
  /* Textes plus petits sur tr√®s petits √©crans */
  .modal-content h2 {
    font-size: 1em !important;
  }
  
  .modal-content button {
    padding: 10px 12px !important;
    font-size: 0.85em !important;
  }
}

/* Effets hover pour le menu hamburger */
#menu-modal button:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

#menu-articles:hover {
  background: #8a0a82 !important;
}

#menu-medias:hover {
  background: #6a3093 !important;
  color: #ffffff !important;
}

#menu-offres:hover, #menu-arnaques:hover {
  background: #6a2c93 !important;
  color: #ffd369 !important;
}

#menu-avis-pending:hover {
  background: #a6f6a6 !important;
  color: #1a1a1a !important;
}
/* Modal review detail */
#review-detail-modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(30,0,60,0.85);
  z-index: 10000;
  align-items: center;
  justify-content: center;
}

#review-detail-modal.show {
  display: flex;
}

#review-detail-modal .modal-content {
  width: 95%;
  max-width: 500px;
  background: #2e004f;
  color: #fff;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  position: relative;
  overflow-y: auto;
  max-height: 90vh;
}

#review-detail-modal .close {
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 24px;
  color: #ffd369;
  background: none;
  border: none;
  cursor: pointer;
}

.review-detail-header {
  display: flex;
  align-items: center;
  margin-bottom: 16px;
}

.review-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #8ef58e;
  color: #2e004f;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-right: 12px;
  font-size: 1.2em;
}

.review-user-info h3 {
  margin: 0;
  color: #8ef58e;
}

.review-user-info p {
  margin: 0;
  color: #ffd369;
  font-size: 0.9em;
}

#review-detail-title {
  color: #ffd369;
  margin-bottom: 10px;
}

#review-detail-text {
  margin-bottom: 20px;
  line-height: 1.5;
}

.review-detail-gallery {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
}

.review-detail-gallery img,
.review-detail-gallery video {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 6px;
  cursor: pointer;
  border: 2px solid transparent;
}

.review-detail-gallery img.active,
.review-detail-gallery video.active {
  border-color: #ffd369;
}

.review-detail-main-media img,
.review-detail-main-media video {
  width: 100%;
  max-height: 300px;
  object-fit: contain;
  border-radius: 8px;
  margin-bottom: 16px;
}

.review-detail-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.review-detail-rating {
  color: #ffd369;
  font-size: 1.2em;
}

.review-detail-verified {
  background: #8ef58e;
  color: #2e004f;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8em;
  font-weight: bold;
}

/* Scrollbars stylis√©es - pratiquement invisibles */
::-webkit-scrollbar {
  width: 4px;
  height: 4px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 211, 105, 0.2);
  border-radius: 2px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 211, 105, 0.4);
}

::-webkit-scrollbar-corner {
  background: transparent;
}

/* Pour Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: rgba(255, 211, 105, 0.2) transparent;
}

  </style>
</head>
<body>
  <!-- Barre sup√©rieure admin -->
  <div id="admin-top-bar" style="position:sticky;top:0;z-index:2000;background:#240038;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px;box-shadow:0 4px 14px #0008;">
    <!-- Menu hamburger -->
    <button id="menu-toggle" style="background:#6a0572;color:#ffd369;border:none;border-radius:8px;padding:8px 12px;font-weight:bold;font-size:1rem;cursor:pointer;margin-right:12px;">
      ‚ò∞
    </button>
    <div style="font-weight:700;letter-spacing:1px;font-size:15px;">Panneau d'administration</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <a href="index.html" style="text-decoration:none;background:#4b1a7f;color:#8ef58e;padding:8px 14px;border-radius:6px;font-weight:600;display:inline-flex;align-items:center;gap:6px;">üè™ <span>Boutique</span></a>
      <button id="open-ordering-btn" type="button" style="background:#ffd369;color:#240038;font-weight:700;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;">‚öôÔ∏è <span id="ordering-btn-text">Ordre (Pertinence)</span></button>
    </div>
  </div>
  
  <!-- Menu modal hamburger admin -->
  <div id="menu-modal" style="display:none; position:fixed; top:56px; left:0; width:250px; background:linear-gradient(135deg, #2e004f, #4b1a7f); color:#fff; z-index:1000; box-shadow:2px 2px 12px rgba(0,0,0,0.4); border-radius:0 12px 12px 0; padding:20px;">
    <!-- Onglets comme dans l'image -->
    <div style="display:flex; flex-direction:column; gap:8px;">
      <button id="menu-articles" style="display:flex; align-items:center; width:100%; padding:14px 18px; background:#6a0572; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.95em; transition:all 0.3s;">
        <img src="img/_technique/icon/produit.png" style="width:18px;height:18px;margin-right:10px;"/> Articles
      </button>
      <button id="menu-medias" style="display:flex; align-items:center; width:100%; padding:14px 18px; background:#4b1a7f; color:#ffd369; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.95em; transition:all 0.3s;">
        <span style="margin-right:10px; font-size:1.1em;">üé®</span> M√©dias GoFile
      </button>
      <button id="menu-offres" style="display:flex; align-items:center; width:100%; padding:14px 18px; background:#4b1a7f; color:#8ef58e; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.95em; transition:all 0.3s;">
        <span style="margin-right:10px; font-size:1.1em;">üè∑Ô∏è</span> Offres
      </button>
      <button id="menu-arnaques" style="display:flex; align-items:center; width:100%; padding:14px 18px; background:#4b1a7f; color:#8ef58e; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.95em; transition:all 0.3s;">
        <span style="margin-right:10px; font-size:1.1em;">‚ö†Ô∏è</span> Arnaques
      </button>
      <button id="menu-avis-pending" style="display:flex; align-items:center; width:100%; padding:14px 18px; background:#8ef58e; color:#2e004f; border:none; border-radius:8px; cursor:pointer; font-weight:700; font-size:0.95em; transition:all 0.3s;">
        <img src="img/_technique/icon/preuve.png" style="width:18px;height:18px;margin-right:10px;"/> Preuves
      </button>
    </div>
  </div>
  
  <!-- Contenu principal avec gestion des sections -->
  <div id="main-content">
    <!-- Section Articles (par d√©faut) -->
    <div id="articles-section" class="admin-section">
      <div class="container">
        <h1>Admin - Mes Articles</h1>
        <form id="addArticleForm">
      <div>
        <label for="nom">Nom affich√©</label>
        <input type="text" name="nom" id="nom" required>
      </div>
      <div>
        <label for="id">ID interne</label>
        <input type="text" name="id" id="id" required>
      </div>
      <div style="grid-column: span 2;">
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:1.1rem;font-weight:600;color:#ffd369;">
          üé¨ M√©dias de l'article
          <span id="media-count-badge" style="background:rgba(255,211,105,0.2);color:#ffd369;padding:2px 8px;border-radius:12px;font-size:0.8rem;font-weight:400;">0 m√©dia(s)</span>
        </label>
        
        <!-- Liste des m√©dias avec drag & drop -->
        <div id="media-list" style="
          min-height:60px;
          background:rgba(46,0,79,0.3);
          border:1px solid rgba(255,255,255,0.1);
          border-radius:8px;
          padding:12px;
          margin-bottom:15px;
        ">
          <div id="media-empty-state" style="
            text-align:center;
            color:#888;
            font-style:italic;
            padding:20px;
            display:block;
          ">Aucun m√©dia ajout√©</div>
        </div>
        
        <!-- Contr√¥les des m√©dias -->
        <div style="display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap;">
          <button type="button" onclick="openMediaExplorer()" style="
            background:linear-gradient(135deg, #4b1a7f, #6d28a3);
            color:#8ef58e;
            padding:8px 16px;
            border-radius:6px;
            cursor:pointer;
            font-weight:600;
            border:none;
            transition:all 0.3s ease;
            display:flex;
            align-items:center;
            gap:6px;
          " onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(139,245,142,0.2)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
            <span>üì∏</span> Ajouter des m√©dias
          </button>
          <button type="button" id="clear-all-media" onclick="clearAllMedia()" style="
            background:linear-gradient(135deg, #dc3545, #c82333);
            color:white;
            padding:8px 16px;
            border-radius:6px;
            cursor:pointer;
            font-weight:600;
            border:none;
            transition:all 0.3s ease;
            display:flex;
            align-items:center;
            gap:6px;
          " onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(220,53,69,0.3)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
            <span>üóëÔ∏è</span> Tout effacer
          </button>
        </div>
        
        <!-- √âl√©ments cach√©s pour la miniature (utilis√©s par le JavaScript) -->
        <input type="hidden" id="thumbnail-select" name="thumbnail" value="">
        <div id="thumbnail-preview" style="display:none;"></div>
      </div>
      <div>
        <label for="categorie">Cat√©gorie (ex: Artifices/Bison)</label>
        <input type="text" name="categorie" id="categorie" required>
        <button type="button" id="select-category-btn" style="margin-top:6px;background:#4b1a7f;color:#8ef58e;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600;border:1px solid #4b1a7f;" onclick="window.openCategoryExplorer()">S√©lectionner cat√©gorie</button>
      </div>
      <div>
        <label for="prix">Prix (‚Ç¨)</label>
        <input type="number" name="prix" id="prix" step="0.01" min="0" required>
      </div>
      <div>
        <label for="reduction">R√©duction <span class="optional">(optionnel)</span></label>
        <select name="reduction_type" id="reduction_type" style="width:100%;padding:8px;border-radius:6px;background:rgba(107,5,114,0.3);color:#fff;border:1px solid rgba(255,255,255,0.2);margin-bottom:8px;">
          <option value="">Aucune r√©duction</option>
          <option value="percent">Pourcentage (%)</option>
          <option value="fixed">Montant fixe (‚Ç¨)</option>
        </select>
        <input type="number" name="reduction" id="reduction" step="0.01" min="0" placeholder="Valeur de la r√©duction" style="width:100%;padding:8px;border-radius:6px;background:rgba(107,5,114,0.3);color:#fff;border:1px solid rgba(255,255,255,0.2);">
      </div>
      <div style="grid-column: span 2;">
        <label for="description">Description</label>
        <textarea name="description" id="description" rows="2"></textarea>
      </div>
      
      <!-- Section Variantes -->
      <div style="grid-column: span 2; border-top: 2px solid rgba(255,211,105,0.3); padding-top: 20px; margin-top: 10px;">
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px;font-size:1.1rem;font-weight:600;color:#ffd369;">
          üîÄ Variantes du produit <span class="optional">(optionnel)</span>
          <span id="variantes-count-badge" style="background:rgba(255,211,105,0.2);color:#ffd369;padding:2px 8px;border-radius:12px;font-size:0.8rem;font-weight:400;">0 variante(s)</span>
        </label>
        <p style="font-size:0.85rem;color:#8ef58e;margin-bottom:15px;">Les variantes partagent le m√™me prix mais peuvent avoir des images, noms et descriptions diff√©rents.</p>
        
        <!-- Liste des variantes -->
        <div id="variantes-list" style="display:flex;flex-direction:column;gap:12px;margin-bottom:15px;">
          <div id="variantes-empty-state" style="text-align:center;color:#888;font-style:italic;padding:20px;background:rgba(46,0,79,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:8px;">
            Aucune variante ajout√©e
          </div>
        </div>
        
        <!-- Bouton ajouter variante -->
        <button type="button" id="add-variante-btn" style="background:linear-gradient(135deg, #4b1a7f, #6d28a3);color:#8ef58e;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;border:none;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(139,245,142,0.2)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
          <span>‚ûï</span> Ajouter une variante
        </button>
      </div>
      
      <!-- La preview-box a √©t√© supprim√©e conform√©ment √† la demande -->
      <button type="submit" id="submit-btn">Ajouter</button>
    </form>
    <div class="article-list" id="articleList"></div>
      </div>
    </div>

    <!-- Section M√©dias GoFile -->
    <div id="medias-section" class="admin-section" style="display:none;">
      <div style="background: rgba(45,0,75,0.92); border-radius: 18px; box-shadow: 0 8px 32px #0006; padding: 32px; margin: 40px auto; max-width: 1400px;">
        <h1 style="text-align: center; font-weight: 700; margin-bottom: 32px; letter-spacing: 1px; color: #ffd369;">üé® Explorateur M√©dias GoFile</h1>
        
        <!-- Navigation dossiers -->
        <div id="gofile-breadcrumb" style="padding: 15px 20px; background: #3a1a4c; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
          <span style="color: #ffd369;">üìÅ Chemin:</span>
          <span id="breadcrumb-path" style="color: #fff;">Chargement...</span>
        </div>
        
        <!-- Contr√¥les -->
        <div style="padding: 20px 30px; background: #4a1a5c; border-radius: 12px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
          <div style="position: relative; flex: 1; min-width: 300px;">
            <input type="text" id="admin-search" placeholder="Rechercher un fichier..." style="width: 100%; padding: 12px 45px 12px 15px; border: 2px solid #6a0572; border-radius: 25px; font-size: 1rem; background: #6a0572; color: #fff;">
            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #ffd369;">üîç</span>
          </div>

          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="admin-filter-btn active" data-filter="all" style="padding: 8px 16px; border: 2px solid #ffd369; background: #ffd369; color: #2e003e; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">Tous</button>
            <button class="admin-filter-btn" data-filter="image" style="padding: 8px 16px; border: 2px solid #6a0572; background: #6a0572; color: #fff; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">Images</button>
            <button class="admin-filter-btn" data-filter="video" style="padding: 8px 16px; border: 2px solid #6a0572; background: #6a0572; color: #fff; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">Vid√©os</button>
            <button class="admin-filter-btn" data-filter="folder" style="padding: 8px 16px; border: 2px solid #6a0572; background: #6a0572; color: #fff; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">üìÅ Dossiers</button>
            <button class="admin-filter-btn" data-filter="other" style="padding: 8px 16px; border: 2px solid #6a0572; background: #6a0572; color: #fff; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">Autres</button>
          </div>

          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="admin-create-folder" style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 0.95rem; font-weight: 600;">üìÅ+ Nouveau dossier</button>
            <button id="admin-refresh" style="padding: 12px 25px; background: #d72660; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 600;">üîÑ Actualiser</button>
            <button id="admin-regenerate-mapping" style="padding: 12px 25px; background: #ff6b35; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 1rem; font-weight: 600; margin-left: 10px;">‚ö° Auto-mapping</button>
            <a href="/ping.html" target="_blank" style="padding: 12px 20px; background: #17a2b8; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 0.95rem; font-weight: 600; text-decoration: none;">üîî Ping fichiers</a>
          </div>
        </div>

        <!-- Statistiques -->
        <div style="display: flex; gap: 20px; font-size: 0.9rem; color: #ffd369; margin-bottom: 20px; justify-content: center;">
          <span id="admin-total-files">Fichiers: 0</span>
          <span id="admin-selected-count">S√©lectionn√©s: 0</span>
          <span id="admin-filtered-count">Affich√©s: 0</span>
        </div>

        <!-- Galerie -->
        <div id="admin-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; min-height: 400px;">
          <!-- Les fichiers seront charg√©s ici -->
        </div>

        <!-- Info s√©lection -->
        <div id="admin-selection-info" style="position: fixed; bottom: 30px; right: 30px; background: #d72660; color: white; padding: 15px 25px; border-radius: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); display: none; align-items: center; gap: 10px; z-index: 1000;">
          <span id="admin-selection-text">0 fichier(s) s√©lectionn√©(s)</span>
          <button id="admin-use-selected" style="background: #4b7c59; border: none; color: white; padding: 8px 16px; border-radius: 15px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">‚úì Utiliser pour l'article</button>
          <button id="admin-clear-selection" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 15px; cursor: pointer; font-size: 0.9rem;">D√©s√©lectionner</button>
        </div>
      </div>
    </div>

    <!-- Section Offres -->
    <div id="offres-section" class="admin-section" style="display:none;">
      <div class="container">
        <h1>Admin - Offres</h1>
        <form id="addOffreForm">
          <div>
            <label for="nom-offre">Nom de l'offre</label>
            <input type="text" name="nom" id="nom-offre" required>
          </div>
          <div>
            <label for="id-offre">ID interne</label>
            <input type="text" name="id" id="id-offre" required>
          </div>
          <div>
            <label for="prix-offre">Prix (‚Ç¨)</label>
            <input type="number" name="prix" id="prix-offre" step="0.01" required>
          </div>
          <div style="grid-column: span 2;">
            <label for="description-offre">Description</label>
            <textarea name="description" id="description-offre"></textarea>
          </div>
          <div>
            <label for="categorie-offre">Cat√©gorie</label>
            <input type="text" name="categorie" id="categorie-offre">
          </div>
          <button type="submit" id="submit-offre-btn">Ajouter Offre</button>
        </form>
        <div class="article-list" id="offresList"></div>
      </div>
    </div>

    <!-- Section Arnaques -->
    <div id="arnaques-section" class="admin-section" style="display:none;">
      <div class="container">
        <h1>Admin - Base de donn√©es Arnaques</h1>
        
        <!-- Onglets pour naviguer entre arnaques -->
        <div style="margin-bottom: 2rem; display: flex; gap: 1rem;">
          <button id="tab-arnaques-pending" class="tab-button active" style="background: #ffd369; color: #1a0b2e; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
            ‚è≥ √Ä v√©rifier
          </button>
          <button id="tab-arnaques-active" class="tab-button" style="background: #ff6b6b; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
            üö® Arnaques actives
          </button>
          <button id="tab-arnaques-archived" class="tab-button" style="background: #4b1a7f; color: #8ef58e; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
            üì¶ Arnaques archiv√©es
          </button>
        </div>
        
        <!-- Section Arnaques √† v√©rifier -->
        <div id="arnaques-pending-content" style="display:block;">
          <div style="background: rgba(255, 211, 105, 0.1); border: 1px solid #ffd369; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #ffd369; margin: 0 0 10px 0;">‚è≥ Signalements en attente de v√©rification</h3>
            <p style="margin: 0; opacity: 0.9;">V√©rifiez et modifiez les informations avant de publier. Le nom du d√©nonciateur est masqu√© si anonyme.</p>
          </div>
          <div class="article-list" id="arnaquesPendingList"></div>
          
          <!-- Modal de modification d'arnaque pending -->
          <div id="edit-pending-arnaque-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; padding:20px; overflow-y:auto;">
            <div style="max-width:900px; margin:auto; background:#2e004f; border:2px solid #ffd369; border-radius:12px; padding:30px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="color:#ffd369; margin:0;">‚úèÔ∏è Modifier avant publication</h3>
                <button onclick="closePendingEditModal()" style="background:#dc3545; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600;">‚úñ Fermer</button>
              </div>
              
              <form id="edit-pending-arnaque-form" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <input type="hidden" id="edit-pending-idx">
                
                <!-- Champs NON MODIFIABLES (gris√©s, disabled) -->
                <div style="grid-column:span 2; background:rgba(255,107,107,0.1); border:1px solid #ff6b6b; border-radius:8px; padding:15px;">
                  <div style="color:#ff6b6b; margin-bottom:12px; font-weight:600; font-size:0.95em;">üîí Informations non modifiables</div>
                  
                  <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div>
                      <label style="color:#ffd369; display:block; margin-bottom:5px; font-size:0.85em;">Nom de l'arnaqueur</label>
                      <input type="text" id="edit-pending-nom" disabled style="width:100%; padding:8px; border-radius:6px; background:rgba(107,5,114,0.2); color:#aaa; border:1px solid rgba(255,255,255,0.1); cursor:not-allowed;">
                    </div>
                    
                    <div>
                      <label style="color:#ffd369; display:block; margin-bottom:5px; font-size:0.85em;">Identifiant (@)</label>
                      <input type="text" id="edit-pending-id" disabled style="width:100%; padding:8px; border-radius:6px; background:rgba(107,5,114,0.2); color:#aaa; border:1px solid rgba(255,255,255,0.1); cursor:not-allowed;">
                    </div>
                  </div>
                  
                  <div style="margin-top:12px;">
                    <label style="color:#ffd369; display:block; margin-bottom:5px; font-size:0.85em;">D√©nonc√© par</label>
                    <div id="edit-pending-denonceur-info" style="font-size:0.9em; color:#fff; background:rgba(0,0,0,0.3); padding:8px; border-radius:6px;"></div>
                  </div>
                </div>
                
                <!-- Champs MODIFIABLES -->
                <div style="grid-column:span 2;">
                  <label style="color:#ffd369; display:block; margin-bottom:5px; font-weight:600;">‚ö†Ô∏è Technique d'arnaque *</label>
                  <select id="edit-pending-technique-select" style="width:100%; padding:10px; border-radius:6px; background:rgba(107,5,114,0.3); color:#fff; border:1px solid #8ef58e;">
                    <option value="">-- S√©lectionnez une technique --</option>
                  </select>
                  <textarea id="edit-pending-technique" rows="4" placeholder="Ou d√©crivez une technique personnalis√©e..." style="width:100%; padding:10px; border-radius:6px; background:rgba(107,5,114,0.3); color:#fff; border:1px solid #8ef58e; margin-top:8px; resize:vertical;"></textarea>
                  <div style="color:#8ef58e; font-size:0.75em; margin-top:4px;">üí° Choisissez une technique dans la liste ou d√©crivez-en une nouvelle</div>
                </div>
                
                <div style="grid-column:span 2;">
                  <label style="color:#ffd369; display:block; margin-bottom:5px; font-weight:600;">ÔøΩ Preuves (m√©dias)</label>
                  <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                    <button type="button" id="edit-pending-add-medias" style="background:#8ef58e; color:#240038; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600;">+ Ajouter m√©dias</button>
                    <span id="edit-pending-medias-count" style="color:#ffd369; font-size:0.9em;">0 m√©dia(s)</span>
                  </div>
                  <div id="edit-pending-medias-preview" style="display:flex; gap:8px; flex-wrap:wrap; padding:10px; background:rgba(0,0,0,0.3); border-radius:8px; min-height:80px;"></div>
                  <input type="hidden" id="edit-pending-medias" value="[]">
                </div>
                
                <div style="grid-column:span 2;">
                  <label style="color:#ffd369; display:block; margin-bottom:5px; font-weight:600;">üß® Produits/Articles li√©s</label>
                  <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                    <button type="button" id="edit-pending-add-product" style="background:#8ef58e; color:#240038; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600;">+ Ajouter produit</button>
                    <span id="edit-pending-products-count" style="color:#ffd369; font-size:0.9em;">0 produit(s)</span>
                  </div>
                  <div id="edit-pending-products-list" style="display:flex; flex-direction:column; gap:8px; padding:10px; background:rgba(0,0,0,0.3); border-radius:8px; min-height:60px;"></div>
                  <input type="hidden" id="edit-pending-products" value="[]">
                </div>
                
                <div style="grid-column:span 2; display:flex; gap:10px; margin-top:10px;">
                  <button type="submit" style="flex:1; background:linear-gradient(135deg, #28a745, #20c997); color:#fff; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:700; font-size:1em;">
                    ‚úÖ Enregistrer et publier
                  </button>
                  <button type="button" onclick="closePendingEditModal()" style="background:#6c757d; color:#fff; border:none; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:600;">
                    Annuler
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
        
        <!-- Section Arnaques Actives -->
        <div id="arnaques-active-content" style="display:none;">
        <form id="addArnaqueForm">
          <div>
            <label for="nom-arnaque">Nom affich√©</label>
            <input type="text" name="nom" id="nom-arnaque" placeholder="Nom visible pour les utilisateurs">
          </div>
          <div>
            <label for="username-arnaque">Nom d'utilisateur</label>
            <input type="text" name="username" id="username-arnaque" placeholder="@username_ou_identifiant" required pattern="[^\s]*" title="Le nom d'utilisateur ne peut pas contenir d'espaces">
          </div>
          <div style="grid-column: span 2;">
            <label for="reseaux-arnaque">R√©seaux sociaux</label>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <button type="button" class="reseau-btn" data-reseau="Snapchat" data-tooltip="Snapchat">
                <img src="img/_technique/icon/Snapchat.png" alt="Snapchat" style="width:16px;height:16px;"> Snapchat
              </button>
              <button type="button" class="reseau-btn" data-reseau="Telegram" data-tooltip="Telegram">
                <img src="img/_technique/icon/telegram.png" alt="Telegram" style="width:16px;height:16px;"> Telegram
              </button>
              <button type="button" class="reseau-btn" data-reseau="Discord" data-tooltip="Discord">
                <img src="img/_technique/icon/discord.ico" alt="Discord" style="width:16px;height:16px;"> Discord
              </button>
              <button type="button" class="reseau-btn" data-reseau="Instagram" data-tooltip="Instagram">
                <img src="img/_technique/icon/Instagram.png" alt="Instagram" style="width:16px;height:16px;"> Instagram
              </button>
              <button type="button" class="reseau-btn" data-reseau="Facebook" data-tooltip="Facebook">
                <img src="img/_technique/icon/facebook.png" alt="Facebook" style="width:16px;height:16px;"> Facebook
              </button>
              <button type="button" class="reseau-btn" data-reseau="WhatsApp" data-tooltip="WhatsApp">
                <img src="img/_technique/icon/whatsapp.png" alt="WhatsApp" style="width:16px;height:16px;"> WhatsApp
              </button>
            </div>
            <input type="hidden" name="reseaux" id="reseaux-arnaque">
          </div>
          <div style="grid-column: span 2;">
            <label for="techniques-arnaque">Techniques utilis√©es</label>
            <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
              <button type="button" id="add-technique-btn" style="background:#28a745; border:1px solid #28a745; padding:8px 16px; border-radius:6px; cursor:pointer; color:#fff; font-weight:600;">‚ûï Nouvelle technique</button>
              <button type="button" id="manage-techniques-btn" style="background:#17a2b8; border:1px solid #17a2b8; padding:8px 16px; border-radius:6px; cursor:pointer; color:#fff; font-weight:600;">‚öôÔ∏è G√©rer les techniques</button>
            </div>
            <div id="techniques-list" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; min-height:40px; padding:10px; background:rgba(0,0,0,0.2); border-radius:8px;"></div>
            <input type="hidden" name="techniques" id="techniques-arnaque">
            <div id="selected-techniques" style="margin-top:8px; display:flex; gap:4px; flex-wrap:wrap;"></div>
          </div>
          <div style="grid-column: span 2;">
            <label for="medias-arnaque">M√©dias (preuves)</label>
            <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
              <button type="button" id="select-media-arnaque" style="background:#6f42c1; border:1px solid #6f42c1; padding:8px 12px;">üìÅ S√©lectionner m√©dias</button>
              <span id="media-count-arnaque" style="color:#ffd369; font-size:0.9em;">Aucun m√©dia s√©lectionn√©</span>
            </div>
            <input type="hidden" name="medias" id="medias-arnaque">
            <div id="media-preview-arnaque" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;"></div>
          </div>
          <div style="grid-column: span 2;">
            <label for="description-arnaque">Description suppl√©mentaire</label>
            <textarea name="description" id="description-arnaque"></textarea>
          </div>
          <div style="grid-column: span 2;">
            <label for="verified-arnaque">Statut de v√©rification</label>
            <div style="display:flex; gap:15px; margin-top:8px;">
              <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                <input type="radio" name="verified" id="verified-true" value="true" checked style="width:18px;height:18px;cursor:pointer;">
                <span style="color:#28a745;font-weight:600;">‚úì V√âRIFI√â</span>
              </label>
              <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                <input type="radio" name="verified" id="verified-false" value="false" style="width:18px;height:18px;cursor:pointer;">
                <span style="color:#ff9800;font-weight:600;">‚ö† SUSPECT√â</span>
              </label>
            </div>
          </div>
          <button type="submit" id="submit-arnaque-btn" style="grid-column: span 2;">Ajouter Arnaqueur</button>
          <button type="button" id="cancel-arnaque-btn" onclick="cancelEditArnaque()" style="grid-column: span 2; background-color: #dc3545; display: none;">Annuler √âdition</button>
        </form>
        <div class="article-list" id="arnaquesList"></div>
        </div>
        
        <!-- Section Arnaques Archiv√©es -->
        <div id="arnaques-archived-content" style="display:none;">
          <div class="article-list" id="arnaquesArchivedList"></div>
        </div>
      </div>
    </div>

    <!-- Section Avis clients fusionn√©e -->
    <div id="avis-pending-section" class="admin-section" style="display:none;">
      <div class="container">
        <h1>Admin - Avis clients</h1>
        
        <!-- Onglets pour naviguer entre avis en attente et Avis publi√©es -->
        <div style="margin-bottom: 2rem; display: flex; gap: 1rem;">
          <button id="tab-pending" class="tab-button active" style="background: #ff6b6b; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
            ‚è≥ Avis en attente
          </button>
          <button id="tab-published" class="tab-button" style="background: #4b1a7f; color: #8ef58e; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
            ‚úÖ Avis publi√©es
          </button>
          <button id="tab-archived" class="tab-button" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
            üì¶ Archiv√©
          </button>
          <button id="tab-messages-preuve" class="tab-button" style="background: #8a2be2; color: #ffd369; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; display:flex;align-items:center;gap:6px;">
            üí¨ Messages avis
          </button>
        </div>
        
        <!-- Contenu des avis en attente -->
        <div id="pending-content" class="tab-content">
          <p style="color: #ffd369; margin-bottom: 2rem;">Les avis soumis par les visiteurs sont list√©s ici. Vous pouvez les valider (publier) ou les archiver.</p>
          <div class="article-list" id="avisPendingList"></div>
        </div>
        
        <!-- Contenu des Avis publi√©es -->
        <div id="published-content" class="tab-content" style="display: none;">
          <p style="color: #ffd369; margin-bottom: 2rem;">Toutes les Avis publi√©es et visibles sur le site. Vous pouvez les supprimer si n√©cessaire.</p>
          <div class="article-list" id="preuvesList"></div>
          
        </div>

        <!-- Contenu des avis archiv√©s -->
        <div id="archived-content" class="tab-content" style="display: none;">
          <p style="color: #ffd369; margin-bottom: 2rem;">Avis archiv√©s (non publi√©s). Ces avis ne sont plus visibles mais conserv√©s pour r√©f√©rence.</p>
          <div class="article-list" id="archivedAvisList"></div>
        </div>

        <!-- Contenu des Messages avis -->
        <div id="messages-preuve-content" class="tab-content" style="display:none;">
          <p style="color:#ffd369;margin-bottom:1.5rem;">Messages courts de confiance (anonymes) ajout√©s directement. Formulaire simplifi√© ci-dessous.</p>
          <form id="message-preuve-form" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;background:#3a0066;padding:16px;border-radius:10px;margin-bottom:24px;">
            <div style="grid-column:span 2;">
              <label style="display:block;margin-bottom:6px;font-weight:600;color:#ffd369;">Titre (optionnel)</label>
              <input type="text" id="msg-preuve-titre" placeholder="Titre court" style="width:100%;padding:10px;border-radius:8px;border:1px solid #4b1a7f;background:#2e004f;color:#fff;">
            </div>
            <div style="grid-column:span 2;">
              <label style="display:block;margin-bottom:6px;font-weight:600;color:#ffd369;">Message *</label>
              <textarea id="msg-preuve-message" rows="3" required placeholder="Votre message de confiance..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #4b1a7f;background:#2e004f;color:#fff;resize:vertical;"></textarea>
            </div>
            <div style="grid-column:span 2;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
              <button type="button" id="msg-preuve-add-media" style="background:#4b1a7f;color:#8ef58e;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600;">üìÅ M√©dias (optionnel)</button>
              <div id="msg-preuve-medias-preview" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
              <input type="hidden" id="msg-preuve-medias" value="[]">
            </div>
            <div style="grid-column:span 2;text-align:right;">
              <button type="submit" style="background:#8ef58e;color:#240038;font-weight:700;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;">‚ûï Ajouter le message</button>
            </div>
          </form>
          <div id="messages-preuve-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;"></div>
        </div>
      </div>
    </div>
    <!-- Section Annonces -->
    <div id="annonces-section" class="admin-section" style="display:none;">
      <div class="container">
        <h1>Admin - Annonces</h1>
        <form id="annonce-form" style="display:grid;grid-template-columns:1fr 1fr;gap:18px;background:#4b1a7f;padding:20px;border-radius:14px;margin-bottom:30px;">
          <div style="grid-column:span 2;">
            <label style="font-weight:600;color:#ffd369;">Titre de l'annonce *</label>
            <input type="text" id="annonce-titre" required placeholder="Ex: Nouvelle collection disponible !" style="width:100%;padding:10px;border-radius:8px;border:1px solid #6a0572;background:#2e004f;color:#fff;">
          </div>
          <div style="grid-column:span 2;">
            <label style="font-weight:600;color:#ffd369;margin-bottom:10px;display:block;">‚úçÔ∏è Message * (formatage direct)</label>
            
            <!-- Barre d'outils -->
            <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;padding:12px;background:rgba(106,5,114,0.2);border-radius:8px;border:2px solid #6a0572;">
              <button type="button" id="annonce-bold-btn" style="background:#6a0572;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:bold;font-size:0.9em;transition:all 0.2s;" title="Gras"><strong>B</strong></button>
              <button type="button" id="annonce-italic-btn" style="background:#6a0572;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-style:italic;font-size:0.9em;transition:all 0.2s;" title="Italique"><em>I</em></button>
              <button type="button" id="annonce-underline-btn" style="background:#6a0572;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;text-decoration:underline;font-size:0.9em;transition:all 0.2s;" title="Soulign√©">U</button>
              <input type="color" id="annonce-text-color" value="#8ef58e" style="width:40px;height:38px;border:none;border-radius:6px;cursor:pointer;background:none;" title="Couleur du texte">
              <input type="color" id="annonce-highlight-color" value="#ffd369" style="width:40px;height:38px;border:none;border-radius:6px;cursor:pointer;background:none;" title="Couleur de surbrillance">
              <button type="button" id="annonce-highlight-btn" style="background:#ffd369;color:#240038;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:0.9em;font-weight:600;transition:all 0.2s;" title="Surligner">üé®</button>
              <select id="annonce-font-size" style="padding:8px;border-radius:6px;border:1px solid #6a0572;background:#2e004f;color:#fff;cursor:pointer;" title="Taille police">
                <option value="1">Petit</option>
                <option value="3" selected>Normal</option>
                <option value="5">Grand</option>
                <option value="7">Tr√®s grand</option>
              </select>
              <select id="annonce-text-align" style="padding:8px;border-radius:6px;border:1px solid #6a0572;background:#2e004f;color:#fff;cursor:pointer;" title="Alignement">
                <option value="left">‚¨Ö Gauche</option>
                <option value="center">‚¨å Centre</option>
                <option value="right">‚û° Droite</option>
              </select>
              <button type="button" id="annonce-insert-image-btn" style="background:#ffd369;color:#240038;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:0.9em;font-weight:700;transition:all 0.2s;" title="Ins√©rer image/vid√©o">üì∑ M√©dia</button>
              <button type="button" id="annonce-link-product-btn" style="background:#8ef58e;color:#240038;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:0.9em;font-weight:600;transition:all 0.2s;" title="Lier √† un produit">üß® Produit</button>
              <button type="button" id="annonce-link-url-btn" style="background:#17a2b8;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:0.9em;font-weight:600;transition:all 0.2s;" title="Lien externe">üîó Lien</button>
              <button type="button" id="annonce-remove-format-btn" style="background:#e74c3c;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:0.9em;font-weight:600;transition:all 0.2s;" title="Enlever le formatage">üßπ Nettoyer</button>
            </div>
            
            <!-- √âditeur WYSIWYG -->
            <div id="annonce-editor" contenteditable="true" spellcheck="false" style="width:100%;min-height:200px;max-height:400px;overflow-y:auto;padding:15px;border-radius:8px;border:2px solid #6a0572;background:#1a0033;color:#fff;font-size:16px;line-height:1.6;margin-bottom:10px;outline:none;" placeholder="√âcrivez votre message ici... S√©lectionnez du texte pour le formater"></div>
            
            <div style="font-size:0.85em;color:#8ef58e;opacity:0.7;">
              üí° S√©lectionnez du texte et utilisez les boutons pour le formater directement
            </div>
          </div>
          

          
          <div style="grid-column:span 2;display:flex;justify-content:flex-end;gap:10px;">
            <button type="button" id="annonce-cancel" style="background:#6d6d6d;color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:600;">Annuler</button>
            <button type="submit" id="annonce-submit" style="background:#8ef58e;color:#240038;font-weight:700;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;">‚ûï Cr√©er l'annonce</button>
          </div>
          <input type="hidden" id="annonce-id-edit" value="">
        </form>
        <div id="annonces-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px;"></div>
      </div>
    </div>

    <!-- Section Page Infos -->
    <div id="infos-section" class="admin-section" style="display:none;">
      <div class="container">
        <h1>Admin - Page Infos (√âditeur)</h1>
        <div style="background:#4b1a7f;padding:20px;border-radius:14px;margin-bottom:20px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="margin:0;color:#ffd369;">üé® Outils d'√©dition</h3>
            <button id="infos-save" style="background:#8ef58e;color:#240038;font-weight:700;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;">üíæ Enregistrer la page</button>
          </div>
          <div id="infos-toolbar" style="display:flex;gap:10px;flex-wrap:wrap;padding:15px;background:#2e004f;border-radius:8px;">
            <button onclick="toggleSommaireEditor()" data-tooltip="G√©rer le sommaire" style="background:#17a2b8;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600;">ÔøΩ Sommaire</button>
            <button class="infos-tool-btn" data-tool="text" data-tooltip="Ajouter du texte" style="background:#6a0572;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600;">ÔøΩ Texte</button>
            <button class="infos-tool-btn" data-tool="media" data-tooltip="Ajouter une image ou vid√©o" style="background:#6a0572;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600;">ÔøΩ M√©dia</button>
            <button class="infos-tool-btn" data-tool="product" data-tooltip="Ajouter un produit" style="background:#6a0572;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600;">üß® Produit</button>
            <button class="infos-tool-btn" data-tool="anchor" data-tooltip="Ajouter une marque de sommaire" style="background:#28a745;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600;">‚öì Marque</button>
            <button class="infos-tool-btn" data-tool="link" data-tooltip="Ajouter un lien" style="background:#6a0572;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600;">üîó Lien</button>
            <button class="infos-tool-btn" data-tool="clear" data-tooltip="Tout effacer" style="background:#8b0000;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600;">üóëÔ∏è Effacer tout</button>
          </div>
        </div>
        
        <!-- Canvas d'√©dition -->
        <div id="infos-canvas" style="position:relative;min-height:400px;background:#1a0033;border-radius:14px;padding:20px;border:2px dashed #6a0572;">
          <div style="text-align:center;color:#8ef58e;opacity:0.5;padding:100px 0;font-size:1.2em;">
            Cliquez sur les outils ci-dessus pour ajouter des √©l√©ments
          </div>
        </div>
      </div>
    </div>

  </div>
  <!-- Modal ordre (pertinence) -->
  <div id="ordering-modal" class="modal" style="z-index:10000;">
    <div class="modal-content" style="width:100vw;height:100vh;max-width:100vw;max-height:100vh;margin:0;border-radius:0;padding:0;display:flex;flex-direction:column;">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:20px;background:#2e004f;border-bottom:2px solid #ffd369;">
        <h2 id="ordering-modal-title" style="margin:0;color:#ffd369;font-size:1.5em;">üìä Ordre des Articles</h2>
        <div style="display:flex;gap:15px;align-items:center;">
          <button id="ordering-save" style="background:#8ef58e;color:#240038;font-weight:700;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:1em;">
            üíæ Sauvegarder
          </button>
          <button id="close-ordering-modal" style="background:none;border:none;color:#ffd369;font-size:2em;cursor:pointer;width:50px;height:50px;">√ó</button>
        </div>
      </div>
      
      <div style="display:flex;gap:15px;padding:20px;background:#2e0052;border-bottom:1px solid #4b1a7f;">
        <input type="text" id="ordering-search" placeholder="üîç Rechercher un article..." style="flex:1;padding:12px 16px;border-radius:8px;border:2px solid #4b1a7f;background:#1a0033;color:#fff;font-size:1em;">
        <button id="ordering-clear" style="background:#6d6d6d;border:none;color:#fff;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:1em;">Effacer</button>
      </div>
      
      <div id="ordering-grid" style="flex:1;overflow-y:auto;padding:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:20px;background:#1a0033;">
        <!-- Les cartes seront g√©n√©r√©es ici -->
      </div>
    </div>
  </div>
  <!-- Aper√ßu modal style site -->
  <div id="product-modal" class="modal side-modal">
    <div class="modal-content" style="padding:0;display:flex;flex-direction:column;position:relative;background: linear-gradient(135deg, #2e003e, #6a0572);overflow-y:auto;">
      <button id="close-product-modal" class="close" style="position:absolute;top:10px;right:15px;background:none;border:none;color:#ffd369;font-size:28px;cursor:pointer;z-index:10;">‚úñ</button>
      
      <div style="padding:24px;">
        <h2 id="product-title" style="margin:0 0 12px 0;color:#fff;font-size:24px;"></h2>
        <div id="product-description" style="color:#fff;margin-bottom:10px;"></div>
        <div id="product-categorie" style="color:#8ef58e;font-size:0.95em;"></div>
      </div>

      <div style="position:relative;margin-top:20px;display:flex;flex-direction:column;align-items:center;">
        <!-- Bouton + en position absolue -->
        <button id="add-to-cart-btn" style="position:absolute;top:20px;right:20px;background:#ffd369;color:#000;border:none;width:42px;height:42px;border-radius:8px;font-weight:bold;font-size:22px;cursor:pointer;z-index:5;display:flex;align-items:center;justify-content:center;">+</button>
        
        <!-- Image/vid√©o centr√©e avec fond normal -->
        <div style="display:flex;align-items:center;justify-content:center;margin:20px 0;background:transparent;">
          <img id="product-media-img" style="max-width:100%;object-fit:contain;display:none;border-radius:8px;" />
          <video id="product-media-video" style="max-width:100%;object-fit:contain;display:none;border-radius:8px;" muted autoplay loop></video>
        </div>
      </div>
    </div>
  </div>

  <!-- La modale apercu-modal a √©t√© supprim√©e car elle est obsol√®te -->

    <!-- Nouvelle modal cat√©gories simplifi√©e -->
    <div id="category-explorer-modal" class="modal">
      <div class="modal-content" style="width:100vw; height:100vh; max-width:100vw; max-height:100vh; margin:0; border-radius:0; position:fixed; top:0; left:0; z-index:10000;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px; flex-wrap:wrap; gap:10px; padding:20px;">
          <h2 style="color:#ffd369; margin:0; font-size:1.2em;">üìÅ S√©lectionner une cat√©gorie</h2>
          <button id="close-category-explorer" style="background:none;border:none;color:#ffd369;font-size:1.5em;cursor:pointer; min-width:40px; min-height:40px;">√ó</button>
        </div>
        
        <div style="padding:0 20px; height:calc(100vh - 120px); overflow-y:auto;">
          <!-- Breadcrumbs de navigation -->
          <div id="admin-cat-breadcrumbs" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;padding:10px;background:#3a0066;border-radius:8px;"></div>
          
          <!-- Liste des cat√©gories du niveau courant -->
          <div id="admin-cat-list-container" style="max-height:none;overflow-y:visible;margin-bottom:80px;padding-bottom:20px;">
            <ul id="admin-cat-list" style="list-style:none;padding:0;margin:0;"></ul>
          </div>
        </div>
        
        <!-- Boutons d'action -->
        <div style="display:flex;justify-content:space-between;gap:10px; flex-wrap:wrap; padding:20px; background:#2e003e; position:absolute; bottom:0; left:0; right:0;">
          <button id="cancel-category-selection" style="background:#6d6d6d;color:white;border:none;padding:12px 16px;border-radius:6px;cursor:pointer; min-width:120px; font-size:0.9em;">Annuler</button>
          <button id="edit-categories-btn" style="background:#ffd369;color:#240038;border:none;padding:12px 16px;border-radius:6px;cursor:pointer;font-weight:bold; min-width:140px; font-size:0.9em;">‚úèÔ∏è G√©rer</button>
          <button id="select-current-category" style="background:#4b1a7f;color:#8ef58e;border:none;padding:12px 16px;border-radius:6px;cursor:pointer;font-weight:bold; min-width:140px; font-size:0.9em;">S√©lectionner</button>
        </div>
      </div>
    </div>
    
    <!-- Modal de gestion des cat√©gories -->
    <div id="category-management-modal" class="modal">
      <div class="modal-content" style="max-width:800px;width:95%;max-height:90vh;overflow-y:auto;background: linear-gradient(135deg, #2e003e, #6a0572);">
        <div style="padding:15px;">
          <h2 style="color:#ffd369;margin-bottom:20px;text-align:center; font-size:1.3em;">üóÇÔ∏è Gestion des Cat√©gories</h2>
          
          <!-- Breadcrumb de navigation -->
          <div id="management-breadcrumbs" style="background:rgba(255,255,255,0.1);padding:10px;border-radius:8px;margin-bottom:20px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;"></div>
          
          <!-- Liste des cat√©gories √©ditables -->
          <div id="management-category-list" style="margin-bottom:20px;"></div>
          
          <!-- Formulaire d'ajout -->
          <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:8px;margin-bottom:20px;">
            <h4 style="color:#8ef58e;margin-bottom:10px;">Ajouter une cat√©gorie</h4>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <input type="text" id="new-category-name" placeholder="Nom de la nouvelle cat√©gorie" style="flex:1;min-width:200px;padding:8px;border-radius:4px;border:1px solid #ccc;">
              <input type="text" id="new-category-icon" placeholder="Ic√¥ne (emoji ou texte)" style="width:120px;padding:8px;border-radius:4px;border:1px solid #ccc;" maxlength="5">
              <button id="add-category" style="background:#4caf50;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;font-weight:bold;">‚ûï Ajouter</button>
            </div>
          </div>
          
          <!-- Boutons de contr√¥le -->
          <div style="display:flex;justify-content:space-between;gap:10px; flex-wrap:wrap;">
            <button id="save-categories" style="background:#4caf50;color:white;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;font-weight:bold; min-width:140px; font-size:0.9em;">üíæ Sauvegarder</button>
            <button class="close" style="background:#d72660;color:white;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;font-weight:bold; min-width:100px; font-size:0.9em;">Fermer</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Explorateur de fichiers -->
    <div id="file-explorer-modal" class="modal">
      <div class="modal-content" style="max-width:100vw; width:100vw; height:100vh; max-height:100vh; margin:0; border-radius:0; position:fixed; top:0; left:0; z-index:10000; display:flex; flex-direction:column;">
        <div style="flex:0 0 auto;display:flex;justify-content:space-between;align-items:center; padding:10px 14px 0 14px;">
          <h2 style="font-size:1em;margin:0;">Explorateur</h2>
          <button id="close-file-explorer" class="close-btn" style="background:none;border:none;color:#ffd369;font-size:1.5em;cursor:pointer;">√ó</button>
        </div>
        <div style="flex:1 1 auto; display:flex; min-height:0; overflow:hidden; padding:0 12px; box-sizing:border-box; gap:10px;">
          <!-- Grille de fichiers √† plein √©cran -->
          <div style="width:78%; height:100%; overflow-y:auto; padding:8px 8px 12px 8px;">
            <!-- Navigation -->
            <div id="file-path" style="margin-bottom:8px;color:#8ef58e;font-weight:500;font-size:.75em;">üìÅ /img</div>
            <!-- Contenu de l'explorateur en grille -->
            <div id="file-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap:10px;"></div>
          </div>
          
          <!-- Panel des s√©lections -->
          <div style="width:22%; height:100%; border-left:1px solid #4b1a7f; padding:8px 8px 12px 12px; background:rgba(75,26,127,0.15); display:flex; flex-direction:column; min-width:150px;">
            <h3 style="color:#ffd369; margin:0 0 8px 0; font-size:.75em; font-weight:600; letter-spacing:.5px; display:flex;align-items:center;gap:4px;">üìã <span>S√©lections</span> (<span id="selected-count">0</span>)</h3>
            <div style="display:flex; justify-content:space-between; margin-bottom:6px; gap:4px;">
              <button id="select-all-media" style="background:#4b1a7f;color:#8ef58e;border:none;padding:4px 6px;border-radius:4px;cursor:pointer;font-size:.55em;">Tous</button>
              <button id="clear-selection" style="background:#ff6b6b;color:white;border:none;padding:4px 6px;border-radius:4px;cursor:pointer;font-size:.55em;">Effacer</button>
            </div>
            <div id="selected-media-list" style="flex:1 1 auto; overflow-y:auto; border:1px solid rgba(255,255,255,0.1); border-radius:6px; padding:4px; background:rgba(0,0,0,0.15); min-height:60px;"></div>
          </div>
          
          <!-- Input cach√© pour stocker les chemins de fichiers s√©lectionn√©s -->
          <input type="hidden" id="selected-file-paths" value="">
        </div>
        <div class="explorer-footer" style="flex:0 0 auto;display:flex;justify-content:space-between;gap:12px;padding:6px 12px 12px 12px; background:rgba(46,0,78,0.92);backdrop-filter:blur(4px); border-top:1px solid rgba(255,255,255,0.08);">
          <button id="cancel-file-selection" class="btn" style="background:#6d6d6d;padding:6px 14px;border-radius:6px;border:none;color:#fff;cursor:pointer;font-size:.7em;">Annuler</button>
          <div style="display:flex;align-items:center;gap:8px;">
            <span id="mobile-selection-count" style="color:#8ef58e;font-weight:600;display:none;font-size:.65em;">0 s√©lection(s)</span>
            <button id="confirm-file-selection" class="btn" style="background:#8ef58e;padding:6px 14px;border-radius:6px;border:none;color:#240038;cursor:pointer;font-weight:700;font-size:.7em;">Confirmer <span id="confirm-count">(0)</span></button>
          </div>
        </div>
      </div>
    </div>

<!-- Modal d√©tails avis -->
<div class="modal" id="review-detail-modal">
  <div class="modal-content">
    <button class="close" id="close-review-detail-modal">√ó</button>
    
    <div class="review-detail-header">
      <div class="review-avatar" id="review-detail-avatar">A</div>
      <div class="review-user-info">
        <h3 id="review-detail-username">@username</h3>
        <p id="review-detail-date">01/01/2025</p>
      </div>
    </div>

    <h2 id="review-detail-title">Titre de l‚Äôavis</h2>
    <p id="review-detail-text">Contenu de l‚Äôavis d√©taill√©‚Ä¶</p>

    <div class="review-detail-gallery" id="review-detail-gallery">
      <!-- Les miniatures images/vid√©os s‚Äôinjectent ici -->
    </div>

    <div class="review-detail-main-media" id="review-detail-main-media">
      <!-- Le m√©dia principal s√©lectionn√© -->
    </div>

    <div class="review-detail-footer">
      <div class="review-detail-rating" id="review-detail-rating">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
      <span class="review-detail-verified" id="review-detail-verified">‚úîÔ∏è V√©rifi√©</span>
    </div>
  </div>
</div>

<script>
// Ajout dynamique d'un bouton Annonces si pas d√©j√† pr√©sent
document.addEventListener('DOMContentLoaded', () => {
  if(!document.getElementById('menu-annonces')){
    const menuModal = document.getElementById('menu-modal') || document.querySelector('.admin-header') || document.body;
    const btn = document.createElement('button');
    btn.id='menu-annonces';
    btn.innerHTML='<img src="img/_technique/icon/annonce.png" style="width:20px;height:20px;margin-right:10px;filter:brightness(0) saturate(100%) invert(82%) sepia(44%) saturate(484%) hue-rotate(353deg) brightness(103%) contrast(102%);"/> Annonces';
    btn.style.cssText='display:flex; align-items:center; width:100%; padding:14px 18px; background:#4b1a7f; color:#ffd369; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.95em; transition:all 0.3s;';
    btn.addEventListener('click', ()=> showSection('annonces'));
    menuModal.appendChild(btn);
  }
  
  // Ajout dynamique d'un bouton Infos
  if(!document.getElementById('menu-infos')){
    const menuModal = document.getElementById('menu-modal') || document.querySelector('.admin-header') || document.body;
    const btn = document.createElement('button');
    btn.id='menu-infos';
    btn.innerHTML='<img src="img/_technique/icon/information.png" style="width:18px;height:18px;margin-right:10px;"/> Page Infos';
    btn.style.cssText='display:flex; align-items:center; width:100%; padding:14px 18px; background:#17a2b8; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.95em; transition:all 0.3s; margin:4px;';
    btn.addEventListener('click', ()=> showSection('infos'));
    menuModal.appendChild(btn);
  }
});
// Variables globales pour le fonctionnement de l'admin
let currentAdminSection = 'articles';
let articlesData = [];
let offresData = [];
let arnaquesData = [];
let avisPendingData = [];
let annoncesData = [];
let infosPageData = {elements: []}; // Page infos personnalis√©e
let selectedInfosElements = []; // √âl√©ments s√©lectionn√©s pour d√©placement multiple
let infosSelectedElement = null; // √âl√©ment actuellement s√©lectionn√© pour √©dition

// Identifiants admin pour les appels API
const adminCredentials = {
  user: 'admin', // ou r√©cup√©rer depuis une variable si besoin
  pass: 'motdepassefort' // ou r√©cup√©rer depuis une variable si besoin
};

// Fonction pour changer de section (globale pour √™tre accessible aux √©v√©nements onclick)
function showSection(sectionName) {
  // Masquer toutes les sections
  document.querySelectorAll('.admin-section').forEach(section => {
    section.style.display = 'none';
  });

  // Afficher la section demand√©e
  const targetSection = document.getElementById(sectionName + '-section');
  if (targetSection) {
    targetSection.style.display = 'block';
    currentAdminSection = sectionName;
    
    // Mettre √† jour le bouton d'ordre selon la section
    const orderingBtnText = document.getElementById('ordering-btn-text');
    if (orderingBtnText) {
      const sectionNames = {
        'articles': 'Articles',
        'offres': 'Offres',
        'arnaques': 'Arnaques',
        'avis-pending': 'Avis clients'
      };
      orderingBtnText.textContent = `Ordre (${sectionNames[sectionName] || 'Pertinence'})`;
    }
    
    // Charger les donn√©es selon la section
    if (sectionName === 'articles') {
      loadArticles();
      // Restaurer le formulaire d'article s'il y a des donn√©es sauvegard√©es
      if (window.currentEditingArticle && window.currentEditingArticle.medias && window.currentEditingArticle.medias.length > 0) {
        restoreArticleForm();
      }
    } else if (sectionName === 'medias') {
      initGofileExplorer();
    } else if (sectionName === 'offres') {
      loadOffres();
    } else if (sectionName === 'arnaques') {
      loadArnaquesPending();
    } else if (sectionName === 'avis-pending') {
      loadAvisPending();
      loadPreuves(); // Charger aussi les Avis publi√©es
    } else if (sectionName === 'annonces') {
      // S'assurer que les articles sont charg√©s pour le s√©lecteur produit
      if(!articlesData || !articlesData.length){
        try { 
          const p = loadArticles();
          if(p && typeof p.then==='function'){
            p.then(()=> loadAnnonces()).catch(e=>{ console.warn('Chargement articles (annonces) √©chou√©', e); loadAnnonces(); });
          } else {
            loadAnnonces();
          }
        } catch(e){ console.warn('Chargement articles (annonces) √©chou√©', e); loadAnnonces(); }
      } else {
        loadAnnonces();
      }
      // Si loadAnnonces pas encore d√©fini (par ordre du script) retenter
      if(typeof loadAnnonces === 'undefined'){
        console.warn('[ANNONCES] loadAnnonces indisponible, retry dans 150ms');
        setTimeout(()=>{ if(typeof loadAnnonces==='function'){ console.log('[ANNONCES] Retry loadAnnonces'); loadAnnonces(); } else { console.error('[ANNONCES] Toujours pas d√©fini'); } },150);
      }
    } else if (sectionName === 'infos') {
      loadInfosPage();
      // S'assurer que les articles sont charg√©s pour le s√©lecteur produit
      if(!articlesData || !articlesData.length){
        loadArticles().catch(e=> console.warn('Chargement articles (infos) √©chou√©', e));
      }
    }
  }

  // Fermer le menu
  const menuModal = document.getElementById('menu-modal');
  if (menuModal) menuModal.style.display = 'none';
}

// Fonction pour afficher la modale d'ordre filtr√©e par section (globale)
function showOrderingModal() {
  console.log('[ORDER] showOrderingModal section:', currentAdminSection);
  const modal = document.getElementById('ordering-modal');
  const itemsList = document.getElementById('ordering-grid');
  if (!modal || !itemsList) return console.error('Ordering modal manquante');

  itemsList.innerHTML = '';
  itemsList.style.display = 'grid';
  itemsList.style.gridTemplateColumns = 'repeat(auto-fill,minmax(140px,1fr))';
  itemsList.style.gap = '12px';
  itemsList.style.background = '#240038';
  itemsList.style.border = '1px solid #4b1a7f';

  let items = [];
  let itemType = '';
  switch(currentAdminSection) {
    case 'articles': items = articlesData || []; itemType='article'; break;
    case 'offres': items = offresData || []; itemType='offre'; break;
    case 'arnaques': items = arnaquesData || []; itemType='arnaque'; break;
    case 'avis-pending': items = avisPendingData || []; itemType='avis'; break;
    default: return console.warn('Section non support√©e pour ordre', currentAdminSection);
  }

  if(!items.length){
    itemsList.innerHTML = '<div class="no-items" style="grid-column:1/-1;">Aucun √©l√©ment √† ordonner</div>';
  } else {
    items.forEach((item, index)=>{
      const card = document.createElement('div');
      card.className='ordering-item';
      card.draggable = true;
      card.dataset.id = item.id;
      card.dataset.type = itemType;
      card.style.cssText='background:#3a0066;border:1px solid #4b1a7f;border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:6px;position:relative;cursor:grab;min-height:160px;box-shadow:0 2px 4px #0006;';

      // Media choisi
      let mediaPath = item.thumbnail || (item.medias && item.medias.length && (item.medias[0].path || item.medias[0])) || item.image || item.video || '';
      let mediaHtml='';
      if(mediaPath){
        if(/\.(mp4|webm|mov)$/i.test(mediaPath)){
          mediaHtml = `<video src="${mediaPath}" muted autoplay loop style="width:100%;height:80px;object-fit:cover;border-radius:8px;"></video>`;
        } else {
          mediaHtml = `<img src="${mediaPath}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;" loading="lazy"/>`;
        }
      }

      const prix = item.prix ? `<div style=\"color:#8ef58e;font-weight:600;font-size:.7em;\">${item.prix}‚Ç¨</div>` : '';
      const titre = (item.nom || item.username || item.id || 'Sans nom');
      const cat = item.categorie ? `<div style=\"font-size:.55em;color:#ffd369;line-height:1.2;\">${item.categorie}</div>` : '';

      card.innerHTML = `
        <div class="ordering-position" style="position:absolute;top:4px;left:4px;background:#ffd369;color:#240038;font-size:.65em;font-weight:700;padding:3px 7px;border-radius:8px;cursor:pointer;z-index:10;" title="Cliquer pour changer la position">${index+1}</div>
        ${mediaHtml}
        <div style="font-size:.65em;font-weight:600;word-break:break-word;text-align:center;">${titre}</div>
        ${prix}
        ${cat}
      `;

      // Rendre la position cliquable
      const positionBadge = card.querySelector('.ordering-position');
      positionBadge.addEventListener('click', (e) => {
        e.stopPropagation();
        const allItems = Array.from(itemsList.children);
        const currentPos = allItems.indexOf(card) + 1;
        const maxPos = allItems.length;
        
        showPositionPrompt(titre, currentPos, maxPos, (newPos) => {
          if (newPos >= 1 && newPos <= maxPos && newPos !== currentPos) {
            // D√©placer l'√©l√©ment √† la nouvelle position
            if (newPos === 1) {
              itemsList.insertBefore(card, itemsList.firstChild);
            } else {
              const targetItem = allItems[newPos - 1];
              if (currentPos < newPos) {
                itemsList.insertBefore(card, targetItem.nextSibling);
              } else {
                itemsList.insertBefore(card, targetItem);
              }
            }
            updateOrderingPositions();
            showToast(`Position chang√©e: ${currentPos} ‚Üí ${newPos}`, 'success');
          }
        });
      });

      card.addEventListener('dragstart', e=>{ card.classList.add('dragging'); e.dataTransfer.setData('text/plain', card.dataset.id); });
      card.addEventListener('dragend', ()=>{ card.classList.remove('dragging'); updateOrderingPositions(); });
      card.addEventListener('dragover', e=>{ e.preventDefault(); });
      card.addEventListener('drop', e=>{
        e.preventDefault();
        const idSrc = e.dataTransfer.getData('text/plain');
        if(!idSrc || idSrc === card.dataset.id) return;
        const children = Array.from(itemsList.children);
        const srcEl = children.find(c=>c.dataset.id===idSrc);
        if(!srcEl) return;
        const srcIndex = children.indexOf(srcEl);
        const tgtIndex = children.indexOf(card);
        if(srcIndex < tgtIndex) itemsList.insertBefore(srcEl, card.nextSibling); else itemsList.insertBefore(srcEl, card);
        updateOrderingPositions();
      });

      itemsList.appendChild(card);
    });
  }

  modal.classList.add('show');
  const modalTitle = document.getElementById('ordering-modal-title');
  if(modalTitle){
    const sectionNames={articles:'Articles',offres:'Offres',arnaques:'Arnaques','avis-pending':'Avis clients'};
    modalTitle.textContent = `Ordre des ${sectionNames[currentAdminSection]||'√âl√©ments'}`;
  }
}

// Fonction pour mettre √† jour les num√©ros de position apr√®s r√©organisation (globale)
function updateOrderingPositions() {
  const items = document.querySelectorAll('#ordering-grid .ordering-item');
  items.forEach((item, index) => {
    const positionElement = item.querySelector('.ordering-position');
    if (positionElement) {
      positionElement.textContent = index + 1;
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {

  // Diagnostic m√©dias manquants (console seulement, sans banni√®re)
  fetch('/api/check-media?detailed=1').then(r=>r.json()).then(rep=>{
    if(rep && rep.missingCount>0){
      console.warn('[DIAGNOSTIC MEDIAS] Fichiers manquants:', rep.missing);
    } else {
      console.log('[DIAGNOSTIC MEDIAS] Tous les m√©dias r√©f√©renc√©s existent.');
    }
  }).catch(e=>console.error('Erreur diagnostic m√©dias', e));

  // Gestion du menu hamburger admin
  const menuToggle = document.getElementById('menu-toggle');
  const menuModal = document.getElementById('menu-modal');

  if (menuToggle && menuModal) {
    menuToggle.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const currentDisplay = menuModal.style.display;
      if (currentDisplay === 'none' || currentDisplay === '') {
        menuModal.style.display = 'block';
      } else {
        menuModal.style.display = 'none';
      }
    });
  }

  // Event listeners pour les boutons de menu
  document.getElementById('menu-articles')?.addEventListener('click', () => showSection('articles'));
  document.getElementById('menu-medias')?.addEventListener('click', () => showSection('medias'));
  document.getElementById('menu-offres')?.addEventListener('click', () => showSection('offres'));
  document.getElementById('menu-arnaques')?.addEventListener('click', () => showSection('arnaques'));
  document.getElementById('menu-avis-pending')?.addEventListener('click', () => showSection('avis-pending'));
  
  // Event listeners pour les onglets dans la section avis/preuves
  document.getElementById('tab-pending')?.addEventListener('click', function() {
    showTab('pending');
  });
  
  document.getElementById('tab-published')?.addEventListener('click', function() {
    showTab('published');
  });
  
  document.getElementById('tab-archived')?.addEventListener('click', function() {
    showTab('archived');
  });
  document.getElementById('tab-messages-preuve')?.addEventListener('click', function(){
    showTab('messages-preuve');
  });
  
  // Onglets pour les arnaques
  document.getElementById('tab-arnaques-pending')?.addEventListener('click', function() {
    showArnaquesTab('pending');
  });

  document.getElementById('tab-arnaques-active')?.addEventListener('click', function() {
    showArnaquesTab('active');
  });
  
  document.getElementById('tab-arnaques-archived')?.addEventListener('click', function() {
    showArnaquesTab('archived');
  });
  
  window.showArnaquesTab = function(tabName) {
    // Mettre √† jour les boutons onglets
    const pendingBtn = document.getElementById('tab-arnaques-pending');
    const activeBtn = document.getElementById('tab-arnaques-active');
    const archivedBtn = document.getElementById('tab-arnaques-archived');
    
    pendingBtn?.classList.remove('active');
    activeBtn?.classList.remove('active');
    archivedBtn?.classList.remove('active');
    
    if (tabName === 'pending') {
      pendingBtn?.classList.add('active');
      document.getElementById('arnaques-pending-content').style.display = 'block';
      document.getElementById('arnaques-active-content').style.display = 'none';
      document.getElementById('arnaques-archived-content').style.display = 'none';
      loadArnaquesPending();
    } else if (tabName === 'active') {
      activeBtn?.classList.add('active');
      document.getElementById('arnaques-pending-content').style.display = 'none';
      document.getElementById('arnaques-active-content').style.display = 'block';
      document.getElementById('arnaques-archived-content').style.display = 'none';
      loadArnaques();
    } else if (tabName === 'archived') {
      archivedBtn?.classList.add('active');
      document.getElementById('arnaques-pending-content').style.display = 'none';
      document.getElementById('arnaques-active-content').style.display = 'none';
      document.getElementById('arnaques-archived-content').style.display = 'block';
      loadArnaquesArchived();
    }
  }
  
  function showTab(tabName) {
    // Mettre √† jour les boutons onglets
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    const btn = document.getElementById(`tab-${tabName}`);
    if(btn) btn.classList.add('active');
    
    // Mettre √† jour le contenu
    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
    const contentEl = document.getElementById(`${tabName}-content`);
    if(contentEl) contentEl.style.display = 'block';
    
    // Charger les donn√©es selon l'onglet
    if (tabName === 'pending') {
      loadAvisPending();
    } else if (tabName === 'published') {
      loadPreuves();
    } else if (tabName === 'archived') {
      loadArchivedAvis();
    } else if (tabName === 'messages-preuve') {
      loadMessagesPreuve();
    }
  }

  // Fermer le menu en cliquant ailleurs
  document.addEventListener('click', function(e) {
    if (menuModal && !menuModal.contains(e.target) && !menuToggle.contains(e.target)) {
      menuModal.style.display = 'none';
    }
  });

  // Gestion des boutons r√©seaux pour les arnaques
  document.querySelectorAll('.reseau-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      this.classList.toggle('selected');
      updateReseauxInput();
    });
  });

  function updateReseauxInput() {
    const selectedReseaux = Array.from(document.querySelectorAll('.reseau-btn.selected'))
      .map(btn => btn.getAttribute('data-reseau'));
    document.getElementById('reseaux-arnaque').value = selectedReseaux.join(', ');
  }

  // Rendre la fonction accessible globalement
  window.updateReseauxInput = updateReseauxInput;

  // ==================== SYST√àME TECHNIQUES ARNAQUES ====================
  let selectedTechniques = [];
  let techniquesData = [];

  async function loadTechniques() {
    try {
      const res = await fetch('/api/techniques-arnaques');
      if (res.ok) {
        techniquesData = await res.json();
      }
    } catch (e) {
      console.error('Erreur chargement techniques:', e);
      techniquesData = [];
    }
    renderTechniquesList();
  }

  function renderTechniquesList() {
    const container = document.getElementById('techniques-list');
    if (!container) return;
    
    container.innerHTML = '';
    if (techniquesData.length === 0) {
      container.innerHTML = '<div style="color:#8ef58e;opacity:0.6;padding:10px;text-align:center;width:100%;">Aucune technique. Cliquez sur "Nouvelle technique" pour en ajouter.</div>';
      return;
    }
    
    techniquesData.forEach(tech => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'technique-btn';
      btn.setAttribute('data-tooltip', tech.description || tech.name);
      btn.textContent = tech.name;
      btn.style.cssText = 'background:#4b1a7f;color:#ffd369;border:1px solid #6a0572;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:600;transition:all 0.2s;position:relative;';
      
      btn.onmouseover = () => btn.style.background = '#6a0572';
      btn.onmouseout = () => btn.style.background = '#4b1a7f';
      
      btn.onclick = () => {
        if (!selectedTechniques.find(t => t.name === tech.name)) {
          selectedTechniques.push({name: tech.name, description: tech.description});
          updateTechniquesDisplay();
          updateTechniquesInput();
        }
      };
      
      container.appendChild(btn);
    });
  }

  document.getElementById('add-technique-btn')?.addEventListener('click', function() {
    showTechniqueModal();
  });

  document.getElementById('manage-techniques-btn')?.addEventListener('click', function() {
    showTechniquesManagerModal();
  });

  function showTechniqueModal(existingTech = null) {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
      <div class="modal-content" style="max-width:600px;width:90%;background:linear-gradient(135deg, #2e003e, #6a0572);border-radius:16px;padding:0;overflow:hidden;">
        <div style="background:linear-gradient(135deg, #ffd369, #ffb347);padding:20px;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;color:#2e003e;font-size:1.3em;">${existingTech ? '‚úèÔ∏è Modifier' : '‚ûï Nouvelle'} Technique</h3>
          <button onclick="this.closest('.modal').remove()" style="background:none;border:none;color:#2e003e;font-size:2em;cursor:pointer;width:40px;height:40px;">√ó</button>
        </div>
        <div style="padding:20px;">
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:8px;color:#ffd369;font-weight:600;">Nom de la technique</label>
            <input type="text" id="tech-name-input" value="${existingTech?.name || ''}" placeholder="Ex: Fausse v√©rification" style="width:100%;padding:12px;border-radius:8px;border:2px solid #ffd369;background:rgba(0,0,0,0.3);color:#fff;font-size:1em;">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:8px;color:#ffd369;font-weight:600;">Description (appara√Æt au survol)</label>
            <textarea id="tech-desc-input" placeholder="D√©crivez la technique en quelques mots..." style="width:100%;padding:12px;border-radius:8px;border:2px solid #ffd369;background:rgba(0,0,0,0.3);color:#fff;font-size:1em;min-height:100px;resize:vertical;">${existingTech?.description || ''}</textarea>
          </div>
          <button onclick="saveTechnique(${existingTech ? `'${existingTech.name}'` : 'null'})" style="width:100%;background:#8ef58e;color:#2e003e;border:none;padding:12px;border-radius:8px;cursor:pointer;font-weight:700;font-size:1.1em;">üíæ Enregistrer</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('tech-name-input').focus();
  }

  async function saveTechnique(oldName) {
    const name = document.getElementById('tech-name-input').value.trim();
    const description = document.getElementById('tech-desc-input').value.trim();
    
    if (!name) {
      showToast('‚ö†Ô∏è Le nom est obligatoire', 'warning');
      return;
    }
    
    if (oldName) {
      // Modification
      const index = techniquesData.findIndex(t => t.name === oldName);
      if (index !== -1) {
        techniquesData[index] = {name, description};
      }
    } else {
      // Ajout
      if (techniquesData.find(t => t.name === name)) {
        showToast('‚ö†Ô∏è Cette technique existe d√©j√†', 'warning');
        return;
      }
      techniquesData.push({name, description});
    }
    
    try {
      const res = await fetch('/api/techniques-arnaques', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(techniquesData)
      });
      if (res.ok) {
        showToast(`‚úÖ Technique ${oldName ? 'modifi√©e' : 'ajout√©e'}`, 'success');
        renderTechniquesList();
        document.querySelector('.modal.show')?.remove();
      } else {
        throw new Error('Erreur serveur');
      }
    } catch (e) {
      console.error('Erreur sauvegarde technique:', e);
      showToast('‚ùå Erreur lors de la sauvegarde', 'error');
    }
  }
  window.saveTechnique = saveTechnique;

  function showTechniquesManagerModal() {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
      <div class="modal-content" style="max-width:800px;width:90%;max-height:90vh;background:linear-gradient(135deg, #2e003e, #6a0572);border-radius:16px;padding:0;overflow:hidden;">
        <div style="background:linear-gradient(135deg, #ffd369, #ffb347);padding:20px;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;color:#2e003e;font-size:1.3em;">‚öôÔ∏è Gestion des Techniques</h3>
          <button onclick="this.closest('.modal').remove()" style="background:none;border:none;color:#2e003e;font-size:2em;cursor:pointer;width:40px;height:40px;">√ó</button>
        </div>
        <div style="padding:20px;overflow-y:auto;max-height:calc(90vh - 80px);">
          <div id="techniques-manager-list"></div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    renderTechniquesManager();
  }

  function renderTechniquesManager() {
    const container = document.getElementById('techniques-manager-list');
    if (!container) return;
    
    container.innerHTML = '';
    if (techniquesData.length === 0) {
      container.innerHTML = '<div style="color:#8ef58e;opacity:0.6;padding:20px;text-align:center;">Aucune technique enregistr√©e</div>';
      return;
    }
    
    techniquesData.forEach(tech => {
      const card = document.createElement('div');
      card.style.cssText = 'background:rgba(0,0,0,0.3);padding:15px;border-radius:12px;margin-bottom:12px;border:2px solid #4b1a7f;';
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:start;gap:15px;">
          <div style="flex:1;">
            <div style="font-weight:600;font-size:1.1em;color:#ffd369;margin-bottom:8px;">${tech.name}</div>
            <div style="font-size:0.9em;color:#fff;opacity:0.8;line-height:1.4;">${tech.description || '<em style="opacity:0.5;">Aucune description</em>'}</div>
          </div>
          <div style="display:flex;gap:8px;">
            <button onclick="editTechnique('${tech.name}')" style="background:#17a2b8;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;">‚úèÔ∏è Modifier</button>
            <button onclick="deleteTechnique('${tech.name}')" style="background:#8b0000;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;">üóëÔ∏è Supprimer</button>
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  window.editTechnique = function(name) {
    const tech = techniquesData.find(t => t.name === name);
    if (tech) {
      document.querySelector('.modal.show')?.remove();
      setTimeout(() => showTechniqueModal(tech), 100);
    }
  };

  window.deleteTechnique = async function(name) {
    if (!confirm(`Supprimer la technique "${name}" ?`)) return;
    
    techniquesData = techniquesData.filter(t => t.name !== name);
    
    try {
      const res = await fetch('/api/techniques-arnaques', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(techniquesData)
      });
      if (res.ok) {
        showToast('‚úÖ Technique supprim√©e', 'success');
        renderTechniquesList();
        renderTechniquesManager();
      } else {
        throw new Error('Erreur serveur');
      }
    } catch (e) {
      console.error('Erreur suppression technique:', e);
      showToast('‚ùå Erreur lors de la suppression', 'error');
    }
  };

  loadTechniques();

  function updateTechniquesDisplay() {
    const container = document.getElementById('selected-techniques');
    container.innerHTML = '';
    selectedTechniques.forEach(technique => {
      const tag = document.createElement('div');
      tag.className = 'selected-technique-tag';
      tag.innerHTML = `
        ${technique}
        <button type="button" class="remove-btn" onclick="removeTechnique('${technique}')">√ó</button>
      `;
      container.appendChild(tag);
    });
  }

  function updateTechniquesInput() {
    document.getElementById('techniques-arnaque').value = selectedTechniques.join(', ');
  }

  window.removeTechnique = function(technique) {
    selectedTechniques = selectedTechniques.filter(t => t !== technique);
    updateTechniquesDisplay();
    updateTechniquesInput();
  };

  // ---- Gestion Annonces (admin) ----
  // ==================== SYST√àME ANNONCES COMPLET ====================
  let annoncesData = [];
  let selectedAnnonceProduits = []; // Produits s√©lectionn√©s pour l'annonce en cours
  
  async function loadAnnonces(){
    try {
      const r = await fetch('/api/annonces');
      const data = await r.json();
      annoncesData = Array.isArray(data) ? data : [];
      renderAnnoncesList();
    } catch(e){ 
      console.error('Erreur chargement annonces', e); 
      showToast('‚ùå Erreur chargement annonces', 'error');
    }
  }
  window.loadAnnonces = loadAnnonces;
  
  function renderAnnoncesList(){
    const container = document.getElementById('annonces-list');
    if(!container) return;
    container.innerHTML='';
    
    if(!annoncesData.length){
      container.innerHTML='<div style="grid-column:1/-1;text-align:center;opacity:.7;padding:40px;color:#8ef58e;">üì¢ Aucune annonce pour le moment</div>'; 
      return;
    }
    
    const sorted = [...annoncesData].sort((a,b)=> new Date(b.dateCreation) - new Date(a.dateCreation));
    
    sorted.forEach(annonce=>{
      const card = document.createElement('div');
      card.className='annonce-card-admin';
      card.style.cssText=`
        position:relative;
        background:linear-gradient(135deg, #2e004f, #4b1a7f);
        border:2px solid #6a0572;
        padding:16px 16px 60px;
        border-radius:16px;
        display:flex;
        flex-direction:column;
        gap:12px;
        overflow:hidden;
        transition:all 0.3s;
      `;
      
      // M√©dia principal
      let mediaHtml = '';
      const medias = annonce.medias || [];
      if(medias.length > 0){
        const firstMedia = medias[0];
        if(/\.(mp4|webm|mov)$/i.test(firstMedia)){
          mediaHtml = `<video src="${firstMedia}" muted loop style="width:100%;height:160px;object-fit:cover;border-radius:12px;"></video>`;
        } else {
          mediaHtml = `<img src="${firstMedia}" style="width:100%;height:160px;object-fit:cover;border-radius:12px;"/>`;
        }
        if(medias.length > 1){
          mediaHtml += `<div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:#fff;padding:4px 8px;border-radius:6px;font-size:0.75em;font-weight:600;">+${medias.length - 1}</div>`;
        }
      }
      
      // Produits li√©s
      const produits = annonce.produits || [];
      let produitsHtml = '';
      if(produits.length > 0){
        produitsHtml = `<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
          <span style="font-size:0.75em;color:#ffd369;">üß® ${produits.length} produit(s)</span>
        </div>`;
      }
      
      card.innerHTML = `
        ${mediaHtml ? `<div style="position:relative;">${mediaHtml}</div>` : ''}
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div style="font-weight:700;font-size:1em;color:#ffd369;">${annonce.titre || '(Sans titre)'}</div>
          <div style="font-size:0.7em;color:#8ef58e;opacity:0.8;">${new Date(annonce.dateCreation).toLocaleString('fr-FR')}</div>
          <div style="font-size:0.75em;line-height:1.4;color:#fff;max-height:80px;overflow:hidden;">${(annonce.message || '').slice(0,200)}${(annonce.message || '').length > 200 ? '...' : ''}</div>
          ${produitsHtml}
          ${annonce.lien ? `<div style="font-size:0.7em;color:#8ef58e;">üîó Lien externe</div>` : ''}
        </div>
        <div class="annonce-actions" style="
          position:absolute;
          left:0;right:0;bottom:0;
          display:flex;gap:8px;
          padding:10px 12px;
          background:linear-gradient(180deg,transparent,rgba(36,0,56,0.95) 30%,#240038);
          backdrop-filter:blur(4px);
        ">
          <button data-edit="${annonce.id}" title="Modifier" style="flex:1;background:#ffd369;color:#240038;border:none;padding:8px;border-radius:8px;font-size:0.8em;cursor:pointer;font-weight:700;">‚úèÔ∏è Modifier</button>
          <button data-del="${annonce.id}" title="Supprimer" style="flex:1;background:#e74c3c;color:#fff;border:none;padding:8px;border-radius:8px;font-size:0.8em;cursor:pointer;font-weight:700;">üóëÔ∏è Supprimer</button>
        </div>
      `;
      
      // Effet hover
      card.addEventListener('mouseenter', () => card.style.borderColor = '#8ef58e');
      card.addEventListener('mouseleave', () => card.style.borderColor = '#6a0572');
      
      container.appendChild(card);
    });
    
    // Event listeners
    container.querySelectorAll('button[data-edit]').forEach(btn => {
      btn.addEventListener('click', () => editAnnonce(btn.getAttribute('data-edit')));
    });
    
    container.querySelectorAll('button[data-del]').forEach(btn => {
      btn.addEventListener('click', () => deleteAnnonce(btn.getAttribute('data-del')));
    });
  }
  
  function editAnnonce(id){
    const annonce = annoncesData.find(a => a.id === id);
    if(!annonce) return;
    
    document.getElementById('annonce-id-edit').value = annonce.id;
    document.getElementById('annonce-titre').value = annonce.titre || '';
    
    // Charger le contenu HTML dans l'√©diteur WYSIWYG
    const editor = document.getElementById('annonce-editor');
    if (editor) {
      editor.innerHTML = annonce.message || '';
    }
    
    document.getElementById('annonce-submit').textContent = 'üíæ Mettre √† jour';
    
    // Scroll vers le formulaire
    document.getElementById('annonce-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  
  async function deleteAnnonce(id){
    try {
      await fetch(`/api/annonces/${id}`, { method: 'DELETE' });
      showToast('üóëÔ∏è Annonce supprim√©e', 'success');
      loadAnnonces();
    } catch(e){
      console.error('Erreur suppression', e);
      showToast('‚ùå Erreur suppression', 'error');
    }
  }
  
  function resetAnnonceForm(){
    document.getElementById('annonce-id-edit').value = '';
    document.getElementById('annonce-titre').value = '';
    const editor = document.getElementById('annonce-editor');
    if (editor) editor.innerHTML = '';
    document.getElementById('annonce-medias').value = '[]';
    document.getElementById('annonce-thumbnail').value = '';
    document.getElementById('annonce-produits').value = '[]';
    selectedAnnonceProduits = [];
    const preview = document.getElementById('annonce-medias-preview');
    if (preview) preview.innerHTML = '<div style="text-align:center;color:#ffd369;opacity:0.6;font-size:0.9em;width:100%;padding:20px;">Aucun m√©dia ‚Ä¢ Cliquez sur "S√©lectionner m√©dias"</div>';
    updateProduitsDisplay();
    const countElem = document.getElementById('annonce-medias-count');
    if (countElem) countElem.textContent = '0 m√©dia(s)';
    document.getElementById('annonce-submit').textContent = '‚ûï Cr√©er l\'annonce';
  }
  
  function updateMediasPreview(medias){
    const preview = document.getElementById('annonce-medias-preview');
    preview.innerHTML = '';
    
    // R√©cup√©rer la miniature actuelle si elle existe
    const thumbnailField = document.getElementById('annonce-thumbnail');
    const currentThumbnail = thumbnailField ? thumbnailField.value : '';
    
    medias.forEach((path, index) => {
      const wrapper = document.createElement('div');
      wrapper.style.cssText = 'position:relative;width:100px;height:100px;display:flex;flex-direction:column;gap:4px;';
      
      // V√©rifier si c'est la miniature s√©lectionn√©e
      const isThumbnail = currentThumbnail === path || (index === 0 && !currentThumbnail);
      
      const mediaPreview = document.createElement('div');
      mediaPreview.style.cssText = 'width:100%;height:80px;position:relative;';
      
      if(/\.(mp4|webm|mov)$/i.test(path)){
        mediaPreview.innerHTML = `
          <video src="${path}" muted loop style="width:100%;height:100%;object-fit:cover;border-radius:8px;border:${isThumbnail ? '3px solid #ffd369' : '2px solid #8ef58e'};"></video>
          <input type="radio" name="annonce-thumbnail-select" value="${index}" ${isThumbnail ? 'checked' : ''} style="position:absolute;bottom:-8px;left:2px;cursor:pointer;accent-color:#ffd369;" title="D√©finir comme miniature">
          <button class="remove-media" data-index="${index}" style="position:absolute;top:-6px;right:-6px;background:#e74c3c;color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:0.7em;font-weight:700;">√ó</button>
        `;
      } else {
        mediaPreview.innerHTML = `
          <img src="${path}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;border:${isThumbnail ? '3px solid #ffd369' : '2px solid #8ef58e'};"/>
          <input type="radio" name="annonce-thumbnail-select" value="${index}" ${isThumbnail ? 'checked' : ''} style="position:absolute;bottom:-8px;left:2px;cursor:pointer;accent-color:#ffd369;" title="D√©finir comme miniature">
          <button class="remove-media" data-index="${index}" style="position:absolute;top:-6px;right:-6px;background:#e74c3c;color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:0.7em;font-weight:700;">√ó</button>
        `;
      }
      
      wrapper.appendChild(mediaPreview);
      
      // Bouton pour ins√©rer dans le texte
      const insertBtn = document.createElement('button');
      insertBtn.type = 'button';
      insertBtn.textContent = `üìç ${index + 1}`;
      insertBtn.title = `Ins√©rer [IMAGE_${index + 1}] dans le texte`;
      insertBtn.style.cssText = 'background:#8ef58e;color:#240038;border:none;padding:4px 6px;border-radius:4px;cursor:pointer;font-size:0.7em;font-weight:700;';
      insertBtn.onclick = () => {
        const textarea = document.getElementById('annonce-message');
        const pos = textarea.selectionStart;
        const tag = `[IMAGE_${index + 1}]`;
        textarea.value = textarea.value.substring(0, pos) + tag + textarea.value.substring(pos);
        textarea.focus();
        updateAnnoncePreview();
        showToast(`‚úÖ [IMAGE_${index + 1}] ins√©r√©`, 'success');
      };
      wrapper.appendChild(insertBtn);
      
      preview.appendChild(wrapper);
    });
    
    // Event pour changer la miniature
    preview.querySelectorAll('input[name="annonce-thumbnail-select"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const idx = parseInt(radio.value);
        if (thumbnailField && medias[idx]) {
          thumbnailField.value = medias[idx];
          updateMediasPreview(medias); // Refresh pour mettre √† jour le style
        }
      });
    });
    
    // Event pour supprimer un m√©dia
    preview.querySelectorAll('.remove-media').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.getAttribute('data-index'));
        medias.splice(idx, 1);
        document.getElementById('annonce-medias').value = JSON.stringify(medias);
        // Si on supprime la miniature actuelle, r√©initialiser
        if (thumbnailField && thumbnailField.value === medias[idx]) {
          thumbnailField.value = medias.length > 0 ? medias[0] : '';
        }
        updateMediasPreview(medias);
        updateMediasCount();
      });
    });
    
    updateMediasCount();
  }
  
  function updateMediasCount(){
    try {
      const medias = JSON.parse(document.getElementById('annonce-medias').value || '[]');
      document.getElementById('annonce-medias-count').textContent = `${medias.length} m√©dia(s)`;
    } catch(e){
      document.getElementById('annonce-medias-count').textContent = '0 m√©dia(s)';
    }
  }
  
  function updateProduitsDisplay(){
    const container = document.getElementById('annonce-produits-list');
    container.innerHTML = '';
    
    if(selectedAnnonceProduits.length === 0){
      container.innerHTML = '<div style="text-align:center;color:#8ef58e;opacity:0.6;font-size:0.85em;">Aucun produit li√©</div>';
      return;
    }
    
    selectedAnnonceProduits.forEach((produitId, index) => {
      const article = (articlesData || []).find(a => a.id === produitId);
      if(!article) return;
      
      const produitCard = document.createElement('div');
      produitCard.style.cssText = `
        display:flex;
        align-items:center;
        gap:10px;
        background:#240038;
        padding:8px;
        border-radius:8px;
        border:1px solid #6a0572;
      `;
      
      const thumbnail = article.thumbnail || (article.medias && article.medias[0]?.path) || '';
      let imgHtml = '';
      if(thumbnail){
        if(/\.(mp4|webm|mov)$/i.test(thumbnail)){
          imgHtml = `<video src="${thumbnail}" muted loop style="width:50px;height:50px;object-fit:cover;border-radius:6px;"></video>`;
        } else {
          imgHtml = `<img src="${thumbnail}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;"/>`;
        }
      } else {
        imgHtml = `<div style="width:50px;height:50px;border:2px dashed #6a0572;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:0.6em;opacity:0.5;">üì¶</div>`;
      }
      
      produitCard.innerHTML = `
        ${imgHtml}
        <div style="flex:1;display:flex;flex-direction:column;gap:4px;">
          <div style="font-size:0.85em;font-weight:600;color:#fff;">${article.nom || article.id}</div>
          <div style="font-size:0.75em;color:#8ef58e;">${article.prix ? article.prix + '‚Ç¨' : ''}</div>
        </div>
        <button class="remove-produit" data-index="${index}" style="background:#e74c3c;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:0.75em;font-weight:600;">‚úï</button>
      `;
      
      container.appendChild(produitCard);
    });
    
    // Event pour supprimer un produit
    container.querySelectorAll('.remove-produit').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.getAttribute('data-index'));
        selectedAnnonceProduits.splice(idx, 1);
        document.getElementById('annonce-produits').value = JSON.stringify(selectedAnnonceProduits);
        updateProduitsDisplay();
      });
    });
  }
  
  // ==================== √âDITEUR WYSIWYG ANNONCES ====================
  
  const annonceEditor = document.getElementById('annonce-editor');
  
  if (annonceEditor) {
    // Placeholder personnalis√©
    annonceEditor.addEventListener('focus', function() {
      if (this.innerHTML === '' || this.innerHTML === '<br>') {
        this.innerHTML = '';
      }
    });
    
    annonceEditor.addEventListener('blur', function() {
      if (this.innerHTML === '' || this.innerHTML === '<br>') {
        this.setAttribute('placeholder', '√âcrivez votre message ici... S√©lectionnez du texte pour le formater');
      }
    });
    
    // Fonctions de formatage direct
    const applyFormat = (command, value = null) => {
      annonceEditor.focus();
      document.execCommand(command, false, value);
    };
    
    // Gras
    document.getElementById('annonce-bold-btn')?.addEventListener('click', () => applyFormat('bold'));
    
    // Italique
    document.getElementById('annonce-italic-btn')?.addEventListener('click', () => applyFormat('italic'));
    
    // Soulign√©
    document.getElementById('annonce-underline-btn')?.addEventListener('click', () => applyFormat('underline'));
    
    // Couleur de texte
    document.getElementById('annonce-text-color')?.addEventListener('change', (e) => {
      applyFormat('foreColor', e.target.value);
    });
    
    // Surlign√©
    document.getElementById('annonce-highlight-btn')?.addEventListener('click', () => {
      const color = document.getElementById('annonce-highlight-color').value;
      applyFormat('backColor', color);
    });
    
    // Taille de police
    document.getElementById('annonce-font-size')?.addEventListener('change', (e) => {
      applyFormat('fontSize', e.target.value);
    });
    
    // Alignement de texte
    document.getElementById('annonce-text-align')?.addEventListener('change', (e) => {
      const align = e.target.value;
      if (align === 'left') applyFormat('justifyLeft');
      else if (align === 'center') applyFormat('justifyCenter');
      else if (align === 'right') applyFormat('justifyRight');
    });
    
    // Insertion d'image/vid√©o
    document.getElementById('annonce-insert-image-btn')?.addEventListener('click', async () => {
      // Ouvrir s√©lecteur GoFile
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:10003;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = `
        <div style="background:linear-gradient(135deg, #2e003e, #6a0572);border:2px solid #ffd369;border-radius:16px;padding:25px;max-width:900px;width:95%;max-height:85vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.5);">
          <h3 style="color:#ffd369;margin-bottom:20px;font-size:1.4em;">üì∑ S√©lectionner un m√©dia √† ins√©rer</h3>
          <input type="text" id="media-search" placeholder="üîç Rechercher..." style="width:100%;padding:12px;margin-bottom:15px;border-radius:8px;border:2px solid #ffd369;background:#1a0033;color:#fff;font-size:1em;">
          <div style="display:flex;gap:10px;margin-bottom:15px;">
            <button class="media-filter active" data-filter="all" style="padding:8px 16px;border:2px solid #ffd369;background:#ffd369;color:#2e003e;border-radius:20px;cursor:pointer;font-weight:600;">Tous</button>
            <button class="media-filter" data-filter="image" style="padding:8px 16px;border:2px solid #6a0572;background:#6a0572;color:#fff;border-radius:20px;cursor:pointer;">Images</button>
            <button class="media-filter" data-filter="video" style="padding:8px 16px;border:2px solid #6a0572;background:#6a0572;color:#fff;border-radius:20px;cursor:pointer;">Vid√©os</button>
          </div>
          <div id="media-gallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;max-height:450px;overflow-y:auto;padding:10px;"></div>
          <button id="close-media-modal" style="margin-top:20px;width:100%;background:#6c757d;color:#fff;border:none;padding:12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:1em;">Annuler</button>
        </div>
      `;
      document.body.appendChild(modal);
      
      let currentFilter = 'all';
      let searchTerm = '';
      let gofileFiles = [];
      
      // Charger les fichiers GoFile
      try {
        const res = await fetch('/images');
        if (res.ok) {
          gofileFiles = (await res.json()).filter(f => f.type !== 'folder');
        }
      } catch(e) {
        console.error('Erreur chargement GoFile:', e);
      }
      
      function renderGallery() {
        const gallery = document.getElementById('media-gallery');
        let filtered = gofileFiles.filter(f => {
          const matchSearch = f.name.toLowerCase().includes(searchTerm.toLowerCase());
          const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name);
          const isVideo = /\.(mp4|webm|mov)$/i.test(f.name);
          
          if (currentFilter === 'image') return matchSearch && isImage;
          if (currentFilter === 'video') return matchSearch && isVideo;
          return matchSearch && (isImage || isVideo);
        });
        
        if (filtered.length === 0) {
          gallery.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#fff;padding:40px;">Aucun m√©dia trouv√©</div>';
          return;
        }
        
        gallery.innerHTML = filtered.map(f => {
          const url = `/media/${f.id}?name=${encodeURIComponent(f.name)}&server=${f.server || 'store1'}`;
          const isVideo = /\.(mp4|webm|mov)$/i.test(f.name);
          return `
            <div class="media-item" data-url="${url}" data-is-video="${isVideo}" style="cursor:pointer;background:#3a0066;border:2px solid #ffd369;border-radius:10px;padding:8px;text-align:center;transition:all 0.3s;">
              ${isVideo ? 
                `<video src="${url}" muted loop style="width:100%;height:100px;object-fit:cover;border-radius:8px;"></video>` :
                `<img src="${url}" style="width:100%;height:100px;object-fit:cover;border-radius:8px;">`
              }
              <div style="color:#fff;font-size:0.7em;margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${f.name}">${f.name}</div>
            </div>
          `;
        }).join('');
        
        // Events
        document.querySelectorAll('.media-item').forEach(item => {
          item.addEventListener('click', () => {
            const url = item.dataset.url;
            const isVideo = item.dataset.isVideo === 'true';
            
            annonceEditor.focus();
            const mediaElement = isVideo ?
              `<video src="${url}" controls style="max-width:100%;height:auto;border-radius:8px;margin:10px 0;"></video>` :
              `<img src="${url}" style="max-width:100%;height:auto;border-radius:8px;margin:10px 0;">`;
            
            document.execCommand('insertHTML', false, mediaElement + '<br>');
            modal.remove();
            showToast('‚úÖ M√©dia ins√©r√©', 'success');
          });
          
          item.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
            this.style.borderColor = '#8ef58e';
          });
          
          item.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.borderColor = '#ffd369';
          });
        });
      }
      
      document.getElementById('media-search').oninput = (e) => {
        searchTerm = e.target.value;
        renderGallery();
      };
      
      document.querySelectorAll('.media-filter').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.media-filter').forEach(b => {
            b.style.background = '#6a0572';
            b.style.color = '#fff';
            b.classList.remove('active');
          });
          this.style.background = '#ffd369';
          this.style.color = '#2e003e';
          this.classList.add('active');
          currentFilter = this.dataset.filter;
          renderGallery();
        });
      });
      
      document.getElementById('close-media-modal').onclick = () => modal.remove();
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      
      renderGallery();
    });
    
    // Lien produit
    document.getElementById('annonce-link-product-btn')?.addEventListener('click', async () => {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('‚ö†Ô∏è S√©lectionnez du texte pour cr√©er un lien produit', 'warning');
        return;
      }
      
      // S'assurer que les articles sont charg√©s
      if (!articlesData || articlesData.length === 0) {
        await loadArticles();
      }
      
      // Modal s√©lection produit
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10003;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = `
        <div style="background:linear-gradient(135deg, #2e003e, #6a0572);border:2px solid #8ef58e;border-radius:16px;padding:25px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.5);">
          <h3 style="color:#8ef58e;margin-bottom:20px;font-size:1.4em;">üß® S√©lectionner un produit √† lier</h3>
          <input type="text" id="link-product-search" placeholder="üîç Rechercher un produit..." style="width:100%;padding:12px;margin-bottom:15px;border-radius:8px;border:2px solid #8ef58e;background:#1a0033;color:#fff;font-size:1em;">
          <div id="link-product-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;max-height:450px;overflow-y:auto;padding:10px;"></div>
          <button id="close-product-link-modal" style="margin-top:20px;width:100%;background:#6c757d;color:#fff;border:none;padding:12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:1em;">Annuler</button>
        </div>
      `;
      document.body.appendChild(modal);
      
      const savedRange = selection.getRangeAt(0).cloneRange();
      
      function renderProducts(filter = '') {
        const list = document.getElementById('link-product-list');
        if (!articlesData || articlesData.length === 0) {
          list.innerHTML = '<div style="color:#fff;text-align:center;padding:30px;grid-column:1/-1;">Aucun produit disponible</div>';
          return;
        }
        const filtered = articlesData.filter(a => a.nom.toLowerCase().includes(filter.toLowerCase()));
        list.innerHTML = filtered.map(art => `
          <div class="product-link-item" data-product-id="${art.id}" data-product-name="${art.nom}" style="cursor:pointer;background:#3a0066;border:2px solid #8ef58e;border-radius:10px;padding:10px;text-align:center;transition:all 0.3s;box-shadow:0 2px 6px rgba(0,0,0,0.3);">
            ${art.thumbnail ? `<img src="${art.thumbnail}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;margin-bottom:8px;">` : '<div style="width:100%;height:80px;background:#1a0033;border-radius:8px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;color:#8ef58e;">üì¶</div>'}
            <div style="color:#fff;font-size:0.85em;font-weight:600;">${art.nom}</div>
            <div style="color:#8ef58e;font-size:0.75em;margin-top:4px;">${art.prix ? art.prix + '‚Ç¨' : ''}</div>
          </div>
        `).join('');
        
        // Events sur les produits
        document.querySelectorAll('.product-link-item').forEach(item => {
          item.addEventListener('click', () => {
            const productId = item.dataset.productId;
            const productName = item.dataset.productName;
            
            // Restaurer la s√©lection et cr√©er le lien
            selection.removeAllRanges();
            selection.addRange(savedRange);
            
            const span = document.createElement('span');
            span.className = 'annonce-product-link';
            span.dataset.productId = productId;
            span.style.cssText = 'color:#8ef58e;background:rgba(142,245,142,0.15);cursor:pointer;padding:2px 4px;border-radius:3px;';
            span.innerHTML = 'üß® ' + savedRange.toString();
            
            savedRange.deleteContents();
            savedRange.insertNode(span);
            
            modal.remove();
            annonceEditor.focus();
            showToast('‚úÖ Lien produit cr√©√©', 'success');
          });
          
          item.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
            this.style.borderColor = '#ffd369';
          });
          
          item.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.borderColor = '#8ef58e';
          });
        });
      }
      
      document.getElementById('link-product-search').oninput = (e) => renderProducts(e.target.value);
      document.getElementById('close-product-link-modal').onclick = () => modal.remove();
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      
      renderProducts();
    });
    
    // Lien URL
    document.getElementById('annonce-link-url-btn')?.addEventListener('click', () => {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('‚ö†Ô∏è S√©lectionnez du texte pour cr√©er un lien', 'warning');
        return;
      }
      
      const savedRange = selection.getRangeAt(0).cloneRange();
      const selectedText = savedRange.toString();
      
      // Modal pour l'URL
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10003;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = `
        <div style="background:linear-gradient(135deg, #2e003e, #6a0572);border:2px solid #17a2b8;border-radius:16px;padding:30px;max-width:500px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.5);">
          <h3 style="color:#17a2b8;margin-bottom:20px;font-size:1.3em;">üîó Cr√©er un lien</h3>
          <label style="display:block;color:#fff;margin-bottom:8px;font-weight:600;">URL du lien :</label>
          <input type="url" id="link-url-input" placeholder="https://example.com" style="width:100%;padding:12px;margin-bottom:20px;border-radius:8px;border:2px solid #17a2b8;background:#1a0033;color:#fff;font-size:1em;">
          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button id="cancel-link-url" style="background:#6c757d;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">Annuler</button>
            <button id="confirm-link-url" style="background:#17a2b8;color:#fff;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:700;">‚úì Cr√©er</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      const input = document.getElementById('link-url-input');
      input.focus();
      
      document.getElementById('cancel-link-url').onclick = () => modal.remove();
      document.getElementById('confirm-link-url').onclick = () => {
        const url = input.value.trim();
        if (!url || !url.startsWith('http')) {
          showToast('‚ùå URL invalide', 'error');
          return;
        }
        
        selection.removeAllRanges();
        selection.addRange(savedRange);
        
        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.style.cssText = 'color:#ffd369;text-decoration:underline;';
        a.innerHTML = selectedText;
        
        savedRange.deleteContents();
        savedRange.insertNode(a);
        
        modal.remove();
        annonceEditor.focus();
        showToast('‚úÖ Lien cr√©√©', 'success');
      };
      
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') document.getElementById('confirm-link-url').click();
      });
      
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    });
    
    // Bouton nettoyer le formatage
    document.getElementById('annonce-remove-format-btn')?.addEventListener('click', () => {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showToast('‚ö†Ô∏è S√©lectionnez du texte pour enlever le formatage', 'warning');
        return;
      }
      
      const range = selection.getRangeAt(0);
      const selectedText = range.toString();
      
      // Remplacer par du texte brut
      const textNode = document.createTextNode(selectedText);
      range.deleteContents();
      range.insertNode(textNode);
      
      annonceEditor.focus();
      showToast('üßπ Formatage supprim√©', 'success');
    });
  }
  
  // Fonction pour mettre √† jour l'aper√ßu des m√©dias des annonces
  window.updateAnnonceMediasPreview = function(medias) {
    const preview = document.getElementById('annonce-medias-preview');
    const countElem = document.getElementById('annonce-medias-count');
    
    if (!preview) return;
    
    preview.innerHTML = '';
    
    if (!medias || medias.length === 0) {
      preview.innerHTML = '<div style="text-align:center;color:#8ef58e;opacity:0.5;padding:20px;">Aucun m√©dia</div>';
      if (countElem) countElem.textContent = '0 m√©dia(s)';
      return;
    }
    
    if (countElem) countElem.textContent = `${medias.length} m√©dia(s)`;
    
    medias.forEach((path, index) => {
      const wrapper = document.createElement('div');
      wrapper.style.cssText = 'position:relative;display:flex;flex-direction:column;gap:6px;';
      
      const mediaPreview = document.createElement('div');
      mediaPreview.style.cssText = 'width:120px;height:120px;position:relative;border-radius:8px;overflow:hidden;border:2px solid #8ef58e;';
      
      if (/\.(mp4|webm|mov)$/i.test(path)) {
        mediaPreview.innerHTML = `
          <video src="${path}" muted loop autoplay style="width:100%;height:100%;object-fit:cover;"></video>
          <button class="remove-annonce-media" data-index="${index}" style="position:absolute;top:4px;right:4px;background:#e74c3c;color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:0.9em;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,0.4);">√ó</button>
        `;
      } else {
        mediaPreview.innerHTML = `
          <img src="${path}" style="width:100%;height:100%;object-fit:cover;"/>
          <button class="remove-annonce-media" data-index="${index}" style="position:absolute;top:4px;right:4px;background:#e74c3c;color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:0.9em;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,0.4);">√ó</button>
        `;
      }
      
      wrapper.appendChild(mediaPreview);
      
      // Bouton pour ins√©rer dans le texte
      const insertBtn = document.createElement('button');
      insertBtn.type = 'button';
      insertBtn.textContent = `üìç ${index + 1}`;
      insertBtn.title = `Ins√©rer [IMAGE_${index + 1}] dans le texte`;
      insertBtn.style.cssText = 'background:#8ef58e;color:#240038;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:0.8em;font-weight:700;box-shadow:0 2px 4px rgba(0,0,0,0.2);';
      insertBtn.onclick = () => {
        const textarea = document.getElementById('annonce-message');
        if (!textarea) return;
        const pos = textarea.selectionStart;
        const tag = `[IMAGE_${index + 1}]`;
        const editor = document.getElementById('annonce-editor');
        if (editor) {
          editor.focus();
          const tag = `[IMAGE_${index + 1}]`;
          document.execCommand('insertHTML', false, `<span style="display:inline-block;background:rgba(255,211,105,0.2);padding:4px 8px;border-radius:4px;font-size:0.85em;color:#ffd369;margin:0 4px;" data-image-marker="${index + 1}">üì∑ Image ${index + 1}</span>&nbsp;`);
        }
        showToast(`‚úÖ Marqueur Image ${index + 1} ins√©r√©`, 'success');
      };
      wrapper.appendChild(insertBtn);
      
      preview.appendChild(wrapper);
    });
    
    // Gestion de la suppression
    preview.querySelectorAll('.remove-annonce-media').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.dataset.index);
        medias.splice(idx, 1);
        document.getElementById('annonce-medias').value = JSON.stringify(medias);
        updateAnnonceMediasPreview(medias);
        showToast('üóëÔ∏è M√©dia retir√©', 'info');
      });
    });
  };
  
  // ==================== FIN √âDITEUR RICHE ANNONCES ====================

  const annonceForm = document.getElementById('annonce-form');
  if(annonceForm){
    annonceForm.addEventListener('submit', async e => {
      e.preventDefault();
      
      const idEdit = document.getElementById('annonce-id-edit').value;
      const titre = document.getElementById('annonce-titre').value.trim();
      const editor = document.getElementById('annonce-editor');
      const message = editor ? editor.innerHTML.trim() : '';
      
      if(!titre || !message || message === '<br>'){
        showToast('‚ùå Titre et message requis', 'error');
        return;
      }
      
      let medias = [];
      try {
        medias = JSON.parse(document.getElementById('annonce-medias').value || '[]');
      } catch(e){}
      
      const thumbnail = document.getElementById('annonce-thumbnail').value || (medias.length > 0 ? medias[0] : '');
      
      const payload = {
        titre,
        message,
        produits: selectedAnnonceProduits,
        lien: null,
        medias,
        thumbnail
      };
      
      try {
        const endpoint = idEdit ? `/api/annonces/${idEdit}` : '/api/annonces';
        const method = idEdit ? 'PUT' : 'POST';
        
        const res = await fetch(endpoint, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        
        showToast(idEdit ? '‚úÖ Annonce mise √† jour' : '‚úÖ Annonce cr√©√©e', 'success');
        resetAnnonceForm();
        loadAnnonces();
      } catch(err){
        console.error('Erreur sauvegarde annonce', err);
        showToast('‚ùå Erreur lors de la sauvegarde', 'error');
      }
    });
  }
  
  // Bouton Annuler
  document.getElementById('annonce-cancel')?.addEventListener('click', () => {
    resetAnnonceForm();
  });
  
  // Bouton Ajouter produit
  document.getElementById('annonce-add-produit')?.addEventListener('click', () => {
    showProduitSelector();
  });
  
  // Bouton S√©lectionner m√©dias
  document.getElementById('annonce-add-medias')?.addEventListener('click', () => {
    openGofileSelectorForAnnonces();
  });
  
  // Modal s√©lection de produit
  async function showProduitSelector(){
    // S'assurer que les articles sont charg√©s
    if (!articlesData || articlesData.length === 0) {
      console.log('[PRODUIT SELECTOR] Chargement articles...');
      await loadArticles();
    }
    
    let modal = document.getElementById('annonce-produit-selector-modal');
    if(!modal){
      modal = document.createElement('div');
      modal.id = 'annonce-produit-selector-modal';
      modal.className = 'modal';
      modal.style.cssText = 'display:flex;align-items:center;justify-content:center;z-index:10001;';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:700px;width:90%;max-height:80vh;background:linear-gradient(135deg, #2e003e, #6a0572);border-radius:16px;padding:0;overflow:hidden;">
          <div style="background:linear-gradient(135deg, #ffd369, #ffb347);padding:20px;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;color:#2e003e;font-size:1.3em;">üß® S√©lectionner un produit</h3>
            <button id="close-produit-selector" style="background:none;border:none;color:#2e003e;font-size:2em;cursor:pointer;width:40px;height:40px;">√ó</button>
          </div>
          <div style="padding:20px;">
            <input type="text" id="produit-search" placeholder="üîç Rechercher un article..." style="width:100%;padding:12px;border-radius:8px;border:2px solid #ffd369;background:rgba(255,255,255,0.1);color:#fff;font-size:1em;margin-bottom:15px;">
            <div id="produit-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;max-height:50vh;overflow-y:auto;"></div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      const closeModal = () => {
        modal.classList.remove('show');
        setTimeout(() => modal.remove(), 300);
      };
      
      document.getElementById('close-produit-selector').addEventListener('click', closeModal);
      
      modal.addEventListener('click', (e) => {
        if(e.target === modal) closeModal();
      });
    }
    
    modal.classList.add('show');
    renderProduitList();
    
    const searchInput = document.getElementById('produit-search');
    searchInput.value = '';
    searchInput.focus();
    searchInput.addEventListener('input', () => renderProduitList(searchInput.value));
  }
  
  function renderProduitList(filter = ''){
    const list = document.getElementById('produit-list');
    if(!list) return;
    
    list.innerHTML = '';
    const articles = (articlesData || []).filter(a => 
      !selectedAnnonceProduits.includes(a.id) &&
      (a.nom || a.id || '').toLowerCase().includes(filter.toLowerCase())
    );
    
    if(articles.length === 0){
      list.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#8ef58e;opacity:0.6;padding:30px;">Aucun article trouv√©</div>';
      return;
    }
    
    articles.slice(0, 50).forEach(article => {
      const card = document.createElement('div');
      card.style.cssText = `
        background:#3a0066;
        border:2px solid #4b1a7f;
        border-radius:12px;
        padding:8px;
        cursor:pointer;
        display:flex;
        flex-direction:column;
        gap:8px;
        transition:all 0.3s;
      `;
      
      const thumbnail = article.thumbnail || (article.medias && article.medias[0]?.path) || '';
      let imgHtml = '';
      if(thumbnail){
        if(/\.(mp4|webm|mov)$/i.test(thumbnail)){
          imgHtml = `<video src="${thumbnail}" muted loop style="width:100%;height:80px;object-fit:cover;border-radius:8px;"></video>`;
        } else {
          imgHtml = `<img src="${thumbnail}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;"/>`;
        }
      } else {
        imgHtml = `<div style="width:100%;height:80px;border:2px dashed #6a0572;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.7em;opacity:0.5;">üì¶</div>`;
      }
      
      card.innerHTML = `
        ${imgHtml}
        <div style="font-size:0.75em;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff;">${article.nom || article.id}</div>
        <div style="font-size:0.7em;color:#8ef58e;">${article.prix ? article.prix + '‚Ç¨' : ''}</div>
      `;
      
      card.addEventListener('mouseenter', () => card.style.borderColor = '#8ef58e');
      card.addEventListener('mouseleave', () => card.style.borderColor = '#4b1a7f');
      
      // V√©rifier si le produit est d√©j√† s√©lectionn√©
      const isSelected = selectedAnnonceProduits.includes(article.id);
      if (isSelected) {
        card.style.opacity = '0.5';
        card.style.background = 'rgba(75,26,127,0.5)';
        card.style.cursor = 'not-allowed';
        card.style.borderColor = '#666';
      }
      
      card.addEventListener('click', () => {
        if (isSelected) {
          showToast(`‚ö†Ô∏è ${article.nom} d√©j√† ajout√©`, 'warning');
          return;
        }
        
        selectedAnnonceProduits.push(article.id);
        document.getElementById('annonce-produits').value = JSON.stringify(selectedAnnonceProduits);
        updateProduitsDisplay();
        
        // Griser la carte au lieu de fermer la modal
        card.style.opacity = '0.5';
        card.style.background = 'rgba(75,26,127,0.5)';
        card.style.cursor = 'not-allowed';
        card.style.borderColor = '#666';
        
        showToast(`‚úÖ ${article.nom} ajout√©`, 'success');
      });
      
      list.appendChild(card);
    });
  }

  // Toast feedback annonces
  function ensureAnnonceToastContainer(){
    let c = document.getElementById('annonce-toast-container');
    if(!c){
      c = document.createElement('div');
      c.id='annonce-toast-container';
      c.style.cssText='position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:99999;';
      document.body.appendChild(c);
    }
    return c;
  }
  function showAnnonceToast(msg,type='info'){
    const c = ensureAnnonceToastContainer();
    const t = document.createElement('div');
    const colors = { success:'#8ef58e', error:'#ff6b6b', info:'#ffd369' };
    t.style.cssText=`background:#240038;padding:12px 16px;border-radius:10px;font-size:.8em;min-width:200px;box-shadow:0 4px 12px #000a;border:1px solid ${colors[type]||'#ffd369'};color:${colors[type]||'#ffd369'};opacity:0;transform:translateY(-6px);transition:.3s;`;
    t.textContent = msg;
    c.appendChild(t);
    requestAnimationFrame(()=>{ t.style.opacity='1'; t.style.transform='translateY(0)'; });
    setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(-6px)'; setTimeout(()=> t.remove(),300); }, 3200);
  }

  // Gestion des m√©dias pour les arnaques
  let selectedMediasArnaque = [];

  document.getElementById('select-media-arnaque')?.addEventListener('click', function() {
    openFileExplorer('img/arnaques', function(selectedFiles) {
      selectedMediasArnaque = selectedFiles;
      updateMediaDisplayArnaque();
    });
  });

  function updateMediaDisplayArnaque() {
    const countSpan = document.getElementById('media-count-arnaque');
    const previewDiv = document.getElementById('media-preview-arnaque');
    const hiddenInput = document.getElementById('medias-arnaque');
    
    if (selectedMediasArnaque.length === 0) {
      countSpan.textContent = 'Aucun m√©dia s√©lectionn√©';
      previewDiv.innerHTML = '';
    } else {
      countSpan.textContent = `${selectedMediasArnaque.length} m√©dia(s) s√©lectionn√©(s)`;
      previewDiv.innerHTML = '';
      
      selectedMediasArnaque.forEach((media, index) => {
        const preview = document.createElement('div');
        preview.style.cssText = 'position:relative; display:inline-block; margin:4px;';
        
        if (media.endsWith('.mp4') || media.endsWith('.webm') || media.endsWith('.mov')) {
          preview.innerHTML = `
            <video src="${media}" style="width:60px; height:60px; object-fit:cover; border-radius:4px;" muted></video>
            <button type="button" onclick="removeMediaArnaque(${index})" style="position:absolute; top:-5px; right:-5px; background:#ff4757; color:white; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer; font-size:12px;">√ó</button>
          `;
        } else {
          preview.innerHTML = `
            <img src="${media}" style="width:60px; height:60px; object-fit:cover; border-radius:4px;" alt="Preview">
            <button type="button" onclick="removeMediaArnaque(${index})" style="position:absolute; top:-5px; right:-5px; background:#ff4757; color:white; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer; font-size:12px;">√ó</button>
          `;
        }
        
        previewDiv.appendChild(preview);
      });
    }
    
    hiddenInput.value = JSON.stringify(selectedMediasArnaque);
  }

  window.removeMediaArnaque = function(index) {
    selectedMediasArnaque.splice(index, 1);
    updateMediaDisplayArnaque();
  };

  // Validation du username pour emp√™cher les espaces
  document.addEventListener('DOMContentLoaded', function() {
    const usernameInput = document.getElementById('username-arnaque');
    if (usernameInput) {
      usernameInput.addEventListener('input', function(e) {
        // Remplacer les espaces par des underscores automatiquement
        if (e.target.value.includes(' ')) {
          e.target.value = e.target.value.replace(/\s+/g, '_');
          // Afficher un message temporaire
          const label = document.querySelector('label[for="username-arnaque"]');
          const originalText = label.textContent;
          label.textContent = 'Nom d\'utilisateur (espaces remplac√©s par _)';
          label.style.color = '#ff6b6b';
          setTimeout(() => {
            label.textContent = originalText;
            label.style.color = '';
          }, 2000);
        }
      });
    }
  });
  
  // Les fonctions loadCategories et renderCategoryTree sont d√©finies plus bas
  
  // fallback minimal function immediately available to buttons
  if (!window.showProductModal) {
    window.showProductModal = function(articleOrId){
      console.warn('showProductModal called before initialization', articleOrId);
    };
  }

  // Fonction pour formater le prix sans z√©ros inutiles
  function formatPrix(p) {
    if (typeof p === 'string') p = p.replace(',', '.');
    const n = Number(p);
    if (isNaN(n)) return '';
    // Affiche sans d√©cimales si c'est un entier, sinon garde les d√©cimales significatives
    return (Math.round(n * 100) % 100 === 0) ? String(n | 0) : n.toString();
  }

  // Charger les articles existants
  // Fonctions de chargement globales
  window.loadArticles = async function() {
    let articles = [];
    try {
      const ts = Date.now();
      const ordered = await fetch('/api/articles-ordered?ts='+ts, { cache: 'no-store' });
      if(!ordered.ok) throw new Error('endpoint /api/articles-ordered non OK');
      articles = await ordered.json();
      console.log('[ADMIN] Articles ordonn√©s charg√©s:', articles.length);
    } catch(e) {
      console.warn('[ADMIN] Fallback /articles.json ->', e.message);
      try {
        const fb = await fetch('/articles.json?ts='+Date.now(), { cache: 'no-store' });
        articles = await fb.json();
      } catch(e2) { console.error('Impossible de charger les articles', e2); }
    }
    articlesData = Array.isArray(articles) ? articles : [];
    const list = document.getElementById("articleList");
    list.innerHTML = '';
    articlesData.forEach((article, idx) => {
      const card = document.createElement('div');
      card.className = 'article-card';

      // Thumb
      const thumb = document.createElement('div');
      thumb.className = 'product-card';
      
      let hasMedia = false;
      // Utiliser la miniature, l'image, la vid√©o ou chercher dans les m√©dias
      if (article.thumbnail) {
        hasMedia = true;
        if (article.thumbnail.endsWith('.mp4') || article.thumbnail.endsWith('.webm')) {
          const vid = document.createElement('video');
          vid.src = article.thumbnail;
          vid.muted = true;
          vid.autoplay = true;
          vid.loop = true;
          thumb.appendChild(vid);
        } else {
          const img = document.createElement('img');
          img.src = article.thumbnail;
          img.alt = article.nom;
          thumb.appendChild(img);
        }
      } else if (article.image) {
        hasMedia = true;
        const img = document.createElement('img');
        img.src = article.image;
        img.alt = article.nom;
        thumb.appendChild(img);
      } else if (article.video) {
        hasMedia = true;
        const vid = document.createElement('video');
        vid.src = article.video;
        vid.muted = true;
        vid.autoplay = true;
        vid.loop = true;
        thumb.appendChild(vid);
      } else if (article.medias && article.medias.length > 0) {
        hasMedia = true;
        const media = article.medias[0];
        if (media.type === 'image') {
          const img = document.createElement('img');
          img.src = media.path;
          img.alt = article.nom;
          thumb.appendChild(img);
        } else {
          const vid = document.createElement('video');
          vid.src = media.path;
          vid.muted = true;
          vid.autoplay = true;
          vid.loop = true;
          thumb.appendChild(vid);
        }
      }
      
      // Ne pas ajouter la carte thumb si pas de m√©dia
      if (hasMedia) {
        card.appendChild(thumb);
      }

      // Info
      const info = document.createElement('div');
      info.className = 'article-info';
      info.innerHTML = `
        <strong>${article.nom}</strong> <span style="color:#8ef58e;">${formatPrix(article.prix)}‚Ç¨</span><br>
        <span style="font-size:0.95em;">${article.description || ''}</span><br>
        <span style="font-size:0.85em; color:#ffd369;">${article.categorie || ''}</span>
      `;
      card.appendChild(info);

      // Actions
      const actions = document.createElement('div');
      actions.className = 'article-actions';

      // Modifier
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Modifier';
      editBtn.onclick = () => {
        editArticle(article, idx);
        // Remonter en haut de la page
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
      actions.appendChild(editBtn);

      // Supprimer
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Supprimer';
      delBtn.onclick = async () => {
        if (confirm("Supprimer cet article ?")) {
          await fetch(`/api/articles/${article.id}`, { method: "DELETE" });
          loadArticles();
        }
      };
      actions.appendChild(delBtn);

      // Aper√ßu
      const previewBtn = document.createElement('button');
      previewBtn.textContent = 'Aper√ßu';
      // pour la d√©l√©gation/compatibilit√©, on ajoute une classe et un data-article
      previewBtn.className = 'preview-btn';
      try {
        previewBtn.setAttribute('data-article', JSON.stringify(article));
      } catch(e) {
        // si JSON √©choue (circular), on attache l'id pour fallback
        if (article.id) previewBtn.setAttribute('data-preview-id', article.id);
      }
      // appel direct s√©curis√© (fonction expos√©e sur window)
      previewBtn.onclick = () => (window.showProductModal ? window.showProductModal(article) : null);
      actions.appendChild(previewBtn);

      card.appendChild(actions);
      list.appendChild(card);
    });
  }
  loadArticles();

  // Fonctions pour les Offres
  window.loadOffres = async function() {
    try {
      const res = await fetch("/offres.json");
      const offres = await res.json();
      
      // Stocker les donn√©es globalement pour l'ordre
      offresData = offres || [];
      
      const list = document.getElementById("offresList");
      list.innerHTML = '';
      offres.forEach((offre, idx) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        card.innerHTML = `
          <div class="article-card">
            <div class="product-card">
              <strong>${offre.nom}</strong> <span style="color:#8ef58e;">${offre.prix}‚Ç¨</span><br>
              <span style="font-size:0.95em;">${offre.description || 'Aucune description'}</span><br>
              <span style="font-size:0.85em; color:#ffd369;">${offre.categorie || 'Non d√©finie'}</span>
            </div>
            <div class="article-actions">
              <button onclick="editOffre(${JSON.stringify(offre).replace(/"/g, '&quot;')}, ${idx})">Modifier</button>
              <button onclick="deleteOffre(${idx})" style="background:#e74c3c;">Supprimer</button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement offres:', e);
    }
  }

  // Fonctions pour les Arnaques  
  window.loadArnaquesPending = async function() {
    try {
      const res = await fetch("/api/arnaques-pending");
      const arnaquesPending = await res.json();
      
      const list = document.getElementById("arnaquesPendingList");
      list.innerHTML = '';
      
      if (!arnaquesPending || arnaquesPending.length === 0) {
        list.innerHTML = '<div style="text-align:center;opacity:0.7;padding:40px;color:#ffd369;">Aucun signalement en attente</div>';
        return;
      }
      
      arnaquesPending.forEach((arnaque, idx) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        
        // Afficher le vrai nom pour l'admin + statut anonyme
        const vraiNom = arnaque.denonceurReel || arnaque.denonceur || 'Non sp√©cifi√©';
        const denonceurDisplay = arnaque.isAnonymous 
          ? `<span style="color:#8ef58e;">${vraiNom}</span> <span style="color:#ff6b6b;font-weight:600;font-size:0.85em;background:rgba(255,107,107,0.2);padding:2px 8px;border-radius:4px;">üîí ANONYME PUBLIQUEMENT</span>` 
          : `<span style="color:#8ef58e;">${vraiNom}</span>`;
        
        // G√©n√©rer aper√ßu des m√©dias GoFile
        let mediasPreview = '';
        if (arnaque.preuves && arnaque.preuves.length > 0) {
          mediasPreview = `
            <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
              <div style="color: #8ef58e; margin-bottom: 8px; font-weight: 600;">üì∑ ${arnaque.preuves.length} preuve(s) :</div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap; max-height: 200px; overflow-y: auto;">
                ${arnaque.preuves.map((url, i) => {
                  const isVideo = /\.(mp4|webm|mov|avi)$/i.test(url);
                  if (isVideo) {
                    return `<div style="position:relative;width:100px;height:100px;border-radius:8px;overflow:hidden;border:2px solid #ffd369;">
                      <video src="${url}" style="width:100%;height:100%;object-fit:cover;" muted></video>
                      <div style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.3);color:#fff;font-size:2em;">‚ñ∂</div>
                    </div>`;
                  } else {
                    return `<img src="${url}" style="width:100px;height:100px;object-fit:cover;border-radius:8px;border:2px solid #ffd369;cursor:pointer;" onclick="window.open('${url}', '_blank')" alt="Preuve ${i+1}">`;
                  }
                }).join('')}
              </div>
            </div>
          `;
        }
        
        card.innerHTML = `
          <div style="background: rgba(255, 211, 105, 0.05); border: 2px solid #ffd369; padding: 15px; border-radius: 12px;">
            <div style="margin-bottom: 15px;">
              <div style="font-size: 1.1em; font-weight: 700; color: #ffd369; margin-bottom: 8px;">
                ${arnaque.nom} <span style="font-size:0.85em;opacity:0.9;">(@${arnaque.arnaqueurId})</span>
              </div>
              <div style="font-size: 0.85em; margin-bottom: 4px;">
                <span style="color: #8ef58e;">Signal√© par:</span> ${denonceurDisplay}
              </div>
              <div style="font-size: 0.85em; margin-bottom: 4px;">
                <span style="color: #8ef58e;">Date:</span> ${new Date(arnaque.date).toLocaleDateString('fr-FR')}
              </div>
              <div style="font-size: 0.9em; margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                <strong style="color: #ffd369;">Technique:</strong><br>
                ${arnaque.technique}
              </div>
              ${arnaque.produits && arnaque.produits.length > 0 ? `
                <div style="font-size: 0.85em; margin-top: 8px;">
                  <span style="color: #8ef58e;">Produits:</span> ${arnaque.produits.map(p => p.nom).join(', ')}
                </div>
              ` : ''}
              ${mediasPreview}
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="approveArnaqueFromPending(${idx})" style="flex: 1; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                ‚úÖ Approuver et publier
              </button>
              <button onclick="editPendingArnaque(${idx})" style="flex: 1; background: linear-gradient(135deg, #ff9800, #ffd369); color: #1a0b2e; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                ‚úèÔ∏è Modifier avant publication
              </button>
              <button onclick="deletePendingArnaque(${idx})" style="background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                üóëÔ∏è Rejeter
              </button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement arnaques en attente:', e);
    }
  }

  window.loadArnaques = async function() {
    try {
      const res = await fetch("/arnaques.json");
      const arnaques = await res.json();
      
      // Stocker les donn√©es globalement pour l'ordre
      arnaquesData = arnaques || [];
      
      const list = document.getElementById("arnaquesList");
      list.innerHTML = '';
      arnaques.forEach((arnaque, idx) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        card.innerHTML = `
          <div class="article-card">
            <div class="product-card">
              <strong>${arnaque.nom || arnaque.username}</strong> 
              ${arnaque.username && arnaque.nom ? `<span style="color:#8ef58e;font-size:0.9em;"> (@${arnaque.username})</span>` : ''} 
              <span style="color:#ff6b6b;">ARNAQUEUR</span><br>
              <span style="font-size:0.95em;">${arnaque.techniques || 'Techniques non sp√©cifi√©es'}</span><br>
              <span style="font-size:0.85em; color:#ffd369;">${arnaque.reseaux || 'R√©seaux non sp√©cifi√©s'}</span>
            </div>
            <div class="article-actions">
              <button onclick="editArnaque(${JSON.stringify(arnaque).replace(/"/g, '&quot;')}, ${idx})">Modifier</button>
              <button onclick="archiveArnaque(${idx})" style="background:#ff9800;">üì¶ Archiver</button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement arnaques:', e);
    }
  }

  // Fonctions pour les Preuves (globale)
  window.loadPreuves = async function() {
    try {
      const res = await fetch("/api/preuves");
      const preuves = await res.json();
      const list = document.getElementById("preuvesList");
      list.innerHTML = '';
      preuves.forEach((preuve, idx) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        
        // Afficher le vrai nom pour l'admin, m√™me si anonyme
        const displayName = preuve.isAnonymous 
          ? `${preuve.realName} <span style="background:#ff6b6b;padding:2px 6px;border-radius:4px;font-size:0.75em;margin-left:6px;">ANONYME</span>`
          : preuve.realName || preuve.client || 'Client';
        
        card.innerHTML = `
          <div class="article-card preuve-clickable" style="cursor: pointer;">
            <div class="product-card">
              <strong>${preuve.titre || 'Sans titre'}</strong> <span style="color:#8ef58e;">‚úÖ V√âRIFI√â</span> <span style="color:#ffd369;">${'‚òÖ'.repeat(preuve.rating || 5)}</span><br>
              <span style="font-size:0.95em;">${preuve.commentaire || preuve.description || ''}</span><br>
              <span style="font-size:0.85em; color:#ffd369;">${displayName} - ${new Date(preuve.dateSubmission).toLocaleString('fr-FR')}</span>
              ${preuve.produit ? `<br><span style="font-size:0.8em; color:#8ef58e;">üì¶ ${preuve.produit}</span>` : ''}
              ${preuve.medias && preuve.medias.length > 0 ? `<br><span style="font-size:0.8em; color:#8ef58e;">üì∑ ${preuve.medias.length} m√©dia(s)</span>` : ''}
            </div>
            <div class="article-actions" onclick="event.stopPropagation()">
              <button onclick="archiverPreuve(${idx})" style="background:#ff6b6b;">Archiver</button>
            </div>
          </div>
        `;
        
        // Ajouter le gestionnaire de clic sur la card pour ouvrir la modal
        card.addEventListener('click', () => {
          const normalized = {
            username: preuve.realName || preuve.client || preuve.username || 'Anonyme',
            client: preuve.client,
            realName: preuve.realName,
            isAnonymous: preuve.isAnonymous || false,
            date: preuve.date || (preuve.dateSubmission ? new Date(preuve.dateSubmission).toLocaleDateString('fr-FR') : ''),
            titre: preuve.titre || preuve.title || '',
            commentaire: preuve.commentaire || preuve.description || preuve.text || '',
            rating: preuve.rating || preuve.note || 5,
            verified: true,
            produit: preuve.produit || '',
            medias: (preuve.medias && preuve.medias.length)
              ? preuve.medias.map(m => ({ type: m.type || (m.path && /\.(mp4|webm|mov)$/i.test(m.path) ? 'video' : 'image'), src: m.path || m }))
              : (Array.isArray(preuve.images) ? preuve.images.map(p => ({ type: /\.(mp4|webm|mov)$/i.test(p) ? 'video' : 'image', src: p })) : [])
          };
          showReviewModal(normalized);
        });
        
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement preuves:', e);
    }
  }

  // ---- Messages avis (admin) ----
  async function loadMessagesPreuve(){
    try {
      const r = await fetch('/api/messages-preuve');
      const data = await r.json();
      renderMessagesPreuveList(data);
    } catch(e){ console.error('Erreur chargement messages-preuve', e); }
  }
  function renderMessagesPreuveList(list){
    const container = document.getElementById('messages-preuve-list');
    if(!container) return;
    container.innerHTML = '';
    if(!list || !list.length){
      container.innerHTML = '<div style="grid-column:1/-1;text-align:center;opacity:.7;padding:20px;">Aucun message</div>';
      return;
    }
    list.forEach(msg => {
      const card = document.createElement('div');
      card.style.cssText='background:#2e004f;border:1px solid #4b1a7f;padding:10px;border-radius:10px;position:relative;display:flex;flex-direction:column;gap:6px;';
      card.innerHTML = `
        <div style="font-size:.7em;color:#ffd369;display:flex;align-items:center;gap:4px;">üí¨ Messages avis</div>
        ${msg.titre?`<div style=\"font-weight:600;font-size:.85em;\">${msg.titre}</div>`:''}
        <div style="font-size:.75em;line-height:1.3;white-space:pre-wrap;">${(msg.message||'').slice(0,280)}</div>
        <div style="margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:6px;">
          <button data-open="${msg.id}" style="background:#4b1a7f;color:#8ef58e;border:none;padding:4px 8px;border-radius:6px;font-size:.65em;cursor:pointer;">Ouvrir</button>
          <button data-del="${msg.id}" style="background:#d72660;color:#fff;border:none;padding:4px 8px;border-radius:6px;font-size:.65em;cursor:pointer;">Supprimer</button>
        </div>`;
      container.appendChild(card);
    });
    // Events
    container.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-del');
        if(confirm('Supprimer ce message ?')){
          await fetch('/api/messages-preuve/'+id, { method:'DELETE' });
          loadMessagesPreuve();
        }
      });
    });
    container.querySelectorAll('button[data-open]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-open');
        const r = await fetch('/api/messages-preuve');
        const list = await r.json();
        const entry = list.find(x=>x.id===id);
        if(entry){
          // r√©utiliser showReviewModal avec adaptation minimaliste
          const fauxAvis = {
            username: 'Anonyme',
            rating: 5,
            titre: entry.titre || 'Message de confiance',
            description: entry.message,
            medias: (entry.medias||[]).map(m=>({ path:m, type:/\.(mp4|webm|mov)$/i.test(m)?'video':'image' })),
            date: new Date(entry.dateSubmission).toLocaleDateString('fr-FR')
          };
          if(window.showReviewModal){ showReviewModal(fauxAvis); }
        }
      });
    });
  }

  // Formulaire ajout Messages avis
  const msgForm = document.getElementById('message-preuve-form');
  if(msgForm){
    msgForm.addEventListener('submit', async e => {
      e.preventDefault();
      const titre = document.getElementById('msg-preuve-titre').value.trim();
      const message = document.getElementById('msg-preuve-message').value.trim();
      const mediasRaw = document.getElementById('msg-preuve-medias').value;
      if(!message){ showToast('?? Message requis', 'error'); return; }
      let medias = [];
      try { medias = JSON.parse(mediasRaw||'[]'); } catch {}
      try {
        await fetch('/api/messages-preuve', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ titre, message, medias }) });
        document.getElementById('msg-preuve-message').value='';
        document.getElementById('msg-preuve-titre').value='';
        document.getElementById('msg-preuve-medias').value='[]';
        document.getElementById('msg-preuve-medias-preview').innerHTML='';
        loadMessagesPreuve();
      } catch(err){ showToast('? Erreur envoi', 'error'); }
    });
  }

  // S√©lection m√©dias Messages avis (r√©utilise explorateur existant)
  const addMediaBtn = document.getElementById('msg-preuve-add-media');
  if(addMediaBtn){
    addMediaBtn.addEventListener('click', ()=>{
      openFileExplorer('img', selected => {
        const preview = document.getElementById('msg-preuve-medias-preview');
        const hidden = document.getElementById('msg-preuve-medias');
        const current = []; // remplacement complet
        selected.forEach(p=> current.push(p));
        hidden.value = JSON.stringify(current);
        preview.innerHTML = '';
        current.forEach(p => {
          const wrap = document.createElement('div');
          wrap.style.cssText='width:50px;height:50px;position:relative;';
            if(/\.(mp4|webm|mov)$/i.test(p)){
              wrap.innerHTML = `<video src="${p}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;" muted></video>`;
            } else {
              wrap.innerHTML = `<img src="${p}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;"/>`;
            }
          preview.appendChild(wrap);
        });
      });
    });
  }

  // Charger les avis archiv√©s
  window.loadArchivedAvis = async function() {
    try {
      const res = await fetch("/api/avis-archived");
      const avisArchived = await res.json();
      const list = document.getElementById("archivedAvisList");
      list.innerHTML = '';
      
      if (avisArchived.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#8ef58e;padding:40px;">Aucun avis archiv√©</div>';
        return;
      }
      
      avisArchived.forEach((avis) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        
        // Afficher le vrai nom pour l'admin, m√™me si anonyme
        const displayName = avis.isAnonymous 
          ? `${avis.realName} <span style="background:#ff6b6b;padding:2px 6px;border-radius:4px;font-size:0.75em;margin-left:6px;">ANONYME</span>`
          : avis.realName || avis.client || 'Client';
        
        card.innerHTML = `
          <div class="article-card archived-clickable" style="cursor: pointer;">
            <div class="product-card">
              <strong>${avis.titre || 'Sans titre'}</strong> <span style="color:#ffd369;">${'‚òÖ'.repeat(avis.rating || 5)}</span><br>
              <span style="font-size:0.95em;">${avis.commentaire || avis.description || ''}</span><br>
              <span style="font-size:0.85em; color:#ffd369;">${displayName} - ${new Date(avis.dateSubmission).toLocaleString('fr-FR')}</span>
              ${avis.produit ? `<br><span style="font-size:0.8em; color:#8ef58e;">üì¶ ${avis.produit}</span>` : ''}
              ${avis.medias && avis.medias.length > 0 ? `<br><span style="font-size:0.8em; color:#8ef58e;">üì∑ ${avis.medias.length} m√©dia(s)</span>` : ''}
              <br><span style="font-size:0.8em; color:#6c757d;">üóÑÔ∏è Archiv√© le ${new Date(avis.dateArchivage).toLocaleDateString('fr-FR')}</span>
            </div>
            <div class="article-actions" onclick="event.stopPropagation()">
              <button onclick="restaurerAvis(${avis.id})" style="background:#ffd369; color:#2e003e;">Restaurer</button>
            </div>
          </div>
        `;
        
        // Ajouter le gestionnaire de clic sur la card pour ouvrir la modal
        card.addEventListener('click', () => {
          const normalized = {
            username: avis.realName || avis.client || 'Anonyme',
            client: avis.client,
            realName: avis.realName,
            isAnonymous: avis.isAnonymous || false,
            date: avis.date || (avis.dateSubmission ? new Date(avis.dateSubmission).toLocaleDateString('fr-FR') : ''),
            titre: avis.titre || avis.title || '',
            commentaire: avis.commentaire || avis.description || avis.text || '',
            rating: avis.rating || avis.note || 5,
            verified: false,
            produit: avis.produit || '',
            medias: (avis.medias && avis.medias.length)
              ? avis.medias.map(m => ({ type: m.type || (m.path && /\.(mp4|webm|mov)$/i.test(m.path) ? 'video' : 'image'), src: m.path || m }))
              : []
          };
          showReviewModal(normalized);
        });
        
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement avis archiv√©s:', e);
    }
  }

  // Archiver une Avis publi√©e (fonction globale)
  window.archiverPreuve = async function(preuveIndex) {
    if (!confirm('√ätes-vous s√ªr de vouloir archiver cette preuve ?')) return;
    
    try {
      console.log('üóÇÔ∏è Archivage preuve index:', preuveIndex);
      
      // R√©cup√©rer les preuves existantes
      const resPreuves = await fetch("/api/preuves");
      const preuves = await resPreuves.json();
      
      // R√©cup√©rer la preuve √† archiver
      const preuveToArchive = preuves[preuveIndex];
      
      if (!preuveToArchive) {
        showToast('Preuve non trouv√©e', 'error');
        return;
      }
      
      console.log('üìù Preuve √† archiver:', preuveToArchive);
      
      // R√©cup√©rer les archives existantes
      const resArchived = await fetch("/api/avis-archived");
      const archived = await resArchived.json();
      
      // Ajouter la preuve aux archives avec timestamp
      const archivedPreuve = {
        ...preuveToArchive,
        dateArchivage: new Date().toISOString(),
        archivedFrom: 'preuves'
      };
      archived.push(archivedPreuve);
      
      // Filtrer la preuve de la liste des Avis publi√©es
      const preuvesFiltrees = preuves.filter((_, index) => index !== preuveIndex);
      
      // Sauvegarder les deux fichiers
      const [preuvesResponse, archivedResponse] = await Promise.all([
        fetch('/api/preuves', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preuvesFiltrees)
        }),
        fetch('/api/avis-archived', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(archived)
        })
      ]);
      
      if (!preuvesResponse.ok || !archivedResponse.ok) {
        throw new Error('Erreur de sauvegarde sur le serveur');
      }
      
      console.log('‚úÖ Preuve archiv√©e avec succ√®s dans avis-archived.json');
      showToast('Preuve archiv√©e dans avis-archived.json !', 'error');
      loadPreuves(); // Recharger la liste
    } catch (error) {
      console.error('Erreur archivage preuve:', error);
      alert('Erreur lors de l\'archivage: ' + error.message);
    }
  };

  // Fonctions pour les Avis en attente (globale)
  window.loadAvisPending = async function() {
    try {
      const res = await fetch("/api/avis-pending");
      const avisPending = await res.json();
      
      // Stocker les donn√©es globalement pour l'ordre
      avisPendingData = avisPending || [];
      
      const list = document.getElementById("avisPendingList");
      list.innerHTML = '';
      
      if (avisPending.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#8ef58e;padding:40px;">Aucun avis en attente</div>';
        return;
      }
      
      avisPending.forEach((avis) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        
        // Afficher le vrai nom pour l'admin, m√™me si anonyme
        const displayName = avis.isAnonymous 
          ? `${avis.realName} <span style="background:#ff6b6b;padding:2px 6px;border-radius:4px;font-size:0.75em;margin-left:6px;">ANONYME</span>`
          : avis.client || avis.realName || 'Client';
        
        card.innerHTML = `
          <div class="article-card avis-clickable" data-avis-id="${avis.id}" style="cursor: pointer;">
            <div class="product-card">
              <strong>${avis.titre || 'Sans titre'}</strong> <span style="color:#ffd369;">${'‚òÖ'.repeat(avis.rating || 5)}</span><br>
              <span style="font-size:0.95em;">${avis.commentaire || avis.description || ''}</span><br>
              <span style="font-size:0.85em; color:#ffd369;">${displayName} - ${new Date(avis.dateSubmission).toLocaleString('fr-FR')}</span>
              ${avis.produit ? `<br><span style="font-size:0.8em; color:#8ef58e;">üì¶ ${avis.produit}</span>` : ''}
              ${avis.medias && avis.medias.length > 0 ? `<br><span style="font-size:0.8em; color:#8ef58e;">üì∑ ${avis.medias.length} m√©dia(s)</span>` : ''}
            </div>
            <div class="article-actions" onclick="event.stopPropagation()">
              <button onclick="validerAvis(${avis.id})" style="background:#8ef58e; color:#2e003e;">Valider</button>
              <button onclick="archiverAvis(${avis.id})" style="background:#ff6b6b;">Archiver</button>
            </div>
          </div>
        `;
        
        // Ajouter le gestionnaire de clic sur la card pour ouvrir la modal
        card.addEventListener('click', () => {
          const normalized = {
            username: avis.realName || avis.client || 'Anonyme',
            client: avis.client,
            realName: avis.realName,
            isAnonymous: avis.isAnonymous || false,
            date: avis.date || (avis.dateSubmission ? new Date(avis.dateSubmission).toLocaleDateString('fr-FR') : ''),
            titre: avis.titre || avis.title || '',
            commentaire: avis.commentaire || avis.description || avis.text || '',
            rating: avis.rating || avis.note || 5,
            verified: false,
            produit: avis.produit || '',
            medias: (avis.medias && avis.medias.length)
              ? avis.medias.map(m => ({ type: m.type || (m.path && /\.(mp4|webm|mov)$/i.test(m.path) ? 'video' : 'image'), src: m.path || m }))
              : []
          };
          showReviewModal(normalized);
        });
        
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement avis pending:', e);
    }
  }

  // Valider un avis (le publier dans preuves.json)
  async function validerAvis(avisId) {
    try {
      // R√©cup√©rer l'avis √† valider
      const resAvis = await fetch("/api/avis-pending");
      const avisPending = await resAvis.json();
      const avis = avisPending.find(a => a.id === avisId);
      
      if (!avis) {
        showToast('Avis non trouv√©', 'error');
        return;
      }
      
      console.log('üìù Avis √† valider:', avis);
      console.log('üì∑ M√©dias dans l\'avis:', avis.medias);
      
      // R√©cup√©rer les preuves existantes
      const resPreuves = await fetch("/api/preuves");
      const preuves = await resPreuves.json();
      
      // Ajouter l'avis complet aux preuves (avec toutes les donn√©es, y compris medias)
      const preuveComplete = {
        ...avis,
        dateValidation: new Date().toISOString()
      };
      
      console.log('‚úÖ Preuve √† ajouter:', preuveComplete);
      preuves.push(preuveComplete);
      
      // Sauvegarder les preuves mises √† jour
      await fetch('/api/preuves', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(preuves)
      });
      
      // Supprimer l'avis de la liste pending
      const avisPendingFiltered = avisPending.filter(a => a.id !== avisId);
      await fetch('/api/avis-pending', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(avisPendingFiltered)
      });
      
      showToast('Avis valid√© et publi√© dans preuves.json !', 'error');
      loadAvisPending(); // Recharger la liste des avis en attente
      loadPreuves(); // Recharger la liste des Avis publi√©es
    } catch (error) {
      console.error('Erreur validation avis:', error);
      alert('Erreur lors de la validation: ' + error.message);
    }
  }

  // Archiver un avis (le supprimer de la liste d'attente) - Fonction globale
  window.archiverAvis = async function(avisId) {
    console.log('üóÇÔ∏è Tentative d\'archivage avis ID:', avisId);
    
    if (!confirm('√ätes-vous s√ªr de vouloir archiver cet avis ?')) return;
    
    try {
      // R√©cup√©rer les avis en attente
      const resAvis = await fetch("/api/avis-pending");
      const avisPending = await resAvis.json();
      console.log('üìã Avis en attente:', avisPending);
      
      const avisToArchive = avisPending.find(a => a.id === avisId);
      console.log('üìù Avis √† archiver:', avisToArchive);
      
      if (!avisToArchive) {
        console.error('‚ùå Avis non trouv√© avec ID:', avisId);
        showToast('Avis non trouv√©', 'error');
        return;
      }
      
      // R√©cup√©rer les avis archiv√©s existants
      const resArchived = await fetch("/api/avis-archived");
      const avisArchived = await resArchived.json();
      
      // Ajouter l'avis aux archives avec timestamp
      const archivedAvis = {
        ...avisToArchive,
        dateArchivage: new Date().toISOString(),
        archivedAt: new Date().toISOString()
      };
      avisArchived.push(archivedAvis);
      
      // Supprimer l'avis des avis en attente
      const avisPendingFiltered = avisPending.filter(a => a.id !== avisId);
      
      // Sauvegarder les deux fichiers
      const [pendingResponse, archivedResponse] = await Promise.all([
        fetch('/api/avis-pending', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(avisPendingFiltered)
        }),
        fetch('/api/avis-archived', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(avisArchived)
        })
      ]);
      
      if (!pendingResponse.ok || !archivedResponse.ok) {
        throw new Error('Erreur de sauvegarde sur le serveur');
      }
      
      console.log('‚úÖ Avis archiv√© avec succ√®s');
      
      // Afficher un message de succ√®s
      const successMsg = document.createElement('div');
      successMsg.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        background: #4caf50; color: white; padding: 12px 20px;
        border-radius: 8px; font-weight: bold;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      successMsg.textContent = 'Avis archiv√© avec succ√®s!';
      document.body.appendChild(successMsg);
      setTimeout(() => successMsg.remove(), 3000);
      
      // Recharger la liste
      loadAvisPending();
      
      // Si on est dans l'onglet archiv√©, le recharger aussi
      const archivedTab = document.getElementById('archived-content');
      if (archivedTab && !archivedTab.style.display !== 'none') {
        loadArchivedAvis();
      }
      
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'archivage:', error);
      alert('Erreur lors de l\'archivage: ' + error.message);
    }
  }

  // Restaurer un avis archiv√© (le remettre en attente) - Fonction globale
  window.restaurerAvis = async function(avisId) {
    if (!confirm('√ätes-vous s√ªr de vouloir restaurer cet avis ?')) return;
    
    try {
      const resArchived = await fetch("/api/avis-archived");
      const avisArchived = await resArchived.json();
      const avisToRestore = avisArchived.find(a => a.id === avisId);
      
      if (!avisToRestore) {
        showToast('Avis archiv√© non trouv√©', 'error');
        return;
      }
      
      // Supprimer les donn√©es d'archivage
      const {dateArchivage, ...avisRestored} = avisToRestore;
      
      // Remettre l'avis en attente
      const resPending = await fetch("/api/avis-pending");
      const avisPending = await resPending.json();
      avisPending.push(avisRestored);
      
      await fetch('/api/avis-pending', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(avisPending)
      });
      
      // Supprimer l'avis des archives
      const avisArchivedFiltered = avisArchived.filter(a => a.id !== avisId);
      await fetch('/api/avis-archived', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(avisArchivedFiltered)
      });
      
      showToast('Avis restaur√© avec succ√®s', 'error');
      loadArchivedAvis();
    } catch (error) {
      console.error('Erreur restauration avis:', error);
      showToast('? Erreur lors de la restauration', 'error');
    }
  }

  // Rendre les fonctions accessibles globalement
  window.validerAvis = validerAvis;

  // Ajout ou √©dition d'article
  let editingIdx = null;
  function editArticle(article, idx) {
    editingIdx = idx;
    document.getElementById('nom').value = article.nom;
    
    // ID non modifiable en mode √©dition
    const idInput = document.getElementById('id');
    idInput.value = article.id;
    idInput.disabled = true;
    idInput.style.background = 'rgba(100, 100, 100, 0.3)';
    idInput.style.cursor = 'not-allowed';
    idInput.style.color = '#999';
    
    document.getElementById('categorie').value = article.categorie || '';
    document.getElementById('prix').value = article.prix;
    document.getElementById('reduction_type').value = article.reduction_type || '';
    document.getElementById('reduction').value = article.reduction || '';
    document.getElementById('description').value = article.description || '';
    
    // Gestion des m√©dias avec le nouveau syst√®me
    window.currentEditingArticle = {
      ...article,
      medias: []
    };
    
    // R√©cup√©rer les m√©dias existants
    if (article.medias && Array.isArray(article.medias)) {
      window.currentEditingArticle.medias = [...article.medias];
    } else {
      // Compatibilit√© avec l'ancien format
      if (article.image) {
        window.currentEditingArticle.medias.push({
          type: 'image',
          path: article.image,
          url: article.image
        });
      }
      
      if (article.video) {
        window.currentEditingArticle.medias.push({
          type: 'video',
          path: article.video,
          url: article.video
        });
      }
    }
    
    // D√©finir la miniature
    const thumbnailInput = document.getElementById('thumbnail-select');
    if (thumbnailInput) {
      thumbnailInput.value = article.thumbnail || '';
    }
    
    // Charger les variantes
    variantesData = article.variantes ? [...article.variantes] : [];
    updateVariantesDisplay();
    
    updateArticleMediaDisplay();
    document.getElementById('submit-btn').textContent = "Modifier";
  }

  // Event listeners pour les nouveaux formulaires
  
  // Formulaire Offres
  document.getElementById("addOffreForm")?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    let offre = Object.fromEntries(formData.entries());
    offre.prix = Number(offre.prix);

    try {
      const response = await fetch('/api/offres', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(offre)
      });
      if (response.ok) {
        showToast('Offre ajout√©e !', 'error');
        e.target.reset();
        loadOffres();
      }
    } catch (error) {
      alert('Erreur lors de l\'ajout de l\'offre');
    }
  });

  // Formulaire Arnaques
  document.getElementById("addArnaqueForm")?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    let arnaque = Object.fromEntries(formData.entries());
    
    // Traiter les m√©dias si pr√©sents
    if (arnaque.medias) {
      try {
        arnaque.medias = JSON.parse(arnaque.medias);
      } catch (e) {
        arnaque.medias = [];
      }
    } else {
      arnaque.medias = [];
    }
    
    // Convertir le statut verified en boolean
    arnaque.verified = arnaque.verified === 'true';
    
    // G√©n√©rer l'ID automatiquement √† partir du username (toujours)
    arnaque.id = arnaque.username.replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase();
    
    // V√©rifier qu'il n'y a pas d'espaces dans le username
    if (arnaque.username.includes(' ')) {
      alert('Le nom d\'utilisateur ne peut pas contenir d\'espaces !');
      return;
    }

    try {
      let response;
      
      // V√©rifier si on √©dite une arnaque existante
      if (window.editingArnaqueIdx !== undefined) {
        // Mode √©dition - PUT request
        const arnaques = await (await fetch('/api/arnaques')).json();
        arnaques[window.editingArnaqueIdx] = arnaque;
        
        response = await fetch('/api/arnaques', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(arnaques)
        });
        
        if (response.ok) {
          showToast('Arnaqueur modifi√© !', 'error');
          window.editingArnaqueIdx = undefined;
          document.getElementById('submit-arnaque-btn').textContent = 'Ajouter Arnaqueur';
          document.getElementById('cancel-arnaque-btn').style.display = 'none';
        }
      } else {
        // Mode ajout - POST request
        response = await fetch('/api/arnaques', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(arnaque)
        });
        
        if (response.ok) {
          showToast('Arnaqueur ajout√© !', 'error');
        }
      }
      
      if (response.ok) {
        e.target.reset();
        // Reset boutons r√©seaux
        document.querySelectorAll('.reseau-btn').forEach(btn => btn.classList.remove('selected'));
        // Reset techniques
        selectedTechniques = [];
        updateTechniquesDisplay();
        updateTechniquesInput();
        // Reset m√©dias
        selectedMediasArnaque = [];
        updateMediaDisplayArnaque();
        loadArnaques();
      }
    } catch (error) {
      alert('Erreur lors de l\'op√©ration');
      console.error('Erreur:', error);
    }
  });

  // Formulaire Preuves
  document.getElementById("addPreuveForm")?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    let preuve = Object.fromEntries(formData.entries());

    try {
      const response = await fetch('/api/preuves', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(preuve)
      });
      if (response.ok) {
        showToast('Preuve ajout√©e !', 'error');
        e.target.reset();
        loadPreuves();
      }
    } catch (error) {
      alert('Erreur lors de l\'ajout de la preuve');
    }
  });

  // ==================== GESTION DES VARIANTES ====================
  let variantesData = []; // Stocker les variantes de l'article en cours
  
  // Ajouter une variante
  document.getElementById('add-variante-btn').addEventListener('click', function() {
    openVarianteModal();
  });
  
  function openVarianteModal(varianteIndex = null) {
    const isEdit = varianteIndex !== null;
    const variante = isEdit ? variantesData[varianteIndex] : null;
    
    const modalHtml = `
      <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;" id="variante-modal-overlay">
        <div style="background:#2e004f;padding:30px;border-radius:16px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.4);">
          <h3 style="color:#ffd369;margin-bottom:20px;">${isEdit ? '‚úèÔ∏è Modifier' : '‚ûï Ajouter'} une variante</h3>
          
          <div style="margin-bottom:15px;">
            <label style="display:block;color:#8ef58e;margin-bottom:8px;font-weight:600;">Nom de la variante <span style="color:#ff6b6b;">*</span></label>
            <input type="text" id="variante-nom" value="${variante ? variante.nom : ''}" placeholder="Ex: Couleur Rouge, Taille L..." style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(107,5,114,0.3);color:#fff;" required>
          </div>
          
          <div style="margin-bottom:15px;">
            <label style="display:block;color:#8ef58e;margin-bottom:8px;font-weight:600;">Description</label>
            <textarea id="variante-description" rows="3" placeholder="Description sp√©cifique √† cette variante..." style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:rgba(107,5,114,0.3);color:#fff;resize:vertical;">${variante ? variante.description || '' : ''}</textarea>
          </div>
          
          <div style="margin-bottom:20px;">
            <label style="display:block;color:#8ef58e;margin-bottom:8px;font-weight:600;">M√©dias de la variante</label>
            <p style="font-size:0.85rem;color:#888;margin-bottom:10px;">S√©lectionnez des images/vid√©os sp√©cifiques √† cette variante</p>
            <div id="variante-media-list" style="min-height:60px;background:rgba(46,0,79,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:12px;margin-bottom:10px;">
              <div id="variante-media-empty" style="text-align:center;color:#888;font-style:italic;padding:20px;">Aucun m√©dia ajout√©</div>
            </div>
            <button type="button" id="variante-add-media-btn" style="background:#4b1a7f;color:#8ef58e;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;border:none;">
              üì∏ Ajouter des m√©dias
            </button>
          </div>
          
          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button type="button" id="variante-cancel-btn" style="background:#6a0572;color:#fff;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;border:none;">
              Annuler
            </button>
            <button type="button" id="variante-save-btn" style="background:linear-gradient(135deg,#4b1a7f,#6d28a3);color:#8ef58e;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;border:none;">
              ${isEdit ? 'Modifier' : 'Ajouter'}
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Initialiser les m√©dias si en √©dition
    if (variante && variante.medias && variante.medias.length > 0) {
      window.tempVarianteMedia = [...variante.medias];
      updateVarianteMediaDisplay();
    } else {
      window.tempVarianteMedia = [];
    }
    
    // √âv√©nements
    document.getElementById('variante-cancel-btn').addEventListener('click', closeVarianteModal);
    document.getElementById('variante-modal-overlay').addEventListener('click', function(e) {
      if (e.target.id === 'variante-modal-overlay') closeVarianteModal();
    });
    
    document.getElementById('variante-add-media-btn').addEventListener('click', function() {
      // Masquer temporairement la modal variante
      const varianteModal = document.getElementById('variante-modal-overlay');
      if (varianteModal) varianteModal.style.display = 'none';
      
      // Ouvrir le s√©lecteur GoFile
      openGofileSelectorGeneric((selectedMedias) => {
        // Ajouter les m√©dias s√©lectionn√©s √† tempVarianteMedia
        if (!window.tempVarianteMedia) window.tempVarianteMedia = [];
        
        selectedMedias.forEach(media => {
          window.tempVarianteMedia.push({
            path: media.url,
            url: media.url,
            name: media.name || media.url.split('/').pop(),
            type: media.type || 'image',
            mime_type: media.type === 'video' ? 'video/mp4' : 'image/jpeg'
          });
        });
        
        updateVarianteMediaDisplay();
        showToast(`‚úÖ ${selectedMedias.length} m√©dia(s) ajout√©(s) √† la variante`, 'success');
        
        // Restaurer la modal variante
        if (varianteModal) varianteModal.style.display = 'flex';
      }, true);
    });
    
    document.getElementById('variante-save-btn').addEventListener('click', function() {
      const nom = document.getElementById('variante-nom').value.trim();
      const description = document.getElementById('variante-description').value.trim();
      
      if (!nom) {
        showToast('Le nom de la variante est obligatoire', 'error');
        return;
      }
      
      const varianteData = {
        nom: nom,
        description: description,
        medias: window.tempVarianteMedia || []
      };
      
      if (isEdit) {
        variantesData[varianteIndex] = varianteData;
        showToast('Variante modifi√©e', 'success');
      } else {
        variantesData.push(varianteData);
        showToast('Variante ajout√©e', 'success');
      }
      
      updateVariantesDisplay();
      closeVarianteModal();
    });
  }
  
  function closeVarianteModal() {
    const modal = document.getElementById('variante-modal-overlay');
    if (modal) modal.remove();
    window.tempVarianteMedia = [];
    window.varianteMediaTarget = false;
  }
  
  function updateVarianteMediaDisplay() {
    const container = document.getElementById('variante-media-list');
    const emptyState = document.getElementById('variante-media-empty');
    
    if (!container) return;
    
    if (!window.tempVarianteMedia || window.tempVarianteMedia.length === 0) {
      if (emptyState) emptyState.style.display = 'block';
      return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    
    const mediasHtml = window.tempVarianteMedia.map((media, idx) => {
      const isVideo = media.type === 'video' || (media.mime_type && media.mime_type.startsWith('video/'));
      const mediaUrl = media.path || media.url;
      
      return `
        <div style="display:flex;align-items:center;gap:10px;padding:8px;background:rgba(107,5,114,0.5);border-radius:8px;margin-bottom:8px;">
          <div style="width:60px;height:60px;border-radius:8px;overflow:hidden;flex-shrink:0;">
            ${isVideo ? 
              `<video src="${mediaUrl}" style="width:100%;height:100%;object-fit:cover;" muted></video>` :
              `<img src="${mediaUrl}" style="width:100%;height:100%;object-fit:cover;">`
            }
          </div>
          <span style="flex:1;color:#fff;font-size:0.9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${media.name || 'M√©dia ' + (idx + 1)}</span>
          <button type="button" onclick="removeVarianteMedia(${idx})" style="background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:0.85rem;">üóëÔ∏è</button>
        </div>
      `;
    }).join('');
    
    container.innerHTML = mediasHtml + (emptyState ? emptyState.outerHTML : '');
  }
  
  window.removeVarianteMedia = function(index) {
    if (window.tempVarianteMedia) {
      window.tempVarianteMedia.splice(index, 1);
      updateVarianteMediaDisplay();
    }
  };
  
  function updateVariantesDisplay() {
    const container = document.getElementById('variantes-list');
    const emptyState = document.getElementById('variantes-empty-state');
    const badge = document.getElementById('variantes-count-badge');
    
    if (badge) badge.textContent = `${variantesData.length} variante(s)`;
    
    if (!variantesData || variantesData.length === 0) {
      if (emptyState) emptyState.style.display = 'block';
      return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    
    const variantesHtml = variantesData.map((variante, idx) => {
      return `
        <div style="display:flex;align-items:center;gap:15px;padding:15px;background:rgba(107,5,114,0.3);border:1px solid rgba(255,211,105,0.2);border-radius:12px;">
          <div style="flex:1;">
            <h4 style="color:#ffd369;margin:0 0 5px 0;font-size:1rem;">${variante.nom}</h4>
            ${variante.description ? `<p style="color:#8ef58e;margin:0 0 8px 0;font-size:0.85rem;">${variante.description}</p>` : ''}
            <span style="color:#888;font-size:0.8rem;">üì∏ ${variante.medias ? variante.medias.length : 0} m√©dia(s)</span>
          </div>
          <div style="display:flex;gap:8px;">
            <button type="button" onclick="editVariante(${idx})" style="background:#4b1a7f;color:#8ef58e;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:600;">‚úèÔ∏è Modifier</button>
            <button type="button" onclick="deleteVariante(${idx})" style="background:#dc3545;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:600;">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join('');
    
    container.innerHTML = variantesHtml + (emptyState ? emptyState.outerHTML : '');
  }
  
  window.editVariante = function(index) {
    openVarianteModal(index);
  };
  
  window.deleteVariante = function(index) {
    variantesData.splice(index, 1);
    updateVariantesDisplay();
    showToast('Variante supprim√©e', 'success');
  };
  
  // Modifier openMediaExplorer pour g√©rer les variantes
  const originalOpenMediaExplorer = window.openMediaExplorer;
  window.openMediaExplorer = function() {
    if (window.varianteMediaTarget) {
      // Mode s√©lection pour variante
      window.tempMediaExplorerTarget = 'variante';
    }
    if (originalOpenMediaExplorer) {
      originalOpenMediaExplorer();
    }
  };
  // ==================== FIN GESTION DES VARIANTES ====================

  // ==================== GESTION DES PALIERS DE QUANTIT√â ====================
  // Code des paliers de quantit√© supprim√©

  document.getElementById("addArticleForm").onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    let article = Object.fromEntries(formData.entries());
    article.prix = Number(article.prix); // prix en nombre
    
    // Si on √©dite, r√©cup√©rer l'ID depuis currentEditingArticle ou le champ disabled
    if (editingIdx !== null && window.currentEditingArticle) {
      article.id = window.currentEditingArticle.id || document.getElementById('id').value;
    }
    
    // Gestion des m√©dias
    // R√©cup√©rer tous les m√©dias disponibles (currentEditingArticle + tempSelectedMedia)
    let allMedias = [];
    
    // M√©dias de currentEditingArticle
    if (window.currentEditingArticle && window.currentEditingArticle.medias) {
      allMedias.push(...window.currentEditingArticle.medias);
    }
    
    // M√©dias temporaires (s√©lectionn√©s depuis GoFile)
    if (window.tempSelectedMedia && window.tempSelectedMedia.length > 0) {
      allMedias.push(...window.tempSelectedMedia);
    }
    
    console.log('[Debug] Tous les m√©dias trouv√©s:', allMedias);
    
    // Convertir les m√©dias GoFile au format standard
    article.medias = allMedias.map(media => {
      if (media.type === 'gofile' || media.type === 'pixeldrain') {
        // Convertir le format GoFile vers le format standard
        const filename = media.name || media.filename;
        return {
          type: media.mime_type && media.mime_type.startsWith('image/') ? 'image' : 
                media.mime_type && media.mime_type.startsWith('video/') ? 'video' : 'file',
          path: media.url, // URL GoFile pour affichage
          url: media.url,
          name: filename,
          mime_type: media.mime_type,
          gofile_id: media.id
        };
      }
      return media; // Garder les autres m√©dias tels quels
    });
    
    article.thumbnail = document.getElementById('thumbnail-select').value;
    
    // Ajouter les variantes
    if (variantesData && variantesData.length > 0) {
      article.variantes = variantesData;
    }
    
    // Pour la compatibilit√© avec l'ancien code
    if (article.medias.length > 0) {
      const firstImage = article.medias.find(m => 
        (m.type === 'image') || 
        (m.mime_type && m.mime_type.startsWith('image/'))
      );
      const firstVideo = article.medias.find(m => 
        (m.type === 'video') || 
        (m.mime_type && m.mime_type.startsWith('video/'))
      );
      
      if (firstImage) {
        article.image = firstImage.path || firstImage.url;
      }
      
      if (firstVideo) {
        article.video = firstVideo.path || firstVideo.url;
      }
    }
    
    // Debug: Afficher les donn√©es de l'article avant envoi
    console.log('[Admin] Article √† sauvegarder:', article);
    console.log('[Admin] M√©dias dans l\'article:', article.medias);
    console.log('[Admin] Variantes dans l\'article:', article.variantes);
    
    if (editingIdx !== null) {
      // Modifier
      const res = await fetch(`/api/articles/${article.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(article)
      });
      if (res.ok) {
        showToast("‚úÖ Article modifi√© avec succ√®s !", "success");
        editingIdx = null;
        document.getElementById('submit-btn').textContent = "Ajouter";
        
        // R√©activer le champ ID
        const idInput = document.getElementById('id');
        idInput.disabled = false;
        idInput.style.background = '';
        idInput.style.cursor = '';
        idInput.style.color = '';
        
        e.target.reset();
        // Nettoyer l'article en cours d'√©dition et les m√©dias temporaires
        window.currentEditingArticle = null;
        window.tempSelectedMedia = [];
        variantesData = [];
        updateArticleMediaDisplay();
        updateVariantesDisplay();
        loadArticles();
      } else {
        showToast("‚ùå Erreur lors de la modification", "error");
      }
    } else {
      // Ajouter
      const res = await fetch("/api/articles", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(article)
      });
      if (res.ok) {
        showToast("‚úÖ Article ajout√© avec succ√®s !", "success");
        e.target.reset();
        // Nettoyer l'article en cours d'√©dition et les m√©dias temporaires
        window.currentEditingArticle = null;
        window.tempSelectedMedia = [];
        variantesData = [];
        updateArticleMediaDisplay();
        updateVariantesDisplay();
        loadArticles();
      } else {
        showToast("‚ùå Erreur lors de l'ajout", "error");
      }
    }
  };

  // Explorateur m√©dias (remplacement ‚Äî logique et style identiques √† index)
  let explorerTarget = null; // "image" ou "video"
  let explorerType = null;   // "image" ou "video"

  const IMAGE_EXT = ['.jpg', '.jpeg', '.png', '.webp', '.gif', '.bmp'];
  const VIDEO_EXT = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.mkv'];

  function getExtension(filename) {
    const i = filename.lastIndexOf('.');
    return i !== -1 ? filename.slice(i).toLowerCase() : '';
  }

  let explorerBasePath = ''; // base relative sous img/ (ex: 'Articles/Electroniques' ou 'arnaques')
  function openExplorer(target, basePath = 'Articles/Electroniques') {
    explorerTarget = target; // 'media'
    explorerType = target;   // 'media'
    explorerBasePath = basePath.replace(/^\/*|\/*$/g,''); // nettoyer

    const modal = document.getElementById('file-explorer-modal');
    if (!modal) return showToast('? Erreur : Modal explorateur introuvable!', 'error');

    clearAllSelections();
    const selectedCount = document.getElementById('selected-count');
    const confirmCount = document.getElementById('confirm-count');
    if (selectedCount) selectedCount.textContent = '0';
    if (confirmCount) confirmCount.textContent = '0';
    modal.classList.add('show');
    // Navigue directement vers la base
    navigateTo(explorerBasePath);
  }

  // Fonction sp√©cifique pour les arnaques avec callback
  function openFileExplorer(startPath, callback) {
    window.fileExplorerCallback = callback;
    explorerTarget = 'media';
    explorerType = 'media';
    const modal = document.getElementById('file-explorer-modal');
    if(!modal) return showToast('? Erreur : Modal explorateur introuvable!', 'error');
    clearAllSelections();
    const selectedCount = document.getElementById('selected-count');
    const confirmCount = document.getElementById('confirm-count');
    if (selectedCount) selectedCount.textContent = '0';
    if (confirmCount) confirmCount.textContent = '0';
    modal.classList.add('show');
    // Normaliser startPath : enlever pr√©fixe img/ ou /img/, trim slashes
    let rel = (startPath||'').replace(/^\/?img\//,'').replace(/^img\//,'').replace(/^\/+|\/+$|\/\/+/g,'');
    if(rel === 'img' || rel === '') rel = '';
    navigateTo(rel);
  }

  async function showExplorer(relPath) {
    // Ajuster affichage relatif pour l'utilisateur (sans r√©p√©ter la base)
    const pathDisplay = document.getElementById('explorer-path');
    const explorer = document.getElementById('explorer');
    explorer.innerHTML = '<div style="grid-column:1/-1;color:#ffd369;padding:8px">Chargement‚Ä¶</div>';
    if (pathDisplay) {
      pathDisplay.textContent = relPath || 'Racine';
    }

    try {
      const res = await fetch(`/api/explorer?path=${encodeURIComponent(relPath || '')}`);
      const list = await res.json();
      explorer.innerHTML = '';

      // Ajouter bouton "retour" si on n'est pas √† la racine
      if (relPath) {
        const up = document.createElement('div');
        up.style = 'background:#4b1a7f;color:#ffd369;padding:10px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
        up.textContent = '‚¨ÖÔ∏è Retour';
        up.onclick = () => {
          const parent = relPath.split('/').slice(0, -1).join('/');
          showExplorer(parent);
        };
        explorer.appendChild(up);
      }

      // Cr√©e vignettes pour dossiers et fichiers
      list.forEach(item => {
        const card = document.createElement('div');
        card.style = 'background:#2e004f;color:#fff;padding:8px;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;text-align:center;min-height:84px;';
        if (item.isDir) {
          card.innerHTML = `üìÅ<div style="margin-top:6px;font-size:0.9em;color:#ffd369;">${item.name}</div>`;
          const nextPath = relPath ? relPath + '/' + item.name : item.name;
          card.onclick = () => showExplorer(nextPath);
        } else {
          const ext = getExtension(item.name);
          const allowed = (explorerType === 'image' && IMAGE_EXT.includes(ext)) || (explorerType === 'video' && VIDEO_EXT.includes(ext));
          if (!allowed) return; // skip non-matching files
          // miniature (image or video icon)
          if (IMAGE_EXT.includes(ext)) {
            card.innerHTML = `<img src="img/${relPath ? relPath + '/' : ''}${item.name}" style="max-width:100%;max-height:56px;border-radius:6px;background:#111;margin-bottom:4px;"><div style="font-size:0.7em;color:#8ef58e;word-break:break-word;line-height:1.2;">${item.name}</div>`;
          } else {
            card.innerHTML = `üé¨<div style="margin-top:6px;font-size:0.85em;color:#8ef58e;">${item.name}</div>`;
          }
          card.onclick = () => {
            const filePath = 'img/' + (relPath ? relPath + '/' : '') + item.name;
            const input = document.getElementById(explorerTarget);
            if (input) {
              input.value = filePath;
            } else if (window.fileExplorerCallback) {
              // Mode callback pour les syst√®mes modernes (infos, etc.)
              window.fileExplorerCallback([filePath]);
              document.getElementById('file-explorer-modal').classList.remove('show');
              setTimeout(() => {
                const modal = document.getElementById('file-explorer-modal');
                if (modal) modal.remove();
              }, 300);
            }
          };
        }
        explorer.appendChild(card);
      });

      // Si aucun √©l√©ment affich√© (ex: aucun fichier autoris√©), afficher info
      if (!explorer.hasChildNodes()) {
        explorer.innerHTML = '<div style="grid-column:1/-1;color:#ffd369;padding:8px">Aucun √©l√©ment</div>';
      }
    } catch (err) {
      explorer.innerHTML = '<div style="grid-column:1/-1;color:#ffd369;padding:8px">Erreur de lecture</div>';
    }
  }

  // Si tu as un bouton sp√©cifique Arnaques, lui passer vers GoFile aussi
  const selectMediaArnaqueBtn = document.getElementById('select-media-arnaque');
  if (selectMediaArnaqueBtn) {
    selectMediaArnaqueBtn.addEventListener('click', function() {
      showSection('medias');
    });
  }
  
  // G√©rer la s√©lection de miniature
  document.getElementById('thumbnail-select').addEventListener('change', function(e) {
    thumbnailPath = e.target.value;
  });
  
  // Fermer l'explorateur de fichiers
  document.getElementById('close-file-explorer').addEventListener('click', function() {
    document.getElementById('file-explorer-modal').classList.remove('show');
  });
  
  document.getElementById('cancel-file-selection').addEventListener('click', function() {
    document.getElementById('file-explorer-modal').classList.remove('show');
    clearAllSelections();
  });
  
  // Nouveaux gestionnaires pour la s√©lection multiple
  document.getElementById('select-all-media').addEventListener('click', function() {
    selectAllVisibleMedia();
  });
  
  document.getElementById('clear-selection').addEventListener('click', function() {
    clearAllSelections();
  });
  
  document.getElementById('confirm-file-selection').addEventListener('click', function() {
    const selectedFilesData = document.getElementById('selected-file-paths').value;
    if (!selectedFilesData || selectedFilesData === '[]') {
      showToast('?? Veuillez s√©lectionner au moins un m√©dia.', 'error');
      return;
    }
    
    try {
      const selectionData = JSON.parse(selectedFilesData);
      
      // Nouveau format avec ordre et miniature
      let selectedFiles;
      let thumbnailIndex = 0;
      
      if (selectionData.medias && Array.isArray(selectionData.medias)) {
        // Nouveau format avec ordre et miniature
        selectedFiles = selectionData.medias;
        thumbnailIndex = selectionData.thumbnailIndex || 0;
      } else if (Array.isArray(selectionData)) {
        // Ancien format pour compatibilit√©
        selectedFiles = selectionData;
        thumbnailIndex = 0;
      } else {
        selectedFiles = [];
      }
      
      // Si on a un callback (pour les arnaques par exemple)
      if (typeof window.fileExplorerCallback === 'function') {
        const filePaths = selectedFiles.map(file => file.path);
        window.fileExplorerCallback(filePaths);
        window.fileExplorerCallback = null; // Nettoyer le callback
      }
      // Si on est dans un contexte d'ajout/modification d'article
      else {
        // Utiliser le nouveau syst√®me avec window.currentEditingArticle ou window.tempSelectedMedia
        const targetArray = window.currentEditingArticle ? window.currentEditingArticle.medias : window.tempSelectedMedia;
        
        if (targetArray) {
          // Remplacer compl√®tement la liste des m√©dias avec l'ordre s√©lectionn√©
          targetArray.length = 0; // Vider la liste actuelle
          selectedFiles.forEach(file => {
            targetArray.push({ type: file.type, path: file.path });
          });
          
          // D√©finir la miniature selon l'index s√©lectionn√©
          if (selectedFiles.length > 0 && thumbnailIndex < selectedFiles.length) {
            const thumbnailPath = selectedFiles[thumbnailIndex].path;
            const thumbnailInput = document.getElementById('thumbnail-select');
            if (thumbnailInput) thumbnailInput.value = thumbnailPath;
            console.log('[Admin] Miniature d√©finie:', thumbnailPath, '√† l\'index', thumbnailIndex);
          } else if (selectedFiles.length > 0) {
            // Fallback sur le premier si l'index est invalide
            const thumbnailPath = selectedFiles[0].path;
            const thumbnailInput = document.getElementById('thumbnail-select');
            if (thumbnailInput) thumbnailInput.value = thumbnailPath;
            console.log('[Admin] Miniature d√©finie (fallback):', thumbnailPath);
          }
          
          // Mettre √† jour l'affichage avec le nouveau syst√®me
          updateArticleMediaDisplay();
        }
      }
      
      // Message de confirmation
      const count = selectedFiles.length;
      console.log(`‚úì ${count} m√©dia(s) s√©lectionn√©(s):`, selectedFiles);
      
      // Fermer la modale
      document.getElementById('file-explorer-modal').classList.remove('show');
      clearAllSelections();
      
    } catch (error) {
      console.error('Erreur lors de la confirmation de s√©lection:', error);
      showToast('? Erreur lors de la confirmation de la s√©lection.', 'error');
    }
  });

  // Ouvrir l'explorateur de fichiers - Cette fonction est d√©finie ailleurs
  let currentMediaType = null;
  let currentPath = '';
  
  // Naviguer dans l'explorateur de fichiers
  async function navigateTo(path) {
    currentPath = path;
    const pathElement = document.getElementById('file-path');
  const safePath = (path||'').replace(/^(img\/|\/img\/)/,'').replace(/\/\/+/g,'/');
  pathElement.textContent = `üìÅ /img${safePath ? '/' + safePath : ''}`;
  const previewBox = document.getElementById('file-preview');
  if (previewBox) { previewBox.style.display='none'; previewBox.innerHTML=''; }
    
    try {
      const response = await fetch(`/api/explorer?path=${encodeURIComponent(path)}`);
      if (!response.ok) throw new Error('Erreur lors de la r√©cup√©ration des fichiers');
      
      // Normaliser le format (serveur renvoie isDirectory)
      const raw = await response.json();
      const files = raw.map(f => ({
        name: f.name,
        isDir: f.isDir === true || f.isDirectory === true
      }));
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = '';
      
      // Configuration de la grille
      fileList.style.display = "grid";
      fileList.style.gridTemplateColumns = "repeat(auto-fill, minmax(180px, 1fr))";
      fileList.style.gap = "20px";
      fileList.style.padding = "10px";
      
      // Ajouter le lien vers le dossier parent si on n'est pas √† la racine
      if (path) {
        const parentItem = document.createElement('div');
        parentItem.style.gridColumn = "1 / -1";
        parentItem.style.marginBottom = "10px";
        parentItem.innerHTML = `<div style="padding:10px;cursor:pointer;display:flex;align-items:center;background:#3a0066;border-radius:6px;">
          <span style="margin-right:8px;font-size:1.2em;">‚¨ÖÔ∏è</span>
          <span>Retour</span>
        </div>`;
        parentItem.onclick = () => {
          const parentPath = path.split('/').slice(0, -1).join('/');
          navigateTo(parentPath);
        };
        fileList.appendChild(parentItem);
      }
      
      // Trier : dossiers d'abord, puis fichiers
      const sortedFiles = files.sort((a, b) => {
        if (a.isDir && !b.isDir) return -1;
        if (!a.isDir && b.isDir) return 1;
        return a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' });
      });
      
      sortedFiles.forEach(file => {
        const fileItem = document.createElement('div');
        const isImage = !file.isDir && /\.(jpe?g|png|webp|gif)$/i.test(file.name);
        const isVideo = !file.isDir && /\.(mp4|webm|mov)$/i.test(file.name);
        
        fileItem.style.background = "#2e004f";
        fileItem.style.borderRadius = "6px";
        fileItem.style.padding = "8px";
        fileItem.style.textAlign = "center";
        fileItem.style.display = "flex";
        fileItem.style.flexDirection = "column";
        fileItem.style.alignItems = "center";
        fileItem.style.cursor = "pointer";
        
        fileItem.innerHTML = `
          <div style="font-size:2em;margin-bottom:5px;">${file.isDir ? 'üìÅ' : (isImage ? 'üñºÔ∏è' : (isVideo ? 'üé¨' : 'üìÑ'))}</div>
          <div style="word-break:break-word;font-size:0.9em;">${file.name}</div>
        `;
        
        if (file.isDir) {
          fileItem.onclick = () => {
            const newPath = path ? `${path}/${file.name}` : file.name;
            navigateTo(newPath);
          };
        } else {
          // D√©terminer le type de m√©dia par l'extension
          const ext = getExtension(file.name).toLowerCase();
          const isImageExt = IMAGE_EXT.includes(ext);
          const isVideoExt = VIDEO_EXT.includes(ext);
          
          // Tous les fichiers m√©dia sont s√©lectionnables
      if (isImageExt || isVideoExt) {
            const filePath = `img/${(safePath? safePath + '/' : '')}${file.name}`;
            const mediaType = isImageExt ? 'image' : 'video';
            
            // Ajouter une case √† cocher
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.style.cssText = 'position:absolute; top:8px; right:8px; width:18px; height:18px; cursor:pointer; z-index:10;';
            checkbox.dataset.filePath = filePath;
            checkbox.dataset.mediaType = mediaType;
            checkbox.dataset.fileName = file.name;
            
            fileItem.style.position = 'relative';
            fileItem.style.cursor = 'pointer';
            fileItem.appendChild(checkbox);
            
            // Gestionnaire de clic sur la case √† cocher
            checkbox.addEventListener('click', (e) => {
              e.stopPropagation();
              updateMediaSelection();
            });
            
            // Clic sur l'item pour cocher/d√©cocher
            fileItem.onclick = (e) => {
              if (e.target === checkbox) return; // √âviter double d√©clenchement
              checkbox.checked = !checkbox.checked;
              updateMediaSelection();
            };
            
            // Ajouter une pr√©visualisation √† l'√©l√©ment
            if (isImageExt) {
                const preview = document.createElement('img');
                preview.src = filePath;
                preview.style.width = '100%';
                preview.style.height = '120px';
                preview.style.objectFit = 'cover';
                preview.style.marginBottom = '5px';
                preview.style.borderRadius = '4px';
                
                // Remplacer l'ic√¥ne par l'aper√ßu
                const iconElement = fileItem.querySelector('div:first-child');
                if (iconElement && !iconElement.querySelector('img')) {
                  iconElement.innerHTML = '';
                  iconElement.style.fontSize = '1em';
                  iconElement.style.height = '120px';
                  iconElement.style.marginBottom = '5px';
                  iconElement.appendChild(preview);
                }
              }
          } else {
            fileItem.style.opacity = '0.5';
            fileItem.style.cursor = 'not-allowed';
          }
        }
        
        fileList.appendChild(fileItem);
      });
      
    } catch (error) {
      console.error('Erreur lors de la navigation dans l\'explorateur :', error);
      document.getElementById('file-list').innerHTML = 
        `<li style="padding:10px;color:#ff6b6b;">Erreur : ${error.message}</li>`;
    }
  }
  
  // Variables pour la s√©lection multiple
  let selectedMediaFiles = [];  // Chang√© en Array pour maintenir l'ordre
  let thumbnailIndex = 0;      // Index du m√©dia utilis√© comme miniature
  
  // Mettre √† jour la s√©lection de m√©dias
  function updateMediaSelection() {
    const checkboxes = document.querySelectorAll('#file-list input[type="checkbox"]');
    const selectedList = document.getElementById('selected-media-list');
    const selectedCount = document.getElementById('selected-count');
    const confirmCount = document.getElementById('confirm-count');
    const mobileCount = document.getElementById('mobile-selection-count');
    
    // R√©cup√©rer les m√©dias actuellement coch√©s
    const newSelectedFiles = [];
    checkboxes.forEach(checkbox => {
      const item = checkbox.closest('div');
      if (checkbox.checked) {
        const mediaData = {
          path: checkbox.dataset.filePath,
          type: checkbox.dataset.mediaType,
          name: checkbox.dataset.fileName
        };
        
        // Pr√©server l'ordre existant si le m√©dia √©tait d√©j√† s√©lectionn√©
        const existingIndex = selectedMediaFiles.findIndex(m => m.path === mediaData.path);
        if (existingIndex >= 0) {
          newSelectedFiles.push(selectedMediaFiles[existingIndex]);
        } else {
          newSelectedFiles.push(mediaData);
        }
        
        item.style.border = '3px solid #8ef58e';
        item.style.backgroundColor = '#3a0066';
      } else {
        item.style.border = 'none';
        item.style.backgroundColor = '#2e004f';
      }
    });
    
    selectedMediaFiles = newSelectedFiles;
    
    // Ajuster l'index de la miniature si n√©cessaire
    if (thumbnailIndex >= selectedMediaFiles.length) {
      thumbnailIndex = Math.max(0, selectedMediaFiles.length - 1);
    }
    
    // Mettre √† jour l'affichage
    const count = selectedMediaFiles.length;
    if (selectedCount) selectedCount.textContent = count;
    if (confirmCount) confirmCount.textContent = count;
    
    // Affichage mobile
    if (mobileCount) {
      mobileCount.textContent = count + ' s√©lection(s)';
      mobileCount.style.display = count > 0 ? 'inline' : 'none';
    }
    
    // Afficher la liste des s√©lections (seulement sur desktop)
    if (selectedList) {
      selectedList.innerHTML = '';
      if (count === 0) {
        selectedList.innerHTML = '<div style="color:#888; font-style:italic; text-align:center; padding:20px;">Aucun m√©dia s√©lectionn√©</div>';
      } else {
        selectedMediaFiles.forEach((media, index) => {
          const mediaDiv = document.createElement('div');
          const isThumbnail = index === thumbnailIndex;
          mediaDiv.style.cssText = `display:flex; align-items:center; margin-bottom:8px; padding:6px; background:${isThumbnail ? 'rgba(255,211,105,0.2)' : 'rgba(255,255,255,0.05)'}; border-radius:4px; border:${isThumbnail ? '2px solid #ffd369' : '1px solid transparent'};`;
          
          const icon = media.type === 'image' ? 'üñºÔ∏è' : 'üé¨';
          const thumbnailBadge = isThumbnail ? '<span style="background:#ffd369; color:#333; padding:2px 6px; border-radius:10px; font-size:0.7em; font-weight:bold; margin-left:6px;">MINIATURE</span>' : '';
          
          mediaDiv.innerHTML = `
            <span style="margin-right:8px; font-size:1.2em;">${icon}</span>
            <span style="flex:1; font-size:0.85em; color:#fff; word-break:break-word;">${media.name}${thumbnailBadge}</span>
            <div style="display:flex; gap:4px; align-items:center;">
              ${index > 0 ? `<button onclick="moveMedia(${index}, -1)" style="background:#4a9eff; color:white; border:none; border-radius:3px; padding:2px 6px; cursor:pointer; font-size:0.8em;" title="Monter">‚Üë</button>` : ''}
              ${index < count - 1 ? `<button onclick="moveMedia(${index}, 1)" style="background:#4a9eff; color:white; border:none; border-radius:3px; padding:2px 6px; cursor:pointer; font-size:0.8em;" title="Descendre">‚Üì</button>` : ''}
              ${!isThumbnail ? `<button onclick="setThumbnail(${index})" style="background:#ffd369; color:#333; border:none; border-radius:3px; padding:2px 6px; cursor:pointer; font-size:0.8em;" title="D√©finir comme miniature">üì∑</button>` : ''}
              <button onclick="removeMediaFromSelection('${media.path}')" style="background:#ff6b6b; color:white; border:none; border-radius:3px; padding:2px 6px; cursor:pointer; font-size:0.8em;">‚úï</button>
            </div>
          `;
          selectedList.appendChild(mediaDiv);
        });
      }
    }
    
    // Stocker dans l'input cach√© avec l'ordre et la miniature
    const dataToStore = {
      medias: selectedMediaFiles,
      thumbnailIndex: thumbnailIndex
    };
    document.getElementById('selected-file-paths').value = JSON.stringify(dataToStore);
  }
  
  // Supprimer un m√©dia de la s√©lection (fonction globale)
  window.removeMediaFromSelection = function(filePath) {
    const checkbox = document.querySelector(`#file-list input[data-file-path="${filePath}"]`);
    if (checkbox) {
      checkbox.checked = false;
      updateMediaSelection();
    }
  };
  
  // D√©placer un m√©dia dans la liste (fonction globale)
  window.moveMedia = function(fromIndex, direction) {
    const toIndex = fromIndex + direction;
    if (toIndex < 0 || toIndex >= selectedMediaFiles.length) return;
    
    // √âchanger les √©l√©ments
    const temp = selectedMediaFiles[fromIndex];
    selectedMediaFiles[fromIndex] = selectedMediaFiles[toIndex];
    selectedMediaFiles[toIndex] = temp;
    
    // Ajuster l'index de la miniature
    if (thumbnailIndex === fromIndex) {
      thumbnailIndex = toIndex;
    } else if (thumbnailIndex === toIndex) {
      thumbnailIndex = fromIndex;
    }
    
    updateMediaSelection();
  };
  
  // D√©finir un m√©dia comme miniature (fonction globale)
  window.setThumbnail = function(index) {
    thumbnailIndex = index;
    updateMediaSelection();
  };
  
  // S√©lectionner tous les m√©dias visibles
  function selectAllVisibleMedia() {
    const checkboxes = document.querySelectorAll('#file-list input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    updateMediaSelection();
  }
  
  // Effacer toutes les s√©lections
  function clearAllSelections() {
    const checkboxes = document.querySelectorAll('#file-list input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    updateMediaSelection();
  }
  
  // G√©rer la s√©lection d'un fichier (fonction de compatibilit√©)
  function selectFile(path, mediaType) {
    // Cette fonction est maintenant g√©r√©e par updateMediaSelection
    // Garder pour compatibilit√© mais utiliser le nouveau syst√®me
  }

  // close button
  document.body.addEventListener('click', function(e){
    if (e.target && e.target.id === 'close-product-modal') {
      document.getElementById('product-modal').classList.remove('show');
    }
    // close when clicking outside modal-content
    if (e.target && e.target.id === 'product-modal') {
      document.getElementById('product-modal').classList.remove('show');
    }
  });

  // Delegated handler: buttons with data-preview-id or class .preview-btn
  document.body.addEventListener('click', function(e){
    const btn = (e.target && e.target.closest) ? e.target.closest('[data-preview-id], .preview-btn') : null;
    if (!btn) return;
    const id = btn.getAttribute('data-preview-id');
    if (id) {
      window.showProductModal(id);
      return;
    }
    const articleJson = btn.getAttribute && btn.getAttribute('data-article');
    if (articleJson) {
      try {
        const art = JSON.parse(articleJson);
        window.showProductModal(art);
        return;
      } catch(e){
        // fallback: try preview id attribute
        const fid = btn.getAttribute('data-preview-id');
        if (fid) window.showProductModal(fid);
      }
    }
  });

  // Define showProductModal (override the fallback above) - same implementation as before
  window.showProductModal = async function(articleOrId){
  if (!window.allArticles) {
    try {
      const r = await fetch('/articles.json');
      window.allArticles = await r.json();
    } catch(e) {
      window.allArticles = [];
    }
  }
  
  let article = null;
  if (!articleOrId) return;
  if (typeof articleOrId === 'string' || typeof articleOrId === 'number') {
    article = (window.allArticles || []).find(a => a.id == articleOrId || a.nom == articleOrId);
  } else if (typeof articleOrId === 'object') {
    article = articleOrId;
  }
  
  if (!article) {
    try {
      const r2 = await fetch('/articles.json');
      const list = await r2.json();
      article = list.find(a => a.id == articleOrId || a.nom == articleOrId) || null;
    } catch(e) { article = null; }
  }

  const modal = document.getElementById('product-modal');
  const imgEl = document.getElementById('product-media-img');
  const videoEl = document.getElementById('product-media-video');
  const titleEl = document.getElementById('product-title');
  const descEl = document.getElementById('product-description');
  const catEl = document.getElementById('product-categorie');
  const addBtn = document.getElementById('add-to-cart-btn');

  // Reset all elements
  imgEl.style.display = 'none';
  videoEl.style.display = 'none';
  videoEl.src = '';
  imgEl.src = '';
  titleEl.textContent = '';
  descEl.textContent = '';
  catEl.textContent = '';

  if (!article) {
    titleEl.textContent = 'Article introuvable';
    modal.classList.add('show');
    return;
  }

  // Format titre avec prix int√©gr√© (comme dans l'image 1)
  titleEl.textContent = article.nom + ' - ' + article.prix + '‚Ç¨';
  
  // Remplir les informations
  descEl.textContent = article.description || '';
  catEl.textContent = article.categorie ? ('Cat√©gorie : ' + article.categorie) : '';

  // Gestion des m√©dias - priorit√© √† l'affichage des m√©dias multiples
  if (article.medias && article.medias.length > 0) {
    // Si nous avons des m√©dias multiples
    const primaryMedia = article.medias[0];
    if (primaryMedia.type === 'image') {
      imgEl.src = primaryMedia.path;
      imgEl.alt = article.nom || '';
      imgEl.style.display = 'block';
    } else if (primaryMedia.type === 'video') {
      videoEl.src = primaryMedia.path;
      videoEl.style.display = 'block';
    }
  } else if (article.image) {
    // Compatibilit√© avec l'ancien format
    imgEl.src = article.image;
    imgEl.alt = article.nom || '';
    imgEl.style.display = 'block';
  } else if (article.video) {
    // Compatibilit√© avec l'ancien format
    videoEl.src = article.video;
    videoEl.style.display = 'block';
  }

  // Simuler le bouton "+" (ferme la modale au clic)
  addBtn.onclick = () => {
    modal.classList.remove('show');
  };

  // Ouvrir la modale
  modal.classList.add('show');
};
});

// === NOUVELLE MODAL CAT√âGORIES ADMIN ===
let adminCategoriesData = [];
let adminNavStack = []; // Navigation breadcrumbs: [{name, children}]

// Charger les cat√©gories depuis l'API
window.loadAdminCategories = async function() {
  try {
    const response = await fetch('/api/categories');
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    adminCategoriesData = await response.json();
    console.log('ÔøΩ Cat√©gories admin charg√©es:', adminCategoriesData.length);
    
    // Initialiser la navigation √† la racine
    adminNavStack = [{ name: 'Racine', children: adminCategoriesData }];
    
    return true;
  } catch (error) {
    console.error('Erreur chargement cat√©gories admin:', error);
    adminCategoriesData = [];
    adminNavStack = [{ name: 'Racine', children: [] }];
    return false;
  }
}

// Rendu des breadcrumbs
function renderAdminBreadcrumbs() {
  const breadcrumbsEl = document.getElementById('admin-cat-breadcrumbs');
  if (!breadcrumbsEl) return;
  
  breadcrumbsEl.innerHTML = '';
  
  adminNavStack.forEach((level, index) => {
    const crumb = document.createElement('span');
    crumb.className = 'admin-breadcrumb';
    crumb.style.cssText = `
      padding: 6px 12px;
      background: ${index === adminNavStack.length - 1 ? '#8ef58e' : '#4b1a7f'};
      color: ${index === adminNavStack.length - 1 ? '#240038' : '#8ef58e'};
      border-radius: 4px;
      cursor: ${index < adminNavStack.length - 1 ? 'pointer' : 'default'};
      font-weight: 600;
      font-size: 0.9em;
    `;
    crumb.textContent = level.name;
    
    if (index < adminNavStack.length - 1) {
      crumb.addEventListener('click', () => {
        adminNavStack = adminNavStack.slice(0, index + 1);
        renderAdminCategoryLevel();
      });
    }
    
    breadcrumbsEl.appendChild(crumb);
    
    if (index < adminNavStack.length - 1) {
      const separator = document.createElement('span');
      separator.textContent = '‚Ä∫';
      separator.style.color = 'rgba(255,255,255,0.6)';
      breadcrumbsEl.appendChild(separator);
    }
  });
}

// Rendu du niveau de cat√©gories actuel
function renderAdminCategoryLevel() {
  const listEl = document.getElementById('admin-cat-list');
  if (!listEl) return;
  
  renderAdminBreadcrumbs();
  
  listEl.innerHTML = '';
  const currentLevel = adminNavStack[adminNavStack.length - 1];
  
  if (!currentLevel.children || currentLevel.children.length === 0) {
    listEl.innerHTML = '<li style="text-align:center;color:#8ef58e;padding:40px;font-style:italic;">Aucune sous-cat√©gorie</li>';
    return;
  }
  
  currentLevel.children.forEach(category => {
    const li = document.createElement('li');
    li.style.cssText = `
      padding: 15px;
      margin-bottom: 8px;
      background: #3a0066;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    `;
    
    const hasChildren = category.children && category.children.length > 0;
    const childrenCount = hasChildren ? ` (${category.children.length})` : '';
    const categoryIcon = category.icon || 'üìÅ';
    
    li.innerHTML = `
      <div style="flex:1;">
        <span style="color:#fff;font-weight:bold;font-size:1.1em;">${categoryIcon} ${category.name}${childrenCount}</span>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="select-btn" style="background:#8ef58e;color:#240038;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-weight:bold;">Choisir</button>
      </div>
    `;
    
    // Hover effects
    li.addEventListener('mouseenter', () => {
      li.style.borderColor = '#ffd369';
      li.style.background = '#4b1a7f';
    });
    
    li.addEventListener('mouseleave', () => {
      li.style.borderColor = 'transparent';
      li.style.background = '#3a0066';
    });
    
    // Navigation vers sous-cat√©gorie en cliquant sur la tuile (m√™me si aucune sous-cat√©gorie)
    li.addEventListener('click', () => {
      adminNavStack.push({ name: category.name, children: category.children || [] });
      renderAdminCategoryLevel();
    });
    
    // S√©lection de cat√©gorie
    const selectBtn = li.querySelector('.select-btn');
    selectBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      selectAdminCategory(category.name);
    });
    
    listEl.appendChild(li);
  });
}

// S√©lectionner une cat√©gorie
function selectAdminCategory(categoryName) {
  // Construire le chemin complet
  const pathParts = adminNavStack
    .map(level => level.name)
    .filter(name => name !== 'Racine')
    .concat(categoryName);
  
  const fullPath = pathParts.join('/');
  
  // Mettre √† jour l'input du formulaire
  const categoryInput = document.getElementById('categorie');
  if (categoryInput) {
    categoryInput.value = fullPath;
    console.log('‚úÖ Cat√©gorie s√©lectionn√©e:', fullPath);
  }
  
  // Fermer la modal
  closeAdminCategoryModal();
}

// S√©lectionner le niveau courant
function selectCurrentAdminCategory() {
  const pathParts = adminNavStack
    .map(level => level.name)
    .filter(name => name !== 'Racine');
  
  const fullPath = pathParts.length > 0 ? pathParts.join('/') : '';
  
  // Mettre √† jour l'input du formulaire
  const categoryInput = document.getElementById('categorie');
  if (categoryInput) {
    categoryInput.value = fullPath;
    console.log('‚úÖ Niveau s√©lectionn√©:', fullPath || 'Racine');
  }
  
  // Fermer la modal
  closeAdminCategoryModal();
}

// Ouvrir la modal
function openAdminCategoryModal() {
  const modal = document.getElementById('category-explorer-modal');
  if (!modal) return;
  
  loadAdminCategories().then(success => {
    if (success) {
      renderAdminCategoryLevel();
      modal.classList.add('show');
    } else {
      showToast('? Erreur lors du chargement des cat√©gories', 'error');
    }
  });
}

// Fermer la modal
function closeAdminCategoryModal() {
  const modal = document.getElementById('category-explorer-modal');
  if (modal) {
    modal.classList.remove('show');
  }
}

// === INITIALISATION ADMIN MODAL CAT√âGORIES ===
// Initialiser la modal des cat√©gories au chargement
document.addEventListener('DOMContentLoaded', function() {
  console.log('üîß Initialisation de la modal cat√©gories admin...');
  
  // Remplacer les attributs onclick par des event listeners
  const categoryButtons = document.querySelectorAll('button[onclick*="openCategoryExplorer"]');
  categoryButtons.forEach(btn => {
    btn.removeAttribute('onclick');
    btn.addEventListener('click', openAdminCategoryModal);
  });
  
  // Bouton "G√©rer les cat√©gories"
  const editCategoriesBtn = document.getElementById('edit-categories-btn');
  if (editCategoriesBtn) {
    editCategoriesBtn.addEventListener('click', openCategoryManagement);
  }
  
  // Bouton de fermeture
  const closeBtn = document.querySelector('#category-explorer-modal .close');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeAdminCategoryModal);
  }
  
  // Bouton de fermeture par ID sp√©cifique
  const closeCategoryBtn = document.getElementById('close-category-explorer');
  if (closeCategoryBtn) {
    closeCategoryBtn.addEventListener('click', closeAdminCategoryModal);
  }
  
  // Bouton annuler
  const cancelBtn = document.getElementById('cancel-category-selection');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', closeAdminCategoryModal);
  }
  
  // Bouton "S√©lectionner ce niveau"
  const selectCurrentBtn = document.getElementById('select-current-category');
  if (selectCurrentBtn) {
    selectCurrentBtn.addEventListener('click', selectCurrentAdminCategory);
  }
  
  // Fermeture par clic sur l'overlay
  const modal = document.getElementById('category-explorer-modal');
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeAdminCategoryModal();
      }
    });
  }
  
  console.log('‚úÖ Modal cat√©gories admin initialis√©e');
});

// Fonction compatibility pour les anciens appels
function openCategoryExplorer() {
  console.log('‚ö†Ô∏è Appel legacy openCategoryExplorer -> ouverture modal admin');
  openAdminCategoryModal();
}

// Export window pour compatibilit√©
window.openCategoryExplorer = openCategoryExplorer;

// === GESTION DES CAT√âGORIES ===
let managementNavStack = [];
let managementCategoriesData = [];

// Ouvrir la modal de gestion des cat√©gories
function openCategoryManagement() {
  const modal = document.getElementById('category-management-modal');
  if (!modal) return;
  
  loadAdminCategories().then(success => {
    if (success) {
      managementCategoriesData = JSON.parse(JSON.stringify(adminCategoriesData)); // Deep copy
      managementNavStack = [{ name: 'Racine', children: managementCategoriesData }];
      renderManagementLevel();
      modal.classList.add('show');
    } else {
      showToast('? Erreur lors du chargement des cat√©gories', 'error');
    }
  });
}

// Rendu du niveau de gestion des cat√©gories
function renderManagementLevel() {
  const listEl = document.getElementById('management-category-list');
  const breadcrumbsEl = document.getElementById('management-breadcrumbs');
  if (!listEl || !breadcrumbsEl) return;
  
  // Rendu des breadcrumbs
  breadcrumbsEl.innerHTML = '';
  managementNavStack.forEach((level, index) => {
    const crumb = document.createElement('span');
    crumb.style.cssText = `
      padding: 6px 12px;
      background: ${index === managementNavStack.length - 1 ? '#8ef58e' : '#4b1a7f'};
      color: ${index === managementNavStack.length - 1 ? '#240038' : '#8ef58e'};
      border-radius: 4px;
      cursor: ${index < managementNavStack.length - 1 ? 'pointer' : 'default'};
      font-weight: 600;
      font-size: 0.9em;
    `;
    crumb.textContent = level.name;
    
    if (index < managementNavStack.length - 1) {
      crumb.addEventListener('click', () => {
        managementNavStack = managementNavStack.slice(0, index + 1);
        renderManagementLevel();
      });
    }
    
    breadcrumbsEl.appendChild(crumb);
    
    if (index < managementNavStack.length - 1) {
      const separator = document.createElement('span');
      separator.textContent = '‚Ä∫';
      separator.style.color = 'rgba(255,255,255,0.6)';
      breadcrumbsEl.appendChild(separator);
    }
  });
  
  // Rendu de la liste
  listEl.innerHTML = '';
  const currentLevel = managementNavStack[managementNavStack.length - 1];
  
  if (!currentLevel.children || currentLevel.children.length === 0) {
    listEl.innerHTML = '<div style="text-align:center;color:#8ef58e;padding:40px;font-style:italic;">Aucune cat√©gorie</div>';
    return;
  }
  
  currentLevel.children.forEach((category, index) => {
    const div = document.createElement('div');
    div.style.cssText = `
      padding: 15px;
      margin-bottom: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 2px solid transparent;
    `;
    
    const hasChildren = category.children && category.children.length > 0;
    const categoryIcon = category.icon || 'üìÅ';
    
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;flex:1;">
        <span style="color:#fff;font-weight:bold;font-size:1.1em;">${categoryIcon} ${category.name}</span>
        ${hasChildren ? `<span style="color:#8ef58e;font-size:0.9em;">(${category.children.length} sous-cat√©gories)</span>` : ''}
      </div>
      <div style="display:flex;gap:8px;">
        <button class="rename-btn" style="background:#ffd369;color:#240038;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:0.9em;">‚úèÔ∏è</button>
        <button class="delete-btn" style="background:#ff6b6b;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:0.9em;">üóëÔ∏è</button>
        <button class="move-up-btn" ${index === 0 ? 'disabled' : ''} style="background:${index === 0 ? '#ccc' : '#17a2b8'};color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:0.9em;">‚Üë</button>
        <button class="move-down-btn" ${index === currentLevel.children.length - 1 ? 'disabled' : ''} style="background:${index === currentLevel.children.length - 1 ? '#ccc' : '#17a2b8'};color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:0.9em;">‚Üì</button>
      </div>
    `;
    
    // Navigation vers sous-cat√©gorie en cliquant sur la carte (m√™me si aucune sous-cat√©gorie)
    div.addEventListener('click', () => {
      managementNavStack.push({ name: category.name, children: category.children || [] });
      renderManagementLevel();
    });
    
    // Renommer
    const renameBtn = div.querySelector('.rename-btn');
    renameBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      showCategoryEditPrompt(category.name, category.icon || '', (newName, newIcon) => {
        if (newName && newName.trim() && newName.trim() !== category.name) {
          category.name = newName.trim();
          if (newIcon !== undefined) {
            if (newIcon.trim()) {
              category.icon = newIcon.trim();
            } else {
              delete category.icon;
            }
          }
          renderManagementLevel();
        }
      });
    });
    
    // Supprimer
    const deleteBtn = div.querySelector('.delete-btn');
    deleteBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (confirm(`Supprimer la cat√©gorie "${category.name}" et toutes ses sous-cat√©gories ?`)) {
        currentLevel.children.splice(index, 1);
        renderManagementLevel();
      }
    });
    
    // D√©placer vers le haut
    const moveUpBtn = div.querySelector('.move-up-btn');
    if (!moveUpBtn.disabled) {
      moveUpBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        [currentLevel.children[index], currentLevel.children[index - 1]] = [currentLevel.children[index - 1], currentLevel.children[index]];
        renderManagementLevel();
      });
    }
    
    // D√©placer vers le bas
    const moveDownBtn = div.querySelector('.move-down-btn');
    if (!moveDownBtn.disabled) {
      moveDownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        [currentLevel.children[index], currentLevel.children[index + 1]] = [currentLevel.children[index + 1], currentLevel.children[index]];
        renderManagementLevel();
      });
    }
    
    listEl.appendChild(div);
  });
}

// Initialiser les √©v√©nements de gestion des cat√©gories
document.addEventListener('DOMContentLoaded', function() {
  // Bouton d'ajout de cat√©gorie
  const addCategoryBtn = document.getElementById('add-category');
  const newCategoryInput = document.getElementById('new-category-name');
  const newCategoryIconInput = document.getElementById('new-category-icon');
  
  if (addCategoryBtn && newCategoryInput) {
    addCategoryBtn.addEventListener('click', () => {
      const name = newCategoryInput.value.trim();
      const icon = newCategoryIconInput ? newCategoryIconInput.value.trim() : '';
      if (!name) return;
      
      const currentLevel = managementNavStack[managementNavStack.length - 1];
      if (currentLevel.children.some(cat => cat.name === name)) {
        showToast('Une cat√©gorie avec ce nom existe d√©j√†', 'error');
        return;
      }
      
      const newCategory = {
        name: name,
        children: []
      };
      
      if (icon) {
        newCategory.icon = icon;
      }
      
      currentLevel.children.push(newCategory);
      
      newCategoryInput.value = '';
      if (newCategoryIconInput) newCategoryIconInput.value = '';
      renderManagementLevel();
    });
    
    newCategoryInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        addCategoryBtn.click();
      }
    });
    
    if (newCategoryIconInput) {
      newCategoryIconInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addCategoryBtn.click();
        }
      });
    }
  }
  
  // Bouton de sauvegarde
  const saveCategoriesBtn = document.getElementById('save-categories');
  if (saveCategoriesBtn) {
    saveCategoriesBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/categories', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(managementCategoriesData)
        });
        
        if (response.ok) {
          showToast('Cat√©gories sauvegard√©es avec succ√®s !', 'success');
          adminCategoriesData = JSON.parse(JSON.stringify(managementCategoriesData));
          document.getElementById('category-management-modal').classList.remove('show');
        } else {
          throw new Error('Erreur de sauvegarde');
        }
      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        showToast('‚ùå Erreur lors de la sauvegarde', 'error');
      }
    });
  }
  
  // Fermeture de la modal de gestion
  const managementModal = document.getElementById('category-management-modal');
  if (managementModal) {
    const closeBtn = managementModal.querySelector('.close');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        managementModal.classList.remove('show');
      });
    }
    
    managementModal.addEventListener('click', (e) => {
      if (e.target === managementModal) {
        managementModal.classList.remove('show');
      }
    });
  }
});

// ================== LOGIQUE ORDRE (PERTINENCE) ==================
let orderingData = { order: [] };
let allArticlesCache = [];

window.loadOrdering = async function() {
  try {
    const r = await fetch('/api/ordering');
    orderingData = await r.json();
    if (!orderingData || !Array.isArray(orderingData.order)) orderingData = { order: [] };
  } catch(e){ orderingData = { order: [] }; }
}

window.loadAllArticlesForOrdering = async function(){
  try { const r = await fetch('/articles.json'); allArticlesCache = await r.json(); }
  catch(e){ allArticlesCache = []; }
}

function buildOrderingGrid(filter='') {
  const grid = document.getElementById('ordering-grid');
  if (!grid) return;
  const filterNorm = filter.trim().toLowerCase();
  
  // Construire une liste ordonn√©e
  const idToArticle = new Map(allArticlesCache.map(a=>[String(a.id), a]));
  const ordered = [];
  const used = new Set();
  orderingData.order.forEach(id => { 
    const art = idToArticle.get(String(id)); 
    if (art){ ordered.push(art); used.add(String(id)); }
  });
  allArticlesCache.forEach(a => { if(!used.has(String(a.id))) ordered.push(a); });
  
  grid.innerHTML='';
  
  ordered.forEach((article, idx) => {
    if(filterNorm && !(String(article.id).toLowerCase().includes(filterNorm) || (article.nom||'').toLowerCase().includes(filterNorm))) return;
    
    const card = document.createElement('div');
    card.className='ordering-item product-card';
    card.setAttribute('data-id', article.id);
    card.setAttribute('draggable','true');
    card.style.cssText = `
      background:linear-gradient(135deg, #2e004f, #1976d2);
      border-radius:12px;
      padding:12px;
      box-shadow:0 4px 8px rgba(0,0,0,0.2);
      transition:all 0.3s;
      cursor:grab;
      border:2px solid rgba(255,255,255,0.1);
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:100%;
    `;
    
    // Badge de position
    const positionBadge = document.createElement('div');
    positionBadge.style.cssText = `
      position:absolute;
      top:8px;
      left:8px;
      background:rgba(255,211,105,0.9);
      color:#2e003e;
      padding:4px 10px;
      border-radius:20px;
      font-weight:bold;
      font-size:0.9em;
      z-index:2;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    `;
    positionBadge.textContent = `#${idx + 1}`;
    card.appendChild(positionBadge);
    
    // Barre de couleur en haut
    const topBar = document.createElement('div');
    topBar.style.cssText = `
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:3px;
      background:linear-gradient(90deg, #8ef58e, #ffd369);
    `;
    card.appendChild(topBar);
    
    // M√©dia
    const mediaContainer = document.createElement('div');
    mediaContainer.style.cssText = 'margin-top:8px;';
    
    let thumb = article.thumbnail || (article.medias && article.medias.length>0 ? article.medias[0].path : article.image || '');
    
    if (thumb) {
      if (/\.(mp4|webm)$/i.test(thumb)) {
        const video = document.createElement('video');
        video.src = thumb;
        video.muted = true;
        video.autoplay = true;
        video.loop = true;
        video.style.cssText = 'width:100%;height:140px;object-fit:cover;border-radius:8px;background:rgba(0,0,0,0.2);';
        mediaContainer.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.src = thumb;
        img.style.cssText = 'width:100%;height:140px;object-fit:cover;border-radius:8px;background:rgba(0,0,0,0.2);';
        mediaContainer.appendChild(img);
      }
    } else {
      const placeholder = document.createElement('div');
      placeholder.style.cssText = `
        width:100%;
        height:140px;
        border:2px dashed #4b1a7f;
        border-radius:8px;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:0.8em;
        opacity:0.6;
        color:#8ef58e;
      `;
      placeholder.textContent = 'Aucun m√©dia';
      mediaContainer.appendChild(placeholder);
    }
    
    card.appendChild(mediaContainer);
    
    // Info produit
    const infoDiv = document.createElement('div');
    infoDiv.style.cssText = 'display:flex;flex-direction:column;gap:6px;flex:1;margin-top:12px;';
    
    // Nom
    const nameDiv = document.createElement('div');
    nameDiv.style.cssText = `
      font-weight:bold;
      color:#ffd369;
      font-size:0.95em;
      line-height:1.2;
      max-height:3em;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
    `;
    nameDiv.textContent = article.nom || article.id || 'Article';
    infoDiv.appendChild(nameDiv);
    
    // Cat√©gorie
    if (article.categorie) {
      const catDiv = document.createElement('div');
      catDiv.style.cssText = `
        font-size:0.75em;
        color:#8ef58e;
        opacity:0.9;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      `;
      catDiv.textContent = `üìÅ ${article.categorie}`;
      infoDiv.appendChild(catDiv);
    }
    
    // Footer avec prix
    const footerDiv = document.createElement('div');
    footerDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-top:auto;padding-top:8px;';
    
    const priceSpan = document.createElement('span');
    priceSpan.style.cssText = 'color:#ff6b6b;font-weight:bold;font-size:1.1em;';
    priceSpan.textContent = article.prix ? article.prix + '‚Ç¨' : '';
    footerDiv.appendChild(priceSpan);
    
    infoDiv.appendChild(footerDiv);
    card.appendChild(infoDiv);
    
    // Clic droit pour changer le num√©ro
    card.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      showPositionPrompt(article.nom, idx + 1, ordered.length, (pos) => {
        if (pos >= 1 && pos <= ordered.length) {
          moveCardToPosition(card, pos - 1);
          rebuildOrderingGrid();
        } else {
          showToast(`‚ö†Ô∏è Position invalide. Entrez un nombre entre 1 et ${ordered.length}`, 'warning');
        }
      });
    });
    
    grid.appendChild(card);
  });
  
  initOrderingDrag();
}

function moveCardToPosition(card, newIndex) {
  const grid = document.getElementById('ordering-grid');
  const cards = Array.from(grid.children);
  const cardId = card.getAttribute('data-id');
  
  // Retirer la carte de l'ordre actuel
  const currentOrder = cards.map(c => c.getAttribute('data-id'));
  const oldIndex = currentOrder.indexOf(cardId);
  
  if (oldIndex !== -1) {
    currentOrder.splice(oldIndex, 1);
    currentOrder.splice(newIndex, 0, cardId);
    
    // Mettre √† jour orderingData
    orderingData.order = currentOrder;
    showToast(`‚úÖ Position modifi√©e !`, 'success');
  }
}

function rebuildOrderingGrid() {
  const searchInput = document.getElementById('ordering-search');
  buildOrderingGrid(searchInput ? searchInput.value : '');
}

function initOrderingDrag(){
  const items = document.querySelectorAll('.ordering-item');
  let dragEl=null;
  items.forEach(it=>{
    it.addEventListener('dragstart', e=>{ dragEl=it; it.style.opacity='0.4'; });
    it.addEventListener('dragend', e=>{ if(dragEl) dragEl.style.opacity='1'; dragEl=null; saveTempOrder(); });
    it.addEventListener('dragover', e=>{ e.preventDefault(); });
    it.addEventListener('drop', e=>{
      e.preventDefault();
      if(!dragEl || dragEl===it) return;
      const grid = document.getElementById('ordering-grid');
      const children = Array.from(grid.children);
      const dragIndex = children.indexOf(dragEl);
      const targetIndex = children.indexOf(it);
      if (dragIndex < targetIndex) grid.insertBefore(dragEl, it.nextSibling); else grid.insertBefore(dragEl, it);
    });
  });
}

function getCurrentGridOrder(){
  const grid = document.getElementById('ordering-grid');
  return Array.from(grid.children).map(c=>c.getAttribute('data-id'));
}

function saveTempOrder(){
  orderingData.order = getCurrentGridOrder().map(id=>String(id));
}

async function saveOrdering(){
  const btn = document.getElementById('ordering-save');
  const original = btn ? btn.textContent : '';
  if(btn){ btn.disabled=true; btn.textContent='‚è≥ Sauvegarde...'; }
  
  try {
    // R√©cup√©rer l'ordre actuel depuis les √©l√©ments DOM
    const items = document.querySelectorAll('#ordering-grid .ordering-item');
    const newOrder = Array.from(items).map(item => ({
      id: item.dataset.id,
      type: item.dataset.type
    }));
    
    console.log(`Sauvegarde ordre pour ${currentAdminSection}:`, newOrder);
    
    // Pr√©parer les donn√©es selon la section
    let endpoint = '';
    let dataToSend = {};
    
    switch(currentAdminSection) {
      case 'articles':
        endpoint = '/api/ordering';
        dataToSend = { order: newOrder.map(item => item.id) };
        break;
      case 'offres':
        endpoint = '/api/offres-ordering';
        dataToSend = { order: newOrder.map(item => item.id) };
        break;
      case 'arnaques':
        endpoint = '/api/arnaques-ordering';
        dataToSend = { order: newOrder.map(item => item.id) };
        break;
      case 'avis-pending':
        endpoint = '/api/avis-ordering';
        dataToSend = { order: newOrder.map(item => item.id) };
        break;
      default:
        console.error('Section non support√©e pour l\'ordre:', currentAdminSection);
        if(btn){ btn.disabled=false; btn.textContent=original; }
        return;
    }
    
    // Envoyer au serveur
    const res = await fetch(endpoint, { 
      method:'PUT', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(dataToSend)
    });
    
    if(res.ok){
      const result = await res.json();
      console.log('Sauvegarde r√©ussie:', result);
      if(btn){ btn.textContent='‚úÖ Sauvegard√©'; setTimeout(()=>{ btn.disabled=false; btn.textContent=original; },1300); }
      
      // Recharger les donn√©es de la section pour refl√©ter les changements
      switch(currentAdminSection) {
        case 'articles':
          await loadArticles();
          break;
        case 'offres':
          await loadOffres();
          break;
        case 'arnaques':
          await loadArnaques();
          break;
        case 'avis-pending':
          await loadAvisPending();
          break;
      }
    } else {
      const error = await res.text();
      console.error('Erreur serveur:', error);
      if(btn){ btn.disabled=false; btn.textContent=original; }
      alert('Erreur sauvegarde: ' + error);
    }
  } catch(e){
    console.error('Erreur r√©seau:', e);
    if(btn){ btn.disabled=false; btn.textContent=original; }
    alert('Erreur r√©seau sauvegarde: ' + e.message);
  }
}

function resetOrdering(){
  orderingData.order = allArticlesCache.map(a=>String(a.id));
  buildOrderingGrid(document.getElementById('ordering-search').value);
}

// Ouverture / fermeture modal
document.addEventListener('DOMContentLoaded', () => {
  const openBtn = document.getElementById('open-ordering-btn');
  const modal = document.getElementById('ordering-modal');
  const closeBtn = document.getElementById('close-ordering-modal');
  const search = document.getElementById('ordering-search');
  
  if(openBtn && modal){
    openBtn.addEventListener('click', async ()=>{
      console.log('Ouverture modale ordre pour section:', currentAdminSection);
      
      // S'assurer que les donn√©es sont charg√©es pour la section courante
      try {
        switch(currentAdminSection) {
          case 'articles':
            if (articlesData.length === 0) {
              console.log('Chargement des articles...');
              await loadArticles();
            }
            break;
          case 'offres':
            if (offresData.length === 0) {
              console.log('Chargement des offres...');
              await loadOffres();
            }
            break;
          case 'arnaques':
            if (arnaquesData.length === 0) {
              console.log('Chargement des arnaques...');
              await loadArnaques();
            }
            break;
          case 'avis-pending':
            if (avisPendingData.length === 0) {
              console.log('Chargement des avis pending...');
              await loadAvisPending();
            }
            break;
        }
        
        showOrderingModal();
      } catch(e) {
        console.error('Erreur lors du chargement des donn√©es:', e);
        alert('Erreur lors du chargement des donn√©es: ' + e.message);
      }
    });
  }
  
  if(closeBtn){ 
    closeBtn.addEventListener('click', ()=> {
      modal.classList.remove('show');
    }); 
  }
  
  modal && modal.addEventListener('click', e=>{ 
    if(e.target===modal) modal.classList.remove('show'); 
  });
  
  if(search){ 
    search.addEventListener('input', (e)=> {
      const searchValue = e.target.value.toLowerCase();
      // Filtrer les √©l√©ments visibles
      const items = document.querySelectorAll('.ordering-item');
      items.forEach(item => {
        const title = item.querySelector('.ordering-title').textContent.toLowerCase();
        const subtitle = item.querySelector('.ordering-subtitle').textContent.toLowerCase();
        const matches = title.includes(searchValue) || subtitle.includes(searchValue);
        item.style.display = matches ? 'flex' : 'none';
      });
    }); 
  }
  
  const clearBtn = document.getElementById('ordering-clear');
  if(clearBtn){ 
    clearBtn.addEventListener('click', ()=>{
      search.value=''; 
      // R√©afficher tous les √©l√©ments
      document.querySelectorAll('.ordering-item').forEach(item => {
        item.style.display = 'flex';
      });
    }); 
  }
  
  const saveBtn = document.getElementById('ordering-save');
  if(saveBtn){ 
    console.log('‚úÖ Event listener attach√© au bouton sauvegarde');
    saveBtn.addEventListener('click', () => {
      console.log('üî• Bouton sauvegarde cliqu√©!');
      saveOrdering();
    }); 
  } else {
    console.error('‚ùå Bouton ordering-save introuvable');
  }
  const resetBtn = document.getElementById('ordering-reset');
  if(resetBtn){ resetBtn.addEventListener('click', ()=>{ if(confirm('R√©initialiser l\'ordre par d√©faut (liste actuelle)?')) resetOrdering(); }); }
});

// ================== ADAPTATION MINIATURES (grille) ==================
function refreshThumbnailGrid(){
  const grid = document.getElementById('thumbnail-grid');
  if(!grid) return;
  grid.innerHTML='';
  if(mediaList.length === 0){
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#8ef58e;padding:20px;border:1px dashed #4b1a7f;border-radius:8px;">Aucun m√©dia ajout√©</div>';
    return;
  }
  mediaList.forEach(m=>{
    const cell = document.createElement('div');
    cell.style.cssText='position:relative;border:2px solid #2e0052;border-radius:8px;overflow:hidden;cursor:pointer;display:flex;align-items:center;justify-content:center;height:80px;';
    let inner='';
    if(m.type==='image') inner = `<img src="${m.path}" style="width:100%;height:100%;object-fit:cover;"/>`;
    else inner = `<video src="${m.path}" muted autoplay loop style="width:100%;height:100%;object-fit:cover;"></video>`;
    cell.innerHTML = inner + `<div style="position:absolute;bottom:2px;right:4px;font-size:18px;text-shadow:1px 1px 2px rgba(0,0,0,0.8);">${m.type==='image'?'üñºÔ∏è':'üé¨'}</div>`;
    if(m.path===thumbnailPath){ cell.style.border='2px solid #8ef58e'; }
    cell.addEventListener('click', ()=>{
      thumbnailPath = m.path;
      document.getElementById('thumbnail-select').value = thumbnailPath;
      refreshThumbnailGrid();
    });
    grid.appendChild(cell);
  });
}

  // Fonctions globales pour l'√©dition et suppression

  // Fonctions pour les offres
  window.editOffre = function(offre, idx) {
    // S'assurer qu'on est dans la bonne section
    showSection('offres');
    
    // Attendre que la section soit visible
    setTimeout(() => {
      const elements = {
        nom: document.getElementById('nom-offre'),
        id: document.getElementById('id-offre'),
        prix: document.getElementById('prix-offre'),
        description: document.getElementById('description-offre'),
        categorie: document.getElementById('categorie-offre')
      };
      
      // V√©rifier que tous les √©l√©ments existent
      for (const [key, element] of Object.entries(elements)) {
        if (!element) {
          console.error(`√âl√©ment ${key} non trouv√© pour editOffre`);
          return;
        }
      }
      
      // Remplir les champs
      elements.nom.value = offre.nom || '';
      elements.id.value = offre.id || '';
      elements.prix.value = offre.prix || '';
      elements.description.value = offre.description || '';
      elements.categorie.value = offre.categorie || '';
    }, 100);
  };

  window.deleteOffre = async function(idx) {
    if (!confirm('Supprimer cette offre ?')) return;
    try {
      const res = await fetch('/api/offres');
      const offres = await res.json();
      offres.splice(idx, 1);
      await fetch('/api/offres', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(offres)
      });
      loadOffres();
    } catch (e) {
      showToast('? Erreur lors de la suppression', 'error');
    }
  };

  // Fonctions pour les arnaques
  window.editArnaque = function(arnaque, idx) {
    console.log('√âdition arnaque:', arnaque);
    // S'assurer qu'on est dans la bonne section
    showSection('arnaques');
    
    // Attendre que la section soit charg√©e
    setTimeout(() => {
      const elements = {
        nom: document.getElementById('nom-arnaque'),
        username: document.getElementById('username-arnaque'),
        techniques: document.getElementById('techniques-arnaque'),
        description: document.getElementById('description-arnaque')
      };
      
      // V√©rifier que tous les √©l√©ments existent
      for (const [key, element] of Object.entries(elements)) {
        if (!element) {
          console.error(`√âl√©ment ${key} non trouv√© pour editArnaque`);
          console.log('√âl√©ments disponibles dans le DOM:', 
            Array.from(document.querySelectorAll('[id*="arnaque"]')).map(el => el.id));
          return;
        }
      }
      
      // Remplir les champs
      elements.nom.value = arnaque.nom || '';
      elements.username.value = arnaque.username || '';
      elements.description.value = arnaque.description || '';
      
      // G√©rer les techniques (nouveau syst√®me)
      selectedTechniques = [];
      if (arnaque.techniques) {
        if (typeof arnaque.techniques === 'string') {
          selectedTechniques = arnaque.techniques.split(', ').filter(t => t.trim());
        } else if (Array.isArray(arnaque.techniques)) {
          selectedTechniques = [...arnaque.techniques];
        }
      }
      updateTechniquesDisplay();
      updateTechniquesInput();
      
      // G√©rer les m√©dias
      if (arnaque.medias && Array.isArray(arnaque.medias)) {
        selectedMediasArnaque = [...arnaque.medias];
      } else {
        selectedMediasArnaque = [];
      }
      updateMediaDisplayArnaque();
      
      // Cocher les bons r√©seaux
      document.querySelectorAll('.reseau-btn').forEach(btn => btn.classList.remove('selected'));
      if (arnaque.reseaux) {
        let reseauxList = [];
        if (typeof arnaque.reseaux === 'string') {
          reseauxList = arnaque.reseaux.split(', ');
        } else if (Array.isArray(arnaque.reseaux)) {
          reseauxList = arnaque.reseaux;
        } else {
          reseauxList = [String(arnaque.reseaux)];
        }
        
        reseauxList.forEach(reseau => {
          const btn = document.querySelector(`[data-reseau="${reseau.trim()}"]`);
          if (btn) btn.classList.add('selected');
        });
        updateReseauxInput();
      }
      
      // Marquer qu'on √©dite cette arnaque
      window.editingArnaqueIdx = idx;
      console.log('√âdition arnaque configur√©e, idx:', idx);
      
      // Changer l'interface pour l'√©dition
      document.getElementById('submit-arnaque-btn').textContent = 'Modifier Arnaqueur';
      document.getElementById('cancel-arnaque-btn').style.display = 'block';
    }, 200); // D√©lai plus long pour s'assurer que le DOM est charg√©
  };

  window.cancelEditArnaque = function() {
    // Reset du mode √©dition
    window.editingArnaqueIdx = undefined;
    
    // Reset de l'interface
    document.getElementById('submit-arnaque-btn').textContent = 'Ajouter Arnaqueur';
    document.getElementById('cancel-arnaque-btn').style.display = 'none';
    
    // Reset du formulaire
    document.getElementById('addArnaqueForm').reset();
    document.querySelectorAll('.reseau-btn').forEach(btn => btn.classList.remove('selected'));
    updateReseauxInput();
    
    // Reset techniques
    selectedTechniques = [];
    updateTechniquesDisplay();
    updateTechniquesInput();
    
    // Reset m√©dias
    selectedMediasArnaque = [];
    updateMediaDisplayArnaque();
  };

  // Gestion des arnaques en attente
  window.approveArnaqueFromPending = async function(idx) {
    try {
      const res = await fetch("/api/arnaques-pending");
      const pending = await res.json();
      const arnaque = pending[idx];
      
      if (!arnaque) return;
      
      // Charger les arnaques existantes
      const arnaquesRes = await fetch("/arnaques.json");
      const arnaques = await arnaquesRes.json();
      
      // Cr√©er la nouvelle arnaque avec statut v√©rifi√©
      const nouvelleArnaque = {
        id: Date.now(),
        nom: arnaque.nom,
        username: arnaque.arnaqueurId,
        techniques: arnaque.technique,
        reseaux: [],
        medias: arnaque.preuves || [],
        description: arnaque.technique,
        verified: true,
        datePublication: new Date().toISOString()
      };
      
      // Ajouter aux arnaques actives
      arnaques.push(nouvelleArnaque);
      await fetch("/api/arnaques", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(arnaques)
      });
      
      // Retirer de pending
      pending.splice(idx, 1);
      await fetch("/api/arnaques-pending", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(pending)
      });
      
      alert('‚úÖ Arnaque approuv√©e et publi√©e !');
      loadArnaquesPending();
    } catch (e) {
      console.error('Erreur approbation arnaque:', e);
      alert('Erreur lors de l\'approbation');
    }
  };

  // Variables globales pour l'√©dition d'arnaque pending
  let editPendingMedias = [];
  let editPendingProducts = [];
  let editPendingTechniques = [];
  
  // S√©lecteur GoFile g√©n√©rique r√©utilisable
  function openGofileSelectorGeneric(callback, multipleMode = true) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10003;display:flex;align-items:center;justify-content:center;padding:20px;';
    
    modal.innerHTML = `
      <div style="background:#2e004f;border:2px solid #ffd369;border-radius:12px;padding:20px;max-width:1000px;width:100%;max-height:90vh;overflow-y:auto;">
        <h3 style="color:#ffd369;margin-bottom:15px;">üé® S√©lectionner des m√©dias GoFile</h3>
        <input type="text" id="generic-pd-search" placeholder="üîç Rechercher..." style="width:100%;padding:10px;margin-bottom:15px;border-radius:6px;border:1px solid #6a0572;background:#1a0033;color:#fff;">
        <div id="generic-pd-gallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;max-height:500px;overflow-y:auto;"></div>
        <div style="display:flex;gap:10px;margin-top:15px;">
          <button id="generic-pd-cancel" style="flex:1;background:#6c757d;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;">Annuler</button>
          <button id="generic-pd-confirm" style="flex:1;background:#8ef58e;color:#240038;border:none;padding:10px;border-radius:6px;cursor:pointer;font-weight:700;">Confirmer (<span id="generic-pd-count">0</span>)</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    let selectedUrls = [];
    let allFiles = [];
    
    // Charger GoFile
    fetch('/images').then(r => r.json()).then(files => {
      allFiles = files.filter(f => f.type !== 'folder').map(f => ({
        ...f,
        url: `/media/${f.id}?name=${encodeURIComponent(f.name)}&server=${f.server || 'store1'}`,
        fileType: /\.(mp4|webm|mov)$/i.test(f.name) ? 'video' : 'image'
      }));
      renderGenericGallery(allFiles);
    });
    
    function renderGenericGallery(files) {
      const gallery = document.getElementById('generic-pd-gallery');
      gallery.innerHTML = files.map(file => {
        const isSelected = selectedUrls.includes(file.url);
        return `
          <div onclick="toggleGenericMedia('${file.url}')" style="cursor:pointer;background:${isSelected ? 'rgba(142,245,142,0.3)' : '#3a0066'};border:2px solid ${isSelected ? '#8ef58e' : 'transparent'};border-radius:8px;padding:8px;position:relative;">
            ${file.fileType === 'video' ? 
              `<video src="${file.url}" muted style="width:100%;height:80px;object-fit:cover;border-radius:6px;"></video>` :
              `<img src="${file.url}" style="width:100%;height:80px;object-fit:cover;border-radius:6px;">`
            }
            <div style="color:#fff;font-size:0.7em;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${file.name}</div>
            ${isSelected ? '<div style="position:absolute;top:4px;right:4px;background:#8ef58e;color:#240038;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:0.8em;">‚úì</div>' : ''}
          </div>
        `;
      }).join('');
    }
    
    window.toggleGenericMedia = function(url) {
      const idx = selectedUrls.indexOf(url);
      if (idx >= 0) {
        selectedUrls.splice(idx, 1);
      } else {
        if (!multipleMode) selectedUrls = [];
        selectedUrls.push(url);
      }
      document.getElementById('generic-pd-count').textContent = selectedUrls.length;
      renderGenericGallery(allFiles);
    };
    
    document.getElementById('generic-pd-search').oninput = (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allFiles.filter(f => f.name.toLowerCase().includes(term));
      renderGenericGallery(filtered);
    };
    
    document.getElementById('generic-pd-cancel').onclick = () => modal.remove();
    document.getElementById('generic-pd-confirm').onclick = () => {
      // Retourner les objets complets, pas juste les URLs
      const selectedFiles = allFiles.filter(f => selectedUrls.includes(f.url));
      callback(selectedFiles);
      modal.remove();
    };
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
  }
  
  // Charger les techniques disponibles
  async function loadTechniquesForEdit() {
    try {
      const res = await fetch('/api/techniques-arnaques');
      if (res.ok) {
        editPendingTechniques = await res.json();
        const select = document.getElementById('edit-pending-technique-select');
        select.innerHTML = '<option value="">-- S√©lectionnez une technique --</option>' +
          editPendingTechniques.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
      }
    } catch (e) {
      console.error('Erreur chargement techniques:', e);
    }
  }

  window.editPendingArnaque = async function(idx) {
    try {
      const res = await fetch("/api/arnaques-pending");
      const pending = await res.json();
      const arnaque = pending[idx];
      
      if (!arnaque) return;
      
      // Charger les techniques
      await loadTechniquesForEdit();
      
      // Ouvrir le modal de modification
      document.getElementById('edit-pending-arnaque-modal').style.display = 'block';
      document.getElementById('edit-pending-idx').value = idx;
      
      // Champs NON MODIFIABLES (disabled)
      document.getElementById('edit-pending-nom').value = arnaque.nom || '';
      document.getElementById('edit-pending-id').value = arnaque.arnaqueurId || '';
      
      // Afficher info du d√©nonciateur
      const vraiNom = arnaque.denonceurReel || arnaque.denonceur || 'Non sp√©cifi√©';
      const statutAnon = arnaque.isAnonymous 
        ? '<span style="color:#ff6b6b;">üîí Sera affich√© comme ANONYME</span>' 
        : '<span style="color:#8ef58e;">‚úì Nom visible publiquement</span>';
      document.getElementById('edit-pending-denonceur-info').innerHTML = `
        <strong>Par:</strong> ${vraiNom} ‚Ä¢ ${statutAnon} ‚Ä¢ <strong>Date:</strong> ${new Date(arnaque.date).toLocaleDateString('fr-FR')}
      `;
      
      // Technique (modifiable)
      document.getElementById('edit-pending-technique').value = arnaque.technique || '';
      const techniqueSelect = document.getElementById('edit-pending-technique-select');
      const matchingTech = editPendingTechniques.find(t => t.name === arnaque.technique);
      if (matchingTech) {
        techniqueSelect.value = matchingTech.name;
      }
      
      // M√©dias (modifiables)
      editPendingMedias = (arnaque.preuves || []).map(url => ({ path: url, url: url }));
      updateEditPendingMediasPreview();
      
      // Produits li√©s (modifiables)
      editPendingProducts = arnaque.produits || [];
      updateEditPendingProductsList();
      
      // Stocker les donn√©es originales
      window.currentPendingEdit = arnaque;
      
    } catch (e) {
      console.error('Erreur √©dition pending:', e);
      alert('Erreur lors du chargement');
    }
  };
  
  // Mettre √† jour l'aper√ßu des m√©dias
  function updateEditPendingMediasPreview() {
    const preview = document.getElementById('edit-pending-medias-preview');
    const count = document.getElementById('edit-pending-medias-count');
    
    count.textContent = `${editPendingMedias.length} m√©dia(s)`;
    
    if (editPendingMedias.length === 0) {
      preview.innerHTML = '<div style="text-align:center; color:#8ef58e; opacity:0.5; padding:20px;">Aucun m√©dia</div>';
      return;
    }
    
    preview.innerHTML = editPendingMedias.map((media, idx) => {
      const url = media.url || media.path;
      const isVideo = /\.(mp4|webm|mov|avi)$/i.test(url);
      
      return `
        <div style="position:relative; width:100px; height:100px;">
          ${isVideo ? 
            `<video src="${url}" muted style="width:100%; height:100%; object-fit:cover; border-radius:8px; border:2px solid #8ef58e;"></video>` :
            `<img src="${url}" style="width:100%; height:100%; object-fit:cover; border-radius:8px; border:2px solid #8ef58e;">`
          }
          <button type="button" onclick="removeEditPendingMedia(${idx})" style="position:absolute; top:-6px; right:-6px; background:#e74c3c; color:#fff; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; font-weight:bold; font-size:0.9em;">√ó</button>
        </div>
      `;
    }).join('');
  }
  
  window.removeEditPendingMedia = function(idx) {
    editPendingMedias.splice(idx, 1);
    updateEditPendingMediasPreview();
  };
  
  // Mettre √† jour la liste des produits
  function updateEditPendingProductsList() {
    const list = document.getElementById('edit-pending-products-list');
    const count = document.getElementById('edit-pending-products-count');
    
    count.textContent = `${editPendingProducts.length} produit(s)`;
    
    if (editPendingProducts.length === 0) {
      list.innerHTML = '<div style="text-align:center; color:#8ef58e; opacity:0.5; padding:10px;">Aucun produit li√©</div>';
      return;
    }
    
    list.innerHTML = editPendingProducts.map((prod, idx) => `
      <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(142,245,142,0.1); border:1px solid #8ef58e; border-radius:6px; padding:8px;">
        <div style="color:#fff;">
          <strong>${prod.nom || 'Produit'}</strong>
          ${prod.prix ? `<span style="color:#ffd369; margin-left:10px;">${prod.prix}‚Ç¨</span>` : ''}
        </div>
        <button type="button" onclick="removeEditPendingProduct(${idx})" style="background:#e74c3c; color:#fff; border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:0.8em;">√ó</button>
      </div>
    `).join('');
  }
  
  window.removeEditPendingProduct = function(idx) {
    editPendingProducts.splice(idx, 1);
    updateEditPendingProductsList();
  };
  
  // Bouton ajouter m√©dias
  document.getElementById('edit-pending-add-medias')?.addEventListener('click', () => {
    openGofileSelectorForEdit((selectedMedias) => {
      editPendingMedias = [...editPendingMedias, ...selectedMedias.map(url => ({ path: url, url: url }))];
      updateEditPendingMediasPreview();
    });
  });
  
  // Bouton ajouter produit
  document.getElementById('edit-pending-add-product')?.addEventListener('click', () => {
    openProductSelectorForEdit((products) => {
      editPendingProducts = [...editPendingProducts, ...products];
      updateEditPendingProductsList();
    });
  });
  
  // Sync technique select avec textarea
  document.getElementById('edit-pending-technique-select')?.addEventListener('change', (e) => {
    if (e.target.value) {
      document.getElementById('edit-pending-technique').value = e.target.value;
    }
  });
  
  window.closePendingEditModal = function() {
    document.getElementById('edit-pending-arnaque-modal').style.display = 'none';
    window.currentPendingEdit = null;
  };
  
  // S√©lecteur GoFile simplifi√© pour √©dition
  function openGofileSelectorForEdit(callback) {
    openGofileSelectorGeneric((urls) => {
      callback(urls);
    }, true);
  }
  
  // S√©lecteur de produits pour √©dition
  function openProductSelectorForEdit(callback) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10003;display:flex;align-items:center;justify-content:center;padding:20px;';
    
    modal.innerHTML = `
      <div style="background:#2e004f;border:2px solid #ffd369;border-radius:12px;padding:20px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;">
        <h3 style="color:#ffd369;margin-bottom:15px;">üß® S√©lectionner des produits</h3>
        <input type="text" id="edit-product-search" placeholder="üîç Rechercher..." style="width:100%;padding:10px;margin-bottom:15px;border-radius:6px;border:1px solid #6a0572;background:#1a0033;color:#fff;">
        <div id="edit-product-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;max-height:400px;overflow-y:auto;"></div>
        <div style="display:flex;gap:10px;margin-top:15px;">
          <button id="edit-product-cancel" style="flex:1;background:#6c757d;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;">Annuler</button>
          <button id="edit-product-confirm" style="flex:1;background:#8ef58e;color:#240038;border:none;padding:10px;border-radius:6px;cursor:pointer;font-weight:700;">Confirmer</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    let selectedProds = [];
    let allArticles = [];
    
    // Charger les articles
    fetch('/articles.json').then(r => r.json()).then(articles => {
      allArticles = articles;
      renderProductList(articles);
    });
    
    function renderProductList(articles) {
      const list = document.getElementById('edit-product-list');
      list.innerHTML = articles.map(art => {
        const isSelected = selectedProds.some(p => p.id === art.id);
        return `
          <div onclick="toggleProduct(${art.id})" style="cursor:pointer;background:${isSelected ? 'rgba(142,245,142,0.3)' : '#3a0066'};border:2px solid ${isSelected ? '#8ef58e' : 'transparent'};border-radius:8px;padding:10px;text-align:center;">
            ${art.thumbnail ? `<img src="${art.thumbnail}" style="width:100%;height:80px;object-fit:cover;border-radius:6px;margin-bottom:5px;">` : ''}
            <div style="color:#fff;font-size:0.85em;font-weight:600;">${art.nom}</div>
            <div style="color:#ffd369;font-size:0.8em;">${art.prix}‚Ç¨</div>
          </div>
        `;
      }).join('');
    }
    
    window.toggleProduct = function(artId) {
      const art = allArticles.find(a => a.id === artId);
      if (!art) return;
      
      const idx = selectedProds.findIndex(p => p.id === artId);
      if (idx >= 0) {
        selectedProds.splice(idx, 1);
      } else {
        selectedProds.push({ id: art.id, nom: art.nom, prix: art.prix });
      }
      renderProductList(allArticles);
    };
    
    document.getElementById('edit-product-search').oninput = (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allArticles.filter(a => a.nom.toLowerCase().includes(term));
      renderProductList(filtered);
    };
    
    document.getElementById('edit-product-cancel').onclick = () => modal.remove();
    document.getElementById('edit-product-confirm').onclick = () => {
      callback(selectedProds);
      modal.remove();
    };
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
  }

  // Gestionnaire de soumission du formulaire d'√©dition
  document.getElementById('edit-pending-arnaque-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const idx = parseInt(document.getElementById('edit-pending-idx').value);
    const technique = document.getElementById('edit-pending-technique').value.trim();
    
    if (!technique) {
      alert('‚ö†Ô∏è La technique est obligatoire');
      return;
    }
    
    if (!window.currentPendingEdit) {
      alert('Erreur: donn√©es manquantes');
      return;
    }
    
    try {
      // Charger les donn√©es
      const [pendingRes, arnaquesRes] = await Promise.all([
        fetch("/api/arnaques-pending"),
        fetch("/arnaques.json")
      ]);
      
      const pending = await pendingRes.json();
      const arnaques = await arnaquesRes.json();
      
      // Cr√©er la nouvelle arnaque avec les donn√©es MODIFI√âES
      const nouvelleArnaque = {
        id: Date.now(),
        nom: window.currentPendingEdit.nom,  // NON modifiable
        username: window.currentPendingEdit.arnaqueurId,  // NON modifiable
        techniques: technique,  // MODIFIABLE
        produits: editPendingProducts,  // MODIFIABLE
        reseaux: [],
        medias: editPendingMedias.map(m => m.path || m.url),  // MODIFIABLE
        preuves: editPendingMedias.map(m => m.path || m.url),  // MODIFIABLE
        description: technique,
        verified: true,
        datePublication: new Date().toISOString(),
        // Conserver les infos du d√©nonciateur pour tra√ßabilit√©
        _denoncePar: window.currentPendingEdit.denonceurReel || window.currentPendingEdit.denonceur,
        _isAnonymous: window.currentPendingEdit.isAnonymous,
        _dateSignalement: window.currentPendingEdit.date
      };
      
      console.log('[Edit Pending] Publication:', nouvelleArnaque);
      
      // Ajouter aux arnaques actives
      arnaques.push(nouvelleArnaque);
      await fetch("/api/arnaques", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(arnaques)
      });
      
      // Retirer de pending
      pending.splice(idx, 1);
      await fetch("/api/arnaques-pending", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(pending)
      });
      
      showToast('‚úÖ Arnaque modifi√©e et publi√©e !', 'success');
      closePendingEditModal();
      loadArnaquesPending();
      
    } catch (e) {
      console.error('Erreur publication arnaque modifi√©e:', e);
      alert('Erreur lors de la publication');
    }
  });

  window.deletePendingArnaque = async function(idx) {
    if (!confirm('√ätes-vous s√ªr de vouloir rejeter ce signalement ?')) return;
    
    try {
      const res = await fetch("/api/arnaques-pending");
      const pending = await res.json();
      
      pending.splice(idx, 1);
      
      await fetch("/api/arnaques-pending", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(pending)
      });
      
      alert('üóëÔ∏è Signalement rejet√©');
      loadArnaquesPending();
    } catch (e) {
      console.error('Erreur suppression pending:', e);
      alert('Erreur lors de la suppression');
    }
  };

  window.deleteArnaque = async function(idx) {
    if (!confirm('Supprimer cet arnaqueur ?')) return;
    try {
      const res = await fetch('/api/arnaques');
      const arnaques = await res.json();
      arnaques.splice(idx, 1);
      await fetch('/api/arnaques', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(arnaques)
      });
      loadArnaques();
    } catch (e) {
      showToast('‚ùå Erreur lors de la suppression', 'error');
    }
  };

  // Fonction pour archiver une arnaque
  window.archiveArnaque = async function(idx) {
    try {
      const res = await fetch('/api/arnaques');
      const arnaques = await res.json();
      const arnaque = arnaques[idx];
      
      // R√©cup√©rer les arnaques archiv√©es
      const archivedRes = await fetch('/api/arnaques-archived');
      let archived = [];
      if (archivedRes.ok) {
        archived = await archivedRes.json();
      }
      
      // Ajouter la date d'archivage
      arnaque.archivedDate = new Date().toISOString();
      archived.push(arnaque);
      
      // Supprimer de la liste active
      arnaques.splice(idx, 1);
      
      // Sauvegarder les deux listes
      await Promise.all([
        fetch('/api/arnaques', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(arnaques)
        }),
        fetch('/api/arnaques-archived', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(archived)
        })
      ]);
      
      showToast('üì¶ Arnaque archiv√©e avec succ√®s', 'success');
      loadArnaques();
    } catch (e) {
      console.error(e);
      showToast('‚ùå Erreur lors de l\'archivage', 'error');
    }
  };

  // Fonction pour restaurer une arnaque archiv√©e
  window.restoreArnaque = async function(idx) {
    try {
      const archivedRes = await fetch('/api/arnaques-archived');
      const archived = await archivedRes.json();
      const arnaque = archived[idx];
      
      // Supprimer la date d'archivage
      delete arnaque.archivedDate;
      
      // R√©cup√©rer les arnaques actives
      const res = await fetch('/api/arnaques');
      const arnaques = await res.json();
      arnaques.push(arnaque);
      
      // Supprimer des archiv√©es
      archived.splice(idx, 1);
      
      // Sauvegarder les deux listes
      await Promise.all([
        fetch('/api/arnaques', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(arnaques)
        }),
        fetch('/api/arnaques-archived', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(archived)
        })
      ]);
      
      showToast('‚úÖ Arnaque restaur√©e avec succ√®s', 'success');
      loadArnaquesArchived();
    } catch (e) {
      console.error(e);
      showToast('‚ùå Erreur lors de la restauration', 'error');
    }
  };

  // Fonction pour supprimer d√©finitivement une arnaque archiv√©e
  window.deleteArchivedArnaque = async function(idx) {
    try {
      const archivedRes = await fetch('/api/arnaques-archived');
      const archived = await archivedRes.json();
      archived.splice(idx, 1);
      
      await fetch('/api/arnaques-archived', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(archived)
      });
      
      showToast('üóëÔ∏è Arnaque supprim√©e d√©finitivement', 'success');
      loadArnaquesArchived();
    } catch (e) {
      console.error(e);
      showToast('‚ùå Erreur lors de la suppression', 'error');
    }
  };

  // Fonction pour charger les arnaques archiv√©es
  window.loadArnaquesArchived = async function() {
    try {
      const res = await fetch('/api/arnaques-archived');
      let archived = [];
      if (res.ok) {
        archived = await res.json();
      }
      
      const list = document.getElementById("arnaquesArchivedList");
      if (!list) return;
      
      list.innerHTML = '';
      
      if (archived.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#8ef58e;padding:40px;font-style:italic;">Aucune arnaque archiv√©e</div>';
        return;
      }
      
      archived.forEach((arnaque, idx) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        
        const archivedDate = arnaque.archivedDate ? new Date(arnaque.archivedDate).toLocaleDateString('fr-FR') : '';
        
        card.innerHTML = `
          <div class="article-card">
            <div class="product-card">
              <strong>${arnaque.nom || arnaque.username}</strong> 
              ${arnaque.username && arnaque.nom ? `<span style="color:#8ef58e;font-size:0.9em;"> (@${arnaque.username})</span>` : ''} 
              <span style="color:#ff9800;">üì¶ ARCHIV√â</span>
              ${archivedDate ? `<span style="color:#999;font-size:0.85em;"> (${archivedDate})</span>` : ''}<br>
              <span style="font-size:0.95em;">${arnaque.techniques || 'Techniques non sp√©cifi√©es'}</span><br>
              <span style="font-size:0.85em; color:#ffd369;">${arnaque.reseaux || 'R√©seaux non sp√©cifi√©s'}</span>
            </div>
            <div class="article-actions">
              <button onclick="restoreArnaque(${idx})" style="background:#4caf50;">‚Ü©Ô∏è Restaurer</button>
              <button onclick="showConfirm('Supprimer d√©finitivement cette arnaque ?', () => deleteArchivedArnaque(${idx}))" style="background:#e74c3c;">üóëÔ∏è Supprimer</button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement arnaques archiv√©es:', e);
    }
  };

  // Fonctions pour les preuves
  window.editPreuve = function(preuve, idx) {
    document.getElementById('titre-preuve').value = preuve.titre;
    document.getElementById('id-preuve').value = preuve.id;
    document.getElementById('client-preuve').value = preuve.client || '';
    document.getElementById('date-preuve').value = preuve.date || '';
    document.getElementById('description-preuve').value = preuve.description;
  };

  window.deletePreuve = async function(idx) {
    if (!confirm('Supprimer cette preuve ?')) return;
    try {
      const res = await fetch('/api/preuves');
      const preuves = await res.json();
      preuves.splice(idx, 1);
      await fetch('/api/preuves', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(preuves)
      });
      loadPreuves();
    } catch (e) {
      showToast('? Erreur lors de la suppression', 'error');
    }
  };

  // Initialisation : ouvrir sur "Mes articles" avec menu visible
  setTimeout(() => {
    showSection('articles');
    const menuModal = document.getElementById('menu-modal');
    if (menuModal) {
      menuModal.style.display = 'block';
    }
  }, 100);

function showReviewModal(preuve) {
  const modal = document.getElementById('review-detail-modal');
  modal.classList.add('show');

  // Remplir infos
  document.getElementById('review-detail-avatar').textContent = preuve.username[0].toUpperCase();
  document.getElementById('review-detail-username').textContent = preuve.username;
  document.getElementById('review-detail-date').textContent = preuve.date;
  document.getElementById('review-detail-title').textContent = preuve.title;
  document.getElementById('review-detail-text').textContent = preuve.text;
  document.getElementById('review-detail-rating').textContent = "‚òÖ".repeat(preuve.rating);
  document.getElementById('review-detail-verified').style.display = preuve.verified ? 'inline-block' : 'none';

  // Galerie
  const gallery = document.getElementById('review-detail-gallery');
  gallery.innerHTML = '';
  const mainMedia = document.getElementById('review-detail-main-media');
  mainMedia.innerHTML = '';

  preuve.media.forEach((m, idx) => {
    let el;
    if (m.type === 'img') {
      el = document.createElement('img');
      el.src = m.src;
    } else {
      el = document.createElement('video');
      el.src = m.src;
      el.controls = true;
    }
    el.addEventListener('click', () => changeReviewMainMedia(m));
    if (idx === 0) changeReviewMainMedia(m);
    gallery.appendChild(el);
  });
}

function changeReviewMainMedia(media) {
  const container = document.getElementById('review-detail-main-media');
  container.innerHTML = '';
  let el;
  if (media.type === 'img') {
    el = document.createElement('img');
    el.src = media.src;
  } else {
    el = document.createElement('video');
    el.src = media.src;
    el.controls = true;
  }
  container.appendChild(el);
}

document.getElementById('close-review-detail-modal').addEventListener('click', () => {
  document.getElementById('review-detail-modal').classList.remove('show');
});

// ==================== EXPLORATEUR GOFILE ADMIN ====================

let adminGofileFiles = [];
let adminFilteredFiles = [];
let adminSelectedFiles = new Set();
let adminCurrentFilter = 'all';
let adminSearchTerm = '';
let currentGofileFolderId = null; // ID du dossier courant
let gofileFolderStack = []; // Pile de navigation pour le breadcrumb

function initGofileExplorer() {
  console.log('[Admin GoFile] Initialisation...');
  loadGofileRootFolder();
  bindGofileEvents();
}

function bindGofileEvents() {
  // Recherche
  const searchInput = document.getElementById('admin-search');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      adminSearchTerm = e.target.value.toLowerCase();
      filterAndDisplayGofileFiles();
    });
  }

  // Filtres
  document.querySelectorAll('.admin-filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.admin-filter-btn').forEach(b => {
        b.style.background = '#6a0572';
        b.style.color = '#fff';
        b.classList.remove('active');
      });
      e.target.style.background = '#ffd369';
      e.target.style.color = '#2e003e';
      e.target.classList.add('active');
      adminCurrentFilter = e.target.dataset.filter;
      filterAndDisplayGofileFiles();
    });
  });

  // Actualiser
  const refreshBtn = document.getElementById('admin-refresh');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', () => loadGofileFolder(currentGofileFolderId));
  }

  // Nouveau dossier
  const createFolderBtn = document.getElementById('admin-create-folder');
  if (createFolderBtn) {
    createFolderBtn.addEventListener('click', createGofileFolder);
  }

  // R√©g√©n√©rer le mapping automatique
  const regenerateMappingBtn = document.getElementById('admin-regenerate-mapping');
  if (regenerateMappingBtn) {
    regenerateMappingBtn.addEventListener('click', regenerateMapping);
  }

  // D√©s√©lectionner
  const clearBtn = document.getElementById('admin-clear-selection');
  if (clearBtn) {
    clearBtn.addEventListener('click', clearGofileSelection);
  }

  // Utiliser s√©lection pour l'article
  const useSelectedBtn = document.getElementById('admin-use-selected');
  if (useSelectedBtn) {
    useSelectedBtn.addEventListener('click', useSelectedForArticle);
  }
}

async function createGofileFolder() {
  const folderName = prompt('Nom du nouveau dossier:');
  if (!folderName || !folderName.trim()) return;
  
  const parentId = currentGofileFolderId;
  
  try {
    const response = await fetch('/api/gofile/folder', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Basic ' + btoa(adminCredentials.user + ':' + adminCredentials.pass)
      },
      body: JSON.stringify({ 
        folderName: folderName.trim(),
        parentFolderId: parentId
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast(`‚úÖ Dossier "${folderName}" cr√©√© !`, 'success');
      loadGofileFolder(currentGofileFolderId);
    } else {
      throw new Error(result.error || 'Erreur inconnue');
    }
  } catch (error) {
    console.error('[GoFile] Erreur cr√©ation dossier:', error);
    showToast(`‚ùå Erreur: ${error.message}`, 'error');
  }
}

async function regenerateMapping() {
  const btn = document.getElementById('admin-regenerate-mapping');
  if (!btn) return;

  // Sauvegarder le texte original et d√©sactiver le bouton
  const originalText = btn.innerHTML;
  btn.innerHTML = '‚è≥ G√©n√©ration...';
  btn.disabled = true;
  btn.style.background = '#666';

  try {
    console.log('[Admin] R√©g√©n√©ration du mapping GoFile...');
    
    const response = await fetch('/api/regenerate-mapping', {
      method: 'GET',
      headers: {
        'Authorization': 'Basic ' + btoa(adminCredentials.user + ':' + adminCredentials.pass)
      }
    });

    if (!response.ok) {
      throw new Error(`Erreur ${response.status}: ${response.statusText}`);
    }

    const result = await response.json();
    
    if (result.success) {
      // Afficher un message de succ√®s
      btn.innerHTML = '‚úÖ G√©n√©r√© !';
      btn.style.background = '#28a745';
      
      // Afficher les d√©tails
      console.log(`‚úÖ Mapping g√©n√©r√©: ${result.count} fichiers`);
      showToast(`‚úÖ Mapping automatique g√©n√©r√© avec succ√®s ! ${result.count} fichiers associ√©s. Les images devraient maintenant s'afficher depuis GoFile.`, 'success');
      
      // Recharger les fichiers pour voir les changements
      setTimeout(() => {
        loadGofileFolder(currentGofileFolderId);
      }, 1000);
      
    } else {
      throw new Error(result.error || 'Erreur inconnue');
    }

  } catch (error) {
    console.error('[Admin] Erreur r√©g√©n√©ration mapping:', error);
    btn.innerHTML = '‚ùå Erreur';
    btn.style.background = '#dc3545';
    showToast(`‚ùå Erreur lors de la g√©n√©ration du mapping: ${error.message}. V√©rifiez que votre cl√© API GoFile est configur√©e.`, 'error');
  }

  // Restaurer le bouton apr√®s 3 secondes
  setTimeout(() => {
    btn.innerHTML = originalText;
    btn.style.background = '#ff6b35';
    btn.disabled = false;
  }, 3000);
}

// Charger le dossier racine GoFile
async function loadGofileRootFolder() {
  currentGofileFolderId = null;
  gofileFolderStack = [];
  await loadGofileFolder(null);
}

// Charger un dossier GoFile sp√©cifique
async function loadGofileFolder(folderId) {
  const gallery = document.getElementById('admin-gallery');
  if (!gallery) return;

  currentGofileFolderId = folderId;

  gallery.innerHTML = '<div style="text-align: center; padding: 60px; color: #ffd369;"><div style="width: 40px; height: 40px; border: 4px solid #4a1a5c; border-top: 4px solid #ffd369; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>Chargement des fichiers GoFile...</div>';

  try {
    const url = folderId ? `/api/gofile/contents/${folderId}` : '/images';
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Erreur ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    
    // Mettre √† jour le breadcrumb
    updateGofileBreadcrumb(data);
    
    // Mapper les fichiers/dossiers
    adminGofileFiles = data.map(item => ({
      ...item,
      url: item.type === 'folder' ? null : `/media/${item.id}?name=${encodeURIComponent(item.name)}&server=${item.server || 'store1'}`,
      fileType: item.type === 'folder' ? 'folder' : getGofileFileType(item.name),
      extension: item.type === 'folder' ? 'folder' : getGofileFileExtension(item.name),
      formattedSize: item.type === 'folder' ? `${item.childrenCount || 0} √©l√©ments` : formatGofileFileSize(item.size),
      formattedDate: formatGofileDate(item.createTime)
    }));

    filterAndDisplayGofileFiles();
    updateGofileStats();
    console.log(`[Admin GoFile] ${adminGofileFiles.length} √©l√©ments charg√©s`);

  } catch (error) {
    console.error('[Admin GoFile] Erreur:', error);
    gallery.innerHTML = `
      <div style="text-align: center; padding: 60px; color: #dc3545;">
        <div style="font-size: 3rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
        <div><strong>Erreur de chargement</strong></div>
        <div>${error.message}</div>
        <button onclick="loadGofileFolder(currentGofileFolderId)" style="margin-top: 20px; padding: 10px 20px; background: #d72660; color: white; border: none; border-radius: 5px; cursor: pointer;">
          R√©essayer
        </button>
      </div>
    `;
  }
}

// Mettre √† jour le fil d'Ariane
function updateGofileBreadcrumb(data) {
  const breadcrumbPath = document.getElementById('breadcrumb-path');
  if (!breadcrumbPath) return;
  
  let html = '<button onclick="loadGofileRootFolder()" style="background:#ffd369; color:#2e003e; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-weight:600;">üè† Racine</button>';
  
  gofileFolderStack.forEach((folder, index) => {
    html += ` <span style="color:#888;">‚Ä∫</span> `;
    html += `<button onclick="navigateToFolder(${index})" style="background:#6a0572; color:#fff; border:none; padding:4px 10px; border-radius:4px; cursor:pointer;">${folder.name}</button>`;
  });
  
  breadcrumbPath.innerHTML = html;
}

// Naviguer vers un dossier du breadcrumb
function navigateToFolder(stackIndex) {
  // Tronquer la pile au niveau voulu
  gofileFolderStack = gofileFolderStack.slice(0, stackIndex + 1);
  const folder = gofileFolderStack[stackIndex];
  loadGofileFolder(folder.id);
}

// Entrer dans un dossier
function enterGofileFolder(folderId, folderName) {
  gofileFolderStack.push({ id: folderId, name: folderName });
  loadGofileFolder(folderId);
}

function filterAndDisplayGofileFiles() {
  adminFilteredFiles = adminGofileFiles.filter(file => {
    const typeMatch = adminCurrentFilter === 'all' || 
                      file.fileType === adminCurrentFilter ||
                      (adminCurrentFilter === 'folder' && file.type === 'folder');
    const searchMatch = !adminSearchTerm || file.name.toLowerCase().includes(adminSearchTerm);
    return typeMatch && searchMatch;
  });

  displayGofileFiles();
  updateGofileStats();
}

function displayGofileFiles() {
  const gallery = document.getElementById('admin-gallery');
  if (!gallery) return;

  if (adminFilteredFiles.length === 0) {
    gallery.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 80px; color: #ffd369;">
        <div style="font-size: 5rem; margin-bottom: 30px; opacity: 0.3;">üìÅ</div>
        <h3 style="font-size: 1.5rem; margin-bottom: 15px;">Dossier vide</h3>
        <p>Aucun fichier dans ce dossier ou vos filtres ne correspondent √† rien.</p>
      </div>
    `;
    return;
  }

  const filesHTML = adminFilteredFiles.map(file => createGofileFileHTML(file)).join('');
  gallery.innerHTML = filesHTML;

  // Ajouter les √©v√©nements de clic (seulement pour les fichiers, pas les dossiers)
  gallery.querySelectorAll('.admin-file-item:not(.folder-item)').forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      const fileId = item.dataset.fileId;
      toggleGofileFileSelection(fileId);
    });
  });
}

function createGofileFileHTML(file) {
  const isSelected = adminSelectedFiles.has(file.id);
  const selectedClass = isSelected ? 'selected' : '';
  const isFolder = file.type === 'folder';
  
  if (isFolder) {
    // Affichage pour les dossiers
    return `
      <div class="admin-file-item folder-item" data-file-id="${file.id}" data-folder-name="${file.name}" style="background: #3a2a5c; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; border: 3px solid #ffd369; position: relative;" ondblclick="enterGofileFolder('${file.id}', '${file.name.replace(/'/g, "\\'")}')">
        <div style="height: 150px; display: flex; align-items: center; justify-content: center; background: #4a3a6c; overflow: hidden;">
          <div style="font-size: 4rem;">üìÅ</div>
        </div>
        <div style="padding: 15px;">
          <div style="font-weight: 600; margin-bottom: 8px; word-break: break-word; color: #ffd369; font-size: 0.9rem;" title="${file.name}">${truncateGofileFileName(file.name, 30)}</div>
          <div style="display: flex; justify-content: space-between; align-items: center; color: #ffd369; font-size: 0.8rem;">
            <span style="background: #ffd369; color: #2e003e; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; text-transform: uppercase; font-weight: 600;">DOSSIER</span>
            <span>${file.formattedSize}</span>
          </div>
          <div style="margin-top: 8px; display: flex; gap: 5px;">
            <button onclick="event.stopPropagation(); deleteGofileContent('${file.id}', '${file.name.replace(/'/g, "\\'")}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">üóëÔ∏è Suppr</button>
          </div>
        </div>
      </div>
    `;
  }
  
  // Affichage pour les fichiers
  return `
    <div class="admin-file-item ${selectedClass}" data-file-id="${file.id}" style="background: #4a1a5c; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; border: 3px solid ${isSelected ? '#ffd369' : 'transparent'}; position: relative;">
      ${isSelected ? '<div style="position: absolute; top: 10px; right: 10px; background: #ffd369; color: #2e003e; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 2;">‚úì</div>' : ''}
      <div style="height: 150px; display: flex; align-items: center; justify-content: center; background: #6a0572; overflow: hidden;">
        ${getGofileMediaHTML(file)}
      </div>
      <div style="padding: 15px;">
        <div style="font-weight: 600; margin-bottom: 8px; word-break: break-word; color: #fff; font-size: 0.9rem;" title="${file.name}">${truncateGofileFileName(file.name, 30)}</div>
        <div style="display: flex; justify-content: space-between; align-items: center; color: #ffd369; font-size: 0.8rem;">
          <span style="background: ${file.fileType === 'image' ? '#d4edda' : file.fileType === 'video' ? '#cce5ff' : '#e9ecef'}; color: ${file.fileType === 'image' ? '#155724' : file.fileType === 'video' ? '#004085' : '#495057'}; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; text-transform: uppercase; font-weight: 600;">${file.extension}</span>
          <span>${file.formattedSize}</span>
        </div>
        <div style="margin-top: 8px; display: flex; gap: 5px;">
          <button onclick="event.stopPropagation(); deleteGofileContent('${file.id}', '${file.name.replace(/'/g, "\\'")}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">üóëÔ∏è Suppr</button>
        </div>
      </div>
    </div>
  `;
}

// Supprimer un contenu GoFile
async function deleteGofileContent(contentId, contentName) {
  if (!confirm(`‚ö†Ô∏è Supprimer "${contentName}" d√©finitivement ?`)) return;
  
  try {
    const response = await fetch(`/api/gofile/content/${contentId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Basic ' + btoa(adminCredentials.user + ':' + adminCredentials.pass)
      }
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast(`‚úÖ "${contentName}" supprim√©`, 'success');
      loadGofileFolder(currentGofileFolderId);
    } else {
      throw new Error(result.error || 'Erreur inconnue');
    }
  } catch (error) {
    console.error('[GoFile] Erreur suppression:', error);
    showToast(`‚ùå Erreur: ${error.message}`, 'error');
  }
}

function getGofileMediaHTML(file) {
  switch (file.fileType) {
    case 'image':
      return `<img src="${file.url}" alt="${file.name}" style="max-width: 100%; max-height: 100%; object-fit: cover;" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div style="display: none; font-size: 3rem; color: #ffd369;">üñºÔ∏è</div>`;
    case 'video':
      const mimeType = getVideoMimeType(file.extension);
      return `<video style="max-width: 100%; max-height: 100%; object-fit: cover;" preload="metadata" muted>
                <source src="${file.url}" type="${mimeType}">
                <div style="font-size: 3rem; color: #ffd369;">üé•</div>
              </video>`;
    default:
      return `<div style="font-size: 3rem; color: #ffd369;">${getGofileFileIcon(file.extension)}</div>`;
  }
}

function getVideoMimeType(extension) {
  const mimeTypes = {
    'mp4': 'video/mp4',
    'webm': 'video/webm',
    'avi': 'video/avi',
    'mov': 'video/quicktime',
    'wmv': 'video/x-ms-wmv',
    'flv': 'video/x-flv',
    'mkv': 'video/x-matroska'
  };
  return mimeTypes[extension.toLowerCase()] || `video/${extension}`;
}

function getGofileFileType(filename) {
  const extension = getGofileFileExtension(filename);
  const imageExtensions = ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp', 'ico'];
  const videoExtensions = ['mp4', 'webm', 'avi', 'mov', 'wmv', 'flv', 'mkv'];
  
  if (imageExtensions.includes(extension)) return 'image';
  if (videoExtensions.includes(extension)) return 'video';
  return 'other';
}

function getGofileFileExtension(filename) {
  return filename.split('.').pop().toLowerCase();
}

function getGofileFileIcon(extension) {
  const icons = {
    pdf: 'üìÑ', txt: 'üìù', doc: 'üìù', docx: 'üìù',
    zip: 'üì¶', rar: 'üì¶', '7z': 'üì¶',
    mp3: 'üéµ', wav: 'üéµ', flac: 'üéµ',
    exe: '‚öôÔ∏è', msi: '‚öôÔ∏è',
    html: 'üåê', css: 'üé®', js: '‚ö°',
    json: 'üìã', xml: 'üìã'
  };
  return icons[extension] || 'üìÑ';
}

function formatGofileFileSize(bytes) {
  if (!bytes) return '0 B';
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  const size = (bytes / Math.pow(1024, i)).toFixed(i === 0 ? 0 : 1);
  return `${size} ${sizes[i]}`;
}

function formatGofileDate(timestamp) {
  if (!timestamp) return 'Date inconnue';
  try {
    // GoFile retourne un timestamp Unix en secondes
    const date = new Date(timestamp * 1000);
    return date.toLocaleDateString('fr-FR', {
      day: '2-digit', month: '2-digit', year: 'numeric'
    });
  } catch {
    return 'Date invalide';
  }
}

function truncateGofileFileName(filename, maxLength = 30) {
  if (filename.length <= maxLength) return filename;
  const extension = getGofileFileExtension(filename);
  const nameWithoutExt = filename.substring(0, filename.lastIndexOf('.'));
  const truncatedName = nameWithoutExt.substring(0, maxLength - extension.length - 4);
  return `${truncatedName}...${extension}`;
}

function toggleGofileFileSelection(fileId) {
  if (adminSelectedFiles.has(fileId)) {
    adminSelectedFiles.delete(fileId);
  } else {
    adminSelectedFiles.add(fileId);
  }
  
  updateGofileSelectionUI();
  updateGofileSelectionInfo();
}

function updateGofileSelectionUI() {
  document.querySelectorAll('.admin-file-item:not(.folder-item)').forEach(item => {
    const fileId = item.dataset.fileId;
    const isSelected = adminSelectedFiles.has(fileId);
    
    if (isSelected) {
      item.style.borderColor = '#ffd369';
      item.classList.add('selected');
      if (!item.querySelector('.selected-indicator')) {
        item.insertAdjacentHTML('afterbegin', '<div class="selected-indicator" style="position: absolute; top: 10px; right: 10px; background: #ffd369; color: #2e003e; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 2;">‚úì</div>');
      }
    } else {
      item.style.borderColor = 'transparent';
      item.classList.remove('selected');
      const indicator = item.querySelector('.selected-indicator');
      if (indicator) indicator.remove();
    }
  });
}

function updateGofileSelectionInfo() {
  const count = adminSelectedFiles.size;
  const selectionText = document.getElementById('admin-selection-text');
  const selectionInfo = document.getElementById('admin-selection-info');
  
  if (selectionText) {
    selectionText.textContent = `${count} fichier${count > 1 ? 's' : ''} s√©lectionn√©${count > 1 ? 's' : ''}`;
  }
  
  if (selectionInfo) {
    if (count > 0) {
      selectionInfo.style.display = 'flex';
    } else {
      selectionInfo.style.display = 'none';
    }
  }
  
  updateGofileStats();
}

function updateGofileStats() {
  const totalFilesSpan = document.getElementById('admin-total-files');
  const selectedCountSpan = document.getElementById('admin-selected-count');
  const filteredCountSpan = document.getElementById('admin-filtered-count');
  
  if (totalFilesSpan) totalFilesSpan.textContent = `√âl√©ments: ${adminGofileFiles.length}`;
  if (selectedCountSpan) selectedCountSpan.textContent = `S√©lectionn√©s: ${adminSelectedFiles.size}`;
  if (filteredCountSpan) filteredCountSpan.textContent = `Affich√©s: ${adminFilteredFiles.length}`;
}

function clearGofileSelection() {
  adminSelectedFiles.clear();
  updateGofileSelectionUI();
  updateGofileSelectionInfo();
}

function useSelectedForArticle() {
  const selectedFiles = getSelectedGofileFilesAdmin();
  console.log('[Debug] Fichiers s√©lectionn√©s:', selectedFiles);
  
  if (selectedFiles.length === 0) {
    showToast('‚ö†Ô∏è Aucun fichier s√©lectionn√©', 'error');
    return;
  }

  // Convertir les fichiers GoFile en format compatible article
  const mediaFiles = selectedFiles.map(file => ({
    type: 'gofile',
    url: file.url,
    id: file.id,
    name: file.name,
    filename: file.name,
    mime_type: file.mimetype || file.mime_type,
    server: file.server
  }));

  console.log('[Debug] M√©dias format√©s:', mediaFiles);

  // V√©rifier si on est en mode variante
  if (window.varianteMediaTarget && window.tempVarianteMedia) {
    // Ajouter aux m√©dias de la variante
    window.tempVarianteMedia.push(...mediaFiles);
    console.log('[Debug] M√©dias ajout√©s √† la variante:', window.tempVarianteMedia);
    updateVarianteMediaDisplay();
    showToast(`‚úì ${mediaFiles.length} m√©dia(s) ajout√©(s) √† la variante`, 'success');
    // Ne pas retourner √† la section article, rester sur l'explorateur
    // L'utilisateur fermera le modal variante manuellement
    clearGofileSelection();
    showSection('articles'); // Retourner au formulaire article avec le modal variante ouvert
    window.varianteMediaTarget = false;
  } else {
    // Ajouter √† la liste des m√©dias de l'article
    if (currentEditingArticle && currentEditingArticle.medias) {
      currentEditingArticle.medias.push(...mediaFiles);
      console.log('[Debug] M√©dias ajout√©s √† currentEditingArticle:', currentEditingArticle);
    } else {
      console.warn('[Admin] Pas d\'article en cours d\'√©dition');
      // Si pas d'article en cours, on peut les stocker temporairement
      if (!window.tempSelectedMedia) window.tempSelectedMedia = [];
      window.tempSelectedMedia.push(...mediaFiles);
      console.log('[Debug] M√©dias stock√©s temporairement:', window.tempSelectedMedia);
    }

    // Retourner √† la section article
    showSection('articles');
    
    // Actualiser l'affichage des m√©dias dans le formulaire article
    updateArticleMediaDisplay();
  }
  
  // Vider la s√©lection
  clearGofileSelection();
  
}

// API pour r√©cup√©rer les fichiers s√©lectionn√©s
function getSelectedGofileFilesAdmin() {
  return adminGofileFiles.filter(file => adminSelectedFiles.has(file.id));
}

function getSelectedGofileUrlsAdmin() {
  return getSelectedGofileFilesAdmin().map(file => file.url);
}

// Ouvrir le s√©lecteur GoFile pour admin>infos (s√©lection unique)
function openGofileSelectorForInfos(callback) {
  // Sauvegarder le callback et le contexte
  window.infosMediaCallback = callback;
  
  // Vider la s√©lection actuelle
  adminSelectedFiles.clear();
  updateGofileSelectionUI();
  updateGofileSelectionInfo();
  
  // Cr√©er le modal de s√©lection
  const modal = document.createElement('div');
  modal.id = 'gofile-selector-modal';
  modal.className = 'modal';
  modal.style.cssText = 'display:flex;align-items:center;justify-content:center;z-index:10002;';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width:1200px;width:95%;max-height:90vh;background:linear-gradient(135deg, #2e003e, #6a0572);border-radius:16px;padding:0;overflow:hidden;display:flex;flex-direction:column;">
      <div style="background:linear-gradient(135deg, #ffd369, #ffb347);padding:20px;display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;color:#2e003e;font-size:1.3em;">üé® S√©lectionner un m√©dia GoFile</h3>
        <button id="close-pd-selector" style="background:none;border:none;color:#2e003e;font-size:2em;cursor:pointer;width:40px;height:40px;">√ó</button>
      </div>
      
      <div style="padding:20px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:15px;">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <input type="text" id="pd-search-infos" placeholder="üîç Rechercher..." style="flex:1;min-width:200px;padding:10px;border-radius:8px;border:2px solid #ffd369;background:rgba(255,255,255,0.1);color:#fff;font-size:1em;">
          <button class="pd-filter-btn active" data-filter="all" style="padding:8px 16px;border:2px solid #ffd369;background:#ffd369;color:#2e003e;border-radius:20px;cursor:pointer;font-weight:600;">Tous</button>
          <button class="pd-filter-btn" data-filter="image" style="padding:8px 16px;border:2px solid #6a0572;background:#6a0572;color:#fff;border-radius:20px;cursor:pointer;">Images</button>
          <button class="pd-filter-btn" data-filter="video" style="padding:8px 16px;border:2px solid #6a0572;background:#6a0572;color:#fff;border-radius:20px;cursor:pointer;">Vid√©os</button>
        </div>
        
        <div id="pd-gallery-infos" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;max-height:calc(90vh - 220px);overflow-y:auto;"></div>
      </div>
      
      <div style="background:rgba(0,0,0,0.3);padding:15px;display:flex;justify-content:space-between;align-items:center;">
        <div id="pd-selected-info" style="color:#ffd369;font-weight:600;">S√©lectionnez un m√©dia</div>
        <div style="display:flex;gap:10px;">
          <button id="pd-cancel-infos" style="background:#6d6d6d;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">Annuler</button>
          <button id="pd-use-infos" style="background:#8ef58e;color:#240038;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:700;">Utiliser</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.classList.add('show');
  
  // Charger les m√©dias GoFile
  loadGofileForInfos();
  
  // Events
  document.getElementById('close-pd-selector').onclick = () => {
    modal.classList.remove('show');
    setTimeout(() => modal.remove(), 300);
  };
  
  document.getElementById('pd-cancel-infos').onclick = () => {
    modal.classList.remove('show');
    setTimeout(() => modal.remove(), 300);
  };
  
  document.getElementById('pd-use-infos').onclick = () => {
    const selected = getSelectedGofileFilesAdmin();
    if (selected.length === 0) {
      showToast('‚ö†Ô∏è Veuillez s√©lectionner un m√©dia', 'warning');
      return;
    }
    const file = selected[0];
    // Appeler le callback avec l'URL et la largeur par d√©faut
    if (window.infosMediaCallback) {
      window.infosMediaCallback(file.url, 'max-width:100%;');
    }
    modal.classList.remove('show');
    setTimeout(() => modal.remove(), 300);
  };
  
  // Recherche
  document.getElementById('pd-search-infos').addEventListener('input', (e) => {
    adminSearchTerm = e.target.value.toLowerCase();
    renderGofileGalleryForInfos();
  });
  
  // Filtres
  document.querySelectorAll('.pd-filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.pd-filter-btn').forEach(b => {
        b.style.background = '#6a0572';
        b.style.color = '#fff';
        b.classList.remove('active');
      });
      e.target.style.background = '#ffd369';
      e.target.style.color = '#2e003e';
      e.target.classList.add('active');
      adminCurrentFilter = e.target.dataset.filter;
      renderGofileGalleryForInfos();
    });
  });
}

async function loadGofileForInfos() {
  const gallery = document.getElementById('pd-gallery-infos');
  if (!gallery) return;
  
  gallery.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#ffd369;">Chargement...</div>';
  
  try {
    if (adminGofileFiles.length === 0) {
      const response = await fetch('/images');
      if (!response.ok) throw new Error(`Erreur ${response.status}`);
      const data = await response.json();
      adminGofileFiles = data.map(file => ({
        ...file,
        url: file.type === 'folder' ? null : `/media/${file.id}?name=${encodeURIComponent(file.name)}&server=${file.server || 'store1'}`,
        fileType: file.type === 'folder' ? 'folder' : getGofileFileType(file.name),
        extension: file.type === 'folder' ? 'folder' : getGofileFileExtension(file.name),
        formattedSize: file.type === 'folder' ? `${file.childrenCount || 0} √©l√©ments` : formatGofileFileSize(file.size),
        formattedDate: formatGofileDate(file.createTime)
      }));
    }
    renderGofileGalleryForInfos();
  } catch (error) {
    gallery.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#ff6b6b;">Erreur de chargement</div>';
    console.error('[GoFile Infos] Erreur:', error);
  }
}

function renderGofileGalleryForInfos() {
  const gallery = document.getElementById('pd-gallery-infos');
  if (!gallery) return;
  
  // Filtrer
  let filtered = adminGofileFiles.filter(f => f.type !== 'folder'); // Exclure dossiers pour infos
  if (adminCurrentFilter !== 'all') {
    filtered = filtered.filter(file => file.fileType === adminCurrentFilter);
  }
  if (adminSearchTerm) {
    filtered = filtered.filter(file => file.name.toLowerCase().includes(adminSearchTerm));
  }
  
  if (filtered.length === 0) {
    gallery.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#8ef58e;opacity:0.6;">Aucun fichier trouv√©</div>';
    return;
  }
  
  gallery.innerHTML = '';
  filtered.forEach(file => {
    const card = document.createElement('div');
    card.style.cssText = `
      background:#3a0066;
      border:2px solid ${adminSelectedFiles.has(file.id) ? '#ffd369' : 'transparent'};
      border-radius:12px;
      padding:8px;
      cursor:pointer;
      transition:all 0.3s;
      position:relative;
    `;
    
    let preview = '';
    if (file.fileType === 'image') {
      preview = `<img src="${file.url}" style="width:100%;height:120px;object-fit:cover;border-radius:8px;"/>`;
    } else if (file.fileType === 'video') {
      preview = `<video src="${file.url}" muted loop style="width:100%;height:120px;object-fit:cover;border-radius:8px;"></video>`;
    } else {
      preview = `<div style="width:100%;height:120px;display:flex;align-items:center;justify-content:center;background:#2e004f;border-radius:8px;font-size:2em;">üìÑ</div>`;
    }
    
    card.innerHTML = `
      ${preview}
      <div style="font-size:0.7em;margin-top:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff;">${file.name}</div>
      ${adminSelectedFiles.has(file.id) ? '<div style="position:absolute;top:4px;right:4px;background:#ffd369;color:#2e003e;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;">‚úì</div>' : ''}
    `;
    
    card.addEventListener('click', () => {
      // S√©lection unique seulement
      adminSelectedFiles.clear();
      adminSelectedFiles.add(file.id);
      renderGofileGalleryForInfos();
      document.getElementById('pd-selected-info').textContent = `‚úì ${file.name}`;
    });
    
    gallery.appendChild(card);
  });
}

// Ouvrir le s√©lecteur GoFile pour admin>annonces (multi-s√©lection + drag & drop)
let annonceMedias = [];

function openGofileSelectorForAnnonces() {
  // Cr√©er le modal de s√©lection
  const modal = document.createElement('div');
  modal.id = 'gofile-selector-annonces-modal';
  modal.className = 'modal';
  modal.style.cssText = 'display:flex;align-items:center;justify-content:center;z-index:10002;';
  
  modal.innerHTML = `
    <div class="modal-content" style="max-width:1400px;width:98%;max-height:95vh;background:linear-gradient(135deg, #2e003e, #6a0572);border-radius:16px;padding:0;overflow:hidden;display:flex;flex-direction:column;">
      <div style="background:linear-gradient(135deg, #ffd369, #ffb347);padding:20px;display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;color:#2e003e;font-size:1.3em;">üé® S√©lectionner des m√©dias GoFile</h3>
        <button id="close-pd-selector-annonces" style="background:none;border:none;color:#2e003e;font-size:2em;cursor:pointer;width:40px;height:40px;">√ó</button>
      </div>
      
      <div style="display:flex;flex:1;min-height:0;overflow:hidden;">
        <!-- Galerie GoFile -->
        <div style="flex:2;padding:20px;border-right:2px solid rgba(255,255,255,0.1);overflow-y:auto;display:flex;flex-direction:column;gap:15px;">
          <h4 style="color:#ffd369;margin:0;">M√©dias disponibles</h4>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <input type="text" id="pd-search-annonces" placeholder="üîç Rechercher..." style="flex:1;min-width:200px;padding:10px;border-radius:8px;border:2px solid #ffd369;background:rgba(255,255,255,0.1);color:#fff;font-size:1em;">
            <button class="pd-filter-annonces-btn active" data-filter="all" style="padding:8px 16px;border:2px solid #ffd369;background:#ffd369;color:#2e003e;border-radius:20px;cursor:pointer;font-weight:600;">Tous</button>
            <button class="pd-filter-annonces-btn" data-filter="image" style="padding:8px 16px;border:2px solid #6a0572;background:#6a0572;color:#fff;border-radius:20px;cursor:pointer;">Images</button>
            <button class="pd-filter-annonces-btn" data-filter="video" style="padding:8px 16px;border:2px solid #6a0572;background:#6a0572;color:#fff;border-radius:20px;cursor:pointer;">Vid√©os</button>
          </div>
          <div id="pd-gallery-annonces" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;max-height:calc(100% - 100px);overflow-y:auto;"></div>
        </div>
        
        <!-- Zone de s√©lection avec drag & drop -->
        <div style="flex:1;padding:20px;overflow-y:auto;background:rgba(0,0,0,0.2);display:flex;flex-direction:column;gap:15px;">
          <h4 style="color:#ffd369;margin:0;">M√©dias s√©lectionn√©s (<span id="annonces-selected-count">0</span>)</h4>
          <div style="color:#8ef58e;font-size:0.85em;opacity:0.8;">Cliquez pour ajouter, drag & drop pour r√©organiser</div>
          <div id="annonces-selected-list" style="display:flex;flex-direction:column;gap:10px;min-height:200px;padding:15px;background:rgba(0,0,0,0.3);border-radius:8px;border:2px dashed #ffd369;">
            <div style="text-align:center;color:#8ef58e;opacity:0.5;padding:40px 10px;">Aucun m√©dia s√©lectionn√©</div>
          </div>
        </div>
      </div>
      
      <div style="background:rgba(0,0,0,0.3);padding:15px;display:flex;justify-content:space-between;align-items:center;">
        <div style="color:#8ef58e;font-size:0.9em;"><strong>Multi-s√©lection :</strong> Cliquez pour ajouter/retirer ‚Ä¢ R√©organisez par glisser-d√©poser</div>
        <div style="display:flex;gap:10px;">
          <button id="pd-cancel-annonces" style="background:#6d6d6d;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">Annuler</button>
          <button id="pd-use-annonces" style="background:#8ef58e;color:#240038;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;font-weight:700;">Ajouter √† l'annonce</button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.classList.add('show');
  
  // Charger les m√©dias GoFile
  loadGofileForAnnonces();
  
  // Events
  document.getElementById('close-pd-selector-annonces').onclick = () => {
    modal.classList.remove('show');
    setTimeout(() => modal.remove(), 300);
  };
  
  document.getElementById('pd-cancel-annonces').onclick = () => {
    modal.classList.remove('show');
    setTimeout(() => modal.remove(), 300);
  };
  
  // Utiliser setTimeout pour s'assurer que le bouton est pr√™t
  setTimeout(() => {
    const btnUse = document.getElementById('pd-use-annonces');
    if (!btnUse) {
      console.error('[pd-use-annonces] Bouton introuvable!');
      return;
    }
    
    btnUse.onclick = () => {
      console.log('[pd-use-annonces] Click! annonceMedias:', annonceMedias);
      
      if (annonceMedias.length === 0) {
        showToast('‚ö†Ô∏è Veuillez s√©lectionner au moins un m√©dia', 'warning');
        return;
      }
      
      // Mettre √† jour le champ cach√© et l'aper√ßu
      const mediasField = document.getElementById('annonce-medias');
      const mediasCountElem = document.getElementById('annonce-medias-count');
      
      if (!mediasField || !mediasCountElem) {
        console.error('[pd-use-annonces] √âl√©ments manquants:', { mediasField: !!mediasField, mediasCountElem: !!mediasCountElem });
        showToast('‚ùå Erreur: √©l√©ments du formulaire manquants', 'error');
        return;
      }
      
      mediasField.value = JSON.stringify(annonceMedias);
      console.log('[pd-use-annonces] Champ mis √† jour:', mediasField.value);
      
      updateAnnonceMediasPreview(annonceMedias);
      mediasCountElem.textContent = `${annonceMedias.length} m√©dia(s)`;
      
      showToast(`‚úÖ ${annonceMedias.length} m√©dia(s) ajout√©(s)`, 'success');
      modal.classList.remove('show');
      setTimeout(() => modal.remove(), 300);
    };
  }, 100);
  
  // Recherche
  document.getElementById('pd-search-annonces').addEventListener('input', (e) => {
    adminSearchTerm = e.target.value.toLowerCase();
    renderGofileGalleryForAnnonces();
  });
  
  // Filtres
  document.querySelectorAll('.pd-filter-annonces-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.pd-filter-annonces-btn').forEach(b => {
        b.style.background = '#6a0572';
        b.style.color = '#fff';
        b.classList.remove('active');
      });
      e.target.style.background = '#ffd369';
      e.target.style.color = '#2e003e';
      e.target.classList.add('active');
      adminCurrentFilter = e.target.dataset.filter;
      renderGofileGalleryForAnnonces();
    });
  });
}

async function loadGofileForAnnonces() {
  const gallery = document.getElementById('pd-gallery-annonces');
  if (!gallery) return;
  
  gallery.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#ffd369;">Chargement...</div>';
  
  try {
    if (adminGofileFiles.length === 0) {
      const response = await fetch('/images');
      if (!response.ok) throw new Error(`Erreur ${response.status}`);
      const data = await response.json();
      adminGofileFiles = data.map(file => ({
        ...file,
        url: file.type === 'folder' ? null : `/media/${file.id}?name=${encodeURIComponent(file.name)}&server=${file.server || 'store1'}`,
        fileType: file.type === 'folder' ? 'folder' : getGofileFileType(file.name),
        extension: file.type === 'folder' ? 'folder' : getGofileFileExtension(file.name),
        formattedSize: file.type === 'folder' ? `${file.childrenCount || 0} √©l√©ments` : formatGofileFileSize(file.size),
        formattedDate: formatGofileDate(file.createTime)
      }));
    }
    renderGofileGalleryForAnnonces();
    renderSelectedAnnoncesMedias();
  } catch (error) {
    gallery.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#ff6b6b;">Erreur de chargement</div>';
    console.error('[GoFile Annonces] Erreur:', error);
  }
}

function renderGofileGalleryForAnnonces() {
  const gallery = document.getElementById('pd-gallery-annonces');
  if (!gallery) return;
  
  // Filtrer
  let filtered = adminGofileFiles.filter(f => f.type !== 'folder');
  if (adminCurrentFilter !== 'all') {
    filtered = filtered.filter(file => file.fileType === adminCurrentFilter);
  }
  if (adminSearchTerm) {
    filtered = filtered.filter(file => file.name.toLowerCase().includes(adminSearchTerm));
  }
  
  if (filtered.length === 0) {
    gallery.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#8ef58e;opacity:0.6;">Aucun fichier trouv√©</div>';
    return;
  }
  
  gallery.innerHTML = '';
  filtered.forEach(file => {
    const isSelected = annonceMedias.some(m => m === file.url || (m.url && m.url === file.url));
    const card = document.createElement('div');
    card.style.cssText = `
      background:#3a0066;
      border:2px solid ${isSelected ? '#8ef58e' : 'transparent'};
      border-radius:12px;
      padding:8px;
      cursor:pointer;
      transition:all 0.3s;
      position:relative;
    `;
    
    let preview = '';
    if (file.fileType === 'image') {
      preview = `<img src="${file.url}" style="width:100%;height:100px;object-fit:cover;border-radius:8px;"/>`;
    } else if (file.fileType === 'video') {
      preview = `<video src="${file.url}" muted loop style="width:100%;height:100px;object-fit:cover;border-radius:8px;"></video>`;
    } else {
      preview = `<div style="width:100%;height:100px;display:flex;align-items:center;justify-content:center;background:#2e004f;border-radius:8px;font-size:2em;">üìÑ</div>`;
    }
    
    card.innerHTML = `
      ${preview}
      <div style="font-size:0.65em;margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff;">${file.name}</div>
      ${isSelected ? '<div style="position:absolute;top:4px;right:4px;background:#8ef58e;color:#2e003e;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:0.8em;">‚úì</div>' : ''}
    `;
    
    card.addEventListener('click', () => {
      if (isSelected) {
        // Retirer
        annonceMedias = annonceMedias.filter(m => {
          if (typeof m === 'string') return m !== file.url;
          return m.url !== file.url;
        });
      } else {
        // Ajouter
        annonceMedias.push(file.url);
      }
      renderGofileGalleryForAnnonces();
      renderSelectedAnnoncesMedias();
    });
    
    gallery.appendChild(card);
  });
}

function renderSelectedAnnoncesMedias() {
  const list = document.getElementById('annonces-selected-list');
  const count = document.getElementById('annonces-selected-count');
  if (!list || !count) return;
  
  count.textContent = annonceMedias.length;
  
  if (annonceMedias.length === 0) {
    list.innerHTML = '<div style="text-align:center;color:#8ef58e;opacity:0.5;padding:40px 10px;">Aucun m√©dia s√©lectionn√©</div>';
    return;
  }
  
  list.innerHTML = '';
  annonceMedias.forEach((media, idx) => {
    const url = typeof media === 'string' ? media : media.url;
    const file = adminGofileFiles.find(f => f.url === url);
    
    const item = document.createElement('div');
    item.draggable = true;
    item.dataset.index = idx;
    item.style.cssText = `
      background:#3a0066;
      border:2px solid #4b1a7f;
      border-radius:10px;
      padding:10px;
      display:flex;
      align-items:center;
      gap:12px;
      cursor:move;
      transition:all 0.3s;
    `;
    
    let preview = '';
    if (file) {
      if (file.fileType === 'image') {
        preview = `<img src="${url}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;"/>`;
      } else if (file.fileType === 'video') {
        preview = `<video src="${url}" muted style="width:60px;height:60px;object-fit:cover;border-radius:6px;"></video>`;
      } else {
        preview = `<div style="width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:#2e004f;border-radius:6px;font-size:1.5em;">üìÑ</div>`;
      }
    } else {
      preview = `<div style="width:60px;height:60px;background:#2e004f;border-radius:6px;"></div>`;
    }
    
    item.innerHTML = `
      <div style="font-size:1.2em;color:#ffd369;">${idx + 1}</div>
      ${preview}
      <div style="flex:1;min-width:0;">
        <div style="font-size:0.8em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff;">${file ? file.name : 'M√©dia'}</div>
        <div style="font-size:0.7em;color:#8ef58e;opacity:0.7;">${file ? file.formattedSize : ''}</div>
      </div>
      <button onclick="removeAnnonceMedia(${idx})" style="background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:0.8em;">üóëÔ∏è</button>
    `;
    
    // Drag & Drop
    item.addEventListener('dragstart', (e) => {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', idx);
      item.style.opacity = '0.5';
    });
    
    item.addEventListener('dragend', () => {
      item.style.opacity = '1';
    });
    
    item.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      item.style.borderColor = '#ffd369';
    });
    
    item.addEventListener('dragleave', () => {
      item.style.borderColor = '#4b1a7f';
    });
    
    item.addEventListener('drop', (e) => {
      e.preventDefault();
      item.style.borderColor = '#4b1a7f';
      const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
      const toIdx = idx;
      
      if (fromIdx !== toIdx) {
        // R√©organiser le tableau
        const [moved] = annonceMedias.splice(fromIdx, 1);
        annonceMedias.splice(toIdx, 0, moved);
        renderSelectedAnnoncesMedias();
      }
    });
    
    list.appendChild(item);
  });
}

function removeAnnonceMedia(idx) {
  annonceMedias.splice(idx, 1);
  renderGofileGalleryForAnnonces();
  renderSelectedAnnoncesMedias();
}

function updateArticleMediaDisplay() {
  const mediaList = document.getElementById('media-list');
  const emptyState = document.getElementById('media-empty-state');
  const countBadge = document.getElementById('media-count-badge');
  
  if (!mediaList) return;

  // R√©cup√©rer les m√©dias de l'article actuel ou temporaires
  let medias = [];
  if (currentEditingArticle && currentEditingArticle.medias && currentEditingArticle.medias.length > 0) {
    medias = currentEditingArticle.medias;
  } else if (window.tempSelectedMedia && window.tempSelectedMedia.length > 0) {
    medias = window.tempSelectedMedia;
  }

  // Mettre √† jour le compteur
  if (countBadge) {
    countBadge.textContent = `${medias.length} m√©dia(s)`;
  }

  // Afficher l'√©tat vide si aucun m√©dia
  if (medias.length === 0) {
    emptyState.style.display = 'block';
    // Vider la liste sauf l'√©tat vide
    Array.from(mediaList.children).forEach(child => {
      if (child.id !== 'media-empty-state') {
        child.remove();
      }
    });
    updateThumbnailPreview(null);
    return;
  }

  // Masquer l'√©tat vide
  emptyState.style.display = 'none';

  // Vider la liste sauf l'√©tat vide
  Array.from(mediaList.children).forEach(child => {
    if (child.id !== 'media-empty-state') {
      child.remove();
    }
  });

  // Cr√©er les √©l√©ments de m√©dias
  medias.forEach((media, index) => {
    const mediaItem = createMediaItem(media, index);
    mediaList.appendChild(mediaItem);
  });

  // Mettre √† jour la miniature - trouver l'index actuel du thumbnail
  const thumbnailInput = document.getElementById('thumbnail-select');
  let thumbnailIndex = 0;
  if (thumbnailInput && thumbnailInput.value) {
    const foundIndex = medias.findIndex(m => m.url === thumbnailInput.value || m.path === thumbnailInput.value);
    if (foundIndex !== -1) {
      thumbnailIndex = foundIndex;
    }
  }
  updateThumbnailPreview(medias, thumbnailIndex);
}

function removeMediaFromArticle(index) {
  if (currentEditingArticle && currentEditingArticle.medias) {
    currentEditingArticle.medias.splice(index, 1);
  } else if (window.tempSelectedMedia) {
    window.tempSelectedMedia.splice(index, 1);
  }
  updateArticleMediaDisplay();
}

// Nouvelle fonction pour cr√©er un √©l√©ment de m√©dia avec drag & drop
function createMediaItem(media, index) {
  const mediaDiv = document.createElement('div');
  mediaDiv.className = 'media-item';
  mediaDiv.draggable = true;
  mediaDiv.dataset.index = index;
  
  // Style de base avec animation
  mediaDiv.style.cssText = `
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px;
    background:linear-gradient(135deg, rgba(46,0,79,0.8), rgba(75,26,127,0.6));
    border:1px solid rgba(255,255,255,0.1);
    border-radius:8px;
    margin-bottom:8px;
    cursor:move;
    transition:all 0.3s ease;
    position:relative;
    overflow:hidden;
  `;
  
  // Ajouter un indicateur d'ordre
  const orderBadge = document.createElement('div');
  orderBadge.style.cssText = `
    position:absolute;
    top:4px;
    left:4px;
    background:rgba(255,211,105,0.9);
    color:#333;
    width:20px;
    height:20px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:0.7rem;
    font-weight:bold;
  `;
  orderBadge.textContent = index + 1;
  
  // Cr√©er la pr√©visualisation
  const preview = createMediaPreview(media);
  
  // Informations du m√©dia
  const mediaInfo = document.createElement('div');
  mediaInfo.style.cssText = 'flex:1;min-width:0;';
  
  const mediaName = document.createElement('div');
  mediaName.style.cssText = 'font-weight:600;font-size:0.95rem;color:#ffd369;margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;';
  mediaName.textContent = media.name || media.filename || 'Sans nom';
  
  const mediaType = document.createElement('div');
  mediaType.style.cssText = 'font-size:0.8rem;color:#8ef58e;margin-bottom:4px;';
  mediaType.textContent = getMediaTypeLabel(media);
  
  const mediaSize = document.createElement('div');
  mediaSize.style.cssText = 'font-size:0.75rem;color:#999;';
  mediaSize.textContent = formatFileSize(media.size);
  
  mediaInfo.appendChild(mediaName);
  mediaInfo.appendChild(mediaType);
  mediaInfo.appendChild(mediaSize);
  
  // Boutons d'action
  const actionsDiv = document.createElement('div');
  actionsDiv.style.cssText = 'display:flex;gap:6px;align-items:center;';
  
  // Case √† cocher radio pour d√©finir comme miniature
  const thumbnailContainer = document.createElement('div');
  thumbnailContainer.style.cssText = `
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:2px;
    padding:4px;
  `;
  
  const thumbnailRadio = document.createElement('input');
  thumbnailRadio.type = 'radio';
  thumbnailRadio.name = 'article-thumbnail-radio';
  thumbnailRadio.dataset.index = index;
  thumbnailRadio.style.cssText = `
    width:18px;
    height:18px;
    cursor:pointer;
    accent-color:#ffd369;
  `;
  
  // V√©rifier si c'est la miniature actuelle
  const thumbnailInput = document.getElementById('thumbnail-select');
  if (thumbnailInput && media.url && thumbnailInput.value === media.url) {
    thumbnailRadio.checked = true;
  }
  
  thumbnailRadio.addEventListener('change', () => {
    if (thumbnailRadio.checked) {
      setAsThumbnail(index);
    }
  });
  
  const thumbnailLabel = document.createElement('div');
  thumbnailLabel.textContent = 'Mini';
  thumbnailLabel.style.cssText = `
    font-size:0.65rem;
    color:#ffd369;
    text-align:center;
    font-weight:600;
  `;
  
  thumbnailContainer.appendChild(thumbnailRadio);
  thumbnailContainer.appendChild(thumbnailLabel);
  
  // Bouton monter
  const upBtn = document.createElement('button');
  upBtn.type = 'button';
  upBtn.innerHTML = '‚Üë';
  upBtn.title = 'Monter';
  upBtn.style.cssText = `
    background:linear-gradient(135deg, #4a9eff, #357abd);
    color:white;
    border:none;
    padding:6px 8px;
    border-radius:4px;
    cursor:pointer;
    font-size:0.8rem;
    transition:all 0.3s ease;
    ${index === 0 ? 'opacity:0.5;cursor:not-allowed;' : ''}
  `;
  // Toujours ajouter l'event listener, mais v√©rifier √† l'int√©rieur
  upBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    console.log('[DEBUG] Bouton monter cliqu√© pour index:', index);
    console.log('[DEBUG] V√©rification: index > 0 ?', index, '>', 0, '=', index > 0);
    if (index > 0) {
      console.log('[DEBUG] D√©placement direct vers le haut');
      
      // Logique de d√©placement directe
      const medias = getCurrentMedias();
      if (medias && index > 0 && index < medias.length) {
        const temp = medias[index];
        medias[index] = medias[index - 1];
        medias[index - 1] = temp;
        
        // Sauvegarder
        if (window.currentEditingArticle && window.currentEditingArticle.medias) {
          window.currentEditingArticle.medias = medias;
        }
        if (window.tempSelectedMedia) {
          window.tempSelectedMedia = medias;
        }
        
        console.log('[DEBUG] √âchange effectu√©, mise √† jour affichage');
        updateArticleMediaDisplay();
      }
    } else {
      console.log('[DEBUG] Mouvement vers le haut impossible - d√©j√† en premi√®re position');
    }
  });
  
  // Bouton descendre
  const downBtn = document.createElement('button');
  downBtn.type = 'button';
  downBtn.innerHTML = '‚Üì';
  downBtn.title = 'Descendre';
  downBtn.style.cssText = `
    background:linear-gradient(135deg, #4a9eff, #357abd);
    color:white;
    border:none;
    padding:6px 8px;
    border-radius:4px;
    cursor:pointer;
    font-size:0.8rem;
    transition:all 0.3s ease;
  `;
  // Toujours ajouter l'event listener, mais v√©rifier √† l'int√©rieur
  downBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    console.log('[DEBUG] Bouton descendre cliqu√© pour index:', index);
    const medias = getCurrentMedias();
    console.log('[DEBUG] M√©dias r√©cup√©r√©s:', medias ? medias.length : 'null');
    console.log('[DEBUG] V√©rification: index < medias.length - 1 ?', index, '<', medias ? medias.length - 1 : 'N/A', '=', medias && index < medias.length - 1);
    if (medias && index < medias.length - 1) {
      console.log('[DEBUG] D√©placement direct vers le bas');
      
      // Logique de d√©placement directe
      if (index >= 0 && index < medias.length - 1) {
        const temp = medias[index];
        medias[index] = medias[index + 1];
        medias[index + 1] = temp;
        
        // Sauvegarder
        if (window.currentEditingArticle && window.currentEditingArticle.medias) {
          window.currentEditingArticle.medias = medias;
        }
        if (window.tempSelectedMedia) {
          window.tempSelectedMedia = medias;
        }
        
        console.log('[DEBUG] √âchange effectu√©, mise √† jour affichage');
        updateArticleMediaDisplay();
      }
    } else {
      console.log('[DEBUG] Mouvement vers le bas impossible - d√©j√† en derni√®re position ou m√©dias non trouv√©s');
    }
  });
  
  // Mettre √† jour le style du bouton descendre selon la position
  const medias = getCurrentMedias();
  if (!medias || index >= medias.length - 1) {
    downBtn.style.opacity = '0.5';
    downBtn.style.cursor = 'not-allowed';
  }
  
  // Bouton supprimer
  const deleteBtn = document.createElement('button');
  deleteBtn.type = 'button';
  deleteBtn.innerHTML = 'üóëÔ∏è';
  deleteBtn.title = 'Supprimer';
  deleteBtn.style.cssText = `
    background:linear-gradient(135deg, #dc3545, #c82333);
    color:white;
    border:none;
    padding:6px 8px;
    border-radius:4px;
    cursor:pointer;
    font-size:0.8rem;
    transition:all 0.3s ease;
  `;
  deleteBtn.addEventListener('click', () => removeMediaFromArticle(index));
  
  actionsDiv.appendChild(thumbnailContainer);
  actionsDiv.appendChild(upBtn);
  actionsDiv.appendChild(downBtn);
  actionsDiv.appendChild(deleteBtn);
  
  // Assemblage
  mediaDiv.appendChild(orderBadge);
  mediaDiv.appendChild(preview);
  mediaDiv.appendChild(mediaInfo);
  mediaDiv.appendChild(actionsDiv);
  
  // √âv√©nements drag & drop
  setupDragAndDrop(mediaDiv);
  
  return mediaDiv;
}

// Fonction pour cr√©er la pr√©visualisation d'un m√©dia
function createMediaPreview(media) {
  const preview = document.createElement('div');
  preview.style.cssText = `
    width:60px;
    height:60px;
    border-radius:6px;
    overflow:hidden;
    background:rgba(74,26,92,0.5);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-shrink:0;
    border:2px solid rgba(255,255,255,0.1);
  `;
  
  if (media.mime_type && media.mime_type.startsWith('image/')) {
    const img = document.createElement('img');
    img.src = media.url;
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
    img.loading = 'lazy';
    img.onload = () => preview.style.background = 'transparent';
    img.onerror = () => {
      img.style.display = 'none';
      preview.innerHTML = 'üñºÔ∏è';
      preview.style.color = '#ffd369';
      preview.style.fontSize = '24px';
    };
    preview.appendChild(img);
  } else if (media.mime_type && media.mime_type.startsWith('video/')) {
    const video = document.createElement('video');
    video.src = media.url;
    video.style.cssText = 'width:100%;height:100%;object-fit:cover;';
    video.preload = 'metadata';
    video.muted = true;
    video.loop = true;
    
    // Logique de lecture : boucle si < 3s, sinon au survol
    video.addEventListener('loadedmetadata', () => {
      console.log('[DEBUG] Dur√©e vid√©o:', video.duration, 'secondes');
      if (video.duration > 0 && video.duration < 3) {
        // Vid√©o courte : lecture en boucle automatique
        video.autoplay = true;
        video.play().catch(e => console.log('[DEBUG] Autoplay √©chou√©:', e));
        console.log('[DEBUG] Vid√©o courte - lecture en boucle');
      } else {
        // Vid√©o longue : lecture au survol
        preview.addEventListener('mouseenter', () => {
          video.play().catch(e => console.log('[DEBUG] Play au survol √©chou√©:', e));
        });
        preview.addEventListener('mouseleave', () => {
          video.pause();
          video.currentTime = 0;
        });
        console.log('[DEBUG] Vid√©o longue - lecture au survol');
      }
    });
    
    video.onloadeddata = () => preview.style.background = 'transparent';
    video.onerror = () => {
      video.style.display = 'none';
      preview.innerHTML = 'üé•';
      preview.style.color = '#ffd369';
      preview.style.fontSize = '24px';
    };
    preview.appendChild(video);
    
    // Ajouter un overlay de lecture pour les vid√©os longues
    const playOverlay = document.createElement('div');
    playOverlay.innerHTML = '‚ñ∂';
    playOverlay.style.cssText = `
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      color:white;
      background:rgba(0,0,0,0.7);
      border-radius:50%;
      width:20px;
      height:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:8px;
      opacity:0.8;
      pointer-events:none;
    `;
    preview.style.position = 'relative';
    preview.appendChild(playOverlay);
  } else {
    // Essayer de deviner le type √† partir de l'URL ou afficher un aper√ßu g√©n√©rique
    console.log('[DEBUG] M√©dia sans type MIME reconnu:', media);
    
    // Essayer de charger comme une image par d√©faut
    const img = document.createElement('img');
    img.src = media.url || media.path;
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
    img.loading = 'lazy';
    img.onload = () => {
      preview.style.background = 'transparent';
      console.log('[DEBUG] Image charg√©e avec succ√®s pour m√©dia sans type MIME');
    };
    img.onerror = () => {
      // Si l'image √©choue, essayer une vid√©o
      img.style.display = 'none';
      const video = document.createElement('video');
      video.src = media.url || media.path;
      video.style.cssText = 'width:100%;height:100%;object-fit:cover;';
      video.preload = 'metadata';
      video.muted = true;
      video.onloadeddata = () => {
        preview.style.background = 'transparent';
        console.log('[DEBUG] Vid√©o charg√©e avec succ√®s pour m√©dia sans type MIME');
        
        // Ajouter overlay de lecture
        const playOverlay = document.createElement('div');
        playOverlay.innerHTML = '‚ñ∂';
        playOverlay.style.cssText = `
          position:absolute;
          top:50%;
          left:50%;
          transform:translate(-50%, -50%);
          color:white;
          background:rgba(0,0,0,0.7);
          border-radius:50%;
          width:20px;
          height:20px;
          display:flex;
          align-items:center;
          justify-content:center;
          font-size:8px;
        `;
        preview.style.position = 'relative';
        preview.appendChild(playOverlay);
      };
      video.onerror = () => {
        // Si ni image ni vid√©o ne marchent, afficher une ic√¥ne bas√©e sur l'extension
        video.style.display = 'none';
        const url = media.url || media.path || '';
        if (url.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i)) {
          preview.innerHTML = 'üñºÔ∏è';
        } else if (url.match(/\.(mp4|webm|avi|mov|mkv|wmv)$/i)) {
          preview.innerHTML = 'üé•';
        } else {
          preview.innerHTML = 'ÔøΩ';
        }
        preview.style.color = '#ffd369';
        preview.style.fontSize = '24px';
        console.log('[DEBUG] Impossible de charger le m√©dia, ic√¥ne de fallback affich√©e');
      };
      preview.appendChild(video);
    };
    preview.appendChild(img);
  }
  
  return preview;
}

// Fonctions utilitaires
function getMediaTypeLabel(media) {
  if (media.mime_type) {
    if (media.mime_type.startsWith('image/')) return 'üì∏ Image';
    if (media.mime_type.startsWith('video/')) return 'üé• Vid√©o';
  }
  return 'üìÅ Fichier';
}

function formatFileSize(bytes) {
  if (!bytes) return 'Taille inconnue';
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

// Fonctions de gestion
function setAsThumbnail(index) {
  console.log('[DEBUG] setAsThumbnail appel√© avec index:', index);
  const medias = getCurrentMedias();
  if (medias && medias[index]) {
    const thumbnailInput = document.getElementById('thumbnail-select');
    if (thumbnailInput) {
      thumbnailInput.value = medias[index].url;
    }
    updateThumbnailPreview(medias, index);
    console.log('[DEBUG] Miniature d√©finie:', medias[index].name, '√† l\'index', index);
    // Pas besoin de rafra√Æchir toute la liste pour la miniature
  } else {
    console.error('[DEBUG] Impossible de d√©finir la miniature - index invalide:', index);
  }
}

function moveMedia(fromIndex, direction) {
  try {
    console.log('[DEBUG] ===== DEBUT moveMedia =====');
    console.log('[DEBUG] moveMedia appel√© avec:', fromIndex, direction);
    
    const medias = getCurrentMedias();
    console.log('[DEBUG] M√©dias r√©cup√©r√©s:', medias ? 'OK' : 'NULL');
    
    if (!medias) {
      console.error('[DEBUG] Aucun m√©dia trouv√© pour moveMedia');
      return;
    }
    
    console.log('[DEBUG] Nombre total de m√©dias:', medias.length);
    
    const toIndex = fromIndex + direction;
    console.log('[DEBUG] fromIndex:', fromIndex, 'direction:', direction, 'toIndex:', toIndex);
    
    if (toIndex < 0) {
      console.log('[DEBUG] Mouvement impossible - toIndex < 0:', toIndex);
      return;
    }
    if (toIndex >= medias.length) {
      console.log('[DEBUG] Mouvement impossible - toIndex >= length:', toIndex, '>=', medias.length);
      return;
    }
    
    console.log('[DEBUG] Avant √©change - fromIndex:', fromIndex, 'toIndex:', toIndex);
    console.log('[DEBUG] Avant √©change - medias[fromIndex]:', medias[fromIndex]?.name);
    console.log('[DEBUG] Avant √©change - medias[toIndex]:', medias[toIndex]?.name);
    
    // √âchanger les √©l√©ments
    const temp = medias[fromIndex];
    medias[fromIndex] = medias[toIndex];
    medias[toIndex] = temp;
    
    console.log('[DEBUG] Apr√®s √©change - medias[fromIndex]:', medias[fromIndex]?.name);
    console.log('[DEBUG] Apr√®s √©change - medias[toIndex]:', medias[toIndex]?.name);
    
    // Sauvegarder les changements
    if (window.currentEditingArticle && window.currentEditingArticle.medias) {
      window.currentEditingArticle.medias = medias;
      console.log('[DEBUG] M√©dias sauvegard√©s dans currentEditingArticle');
    }
    if (window.tempSelectedMedia) {
      window.tempSelectedMedia = medias;
      console.log('[DEBUG] M√©dias sauvegard√©s dans tempSelectedMedia');
    }
    
    console.log('[DEBUG] Appel updateArticleMediaDisplay...');
    updateArticleMediaDisplay();
    console.log('[DEBUG] ===== FIN moveMedia =====');
    
  } catch (error) {
    console.error('[DEBUG] Erreur dans moveMedia:', error);
  }
}

function getCurrentMedias() {
  console.log('[DEBUG] getCurrentMedias appel√©');
  
  if (currentEditingArticle && currentEditingArticle.medias) {
    console.log('[DEBUG] M√©dias trouv√©s dans currentEditingArticle:', currentEditingArticle.medias.length, '√©l√©ments');
    return currentEditingArticle.medias;
  } 
  
  if (window.tempSelectedMedia) {
    console.log('[DEBUG] M√©dias trouv√©s dans tempSelectedMedia:', window.tempSelectedMedia.length, '√©l√©ments');
    return window.tempSelectedMedia;
  }
  
  console.log('[DEBUG] Aucun m√©dia trouv√© dans currentEditingArticle ou tempSelectedMedia');
  return null;
}

function clearAllMedia() {
  if (confirm('√ätes-vous s√ªr de vouloir supprimer tous les m√©dias ?')) {
    if (currentEditingArticle && currentEditingArticle.medias) {
      currentEditingArticle.medias = [];
    }
    if (window.tempSelectedMedia) {
      window.tempSelectedMedia = [];
    }
    updateArticleMediaDisplay();
  }
}

function openMediaExplorer() {
  // Sauvegarder l'√©tat actuel du formulaire
  saveCurrentArticleForm();
  
  // R√©cup√©rer l'ID de l'article pour pr√©-remplir la recherche
  const articleId = document.getElementById('id-article')?.value || '';
  
  // Ouvrir l'explorateur de fichiers GoFile
  showSection('medias');
  
  // Pr√©-remplir la recherche avec l'ID de l'article
  setTimeout(() => {
    const searchInput = document.getElementById('admin-search');
    if (searchInput && articleId) {
      searchInput.value = articleId;
      // D√©clencher la recherche
      searchInput.dispatchEvent(new Event('input'));
    }
  }, 100);
}

// Drag & Drop
function setupDragAndDrop(mediaDiv) {
  mediaDiv.addEventListener('dragstart', handleDragStart);
  mediaDiv.addEventListener('dragover', handleDragOver);
  mediaDiv.addEventListener('drop', handleDrop);
  mediaDiv.addEventListener('dragend', handleDragEnd);
}

let draggedElement = null;

function handleDragStart(e) {
  draggedElement = this;
  this.style.opacity = '0.5';
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
  if (e.preventDefault) e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  
  // Ajouter un indicateur visuel
  this.style.borderTop = '3px solid #ffd369';
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) e.stopPropagation();
  
  if (draggedElement !== this) {
    const fromIndex = parseInt(draggedElement.dataset.index);
    const toIndex = parseInt(this.dataset.index);
    
    const medias = getCurrentMedias();
    if (medias) {
      // R√©organiser les m√©dias
      const movedItem = medias.splice(fromIndex, 1)[0];
      medias.splice(toIndex, 0, movedItem);
      updateArticleMediaDisplay();
    }
  }
  
  this.style.borderTop = '';
  return false;
}

function handleDragEnd(e) {
  this.style.opacity = '';
  // Nettoyer tous les indicateurs visuels
  document.querySelectorAll('.media-item').forEach(item => {
    item.style.borderTop = '';
  });
}

function updateThumbnailPreview(medias, selectedIndex = 0) {
  const thumbnailPreview = document.getElementById('thumbnail-preview');
  const thumbnailInput = document.getElementById('thumbnail-select');
  
  if (!thumbnailPreview) return;
  
  if (!medias || medias.length === 0) {
    thumbnailPreview.innerHTML = `
      <div style="text-align:center;color:#888;font-style:italic;">
        S√©lectionnez un m√©dia comme miniature
      </div>
    `;
    if (thumbnailInput) thumbnailInput.value = '';
    return;
  }
  
  const selectedMedia = medias[selectedIndex];
  if (!selectedMedia) return;
  
  // Mettre √† jour l'input cach√©
  if (thumbnailInput) {
    thumbnailInput.value = selectedMedia.url;
  }
  
  // Cr√©er la pr√©visualisation
  thumbnailPreview.innerHTML = '';
  
  const container = document.createElement('div');
  container.style.cssText = 'display:flex;align-items:center;gap:12px;';
  
  // Pr√©visualisation du m√©dia
  const preview = document.createElement('div');
  preview.style.cssText = `
    width:80px;
    height:80px;
    border-radius:6px;
    overflow:hidden;
    background:rgba(74,26,92,0.5);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-shrink:0;
    border:2px solid #ffd369;
  `;
  
  if (selectedMedia.mime_type && selectedMedia.mime_type.startsWith('image/')) {
    const img = document.createElement('img');
    img.src = selectedMedia.url;
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
    img.loading = 'lazy';
    img.onload = () => preview.style.background = 'transparent';
    preview.appendChild(img);
  } else if (selectedMedia.mime_type && selectedMedia.mime_type.startsWith('video/')) {
    const video = document.createElement('video');
    video.src = selectedMedia.url;
    video.style.cssText = 'width:100%;height:100%;object-fit:cover;';
    video.preload = 'metadata';
    video.muted = true;
    video.onloadeddata = () => preview.style.background = 'transparent';
    preview.appendChild(video);
  } else {
    preview.innerHTML = 'üìÅ';
    preview.style.color = '#ffd369';
    preview.style.fontSize = '32px';
  }
  
  // Informations
  const info = document.createElement('div');
  info.style.cssText = 'flex:1;';
  
  const name = document.createElement('div');
  name.style.cssText = 'font-weight:600;color:#ffd369;margin-bottom:4px;';
  name.textContent = selectedMedia.name || selectedMedia.filename || 'Sans nom';
  
  const badge = document.createElement('div');
  badge.style.cssText = `
    display:inline-flex;
    align-items:center;
    gap:4px;
    background:rgba(255,211,105,0.9);
    color:#333;
    padding:4px 8px;
    border-radius:12px;
    font-size:0.8rem;
    font-weight:600;
  `;
  badge.innerHTML = 'üñºÔ∏è Miniature active';
  
  const changeBtn = document.createElement('button');
  changeBtn.type = 'button';
  changeBtn.innerHTML = 'üîÑ Changer';
  changeBtn.style.cssText = `
    background:linear-gradient(135deg, #4b1a7f, #6d28a3);
    color:#8ef58e;
    border:none;
    padding:4px 12px;
    border-radius:4px;
    cursor:pointer;
    font-size:0.8rem;
    margin-top:8px;
    transition:all 0.3s ease;
  `;
  changeBtn.onclick = () => showThumbnailSelector(medias);
  
  info.appendChild(name);
  info.appendChild(badge);
  info.appendChild(changeBtn);
  
  container.appendChild(preview);
  container.appendChild(info);
  thumbnailPreview.appendChild(container);
}

function showThumbnailSelector(medias) {
  if (!medias || medias.length === 0) return;
  
  // Cr√©er une modal de s√©lection de miniature
  const modal = document.createElement('div');
  modal.style.cssText = `
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.8);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:10000;
  `;
  
  const content = document.createElement('div');
  content.style.cssText = `
    background:linear-gradient(135deg, #2e004f, #4b1a7f);
    border-radius:12px;
    padding:20px;
    max-width:600px;
    max-height:80vh;
    overflow-y:auto;
    border:1px solid rgba(255,255,255,0.2);
  `;
  
  const title = document.createElement('h3');
  title.textContent = 'Choisir une miniature';
  title.style.cssText = 'color:#ffd369;margin:0 0 20px 0;text-align:center;';
  
  const grid = document.createElement('div');
  grid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:12px;margin-bottom:20px;';
  
  medias.forEach((media, index) => {
    const item = document.createElement('div');
    item.style.cssText = `
      border:2px solid rgba(255,255,255,0.2);
      border-radius:8px;
      overflow:hidden;
      cursor:pointer;
      transition:all 0.3s ease;
      background:rgba(46,0,79,0.5);
    `;
    
    const preview = document.createElement('div');
    preview.style.cssText = `
      width:100%;
      height:100px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(74,26,92,0.5);
    `;
    
    if (media.mime_type && media.mime_type.startsWith('image/')) {
      const img = document.createElement('img');
      img.src = media.url;
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
      preview.appendChild(img);
    } else if (media.mime_type && media.mime_type.startsWith('video/')) {
      const video = document.createElement('video');
      video.src = media.url;
      video.style.cssText = 'width:100%;height:100%;object-fit:cover;';
      video.preload = 'metadata';
      video.muted = true;
      preview.appendChild(video);
    } else {
      preview.innerHTML = 'üìÅ';
      preview.style.color = '#ffd369';
      preview.style.fontSize = '32px';
    }
    
    const name = document.createElement('div');
    name.style.cssText = 'padding:8px;font-size:0.8rem;color:#fff;text-align:center;word-break:break-word;';
    name.textContent = media.name || media.filename || 'Sans nom';
    
    item.appendChild(preview);
    item.appendChild(name);
    
    item.onclick = () => {
      setAsThumbnail(index);
      document.body.removeChild(modal);
    };
    
    item.onmouseover = () => {
      item.style.borderColor = '#ffd369';
      item.style.transform = 'scale(1.05)';
    };
    
    item.onmouseout = () => {
      item.style.borderColor = 'rgba(255,255,255,0.2)';
      item.style.transform = 'scale(1)';
    };
    
    grid.appendChild(item);
  });
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Fermer';
  closeBtn.style.cssText = `
    background:#dc3545;
    color:white;
    border:none;
    padding:8px 16px;
    border-radius:6px;
    cursor:pointer;
    display:block;
    margin:0 auto;
  `;
  closeBtn.onclick = () => document.body.removeChild(modal);
  
  content.appendChild(title);
  content.appendChild(grid);
  content.appendChild(closeBtn);
  modal.appendChild(content);
  
  modal.onclick = (e) => {
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  };
  
  document.body.appendChild(modal);
}

function saveCurrentArticleForm() {
  const form = document.getElementById('addArticleForm');
  if (!form) return;

  // R√©cup√©rer les donn√©es du formulaire
  const formData = new FormData(form);
  const articleData = Object.fromEntries(formData.entries());
  
  console.log('[Debug] Donn√©es du formulaire:', articleData);
  
  // Initialiser currentEditingArticle s'il n'existe pas
  if (!window.currentEditingArticle) {
    window.currentEditingArticle = {};
    console.log('[Debug] Initialisation de currentEditingArticle');
  }
  
  // Sauvegarder les donn√©es
  Object.assign(window.currentEditingArticle, articleData);
  
  // Sauvegarder les m√©dias temporaires s'ils existent
  if (window.tempSelectedMedia && window.tempSelectedMedia.length > 0) {
    if (!window.currentEditingArticle.medias) {
      window.currentEditingArticle.medias = [];
    }
    window.currentEditingArticle.medias.push(...window.tempSelectedMedia);
    window.tempSelectedMedia = [];
    console.log('[Debug] M√©dias temporaires transf√©r√©s vers currentEditingArticle');
  }
  
  console.log('[Admin] Article sauvegard√© temporairement:', window.currentEditingArticle);
}

function restoreArticleForm() {
  if (!window.currentEditingArticle) return;
  
  const form = document.getElementById('addArticleForm');
  if (!form) return;
  
  // Restaurer les champs texte
  Object.entries(window.currentEditingArticle).forEach(([key, value]) => {
    if (key !== 'medias') {
      const field = form.querySelector(`[name="${key}"]`);
      if (field) {
        field.value = value;
      }
    }
  });
  
  // Restaurer l'affichage des m√©dias
  updateArticleMediaDisplay();
  
  console.log('[Admin] Formulaire d\'article restaur√©');
}

// ==================== FIN EXPLORATEUR GOFILE ====================

// ==================== PROMPT STYLIS√â POUR POSITION ====================
function showPositionPrompt(articleName, currentPos, maxPos, callback) {
  // Cr√©er la modale si elle n'existe pas
  let modal = document.getElementById('position-prompt-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'position-prompt-modal';
    modal.className = 'modal';
    modal.style.cssText = 'z-index:10001;display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;';
    modal.innerHTML = `
      <div class="modal-content" style="max-width:450px;width:90%;background:linear-gradient(135deg, #2e003e, #6a0572);border-radius:16px;padding:0;overflow:hidden;">
        <div style="background:linear-gradient(135deg, #ffd369, #ffb347);padding:20px;text-align:center;">
          <h3 style="margin:0;color:#2e003e;font-size:1.3em;">üî¢ Modifier la position</h3>
        </div>
        <div style="padding:25px;">
          <div id="position-prompt-text" style="color:#8ef58e;margin-bottom:20px;line-height:1.6;text-align:center;"></div>
          <input type="number" id="position-prompt-input" min="1" style="
            width:100%;
            padding:15px;
            font-size:1.2em;
            border:2px solid #ffd369;
            border-radius:8px;
            background:rgba(255,255,255,0.1);
            color:#fff;
            text-align:center;
            font-weight:bold;
            box-sizing:border-box;
          " placeholder="Nouvelle position">
          <div style="display:flex;gap:10px;margin-top:20px;">
            <button id="position-prompt-cancel" style="
              flex:1;
              background:#6d6d6d;
              color:#fff;
              border:none;
              padding:12px;
              border-radius:8px;
              cursor:pointer;
              font-weight:600;
              font-size:1em;
            ">Annuler</button>
            <button id="position-prompt-ok" style="
              flex:1;
              background:#8ef58e;
              color:#2e003e;
              border:none;
              padding:12px;
              border-radius:8px;
              cursor:pointer;
              font-weight:700;
              font-size:1em;
            ">‚úì Valider</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  // Remplir le texte
  const text = document.getElementById('position-prompt-text');
  text.innerHTML = `<strong style="color:#ffd369;">${articleName}</strong><br><br>Position actuelle: <strong>#${currentPos}</strong><br>Total: ${maxPos} articles<br><br>Entrez la nouvelle position (1-${maxPos}):`;
  
  // Input
  const input = document.getElementById('position-prompt-input');
  input.value = currentPos;
  input.max = maxPos;
  input.focus();
  input.select();
  
  // Afficher la modale
  modal.style.display = 'flex';
  
  // G√©rer la validation
  const okBtn = document.getElementById('position-prompt-ok');
  const cancelBtn = document.getElementById('position-prompt-cancel');
  
  const cleanup = () => {
    modal.style.display = 'none';
    okBtn.onclick = null;
    cancelBtn.onclick = null;
    input.onkeypress = null;
  };
  
  okBtn.onclick = () => {
    const value = parseInt(input.value);
    cleanup();
    if (!isNaN(value)) {
      callback(value);
    }
  };
  
  cancelBtn.onclick = cleanup;
  
  input.onkeypress = (e) => {
    if (e.key === 'Enter') {
      okBtn.click();
    } else if (e.key === 'Escape') {
      cancelBtn.click();
    }
  };
  
  // Fermer en cliquant sur le fond
  modal.onclick = (e) => {
    if (e.target === modal) {
      cleanup();
    }
  };
}

// ==================== SYST√àME D'√âDITION DE CAT√âGORIE ====================
function showCategoryEditPrompt(currentName, currentIcon, callback) {
  // Cr√©er la modale si elle n'existe pas
  let modal = document.getElementById('category-edit-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'category-edit-modal';
    modal.className = 'modal';
    modal.style.cssText = 'z-index:10001;display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;';
    modal.innerHTML = `
      <div class="modal-content" style="max-width:500px;width:90%;background:linear-gradient(135deg, #2e003e, #6a0572);border-radius:16px;padding:0;overflow:hidden;">
        <div style="background:linear-gradient(135deg, #ffd369, #ffb347);padding:20px;text-align:center;">
          <h3 style="margin:0;color:#2e003e;font-size:1.3em;">‚úèÔ∏è Modifier la cat√©gorie</h3>
        </div>
        <div style="padding:25px;">
          <div style="margin-bottom:20px;">
            <label style="display:block;color:#8ef58e;margin-bottom:8px;font-weight:600;">Nom de la cat√©gorie:</label>
            <input type="text" id="category-name-input" style="
              width:100%;
              padding:12px;
              font-size:1em;
              border:2px solid #ffd369;
              border-radius:8px;
              background:rgba(255,255,255,0.1);
              color:#fff;
              box-sizing:border-box;
            " placeholder="Nom de la cat√©gorie">
          </div>
          <div style="margin-bottom:20px;">
            <label style="display:block;color:#8ef58e;margin-bottom:8px;font-weight:600;">Ic√¥ne (emoji ou texte):</label>
            <input type="text" id="category-icon-input" maxlength="5" style="
              width:100%;
              padding:12px;
              font-size:1em;
              border:2px solid #ffd369;
              border-radius:8px;
              background:rgba(255,255,255,0.1);
              color:#fff;
              box-sizing:border-box;
            " placeholder="üìÅ üî• ‚≠ê">
          </div>
          <div style="display:flex;gap:10px;margin-top:20px;">
            <button id="category-edit-cancel" style="
              flex:1;
              background:#6d6d6d;
              color:#fff;
              border:none;
              padding:12px;
              border-radius:8px;
              cursor:pointer;
              font-weight:600;
              font-size:1em;
            ">Annuler</button>
            <button id="category-edit-ok" style="
              flex:1;
              background:#8ef58e;
              color:#2e003e;
              border:none;
              padding:12px;
              border-radius:8px;
              cursor:pointer;
              font-weight:700;
              font-size:1em;
            ">‚úì Valider</button>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  // Remplir les inputs
  const nameInput = document.getElementById('category-name-input');
  const iconInput = document.getElementById('category-icon-input');
  nameInput.value = currentName || '';
  iconInput.value = currentIcon || '';
  nameInput.focus();
  nameInput.select();
  
  // Afficher la modale
  modal.style.display = 'flex';
  
  // G√©rer la validation
  const okBtn = document.getElementById('category-edit-ok');
  const cancelBtn = document.getElementById('category-edit-cancel');
  
  const cleanup = () => {
    modal.style.display = 'none';
    okBtn.onclick = null;
    cancelBtn.onclick = null;
    nameInput.onkeypress = null;
    iconInput.onkeypress = null;
  };
  
  okBtn.onclick = () => {
    const name = nameInput.value.trim();
    const icon = iconInput.value.trim();
    cleanup();
    if (name) {
      callback(name, icon);
    }
  };
  
  cancelBtn.onclick = cleanup;
  
  const handleEnter = (e) => {
    if (e.key === 'Enter') {
      okBtn.click();
    } else if (e.key === 'Escape') {
      cancelBtn.click();
    }
  };
  
  nameInput.onkeypress = handleEnter;
  iconInput.onkeypress = handleEnter;
  
  // Fermer en cliquant sur le fond
  modal.onclick = (e) => {
    if (e.target === modal) {
      cleanup();
    }
  };
}

// ==================== SYST√àME PAGE INFOS ====================
// Charger la page infos depuis le backend
async function loadInfosPage() {
  try {
    const res = await fetch('/api/info-page');
    if (res.ok) {
      infosPageData = await res.json();
      console.log('[ADMIN] Page infos charg√©e, sommaire:', infosPageData.sommaire);
      renderInfosCanvas();
      showToast('‚úÖ Page infos charg√©e', 'success');
    } else {
      infosPageData = { elements: [], sommaire: { visible: true, items: [] } };
      console.log('[ADMIN] Donn√©es par d√©faut initialis√©es');
      renderInfosCanvas();
    }
  } catch (e) {
    console.error('Erreur chargement page infos:', e);
    infosPageData = { elements: [], sommaire: { visible: true, items: [] } };
    renderInfosCanvas();
  }
}

// Sauvegarder la page infos
async function saveInfosPage() {
  try {
    console.log('[ADMIN] Sauvegarde page infos, sommaire:', infosPageData.sommaire);
    const res = await fetch('/api/info-page', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(infosPageData)
    });
    if (res.ok) {
      const result = await res.json();
      console.log('[ADMIN] Sauvegarde OK, r√©sultat:', result);
      showToast('‚úÖ Page infos enregistr√©e', 'success');
    } else {
      throw new Error('Erreur serveur');
    }
  } catch (e) {
    console.error('Erreur sauvegarde page infos:', e);
    showToast('‚ùå Erreur lors de la sauvegarde', 'error');
  }
}

// Sauvegarder automatiquement la position d'un √©l√©ment (debounced)
let updatePositionTimeout;
function updateElementPosition(idx, position) {
  if (!infosPageData.elements[idx]) return;
  infosPageData.elements[idx].position = position;
  
  clearTimeout(updatePositionTimeout);
  updatePositionTimeout = setTimeout(async () => {
    try {
      await fetch('/api/info-page', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(infosPageData)
      });
    } catch (e) {
      console.error('Erreur auto-sauvegarde position:', e);
    }
  }, 500);
}

// Rendre le canvas avec tous les √©l√©ments
function renderInfosCanvas() {
  const canvas = document.getElementById('infos-canvas');
  if (!canvas) return;
  
  if (!infosPageData.elements || infosPageData.elements.length === 0) {
    canvas.innerHTML = '<div style="text-align:center;color:#8ef58e;opacity:0.5;padding:100px 0;font-size:1.2em;">Cliquez sur les outils ci-dessus pour ajouter des √©l√©ments</div>';
    return;
  }
  
  canvas.innerHTML = '';
  infosPageData.elements.forEach((element, idx) => {
    const el = createInfosElement(element, idx);
    canvas.appendChild(el);
  });
  
  // Ajuster automatiquement la hauteur du canvas pour contenir tous les √©l√©ments
  let maxBottom = 1000; // Hauteur minimale
  infosPageData.elements.forEach(element => {
    if (element.position) {
      const bottom = element.position.y + (element.position.height || 200) + 100; // Marge suppl√©mentaire
      if (bottom > maxBottom) maxBottom = bottom;
    }
  });
  canvas.style.minHeight = maxBottom + 'px';
}

// Gestionnaire Ctrl+Fl√®ches pour s√©lection multiple
document.addEventListener('keydown', (e) => {
  // V√©rifier si on est sur la page infos
  const infosSection = document.getElementById('infos-section');
  if (!infosSection || infosSection.style.display === 'none') return;
  
  // Ctrl+Fl√®che Haut : s√©lectionner tous les √©l√©ments au-dessus
  if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowUp') {
    e.preventDefault();
    
    // Trouver l'√©l√©ment le plus haut actuellement s√©lectionn√©
    if (selectedInfosElements.length === 0) {
      // Si rien de s√©lectionn√©, s√©lectionner tous les √©l√©ments
      selectedInfosElements = infosPageData.elements.map((_, idx) => idx);
    } else {
      const lowestY = Math.min(...selectedInfosElements.map(idx => infosPageData.elements[idx].position.y));
      
      // S√©lectionner tous les √©l√©ments au-dessus
      selectedInfosElements = infosPageData.elements
        .map((el, idx) => ({ el, idx }))
        .filter(item => item.el.position.y <= lowestY)
        .map(item => item.idx);
    }
    
    renderInfosCanvas();
  }
  
  // Ctrl+Fl√®che Bas : s√©lectionner tous les √©l√©ments en-dessous
  if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowDown') {
    e.preventDefault();
    
    // Trouver l'√©l√©ment le plus bas actuellement s√©lectionn√©
    if (selectedInfosElements.length === 0) {
      // Si rien de s√©lectionn√©, s√©lectionner tous les √©l√©ments
      selectedInfosElements = infosPageData.elements.map((_, idx) => idx);
    } else {
      const highestY = Math.max(...selectedInfosElements.map(idx => infosPageData.elements[idx].position.y));
      
      // S√©lectionner tous les √©l√©ments en-dessous
      selectedInfosElements = infosPageData.elements
        .map((el, idx) => ({ el, idx }))
        .filter(item => item.el.position.y >= highestY)
        .map(item => item.idx);
    }
    
    renderInfosCanvas();
  }
});

// Cr√©er un √©l√©ment HTML √† partir des donn√©es avec positionnement absolu
function createInfosElement(element, idx) {
  const wrapper = document.createElement('div');
  wrapper.className = 'infos-element';
  wrapper.dataset.index = idx;
  
  // Position par d√©faut si non d√©finie
  const pos = element.position || { x: 50 + (idx * 30), y: 50 + (idx * 30), width: 400, height: 200, zIndex: idx + 1 };
  
  wrapper.style.cssText = `
    position:absolute;
    left:${pos.x}px;
    top:${pos.y}px;
    width:${pos.width}px;
    min-height:${pos.height}px;
    z-index:${pos.zIndex};
    padding:15px;
    background:rgba(107,5,114,0.3);
    border:2px solid #6a0572;
    border-radius:10px;
    cursor:move;
    transition:border-color 0.2s;
    box-sizing:border-box;
  `;
  
  // V√©rifier si s√©lectionn√© pour le style
  const isSelected = selectedInfosElements.includes(idx);
  if (isSelected) {
    wrapper.style.background = 'rgba(255,211,105,0.4)';
    wrapper.style.borderColor = '#ffd369';
  }
  
  wrapper.dataset.elementIdx = idx;
  wrapper.onmouseover = () => wrapper.style.borderColor = '#ffd369';
  wrapper.onmouseout = () => {
    if (!selectedInfosElements.includes(idx)) {
      wrapper.style.borderColor = '#6a0572';
    }
  };
  
  // Drag & Drop
  let isDragging = false;
  let startX, startY, initialX, initialY;
  let initialPositions = [];
  const isAnchor = element.type === 'anchor';
  
  wrapper.onmousedown = (e) => {
    if (e.target.tagName === 'BUTTON' || e.target.closest('.resize-handle')) return;
    
    // Ctrl+clic pour s√©lection multiple
    if (e.ctrlKey || e.metaKey) {
      e.preventDefault();
      const selectedIdx = selectedInfosElements.indexOf(idx);
      if (selectedIdx > -1) {
        selectedInfosElements.splice(selectedIdx, 1);
      } else {
        selectedInfosElements.push(idx);
      }
      renderInfosCanvas();
      return;
    }
    
    // Si on clique sur un √©l√©ment non s√©lectionn√©, d√©s√©lectionner tout
    if (!selectedInfosElements.includes(idx)) {
      selectedInfosElements = [];
    }
    
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    initialX = pos.x;
    initialY = pos.y;
    
    // Sauvegarder positions initiales des √©l√©ments s√©lectionn√©s
    initialPositions = selectedInfosElements.map(i => ({
      idx: i,
      y: infosPageData.elements[i].position.y
    }));
    
    wrapper.style.cursor = 'grabbing';
    wrapper.style.zIndex = 9999;
  };
  
  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    
    // Obtenir les limites du canvas
    const canvas = document.getElementById('infos-canvas');
    if (!canvas) return;
    const canvasRect = canvas.getBoundingClientRect();
    const wrapperWidth = wrapper.offsetWidth;
    const wrapperHeight = wrapper.offsetHeight;
    
    // Si plusieurs √©l√©ments s√©lectionn√©s, les d√©placer tous sur Y uniquement
    if (selectedInfosElements.length > 1) {
      initialPositions.forEach(item => {
        const el = infosPageData.elements[item.idx];
        if (el && el.position) {
          let newY = item.y + dy;
          // Limiter aux bordures
          newY = Math.max(20, Math.min(newY, canvasRect.height - 200));
          el.position.y = newY;
          
          // Mettre √† jour visuellement
          const elWrapper = document.querySelector(`[data-element-idx="${item.idx}"]`);
          if (elWrapper) {
            elWrapper.style.top = newY + 'px';
          }
        }
      });
    }
    // Pour les anchors, bloquer le d√©placement horizontal
    else if (isAnchor) {
      let newY = initialY + dy;
      // Limiter aux bordures (avec marge de 20px)
      newY = Math.max(20, Math.min(newY, canvasRect.height - wrapperHeight - 20));
      pos.y = newY;
      wrapper.style.top = pos.y + 'px';
    } else {
      let newX = initialX + dx;
      let newY = initialY + dy;
      // Limiter aux bordures du canvas
      newX = Math.max(20, Math.min(newX, canvasRect.width - wrapperWidth - 20));
      newY = Math.max(20, Math.min(newY, canvasRect.height - wrapperHeight - 20));
      pos.x = newX;
      pos.y = newY;
      wrapper.style.left = pos.x + 'px';
      wrapper.style.top = pos.y + 'px';
    }
  });
  
  document.addEventListener('mouseup', () => {
    if (isDragging) {
      isDragging = false;
      wrapper.style.cursor = 'move';
      wrapper.style.zIndex = pos.zIndex;
      
      // Sauvegarder tous les √©l√©ments modifi√©s
      if (selectedInfosElements.length > 1) {
        saveInfosPage();
      } else {
        updateElementPosition(idx, pos);
      }
    }
  });
  
  // Barre d'outils de l'√©l√©ment
  const toolbar = document.createElement('div');
  toolbar.style.cssText = 'display:flex;justify-content:flex-end;gap:8px;margin-bottom:10px;user-select:none;';
  
  // Ne pas afficher le bouton "Modifier" pour les marques et le sommaire
  const showEditButton = element.type !== 'anchor' && element.type !== 'sommaire';
  
  toolbar.innerHTML = `
    ${showEditButton ? `<button onclick="editInfosElement(${idx})" style="background:#4b1a7f;color:#ffd369;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:0.8em;">‚úèÔ∏è Modifier</button>` : ''}
    <button onclick="deleteInfosElement(${idx})" style="background:#8b0000;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:0.8em;">üóëÔ∏è</button>
  `;
  wrapper.appendChild(toolbar);
  
  // Contenu de l'√©l√©ment
  const content = document.createElement('div');
  content.style.cssText = element.style || '';
  
  switch (element.type) {
    case 'sommaire':
      // G√©n√©rer un aper√ßu du sommaire
      const textElements = infosPageData.elements.filter(e => e.type === 'text' && e.content);
      content.innerHTML = `<div style="background:#2e004f;padding:15px;border-radius:8px;">
        <div style="font-size:1.2em;font-weight:600;color:#ffd369;margin-bottom:10px;">üìã Sommaire (auto-g√©n√©r√©)</div>
        <div style="color:#8ef58e;font-size:0.9em;">
          ${textElements.length > 0 ? textElements.map((e, i) => {
            const title = e.content.replace(/<[^>]*>/g, '').slice(0, 50);
            return `<div style="margin:5px 0;">‚Üí ${title}${title.length >= 50 ? '...' : ''}</div>`;
          }).join('') : '<div style="opacity:0.6;">Aucune section de texte d√©tect√©e</div>'}
        </div>
      </div>`;
      break;
    case 'text':
      content.innerHTML = element.content || 'Texte vide';
      break;
    case 'image':
      content.innerHTML = `<img src="${element.content}" style="max-width:100%;border-radius:8px;" />`;
      break;
    case 'video':
      content.innerHTML = `<video src="${element.content}" controls style="max-width:100%;border-radius:8px;"></video>`;
      break;
    case 'product':
      const prod = articlesData.find(a => a.id === element.content);
      if (prod) {
        // Parse style config
        const style = element.style || '';
        const layout = style.includes('layout:horizontal') ? 'horizontal' : 'vertical';
        const imageSize = (style.match(/image-size:(\d+px)/) || ['', '200px'])[1];
        const imagePosition = (style.match(/image-position:(top|left|right|bottom)/) || ['', 'top'])[1];
        const showName = !style.includes('show-name:false');
        const showPrice = !style.includes('show-price:false');
        
        // Thumbnail
        const thumbnail = prod.thumbnail || (prod.medias && prod.medias[0]?.path) || '';
        let imgHtml = '';
        if(thumbnail){
          if(/\.(mp4|webm|mov)$/i.test(thumbnail)){
            imgHtml = `<video src="${thumbnail}" muted loop autoplay style="max-width:${imageSize};max-height:${imageSize};object-fit:cover;border-radius:8px;"></video>`;
          } else {
            imgHtml = `<img src="${thumbnail}" style="max-width:${imageSize};max-height:${imageSize};object-fit:cover;border-radius:8px;"/>`;
          }
        } else {
          imgHtml = `<div style="width:${imageSize};height:${imageSize};border:2px dashed #6a0572;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:2em;opacity:0.5;">üß®</div>`;
        }
        
        const nameHtml = showName ? `<div style="font-weight:700;font-size:1.1em;color:#ffd369;margin-bottom:5px;">${prod.nom || 'Produit'}</div>` : '';
        const priceHtml = showPrice ? `<div style="font-size:0.9em;color:#8ef58e;margin-bottom:5px;">${prod.prix ? prod.prix + '‚Ç¨' : 'Prix non d√©fini'}</div>` : '';
        
        // D√©terminer la direction flex
        const flexDir = (layout === 'horizontal' || imagePosition === 'left' || imagePosition === 'right') ? 'row' : 'column';
        const order = (imagePosition === 'bottom' || imagePosition === 'right') ? 'reverse' : 'normal';
        
        content.innerHTML = `<div style="padding:15px;background:#2e004f;border-radius:12px;display:flex;flex-direction:${flexDir}${order === 'reverse' ? '-reverse' : ''};align-items:center;gap:15px;">
          ${imgHtml}
          <div style="flex:1;display:flex;flex-direction:column;gap:5px;">
            ${nameHtml}
            ${priceHtml}
            <div style="font-size:0.75em;color:#8ef58e;opacity:0.7;">ID: ${prod.id}</div>
          </div>
        </div>`;
      } else {
        content.innerHTML = `<div style="color:#ff6b6b;">Produit introuvable (ID: ${element.content})</div>`;
      }
      break;
    case 'link':
      content.innerHTML = `<a href="${element.url}" target="_blank" style="color:#8ef58e;text-decoration:underline;">${element.content || element.url}</a>`;
      break;
    case 'anchor':
      // Afficher une marque visuelle en barre horizontale
      // R√©cup√©rer toutes les sections du sommaire
      const getAllSectionsForAnchor = (items, path = []) => {
        let sections = [];
        items.forEach(item => {
          const currentPath = [...path, item.titre];
          sections.push({
            path: currentPath.join(' > '),
            id: item.id,
            titre: item.titre
          });
          if (item.children && item.children.length > 0) {
            sections = sections.concat(getAllSectionsForAnchor(item.children, currentPath));
          }
        });
        return sections;
      };
      const allSectionsForAnchor = getAllSectionsForAnchor(infosPageData.sommaire?.items || []);
      const anchorSection = allSectionsForAnchor.find(s => s.id === element.content);
      const anchorTitle = anchorSection ? anchorSection.path : element.content;
      content.innerHTML = `<div style="
        width:90%;
        padding:12px 20px;
        background:linear-gradient(135deg, #28a745, #20c997);
        border:2px solid #1e7e34;
        border-radius:8px;
        display:flex;
        align-items:center;
        gap:12px;
        box-shadow:0 2px 8px rgba(40,167,69,0.3);
      ">
        <span style="font-size:1.5em;">‚öì</span>
        <div style="flex:1;">
          <div style="font-weight:700;color:#fff;font-size:0.95em;">Marque de sommaire</div>
          <div style="font-size:0.8em;color:rgba(255,255,255,0.8);">${anchorTitle}</div>
        </div>
      </div>`;
      // Forcer la largeur et position pour que ce soit une vraie barre
      const canvas = document.getElementById('infos-canvas');
      if (canvas) {
        wrapper.style.width = `${canvas.offsetWidth - 80}px`; // Largeur canvas moins marges
        wrapper.style.left = '20px'; // Position fixe √† gauche
      }
      wrapper.style.minHeight = 'auto';
      wrapper.style.height = 'auto';
      break;
    default:
      // Tenter de d√©tecter le type bas√© sur le contenu si le type est invalide
      if (element.content && typeof element.content === 'string') {
        if (/\.(jpg|jpeg|png|gif|webp|svg)$/i.test(element.content)) {
          content.innerHTML = `<img src="${element.content}" style="max-width:100%;border-radius:8px;" />`;
          element.type = 'image'; // Corriger le type
        } else if (/\.(mp4|webm|mov)$/i.test(element.content)) {
          content.innerHTML = `<video src="${element.content}" controls style="max-width:100%;border-radius:8px;"></video>`;
          element.type = 'video'; // Corriger le type
        } else {
          content.innerHTML = `<div style="color:#ff6b6b;padding:10px;background:rgba(255,0,0,0.1);border-radius:8px;">‚ö†Ô∏è Type d'√©l√©ment non reconnu: "${element.type}"</div>`;
        }
      } else {
        content.innerHTML = `<div style="color:#ff6b6b;padding:10px;background:rgba(255,0,0,0.1);border-radius:8px;">‚ö†Ô∏è Type d'√©l√©ment non reconnu: "${element.type}"</div>`;
      }
  }
  
  wrapper.appendChild(content);
  
  // Poign√©es de redimensionnement (8: coins + bords) - sauf pour les anchors
  if (!isAnchor) {
    const handles = ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'];
    handles.forEach(dir => {
    const handle = document.createElement('div');
    handle.className = 'resize-handle resize-' + dir;
    handle.style.cssText = `
      position:absolute;
      background:#ffd369;
      border:1px solid #2e003e;
      z-index:10;
      ${dir.includes('n') ? 'top:-5px;' : ''}
      ${dir.includes('s') ? 'bottom:-5px;' : ''}
      ${dir.includes('w') ? 'left:-5px;' : ''}
      ${dir.includes('e') ? 'right:-5px;' : ''}
      ${dir === 'n' || dir === 's' ? 'left:50%;transform:translateX(-50%);width:30px;height:8px;cursor:ns-resize;' : ''}
      ${dir === 'e' || dir === 'w' ? 'top:50%;transform:translateY(-50%);width:8px;height:30px;cursor:ew-resize;' : ''}
      ${dir === 'nw' || dir === 'ne' || dir === 'se' || dir === 'sw' ? 'width:10px;height:10px;border-radius:50%;' : ''}
      ${dir === 'nw' ? 'cursor:nw-resize;' : ''}
      ${dir === 'ne' ? 'cursor:ne-resize;' : ''}
      ${dir === 'se' ? 'cursor:se-resize;' : ''}
      ${dir === 'sw' ? 'cursor:sw-resize;' : ''}
    `;
    
    let isResizing = false;
    let resizeStartX, resizeStartY, startWidth, startHeight, startLeft, startTop;
    
    handle.onmousedown = (e) => {
      e.stopPropagation();
      isResizing = true;
      resizeStartX = e.clientX;
      resizeStartY = e.clientY;
      startWidth = pos.width;
      startHeight = pos.height;
      startLeft = pos.x;
      startTop = pos.y;
      wrapper.style.zIndex = 9999;
    };
    
    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const dx = e.clientX - resizeStartX;
      const dy = e.clientY - resizeStartY;
      
      // Obtenir les dimensions du canvas
      const canvas = document.getElementById('infos-canvas');
      if (!canvas) return;
      const canvasRect = canvas.getBoundingClientRect();
      const maxWidth = canvasRect.width - 40; // Marges
      const maxHeight = canvasRect.height - 40;
      
      // Redimensionnement selon la direction avec limites
      if (dir.includes('e')) {
        const newWidth = Math.max(100, startWidth + dx);
        // V√©rifier que l'√©l√©ment ne d√©passe pas √† droite
        pos.width = Math.min(newWidth, maxWidth - pos.x);
      }
      if (dir.includes('w')) {
        const newWidth = Math.max(100, startWidth - dx);
        const newX = startLeft + (startWidth - newWidth);
        // V√©rifier que l'√©l√©ment ne d√©passe pas √† gauche
        if (newX >= 20) {
          pos.x = newX;
          pos.width = newWidth;
        }
      }
      if (dir.includes('s')) {
        const newHeight = Math.max(80, startHeight + dy);
        // V√©rifier que l'√©l√©ment ne d√©passe pas en bas (pas de limite pour hauteur infinie)
        pos.height = newHeight;
      }
      if (dir.includes('n')) {
        const newHeight = Math.max(80, startHeight - dy);
        const newY = startTop + (startHeight - newHeight);
        // V√©rifier que l'√©l√©ment ne d√©passe pas en haut
        if (newY >= 20) {
          pos.y = newY;
          pos.height = newHeight;
        }
      }
      
      wrapper.style.width = pos.width + 'px';
      wrapper.style.minHeight = pos.height + 'px';
      wrapper.style.left = pos.x + 'px';
      wrapper.style.top = pos.y + 'px';
    });
    
    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        wrapper.style.zIndex = pos.zIndex;
        updateElementPosition(idx, pos);
      }
    });
    
    wrapper.appendChild(handle);
    });
  }
  
  return wrapper;
}

// G√©n√©rer une position par d√©faut pour les nouveaux √©l√©ments
function getDefaultPosition() {
  const count = infosPageData.elements.length;
  return {
    x: 50 + (count * 30) % 400,
    y: 50 + (count * 30) % 400,
    width: 400,
    height: 200,
    zIndex: count + 1
  };
}

// Ajouter un √©l√©ment
function addInfosElement(type) {
  if (type === 'text') {
    showInfosTextPrompt((content, style) => {
      infosPageData.elements.push({ type: 'text', content, style, position: getDefaultPosition() });
      renderInfosCanvas();
    });
  } else if (type === 'media') {
    showInfosMediaSelector((mediaPath) => {
      // D√©tecter si c'est une vid√©o ou image
      const isVideo = /\.(mp4|webm|mov)$/i.test(mediaPath);
      infosPageData.elements.push({ type: isVideo ? 'video' : 'image', content: mediaPath, position: getDefaultPosition() });
      renderInfosCanvas();
    });
  } else if (type === 'product') {
    showInfosProductSelector((productId, style) => {
      infosPageData.elements.push({ type: 'product', content: productId, style, position: getDefaultPosition() });
      renderInfosCanvas();
    });
  } else if (type === 'anchor') {
    showInfosAnchorSelector((anchorId) => {
      // V√©rifier si une marque existe d√©j√† pour cette section
      const existingAnchor = infosPageData.elements.find(el => el.type === 'anchor' && el.content === anchorId);
      if (existingAnchor) {
        showToast('‚ö†Ô∏è Une marque existe d√©j√† pour cette section', 'warning');
        return;
      }
      
      infosPageData.elements.push({ type: 'anchor', content: anchorId, position: getDefaultPosition() });
      renderInfosCanvas();
      showToast('‚öì Marque de sommaire ajout√©e', 'success');
    });
  } else if (type === 'link') {
    showInfosLinkPrompt((url, text, style) => {
      infosPageData.elements.push({ type: 'link', content: text, url, style, position: getDefaultPosition() });
      renderInfosCanvas();
    });
  }
}

// √âditer un √©l√©ment
function editInfosElement(idx) {
  const element = infosPageData.elements[idx];
  if (!element) return;
  
  if (element.type === 'sommaire') {
    showToast('<img src="img/_technique/icon/information.png" style="width:16px;height:16px;vertical-align:middle;"/> Le sommaire se g√©n√®re automatiquement', 'info');
    return;
  } else if (element.type === 'anchor') {
    showToast('<img src="img/_technique/icon/information.png" style="width:16px;height:16px;vertical-align:middle;"/> Les marques ne peuvent pas √™tre modifi√©es (utilisez les fl√®ches pour changer l\'ordre)', 'info');
    return;
  } else if (element.type === 'text') {
    showInfosTextPrompt((content, style) => {
      element.content = content;
      element.style = style;
      renderInfosCanvas();
    }, element.content, element.style);
  } else if (element.type === 'image' || element.type === 'video') {
    showInfosMediaSelector((mediaPath) => {
      const isVideo = /\.(mp4|webm|mov)$/i.test(mediaPath);
      element.type = isVideo ? 'video' : 'image';
      element.content = mediaPath;
      renderInfosCanvas();
    }, element.content);
  } else if (element.type === 'product') {
    showInfosProductSelector((productId, style) => {
      element.content = productId;
      element.style = style;
      renderInfosCanvas();
    }, element.content, element.style);
  } else if (element.type === 'link') {
    showInfosLinkPrompt((url, text, style) => {
      element.content = text;
      element.url = url;
      element.style = style;
      renderInfosCanvas();
    }, element.url, element.content, element.style);
  }
}

// Supprimer un √©l√©ment
function deleteInfosElement(idx) {
  infosPageData.elements.splice(idx, 1);
  renderInfosCanvas();
  showToast('üóëÔ∏è √âl√©ment supprim√©', 'success');
}

// D√©placer un √©l√©ment
function moveInfosElement(idx, direction) {
  if (direction === 'up' && idx > 0) {
    [infosPageData.elements[idx], infosPageData.elements[idx - 1]] = [infosPageData.elements[idx - 1], infosPageData.elements[idx]];
    renderInfosCanvas();
  } else if (direction === 'down' && idx < infosPageData.elements.length - 1) {
    [infosPageData.elements[idx], infosPageData.elements[idx + 1]] = [infosPageData.elements[idx + 1], infosPageData.elements[idx]];
    renderInfosCanvas();
  }
}

// Prompt pour ajouter/√©diter du texte
function showInfosTextPrompt(callback, initialContent = '', initialStyle = '') {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;';
  
  const box = document.createElement('div');
  box.style.cssText = 'background:#2e004f;padding:30px;border-radius:14px;width:800px;max-width:95%;max-height:90vh;overflow-y:auto;';
  box.innerHTML = `
    <h3 style="margin:0 0 20px 0;color:#ffd369;">üìù √âditeur de texte enrichi</h3>
    
    <!-- Barre d'outils de formatage -->
    <div style="display:flex;flex-wrap:wrap;gap:6px;padding:12px;background:#1a0033;border-radius:8px;margin-bottom:15px;">
      <!-- Taille -->
      <div style="display:flex;align-items:center;gap:6px;padding:4px 8px;background:#2e004f;border-radius:6px;">
        <label style="color:#8ef58e;font-size:0.8em;">Taille:</label>
        <input type="number" id="text-font-size" min="8" max="100" value="16" style="width:50px;padding:4px;border-radius:4px;border:1px solid #6a0572;background:#1a0033;color:#fff;text-align:center;">
        <span style="color:#8ef58e;font-size:0.8em;">px</span>
      </div>
      
      <!-- Police -->
      <select id="text-font-family" style="padding:6px 10px;border-radius:6px;border:1px solid #6a0572;background:#1a0033;color:#fff;cursor:pointer;">
        <option value="Arial, sans-serif">Arial</option>
        <option value="'Times New Roman', serif">Times New Roman</option>
        <option value="'Courier New', monospace">Courier New</option>
        <option value="Georgia, serif">Georgia</option>
        <option value="Verdana, sans-serif">Verdana</option>
        <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
        <option value="Impact, sans-serif">Impact</option>
        <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
      </select>
      
      <!-- Gras -->
      <button id="text-bold-btn" title="Gras" style="background:#4b1a7f;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700;">B</button>
      
      <!-- Italique -->
      <button id="text-italic-btn" title="Italique" style="background:#4b1a7f;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-style:italic;">I</button>
      
      <!-- Soulign√© + couleur -->
      <div style="display:flex;align-items:center;gap:4px;">
        <button id="text-underline-btn" title="Soulign√©" style="background:#4b1a7f;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;text-decoration:underline;">U</button>
        <input type="color" id="text-underline-color" value="#ffffff" title="Couleur du soulignement" style="width:30px;height:30px;border:none;border-radius:6px;cursor:pointer;">
      </div>
      
      <!-- Surlign√© + couleur -->
      <div style="display:flex;align-items:center;gap:4px;">
        <button id="text-highlight-btn" title="Surlign√©" style="background:#4b1a7f;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;position:relative;">
          <span style="background:#ffd369;color:#2e003e;padding:2px 6px;border-radius:3px;">H</span>
        </button>
        <input type="color" id="text-highlight-color" value="#ffd369" title="Couleur du surlignage" style="width:30px;height:30px;border:none;border-radius:6px;cursor:pointer;">
      </div>
      
      <!-- Couleur du texte -->
      <div style="display:flex;align-items:center;gap:4px;">
        <label style="color:#8ef58e;font-size:0.8em;">Couleur:</label>
        <input type="color" id="text-color" value="#ffffff" style="width:40px;height:30px;border:none;border-radius:6px;cursor:pointer;">
      </div>
      
      <!-- Alignement -->
      <select id="text-align" style="padding:6px 10px;border-radius:6px;border:1px solid #6a0572;background:#1a0033;color:#fff;cursor:pointer;">
        <option value="left">‚¨Ö Gauche</option>
        <option value="center">‚¨å Centre</option>
        <option value="right">‚û° Droite</option>
        <option value="justify">‚¨å Justifi√©</option>
      </select>
      
      <!-- Lien vers produit/variante -->
      <button id="text-link-product-btn" title="Lier √† un produit/variante" style="background:#28a745;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:600;">üîó Produit</button>
    </div>
    
    <!-- Zone d'√©dition -->
    <div id="text-editor" contenteditable="true" spellcheck="false" style="
      width:100%;
      min-height:200px;
      max-height:400px;
      overflow-y:auto;
      padding:15px;
      border-radius:8px;
      border:2px solid #6a0572;
      background:#1a0033;
      color:#fff;
      font-size:16px;
      line-height:1.6;
      margin-bottom:15px;
      outline:none;
    ">${initialContent}</div>
    
    <div style="font-size:0.85em;color:#8ef58e;opacity:0.7;margin-bottom:15px;">
      üí° S√©lectionnez du texte pour appliquer le formatage caract√®re par caract√®re
    </div>
    
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="infos-text-cancel" style="background:#6d6d6d;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">Annuler</button>
      <button id="infos-text-ok" style="background:#8ef58e;color:#2e003e;font-weight:700;border:none;padding:10px 24px;border-radius:8px;cursor:pointer;">‚úì Valider</button>
    </div>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  const editor = document.getElementById('text-editor');
  
  // Fonctions de formatage
  const applyFormat = (command, value = null) => {
    editor.focus();
    document.execCommand(command, false, value);
  };
  
  // Gras
  document.getElementById('text-bold-btn').onclick = () => applyFormat('bold');
  
  // Italique
  document.getElementById('text-italic-btn').onclick = () => applyFormat('italic');
  
  // Soulign√© avec couleur
  document.getElementById('text-underline-btn').onclick = () => {
    const selection = window.getSelection();
    if (selection.rangeCount > 0 && !selection.isCollapsed) {
      const range = selection.getRangeAt(0);
      const span = document.createElement('span');
      const color = document.getElementById('text-underline-color').value;
      span.style.textDecoration = 'underline';
      span.style.textDecorationColor = color;
      range.surroundContents(span);
    }
  };
  
  // Surlign√© avec couleur
  document.getElementById('text-highlight-btn').onclick = () => {
    const selection = window.getSelection();
    if (selection.rangeCount > 0 && !selection.isCollapsed) {
      const range = selection.getRangeAt(0);
      const span = document.createElement('span');
      const color = document.getElementById('text-highlight-color').value;
      span.style.backgroundColor = color;
      span.style.padding = '2px 4px';
      span.style.borderRadius = '3px';
      range.surroundContents(span);
    }
  };
  
  // Couleur du texte
  document.getElementById('text-color').onchange = (e) => {
    applyFormat('foreColor', e.target.value);
  };
  
  // Taille de police
  document.getElementById('text-font-size').onchange = (e) => {
    const selection = window.getSelection();
    if (selection.rangeCount > 0 && !selection.isCollapsed) {
      const range = selection.getRangeAt(0);
      const span = document.createElement('span');
      span.style.fontSize = e.target.value + 'px';
      range.surroundContents(span);
    }
  };
  
  // Police
  document.getElementById('text-font-family').onchange = (e) => {
    applyFormat('fontName', e.target.value);
  };
  
  // Alignement
  document.getElementById('text-align').onchange = (e) => {
    editor.style.textAlign = e.target.value;
  };
  
  // Lien vers produit/variante
  document.getElementById('text-link-product-btn').onclick = async () => {
    const selection = window.getSelection();
    if (selection.rangeCount === 0 || selection.isCollapsed) {
      showToast('‚ö†Ô∏è S√©lectionnez d\'abord le texte √† lier', 'warning');
      return;
    }
    
    const range = selection.getRangeAt(0);
    const selectedText = range.toString();
    
    // Ouvrir un s√©lecteur de produit/variante
    showProductVariantSelector((productId, varianteName) => {
      const span = document.createElement('span');
      span.className = 'product-link';
      span.dataset.productId = productId;
      if (varianteName) span.dataset.varianteName = varianteName;
      span.style.cssText = 'color:#8ef58e;cursor:pointer;position:relative;padding:2px 4px;background:rgba(142,245,142,0.15);border-radius:3px;transition:all 0.2s;';
      span.textContent = selectedText;
      span.title = varianteName ? `üîó ${varianteName}` : `üîó Produit`;
      
      try {
        range.deleteContents();
        range.insertNode(span);
      } catch (e) {
        console.error('Erreur insertion lien:', e);
      }
    });
  };
  
  // Valider
  document.getElementById('infos-text-ok').onclick = () => {
    const content = editor.innerHTML;
    const align = editor.style.textAlign || 'left';
    const style = `text-align:${align};`;
    callback(content, style);
    modal.remove();
  };
  
  // Annuler
  document.getElementById('infos-text-cancel').onclick = () => modal.remove();
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

// S√©lecteur de produit/variante pour cr√©er des liens dans le texte
function showProductVariantSelector(callback) {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10002;';
  
  const box = document.createElement('div');
  box.style.cssText = 'background:#2e004f;padding:30px;border-radius:14px;width:700px;max-width:95%;max-height:80vh;overflow-y:auto;';
  
  let selectedProduct = null;
  let selectedVariant = null;
  
  const renderProductsList = () => {
    const productsHtml = articlesData.map(article => {
      const hasVariants = article.variantes && article.variantes.length > 0;
      const variantsHtml = hasVariants ? article.variantes.map((v, vIdx) => `
        <div onclick="selectProductVariant('${article.id}', '${v.nom}')" style="padding:8px 12px;background:rgba(107,5,114,0.3);border:1px solid #6a0572;border-radius:6px;cursor:pointer;transition:all 0.2s;margin-left:30px;margin-top:5px;" onmouseover="this.style.background='rgba(142,245,142,0.2)'" onmouseout="this.style.background='rgba(107,5,114,0.3)'">
          <span style="color:#8ef58e;">üì¶ ${v.nom}</span>
          ${v.description ? `<div style="font-size:0.8em;color:#ccc;margin-top:3px;">${v.description}</div>` : ''}
        </div>
      `).join('') : '';
      
      return `
        <div style="margin-bottom:15px;padding:15px;background:rgba(46,0,79,0.5);border-radius:10px;border:1px solid #6a0572;">
          <div onclick="selectProductVariant('${article.id}', null)" style="cursor:pointer;transition:all 0.2s;padding:10px;border-radius:8px;" onmouseover="this.style.background='rgba(142,245,142,0.15)'" onmouseout="this.style.background='transparent'">
            <div style="display:flex;align-items:center;gap:10px;">
              ${article.thumbnail ? `<img src="${article.thumbnail}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;">` : ''}
              <div style="flex:1;">
                <div style="color:#ffd369;font-weight:700;">${article.nom}</div>
                <div style="color:#8ef58e;font-size:0.85em;">${article.prix}‚Ç¨</div>
              </div>
            </div>
          </div>
          ${variantsHtml}
        </div>
      `;
    }).join('');
    
    box.innerHTML = `
      <h3 style="margin:0 0 20px 0;color:#ffd369;">üîó S√©lectionner un produit ou variante</h3>
      
      <!-- Recherche -->
      <input type="text" id="product-search" placeholder="üîç Rechercher un produit..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #6a0572;background:#1a0033;color:#fff;margin-bottom:15px;font-size:0.95em;">
      
      <!-- Liste des produits -->
      <div id="products-list" style="max-height:400px;overflow-y:auto;margin-bottom:20px;">
        ${productsHtml || '<div style="text-align:center;color:#888;padding:40px;">Aucun produit disponible</div>'}
      </div>
      
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="product-selector-cancel" style="background:#6d6d6d;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Annuler</button>
      </div>
    `;
  };
  
  renderProductsList();
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  // Fonction globale pour s√©lectionner un produit/variante
  window.selectProductVariant = (productId, variantName) => {
    callback(productId, variantName);
    modal.remove();
    showToast(`‚úÖ Lien cr√©√© vers ${variantName || 'le produit'}`, 'success');
  };
  
  // Recherche
  document.getElementById('product-search').oninput = (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filtered = articlesData.filter(a => 
      a.nom.toLowerCase().includes(searchTerm) ||
      (a.variantes && a.variantes.some(v => v.nom.toLowerCase().includes(searchTerm)))
    );
    
    const productsHtml = filtered.map(article => {
      const hasVariants = article.variantes && article.variantes.length > 0;
      const variantsHtml = hasVariants ? article.variantes.map((v, vIdx) => `
        <div onclick="selectProductVariant('${article.id}', '${v.nom}')" style="padding:8px 12px;background:rgba(107,5,114,0.3);border:1px solid #6a0572;border-radius:6px;cursor:pointer;transition:all 0.2s;margin-left:30px;margin-top:5px;" onmouseover="this.style.background='rgba(142,245,142,0.2)'" onmouseout="this.style.background='rgba(107,5,114,0.3)'">
          <span style="color:#8ef58e;">üì¶ ${v.nom}</span>
        </div>
      `).join('') : '';
      
      return `
        <div style="margin-bottom:15px;padding:15px;background:rgba(46,0,79,0.5);border-radius:10px;border:1px solid #6a0572;">
          <div onclick="selectProductVariant('${article.id}', null)" style="cursor:pointer;transition:all 0.2s;padding:10px;border-radius:8px;" onmouseover="this.style.background='rgba(142,245,142,0.15)'" onmouseout="this.style.background='transparent'">
            <div style="color:#ffd369;font-weight:700;">${article.nom} - ${article.prix}‚Ç¨</div>
          </div>
          ${variantsHtml}
        </div>
      `;
    }).join('');
    
    document.getElementById('products-list').innerHTML = productsHtml || '<div style="text-align:center;color:#888;padding:40px;">Aucun r√©sultat</div>';
  };
  
  document.getElementById('product-selector-cancel').onclick = () => modal.remove();
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

// S√©lecteur de m√©dia depuis GoFile
function showInfosMediaSelector(callback, initialMediaPath = '', initialStyle = '') {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;';
  
  const box = document.createElement('div');
  box.style.cssText = 'background:#2e004f;padding:30px;border-radius:14px;width:600px;max-width:90%;';
  box.innerHTML = `
    <h3 style="margin:0 0 20px 0;color:#ffd369;">üé¨ S√©lectionner un m√©dia</h3>
    <div style="background:#1a0033;padding:20px;border-radius:8px;margin-bottom:15px;">
      <div style="color:#8ef58e;margin-bottom:10px;font-weight:600;">M√©dia s√©lectionn√©:</div>
      <div id="infos-media-selected" style="color:#fff;font-size:0.9em;word-break:break-all;">${initialMediaPath || 'Aucun m√©dia s√©lectionn√©'}</div>
      <div id="infos-media-preview" style="margin-top:15px;text-align:center;"></div>
    </div>
    
    <button id="infos-media-browse" style="width:100%;background:#6a0572;color:#fff;border:none;padding:12px;border-radius:8px;cursor:pointer;font-weight:600;margin-bottom:20px;">üìÅ Parcourir GoFile</button>
    
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="infos-media-selector-cancel" style="background:#6d6d6d;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Annuler</button>
      <button id="infos-media-selector-ok" style="background:#8ef58e;color:#240038;font-weight:700;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">OK</button>
    </div>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  let selectedMedia = initialMediaPath;
  
  // Afficher preview si initial media
  if (initialMediaPath) {
    updateMediaPreview(initialMediaPath);
  }
  
  function updateMediaPreview(path) {
    const preview = document.getElementById('infos-media-preview');
    const selected = document.getElementById('infos-media-selected');
    selected.textContent = path;
    
    if (/\.(mp4|webm|mov)$/i.test(path)) {
      preview.innerHTML = `<video src="${path}" controls style="max-width:100%;max-height:200px;border-radius:8px;"></video>`;
    } else {
      preview.innerHTML = `<img src="${path}" style="max-width:100%;max-height:200px;border-radius:8px;">`;
    }
  }
  
  document.getElementById('infos-media-browse').onclick = () => {
    if (typeof openFileExplorer === 'function') {
      openFileExplorer('img', (selected) => {
        if (selected && selected.length > 0) {
          selectedMedia = selected[0];
          updateMediaPreview(selectedMedia);
          showToast('‚úÖ M√©dia s√©lectionn√©', 'success');
        }
      });
    } else {
      // Ouvrir le s√©lecteur GoFile si l'explorateur n'est pas disponible
      openGofileSelectorForInfos(callback);
    }
  };
  
  document.getElementById('infos-media-selector-ok').onclick = () => {
    if (!selectedMedia) {
      showToast('‚ö†Ô∏è Veuillez s√©lectionner un m√©dia', 'warning');
      return;
    }
    callback(selectedMedia);
    modal.remove();
  };
  
  document.getElementById('infos-media-selector-cancel').onclick = () => modal.remove();
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

// Prompt pour m√©dia (ancienne version - peut √™tre supprim√©e)
function showInfosMediaPrompt(type, callback, initialUrl = '', initialStyle = '') {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;';
  
  const box = document.createElement('div');
  box.style.cssText = 'background:#2e004f;padding:30px;border-radius:14px;width:500px;max-width:90%;';
  box.innerHTML = `
    <h3 style="margin:0 0 20px 0;color:#ffd369;">${type === 'image' ? 'üñºÔ∏è Image' : 'üé• Vid√©o'}</h3>
    <label style="display:block;margin-bottom:5px;color:#8ef58e;">URL ${type === 'image' ? 'de l\'image' : 'de la vid√©o'}:</label>
    <input type="url" id="infos-media-url" value="${initialUrl}" placeholder="https://..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #6a0572;background:#1a0033;color:#fff;margin-bottom:20px;">
    
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="infos-media-cancel" style="background:#6d6d6d;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Annuler</button>
      <button id="infos-media-ok" style="background:#8ef58e;color:#240038;font-weight:700;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">OK</button>
    </div>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  document.getElementById('infos-media-ok').onclick = () => {
    const url = document.getElementById('infos-media-url').value;
    const width = document.getElementById('infos-media-width').value;
    callback(url, width);
    modal.remove();
  };
  
  document.getElementById('infos-media-cancel').onclick = () => modal.remove();
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

// S√©lecteur de produit
// S√©lecteur de marque de sommaire (anchor)
function showInfosAnchorSelector(callback, initialAnchorId = '') {
  // R√©cup√©rer toutes les sections du sommaire de mani√®re r√©cursive
  const getAllSections = (items = [], path = []) => {
    let sections = [];
    items.forEach((item, idx) => {
      const currentPath = [...path, item.titre];
      sections.push({
        path: currentPath.join(' > '),
        id: item.id,
        titre: item.titre
      });
      if (item.children && item.children.length > 0) {
        sections = sections.concat(getAllSections(item.children, currentPath));
      }
    });
    return sections;
  };
  
  const allSections = getAllSections(infosPageData.sommaire?.items || []);
  
  if (allSections.length === 0) {
    alert('Aucune section dans le sommaire. Cr√©ez d\'abord des sections dans le sommaire.');
    return;
  }
  
  // Filtrer les sections d√©j√† utilis√©es par des marques existantes
  const usedAnchorIds = infosPageData.elements
    .filter(el => el.type === 'anchor')
    .map(el => el.content);
  
  const availableSections = allSections.filter(section => !usedAnchorIds.includes(section.id));
  
  if (availableSections.length === 0) {
    alert('Toutes les sections ont d√©j√† une marque. Cr√©ez d\'abord de nouvelles sections dans le sommaire.');
    return;
  }
  
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;';
  
  const box = document.createElement('div');
  box.style.cssText = 'background:#2e004f;padding:30px;border-radius:14px;width:600px;max-width:90%;';
  
  let optionsHtml = '';
  availableSections.forEach(section => {
    const selected = section.id === initialAnchorId ? 'selected' : '';
    optionsHtml += `<option value="${section.id}" ${selected}>${section.path} (ID: ${section.id})</option>`;
  });
  
  box.innerHTML = `
    <h3 style="margin:0 0 20px 0;color:#ffd369;">‚öì Marque de sommaire</h3>
    <p style="color:#8ef58e;margin-bottom:15px;">S√©lectionnez une section du sommaire. Une ancre invisible sera plac√©e ici pour permettre la navigation.</p>
    
    <label style="display:block;margin-bottom:5px;color:#8ef58e;">Section du sommaire:</label>
    <select id="infos-anchor-select" style="width:100%;padding:10px;border-radius:8px;border:1px solid #6a0572;background:#1a0033;color:#fff;margin-bottom:20px;">
      ${optionsHtml}
    </select>
    
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="infos-anchor-cancel" style="background:#6d6d6d;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Annuler</button>
      <button id="infos-anchor-ok" style="background:#8ef58e;color:#240038;font-weight:700;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">OK</button>
    </div>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  document.getElementById('infos-anchor-ok').onclick = () => {
    const anchorId = document.getElementById('infos-anchor-select').value;
    callback(anchorId);
    modal.remove();
  };
  
  document.getElementById('infos-anchor-cancel').onclick = () => modal.remove();
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

function showInfosProductSelector(callback, initialProductId = '', initialStyle = '') {
  // Parse initial style to get current settings
  let currentLayout = 'vertical';
  let currentImageSize = '200px';
  let currentImagePosition = 'top';
  let showName = true;
  let showPrice = true;
  
  if (initialStyle) {
    if (initialStyle.includes('layout:horizontal')) currentLayout = 'horizontal';
    const sizeMatch = initialStyle.match(/image-size:(\d+px)/);
    if (sizeMatch) currentImageSize = sizeMatch[1];
    const posMatch = initialStyle.match(/image-position:(top|left|right|bottom)/);
    if (posMatch) currentImagePosition = posMatch[1];
    if (initialStyle.includes('show-name:false')) showName = false;
    if (initialStyle.includes('show-price:false')) showPrice = false;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.cssText = 'display:flex;align-items:center;justify-content:center;z-index:10001;';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:900px;width:95%;max-height:90vh;background:linear-gradient(135deg, #2e003e, #6a0572);border-radius:16px;padding:0;overflow:hidden;display:flex;flex-direction:column;">
      <div style="background:linear-gradient(135deg, #ffd369, #ffb347);padding:20px;display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;color:#2e003e;font-size:1.3em;">üß® Configurer le produit</h3>
        <button id="close-infos-product-selector" style="background:none;border:none;color:#2e003e;font-size:2em;cursor:pointer;width:40px;height:40px;">√ó</button>
      </div>
      <div style="display:flex;flex:1;min-height:0;overflow:hidden;">
        <!-- S√©lection produit -->
        <div style="flex:1;padding:20px;border-right:2px solid rgba(255,255,255,0.1);overflow-y:auto;">
          <h4 style="color:#ffd369;margin-top:0;">S√©lectionner un produit</h4>
          <input type="text" id="infos-product-search" placeholder="üîç Rechercher..." style="width:100%;padding:10px;border-radius:8px;border:2px solid #ffd369;background:rgba(255,255,255,0.1);color:#fff;margin-bottom:12px;">
          <div id="infos-product-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;max-height:calc(100% - 80px);overflow-y:auto;"></div>
        </div>
        
        <!-- Configuration -->
        <div style="width:350px;padding:20px;overflow-y:auto;background:rgba(0,0,0,0.2);">
          <h4 style="color:#ffd369;margin-top:0;">Configuration de l'affichage</h4>
          <div id="product-config-panel" style="display:flex;flex-direction:column;gap:15px;">
            <div style="opacity:0.5;text-align:center;padding:30px;color:#8ef58e;">S√©lectionnez d'abord un produit</div>
          </div>
          
          <!-- Preview -->
          <div style="margin-top:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;border:2px dashed #ffd369;">
            <h4 style="color:#ffd369;margin:0 0 10px 0;font-size:0.9em;">Aper√ßu:</h4>
            <div id="product-preview" style="min-height:150px;display:flex;align-items:center;justify-content:center;color:#8ef58e;opacity:0.5;">
              Aper√ßu du produit
            </div>
          </div>
        </div>
      </div>
      <div style="padding:15px;background:rgba(0,0,0,0.3);display:flex;justify-content:flex-end;gap:10px;">
        <button id="cancel-product-config" style="background:#6d6d6d;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Annuler</button>
        <button id="save-product-config" style="background:#8ef58e;color:#2e003e;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:700;" disabled>üíæ Enregistrer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  let selectedProduct = null;
  let config = {
    layout: currentLayout,
    imageSize: currentImageSize,
    imagePosition: currentImagePosition,
    showName: showName,
    showPrice: showPrice
  };
  
  // Find initial product
  if (initialProductId) {
    selectedProduct = (articlesData || []).find(a => a.id === initialProductId);
    if (selectedProduct) renderConfig();
  }
  
  const closeModal = () => {
    modal.classList.remove('show');
    setTimeout(() => modal.remove(), 300);
  };
  
  document.getElementById('close-infos-product-selector').addEventListener('click', closeModal);
  document.getElementById('cancel-product-config').addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if(e.target === modal) closeModal();
  });
  
  modal.classList.add('show');
  
  const renderProducts = (filter = '') => {
    const list = document.getElementById('infos-product-list');
    if(!list) return;
    
    list.innerHTML = '';
    const articles = (articlesData || []).filter(a => 
      !filter || (a.nom || a.id || '').toLowerCase().includes(filter.toLowerCase())
    );
    
    if(articles.length === 0){
      list.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#8ef58e;opacity:0.6;padding:20px;">Aucun article</div>';
      return;
    }
    
    articles.slice(0, 50).forEach(article => {
      const card = document.createElement('div');
      card.style.cssText = `
        background:${selectedProduct?.id === article.id ? '#4b1a7f' : '#3a0066'};
        border:2px solid ${selectedProduct?.id === article.id ? '#8ef58e' : '#4b1a7f'};
        border-radius:10px;
        padding:6px;
        cursor:pointer;
        display:flex;
        flex-direction:column;
        gap:6px;
        transition:all 0.3s;
      `;
      
      const thumbnail = article.thumbnail || (article.medias && article.medias[0]?.path) || '';
      let imgHtml = '';
      if(thumbnail){
        if(/\.(mp4|webm|mov)$/i.test(thumbnail)){
          imgHtml = `<video src="${thumbnail}" muted loop style="width:100%;height:70px;object-fit:cover;border-radius:6px;"></video>`;
        } else {
          imgHtml = `<img src="${thumbnail}" style="width:100%;height:70px;object-fit:cover;border-radius:6px;"/>`;
        }
      } else {
        imgHtml = `<div style="width:100%;height:70px;border:2px dashed #6a0572;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1.5em;opacity:0.5;">üì¶</div>`;
      }
      
      card.innerHTML = `
        ${imgHtml}
        <div style="font-size:0.7em;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff;">${article.nom || article.id}</div>
        <div style="font-size:0.65em;color:#8ef58e;">${article.prix ? article.prix + '‚Ç¨' : ''}</div>
      `;
      
      card.addEventListener('click', () => {
        selectedProduct = article;
        renderProducts(filter);
        renderConfig();
        updatePreview();
        document.getElementById('save-product-config').disabled = false;
      });
      
      list.appendChild(card);
    });
  };
  
  function renderConfig() {
    const panel = document.getElementById('product-config-panel');
    if (!selectedProduct) {
      panel.innerHTML = '<div style="opacity:0.5;text-align:center;padding:30px;color:#8ef58e;">S√©lectionnez d\'abord un produit</div>';
      return;
    }
    
    panel.innerHTML = `
      <div>
        <label style="color:#8ef58e;font-size:0.9em;display:block;margin-bottom:5px;">Disposition:</label>
        <select id="config-layout" style="width:100%;padding:8px;border-radius:6px;background:#1a0033;color:#fff;border:1px solid #4b1a7f;">
          <option value="vertical" ${config.layout === 'vertical' ? 'selected' : ''}>Verticale (photo en haut)</option>
          <option value="horizontal" ${config.layout === 'horizontal' ? 'selected' : ''}>Horizontale (photo √† c√¥t√©)</option>
        </select>
      </div>
      
      <div>
        <label style="color:#8ef58e;font-size:0.9em;display:block;margin-bottom:5px;">Position de la photo:</label>
        <select id="config-image-position" style="width:100%;padding:8px;border-radius:6px;background:#1a0033;color:#fff;border:1px solid #4b1a7f;">
          <option value="top" ${config.imagePosition === 'top' ? 'selected' : ''}>En haut</option>
          <option value="bottom" ${config.imagePosition === 'bottom' ? 'selected' : ''}>En bas</option>
          <option value="left" ${config.imagePosition === 'left' ? 'selected' : ''}>√Ä gauche</option>
          <option value="right" ${config.imagePosition === 'right' ? 'selected' : ''}>√Ä droite</option>
        </select>
      </div>
      
      <div>
        <label style="color:#8ef58e;font-size:0.9em;display:block;margin-bottom:5px;">Taille de la photo:</label>
        <input type="range" id="config-image-size" min="100" max="400" step="10" value="${parseInt(config.imageSize)}" style="width:100%;">
        <div style="color:#fff;font-size:0.8em;text-align:center;">${config.imageSize}</div>
      </div>
      
      <div style="display:flex;gap:10px;">
        <label style="display:flex;align-items:center;gap:8px;color:#fff;cursor:pointer;">
          <input type="checkbox" id="config-show-name" ${config.showName ? 'checked' : ''} style="cursor:pointer;">
          Afficher le nom
        </label>
      </div>
      
      <div style="display:flex;gap:10px;">
        <label style="display:flex;align-items:center;gap:8px;color:#fff;cursor:pointer;">
          <input type="checkbox" id="config-show-price" ${config.showPrice ? 'checked' : ''} style="cursor:pointer;">
          Afficher le prix
        </label>
      </div>
    `;
    
    // Event listeners
    document.getElementById('config-layout').addEventListener('change', (e) => {
      config.layout = e.target.value;
      updatePreview();
    });
    document.getElementById('config-image-position').addEventListener('change', (e) => {
      config.imagePosition = e.target.value;
      updatePreview();
    });
    document.getElementById('config-image-size').addEventListener('input', (e) => {
      config.imageSize = e.target.value + 'px';
      e.target.nextElementSibling.textContent = config.imageSize;
      updatePreview();
    });
    document.getElementById('config-show-name').addEventListener('change', (e) => {
      config.showName = e.target.checked;
      updatePreview();
    });
    document.getElementById('config-show-price').addEventListener('change', (e) => {
      config.showPrice = e.target.checked;
      updatePreview();
    });
    
    updatePreview();
  }
  
  function updatePreview() {
    const preview = document.getElementById('product-preview');
    if (!selectedProduct) return;
    
    const thumbnail = selectedProduct.thumbnail || (selectedProduct.medias && selectedProduct.medias[0]?.path) || '';
    let mediaHtml = '';
    if (thumbnail) {
      if (/\.(mp4|webm|mov)$/i.test(thumbnail)) {
        mediaHtml = `<video src="${thumbnail}" muted loop autoplay style="max-width:${config.imageSize};max-height:${config.imageSize};object-fit:cover;border-radius:8px;"></video>`;
      } else {
        mediaHtml = `<img src="${thumbnail}" style="max-width:${config.imageSize};max-height:${config.imageSize};object-fit:cover;border-radius:8px;"/>`;
      }
    }
    
    const nameHtml = config.showName ? `<div style="font-weight:600;color:#fff;font-size:1.1em;">${selectedProduct.nom}</div>` : '';
    const priceHtml = config.showPrice ? `<div style="color:#8ef58e;font-size:1em;">${selectedProduct.prix}‚Ç¨</div>` : '';
    
    const flexDir = (config.layout === 'horizontal' || config.imagePosition === 'left' || config.imagePosition === 'right') ? 'row' : 'column';
    const order = config.imagePosition === 'bottom' || config.imagePosition === 'right' ? 'reverse' : 'normal';
    
    preview.style.cssText = `display:flex;flex-direction:${flexDir}${order === 'reverse' ? '-reverse' : ''};gap:10px;align-items:center;justify-content:center;padding:10px;`;
    preview.innerHTML = `
      ${mediaHtml}
      <div style="display:flex;flex-direction:column;gap:5px;text-align:center;">
        ${nameHtml}
        ${priceHtml}
      </div>
    `;
  }
  
  // Attendre que le DOM soit pr√™t
  setTimeout(() => {
    document.getElementById('save-product-config').addEventListener('click', () => {
      if (!selectedProduct) {
        alert('Veuillez s√©lectionner un produit');
        return;
      }
      
      const style = `layout:${config.layout};image-size:${config.imageSize};image-position:${config.imagePosition};show-name:${config.showName};show-price:${config.showPrice};`;
      callback(selectedProduct.id, style);
      closeModal();
      showToast(`‚úÖ ${selectedProduct.nom} configur√©`, 'success');
    });
    
    renderProducts();
    const searchInput = document.getElementById('infos-product-search');
    if (searchInput) {
      searchInput.focus();
      searchInput.addEventListener('input', () => renderProducts(searchInput.value));
    }
  }, 100);
}

// Prompt pour lien
function showInfosLinkPrompt(callback, initialUrl = '', initialText = '', initialStyle = '') {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;';
  
  const box = document.createElement('div');
  box.style.cssText = 'background:#2e004f;padding:30px;border-radius:14px;width:500px;max-width:90%;';
  box.innerHTML = `
    <h3 style="margin:0 0 20px 0;color:#ffd369;">üîó Lien</h3>
    <label style="display:block;margin-bottom:5px;color:#8ef58e;">URL:</label>
    <input type="url" id="infos-link-url" value="${initialUrl}" placeholder="https://..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #6a0572;background:#1a0033;color:#fff;margin-bottom:15px;">
    
    <label style="display:block;margin-bottom:5px;color:#8ef58e;">Texte du lien:</label>
    <input type="text" id="infos-link-text" value="${initialText}" placeholder="Cliquez ici" style="width:100%;padding:10px;border-radius:8px;border:1px solid #6a0572;background:#1a0033;color:#fff;margin-bottom:20px;">
    
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="infos-link-cancel" style="background:#6d6d6d;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">Annuler</button>
      <button id="infos-link-ok" style="background:#8ef58e;color:#240038;font-weight:700;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;">OK</button>
    </div>
  `;
  
  modal.appendChild(box);
  document.body.appendChild(modal);
  
  document.getElementById('infos-link-ok').onclick = () => {
    const url = document.getElementById('infos-link-url').value;
    const text = document.getElementById('infos-link-text').value;
    callback(url, text, '');
    modal.remove();
  };
  
  document.getElementById('infos-link-cancel').onclick = () => modal.remove();
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

// Event listeners pour les outils
document.addEventListener('DOMContentLoaded', () => {
  // Boutons de la toolbar infos
  // Gestionnaire de sommaire hi√©rarchique
  function toggleSommaireEditor() {
    let modal = document.getElementById('sommaire-editor-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'sommaire-editor-modal';
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width:800px;width:90%;max-height:90vh;background:linear-gradient(135deg, #2e003e, #6a0572);border-radius:16px;padding:0;overflow:hidden;">
          <div style="background:linear-gradient(135deg, #17a2b8, #1c8c9c);padding:20px;display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;color:#fff;font-size:1.3em;">üìã Gestion du sommaire</h3>
            <div style="display:flex;gap:10px;">
              <label style="display:flex;align-items:center;gap:8px;color:#fff;cursor:pointer;">
                <input type="checkbox" id="sommaire-visible-toggle" ${infosPageData.sommaire?.visible !== false ? 'checked' : ''} style="cursor:pointer;">
                Afficher le sommaire
              </label>
              <button onclick="document.getElementById('sommaire-editor-modal').classList.remove('show')" style="background:none;border:none;color:#fff;font-size:2em;cursor:pointer;width:40px;height:40px;">√ó</button>
            </div>
          </div>
          <div style="padding:20px;overflow-y:auto;max-height:calc(90vh - 140px);">
            <div id="sommaire-tree" style="margin-bottom:20px;"></div>
            <button onclick="addSommaireItem()" style="background:#17a2b8;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;width:100%;">‚ûï Ajouter une section</button>
          </div>
          <div style="padding:20px;background:rgba(0,0,0,0.3);display:flex;justify-content:flex-end;gap:10px;">
            <button onclick="saveSommaire()" style="background:#8ef58e;color:#2e003e;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:700;">üíæ Enregistrer</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    renderSommaireTree();
    modal.classList.add('show');
  }
  
  window.toggleSommaireEditor = toggleSommaireEditor;
  
  function renderSommaireTree(items = null, container = null, path = []) {
    if (!items) items = infosPageData.sommaire?.items || [];
    if (!container) container = document.getElementById('sommaire-tree');
    if (!container) return;
    
    container.innerHTML = '';
    if (items.length === 0 && path.length === 0) {
      container.innerHTML = '<div style="color:#8ef58e;opacity:0.6;text-align:center;padding:20px;">Aucune section. Cliquez sur "Ajouter une section"</div>';
      return;
    }
    
    items.forEach((item, idx) => {
      const currentPath = [...path, idx];
      const pathStr = currentPath.join('-');
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = `
        margin-left:${path.length * 25}px;
        padding:10px;
        background:rgba(255,211,105,0.1);
        border-left:3px solid #ffd369;
        margin-bottom:8px;
        border-radius:6px;
      `;
      // √âchapper les guillemets dans les valeurs
      const safeTitle = (item.titre || '').replace(/"/g, '&quot;');
      const safeId = (item.id || '').replace(/"/g, '&quot;');
      
      itemDiv.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:5px;">
          <input type="text" value="${safeTitle}" onchange="updateSommaireItemTitle('${pathStr}', this.value)" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ffd369;background:rgba(0,0,0,0.3);color:#fff;">
          <input type="text" value="${safeId}" placeholder="ID (pour ancre)" onchange="updateSommaireItemId('${pathStr}', this.value)" style="width:150px;padding:8px;border-radius:6px;border:1px solid #8ef58e;background:rgba(0,0,0,0.3);color:#8ef58e;font-size:0.9em;">
          <button onclick="addSommaireSubItem('${pathStr}')" style="background:#4b1a7f;color:#8ef58e;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.9em;">‚ûï Sous-section</button>
          <button onclick="deleteSommaireItem('${pathStr}')" style="background:#8b0000;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.9em;">üóëÔ∏è</button>
        </div>
        <div class="sommaire-children-${pathStr}"></div>
      `;
      container.appendChild(itemDiv);
      
      if (item.children && item.children.length > 0) {
        const childContainer = itemDiv.querySelector(`.sommaire-children-${pathStr}`);
        renderSommaireTree(item.children, childContainer, currentPath);
      }
    });
  }
  
  // Fonction helper pour obtenir un item par son chemin
  function getSommaireItemByPath(pathStr) {
    if (!infosPageData.sommaire || !infosPageData.sommaire.items) return null;
    const path = pathStr.split('-').map(n => parseInt(n));
    let current = infosPageData.sommaire.items;
    let item = null;
    
    for (let i = 0; i < path.length; i++) {
      const idx = path[i];
      if (!current || !current[idx]) return null;
      item = current[idx];
      if (i < path.length - 1) {
        if (!item.children) return null;
        current = item.children;
      }
    }
    return item;
  }
  
  // Fonction helper pour obtenir le parent et l'index d'un item
  function getSommaireItemParent(pathStr) {
    const path = pathStr.split('-').map(n => parseInt(n));
    if (path.length === 1) {
      // Item de niveau racine
      return { parent: infosPageData.sommaire.items, idx: path[0] };
    }
    
    // Item imbriqu√©
    const parentPath = path.slice(0, -1);
    const idx = path[path.length - 1];
    let current = infosPageData.sommaire.items;
    
    for (let i = 0; i < parentPath.length; i++) {
      const parentIdx = parentPath[i];
      if (!current || !current[parentIdx]) return null;
      const item = current[parentIdx];
      if (!item.children) item.children = [];
      current = item.children;
    }
    
    return { parent: current, idx: idx };
  }
  
  window.updateSommaireItemTitle = (pathStr, value) => {
    const item = getSommaireItemByPath(pathStr);
    if (item) {
      item.titre = value;
      
      // Auto-g√©n√©rer l'ID bas√© sur les parents
      const path = pathStr.split('-').map(n => parseInt(n));
      let titles = [value];
      
      // R√©cup√©rer tous les titres parents
      let current = infosPageData.sommaire.items;
      for (let i = 0; i < path.length - 1; i++) {
        const idx = path[i];
        if (current && current[idx]) {
          titles.unshift(current[idx].titre || '');
          current = current[idx].children;
        }
      }
      
      // G√©n√©rer l'ID: "Parent > Enfant" ‚Üí "parent>enfant", espaces ‚Üí "-"
      const autoId = titles
        .map(t => t.toLowerCase()
          .replace(/\s+/g, '-')  // Remplacer les espaces par des tirets
          .replace(/[^a-z0-9\-]/g, '')  // Supprimer les caract√®res sp√©ciaux
        )
        .filter(t => t)  // Supprimer les √©l√©ments vides
        .join('>');
      
      item.id = autoId;
      console.log('Titre mis √† jour:', pathStr, value);
      console.log('ID auto-g√©n√©r√©:', autoId);
      
      // Rafra√Æchir l'affichage pour montrer le nouvel ID
      renderSommaireTree();
    }
  };
  
  window.updateSommaireItemId = (pathStr, value) => {
    const item = getSommaireItemByPath(pathStr);
    if (item) {
      item.id = value;
      console.log('ID mis √† jour:', pathStr, value);
    }
  };
  
  window.addSommaireItem = () => {
    if (!infosPageData.sommaire) infosPageData.sommaire = { visible: true, items: [] };
    infosPageData.sommaire.items.push({ 
      id: 'section-' + Date.now(), 
      titre: 'Nouvelle section', 
      children: [] 
    });
    renderSommaireTree();
  };
  
  window.addSommaireSubItem = (pathStr) => {
    const item = getSommaireItemByPath(pathStr);
    if (item) {
      if (!item.children) item.children = [];
      item.children.push({ 
        id: 'subsection-' + Date.now(), 
        titre: 'Nouvelle sous-section', 
        children: [] 
      });
      renderSommaireTree();
    }
  };
  
  window.deleteSommaireItem = (pathStr) => {
    if (!confirm('Supprimer cette section et toutes ses sous-sections ?')) return;
    
    const result = getSommaireItemParent(pathStr);
    if (result) {
      result.parent.splice(result.idx, 1);
      renderSommaireTree();
      showToast('üóëÔ∏è Section supprim√©e', 'warning');
    }
  };
  
  window.saveSommaire = async () => {
    // S'assurer que sommaire existe
    if (!infosPageData.sommaire) {
      infosPageData.sommaire = { visible: true, items: [] };
    }
    infosPageData.sommaire.visible = document.getElementById('sommaire-visible-toggle').checked;
    
    console.log('[Debug] Sauvegarde sommaire:', infosPageData.sommaire);
    
    try {
      const res = await fetch('/api/info-page', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(infosPageData)
      });
      if (res.ok) {
        showToast('‚úÖ Sommaire enregistr√©', 'success');
        document.getElementById('sommaire-editor-modal').classList.remove('show');
      } else {
        throw new Error('Erreur serveur');
      }
    } catch (e) {
      console.error('Erreur sauvegarde sommaire:', e);
      showToast('‚ùå Erreur lors de la sauvegarde', 'error');
    }
  };

  document.querySelectorAll('.infos-tool-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tool = btn.dataset.tool;
      if (tool === 'clear') {
        if (confirm('Effacer toute la page infos ?')) {
          infosPageData.elements = [];
          renderInfosCanvas();
          showToast('üóëÔ∏è Page effac√©e', 'warning');
        }
      } else {
        addInfosElement(tool);
      }
    });
  });
  
  // Bouton sauvegarder
  document.getElementById('infos-save')?.addEventListener('click', saveInfosPage);
});

// ==================== SYST√àME DE TOAST STYLIS√â ====================
function showToast(message, type = 'info') {
  let toastContainer = document.getElementById('toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    toastContainer.style.cssText = 'position:fixed;top:80px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:10px;max-width:400px;';
    document.body.appendChild(toastContainer);
  }
  const toast = document.createElement('div');
  const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '<img src="img/_technique/icon/information.png" style="width:16px;height:16px;vertical-align:middle;"/>' };
  const colors = { success: 'linear-gradient(135deg, #4CAF50, #45a049)', error: 'linear-gradient(135deg, #f44336, #da190b)', warning: 'linear-gradient(135deg, #ff9800, #fb8c00)', info: 'linear-gradient(135deg, #2196F3, #0b7dda)' };
  toast.style.cssText = `background:${colors[type]||colors.info};color:white;padding:16px 20px;border-radius:12px;box-shadow:0 6px 25px rgba(0,0,0,0.3);display:flex;align-items:center;gap:12px;font-weight:500;font-size:14px;animation:slideIn 0.3s ease-out;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);`;
  toast.innerHTML = `<span style="font-size:20px;">${icons[type]||icons.info}</span><span>${message}</span>`;
  if (!document.getElementById('toast-animations')) {
    const style = document.createElement('style');
    style.id = 'toast-animations';
    style.textContent = '@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(400px);opacity:0}}';
    document.head.appendChild(style);
  }
  toastContainer.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => { toast.remove(); if (toastContainer.children.length === 0) toastContainer.remove(); }, 300);
  }, 4000);
}

// ==================== SYST√àME DE CONFIRMATION √âL√âGANTE ====================
function showConfirm(message, onConfirm, onCancel) {
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10005;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.2s;';
  
  modal.innerHTML = `
    <div style="background:linear-gradient(135deg, #2e003e, #6a0572);border:2px solid #ffd369;border-radius:16px;padding:30px;max-width:450px;width:90%;box-shadow:0 10px 50px rgba(0,0,0,0.7);animation:scaleIn 0.3s;">
      <h3 style="color:#ffd369;margin-bottom:20px;font-size:1.3em;text-align:center;">‚ö†Ô∏è Confirmation</h3>
      <p style="color:#fff;margin-bottom:30px;font-size:1.05em;line-height:1.5;text-align:center;">${message}</p>
      <div style="display:flex;gap:15px;justify-content:center;">
        <button id="confirm-cancel-btn" style="flex:1;background:#6c757d;color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;font-size:1em;transition:all 0.2s;">Annuler</button>
        <button id="confirm-ok-btn" style="flex:1;background:linear-gradient(135deg, #e74c3c, #c0392b);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:700;font-size:1em;transition:all 0.2s;box-shadow:0 4px 12px rgba(231,76,60,0.4);">OK</button>
      </div>
    </div>
  `;
  
  if (!document.getElementById('confirm-animations')) {
    const style = document.createElement('style');
    style.id = 'confirm-animations';
    style.textContent = '@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes scaleIn{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}';
    document.head.appendChild(style);
  }
  
  document.body.appendChild(modal);
  
  document.getElementById('confirm-cancel-btn').onclick = () => {
    modal.remove();
    if (onCancel) onCancel();
  };
  
  document.getElementById('confirm-ok-btn').onclick = () => {
    modal.remove();
    if (onConfirm) onConfirm();
  };
  
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.remove();
      if (onCancel) onCancel();
    }
  };
}

  </script>
</body>
</html>










