<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin - J'vend tout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #8b00ff 0%, #9932cc 25%, #ba55d3 50%, #da70d6 75%, #ff00ff 100%);
      color: #fff;
      font-family: 'Inter', 'Poppins', sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: rgba(45,0,75,0.92);
      border-radius: 18px;
      box-shadow: 0 8px 32px #0006;
      padding: 32px;
    }
    h1 {
      text-align: center;
      font-weight: 700;
      margin-bottom: 32px;
      letter-spacing: 1px;
    }
    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      background: #4a1a5c;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: 0 2px 8px #0004;
    }

    #addArnaqueForm {
      grid-template-columns: 1fr 1fr;
    }
    form label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
      color: #ffd369;
    }
    form input, form textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin-bottom: 8px;
      font-size: 1em;
      background: #6a0572;
      color: #fff;
      box-shadow: 0 1px 4px #0002;
    }
    form input[type="number"] {
      text-align: right;
    }
    form button {
      grid-column: span 2;
      background: #d72660;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 0;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      margin-top: 12px;
      transition: background 0.2s;
    }
    form button:hover {
      background: #a80038;
    }
    .preview-box {
      grid-column: span 2;
      background: #2e004f;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      text-align: center;
      min-height: 120px;
    }
    .preview-box img, .preview-box video {
      max-width: 120px;
      max-height: 120px;
      border-radius: 8px;
      margin: 8px;
      background: #222;
      display: inline-block;
    }
    .article-list {
      margin-top: 24px;
    }
    .article-card {
      background: #3a0066;
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 18px;
      box-shadow: 0 2px 8px #0004;
      transition: background 0.2s;
    }
    .article-card:hover {
      background: #6a0572;
    }
        .product-card img, .product-card video {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
      display: block;
    }

    .article-info {
      flex: 1;
      min-width: 0;
    }
    .article-info strong {
      color: #ffd369;
      font-size: 1.1em;
    }
    .article-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .article-actions button {
      background: #d72660;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.95em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .article-actions button:hover {
      background: #a80038;
    }
    
    /* Styles pour l'explorateur de catégories */
    .category-item {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .category-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
    }
    
    .category-item span {
      pointer-events: auto !important;
      z-index: 10;
    }
    
    .category-item button {
      pointer-events: auto !important;
      z-index: 20;
    }
    
    /* --- Modal / drawer identique à index --- */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(30,0,60,0.85);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .modal.show { 
      display: flex; 
    }
    /* Ne rien ajouter ici */
    /* drawer (latéral) */
    .side-modal.show {
      display: flex;
      justify-content: flex-end !important;
      align-items: flex-start !important;
      background: rgba(30,0,60,0.35);
    }
.side-modal .modal-content {
  width: 400px; /* Largeur identique à index */
  height: 100vh; /* Hauteur plein écran pour toucher le sol */
  border-radius: 0; /* Pas d'arrondi pour coller aux bords */
  border-top-left-radius: 18px; /* Arrondi uniquement en haut à gauche */
  border-bottom-left-radius: 18px; /* Arrondi uniquement en bas à gauche */
  background: #2e004f; /* Couleur identique */
  color: #fff; /* Texte blanc */
  padding: 24px; /* Espacement interne */
  box-shadow: -8px 0 32px rgba(0, 0, 0, 0.4); /* Ombre à gauche */
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  position: relative;
  margin: 0; /* Supprime les marges pour coller aux bords */
}
    .side-modal .modal-content .media {
      display:flex;
      align-items:center;
      justify-content:center;

    }
.side-modal .modal-content img,
.side-modal .modal-content video {
  width: 100%; /* Prend toute la largeur */
  max-height: 300px; /* Limite la hauteur */
  object-fit: contain; /* Contient l'image/vidéo sans déformation */
  border-radius: 12px; /* Coins arrondis */
  margin-top: 16px; /* Espacement avec le contenu au-dessus */
}
.side-modal h2 {
  font-size: 1.5em; /* Taille du titre */
  margin-bottom: 12px; /* Espacement avec la description */
  color: #ffd369; /* Couleur du titre */
}
.side-modal .meta {
  font-size: 1em; /* Taille du texte catégorie */
  color: #8ef58e; /* Couleur verte */
  margin-bottom: 12px; /* Espacement avec le prix */
}
.side-modal .price {
  font-size: 1.2em; /* Taille du prix */
  font-weight: bold;
  color: #ffd369; /* Couleur jaune */
}
.side-modal .close {
  position: absolute;
  top: 16px;
  right: 16px;
  font-size: 24px; /* Taille du bouton fermer */
  color: #ffd369; /* Couleur jaune */
  cursor: pointer;
}

.reseau-btn {
  background: #4b1a7f;
  color: #8ef58e;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.2s;
}

.reseau-btn:hover {
  background: #6a2a9f;
}

.reseau-btn.selected {
  background: #8ef58e;
  color: #2e004f;
  font-weight: bold;
}

.technique-btn {
  background: #6f42c1;
  color: white;
  border: 1px solid #6f42c1;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.2s;
}

.technique-btn:hover {
  background: #8a5cd6;
}

.technique-btn.selected {
  background: #ffd369;
  color: #2e004f;
  font-weight: bold;
  border-color: #ffd369;
}

.selected-technique-tag {
  background: #28a745;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.selected-technique-tag .remove-btn {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 0.9em;
  padding: 0;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.selected-technique-tag .remove-btn:hover {
  background: rgba(255,255,255,0.2);
}

.admin-section {
  display: none;
}

/* Styles pour la modale d'ordre */
.ordering-item {
  display: flex;
  align-items: center;
  padding: 15px;
  margin-bottom: 10px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  cursor: move;
  transition: all 0.2s ease;
}

.ordering-item:hover {
  background: #e9ecef;
  transform: translateX(2px);
}

.ordering-item.dragging {
  opacity: 0.5;
  transform: rotate(2deg);
}

.ordering-handle {
  font-size: 18px;
  color: #6c757d;
  margin-right: 15px;
  cursor: grab;
}

.ordering-handle:active {
  cursor: grabbing;
}

.ordering-content {
  flex: 1;
}

.ordering-title {
  font-weight: bold;
  margin-bottom: 4px;
  color: #2c3e50;
}

.ordering-subtitle {
  font-size: 0.9em;
  color: #6c757d;
}

.ordering-position {
  background: #007bff;
  color: white;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.9em;
}

.no-items {
  text-align: center;
  padding: 40px 20px;
  color: #6c757d;
  font-style: italic;
}

#ordering-items {
  max-height: 400px;
  overflow-y: auto;
}

.admin-section.active {
  display: block;
}

/* Styles pour les onglets */
.tab-button.active {
  background: #ff6b6b !important;
  color: white !important;
}

.tab-button:not(.active) {
  background: #4b1a7f !important;
  color: #8ef58e !important;
}

.tab-content {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Styles responsive pour les modales */
@media screen and (max-width: 768px) {
  .modal-content {
    width: 95% !important;
    max-width: none !important;
    margin: 10px auto !important;
    max-height: 95vh !important;
  }
  
  /* Modal catégories responsive */
  #category-explorer-modal {
    /* Force le plein écran */
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 10000 !important;
  }
  
  #category-explorer-modal .modal-content {
    padding: 15px !important;
    width: 95vw !important;
    height: 95vh !important;
    max-width: none !important;
    max-height: none !important;
    border-radius: 8px !important;
    overflow-y: auto !important;
  }
  
  #category-explorer-modal h2 {
    font-size: 1.1em !important;
  }
  
  /* Boutons responsive */
  #category-explorer-modal [style*="display:flex"] {
    flex-direction: column !important;
    gap: 8px !important;
  }
  
  #category-explorer-modal button {
    width: 100% !important;
    min-width: auto !important;
  }
  
  /* Modal gestion catégories responsive */
  #category-management-modal .modal-content {
    width: 98% !important;
    height: 95vh !important;
    max-height: 95vh !important;
    margin: 2.5vh auto !important;
  }
  
  /* Explorateur de fichiers responsive */
  #file-explorer-modal .modal-content {
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    margin: 0 !important;
    border-radius: 0 !important;
  }
  
  /* Ajustement du layout pour mobile */
  #file-explorer-modal [style*="display:flex"][style*="width:70%"] {
    width: 100% !important;
  }
  
  #file-explorer-modal [style*="width:30%"] {
    display: none !important; /* Masquer le panel de sélection sur mobile */
  }
  
  /* Breadcrumbs responsive */
  #admin-cat-breadcrumbs {
    flex-direction: row !important;
    flex-wrap: wrap !important;
  }
  
  /* Grille de fichiers responsive */
  #file-list {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) !important;
    gap: 15px !important;
  }
}

@media screen and (max-width: 480px) {
  #file-list {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)) !important;
    gap: 10px !important;
  }
  
  /* Textes plus petits sur très petits écrans */
  .modal-content h2 {
    font-size: 1em !important;
  }
  
  .modal-content button {
    padding: 10px 12px !important;
    font-size: 0.85em !important;
  }
}

/* Effets hover pour le menu hamburger */
#menu-modal button:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

#menu-articles:hover {
  background: #8a0a82 !important;
}

#menu-offres:hover, #menu-arnaques:hover {
  background: #6a2c93 !important;
  color: #ffd369 !important;
}

#menu-avis-pending:hover {
  background: #a6f6a6 !important;
  color: #1a1a1a !important;
}
/* Modal review detail */
#review-detail-modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(30,0,60,0.85);
  z-index: 10000;
  align-items: center;
  justify-content: center;
}

#review-detail-modal.show {
  display: flex;
}

#review-detail-modal .modal-content {
  width: 95%;
  max-width: 500px;
  background: #2e004f;
  color: #fff;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  position: relative;
  overflow-y: auto;
  max-height: 90vh;
}

#review-detail-modal .close {
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 24px;
  color: #ffd369;
  background: none;
  border: none;
  cursor: pointer;
}

.review-detail-header {
  display: flex;
  align-items: center;
  margin-bottom: 16px;
}

.review-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: #8ef58e;
  color: #2e004f;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-right: 12px;
  font-size: 1.2em;
}

.review-user-info h3 {
  margin: 0;
  color: #8ef58e;
}

.review-user-info p {
  margin: 0;
  color: #ffd369;
  font-size: 0.9em;
}

#review-detail-title {
  color: #ffd369;
  margin-bottom: 10px;
}

#review-detail-text {
  margin-bottom: 20px;
  line-height: 1.5;
}

.review-detail-gallery {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
}

.review-detail-gallery img,
.review-detail-gallery video {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 6px;
  cursor: pointer;
  border: 2px solid transparent;
}

.review-detail-gallery img.active,
.review-detail-gallery video.active {
  border-color: #ffd369;
}

.review-detail-main-media img,
.review-detail-main-media video {
  width: 100%;
  max-height: 300px;
  object-fit: contain;
  border-radius: 8px;
  margin-bottom: 16px;
}

.review-detail-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.review-detail-rating {
  color: #ffd369;
  font-size: 1.2em;
}

.review-detail-verified {
  background: #8ef58e;
  color: #2e004f;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8em;
  font-weight: bold;
}

/* Scrollbars stylisées - pratiquement invisibles */
::-webkit-scrollbar {
  width: 4px;
  height: 4px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 211, 105, 0.2);
  border-radius: 2px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 211, 105, 0.4);
}

::-webkit-scrollbar-corner {
  background: transparent;
}

/* Pour Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: rgba(255, 211, 105, 0.2) transparent;
}

  </style>
</head>
<body>
  <!-- Barre supérieure admin -->
  <div id="admin-top-bar" style="position:sticky;top:0;z-index:2000;background:#240038;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px;box-shadow:0 4px 14px #0008;">
    <!-- Menu hamburger -->
    <button id="menu-toggle" style="background:#6a0572;color:#ffd369;border:none;border-radius:8px;padding:8px 12px;font-weight:bold;font-size:1rem;cursor:pointer;margin-right:12px;">
      ☰
    </button>
    <div style="font-weight:700;letter-spacing:1px;font-size:15px;">Panneau d'administration</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <a href="index.html" style="text-decoration:none;background:#4b1a7f;color:#8ef58e;padding:8px 14px;border-radius:6px;font-weight:600;display:inline-flex;align-items:center;gap:6px;">🏪 <span>Boutique</span></a>
      <button id="open-ordering-btn" type="button" style="background:#ffd369;color:#240038;font-weight:700;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;">⚙️ <span id="ordering-btn-text">Ordre (Pertinence)</span></button>
    </div>
  </div>
  
  <!-- Menu modal hamburger admin -->
  <div id="menu-modal" style="display:none; position:fixed; top:56px; left:0; width:250px; background:linear-gradient(135deg, #2e004f, #4b1a7f); color:#fff; z-index:1000; box-shadow:2px 2px 12px rgba(0,0,0,0.4); border-radius:0 12px 12px 0; padding:20px;">
    <!-- Onglets comme dans l'image -->
    <div style="display:flex; flex-direction:column; gap:8px;">
      <button id="menu-articles" style="display:flex; align-items:center; width:100%; padding:14px 18px; background:#6a0572; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.95em; transition:all 0.3s;">
        <span style="margin-right:10px; font-size:1.1em;">📦</span> Articles
      </button>
      <button id="menu-offres" style="display:flex; align-items:center; width:100%; padding:14px 18px; background:#4b1a7f; color:#8ef58e; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.95em; transition:all 0.3s;">
        <span style="margin-right:10px; font-size:1.1em;">🏷️</span> Offres
      </button>
      <button id="menu-arnaques" style="display:flex; align-items:center; width:100%; padding:14px 18px; background:#4b1a7f; color:#8ef58e; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.95em; transition:all 0.3s;">
        <span style="margin-right:10px; font-size:1.1em;">⚠️</span> Arnaques
      </button>
      <button id="menu-avis-pending" style="display:flex; align-items:center; width:100%; padding:14px 18px; background:#8ef58e; color:#2e004f; border:none; border-radius:8px; cursor:pointer; font-weight:700; font-size:0.95em; transition:all 0.3s;">
        <span style="margin-right:10px; font-size:1.1em;">✓</span> Preuves
      </button>
    </div>
  </div>
  
  <!-- Contenu principal avec gestion des sections -->
  <div id="main-content">
    <!-- Section Articles (par défaut) -->
    <div id="articles-section" class="admin-section">
      <div class="container">
        <h1>Admin - Mes Articles</h1>
        <form id="addArticleForm">
      <div>
        <label for="nom">Nom affiché</label>
        <input type="text" name="nom" id="nom" required>
      </div>
      <div>
        <label for="id">ID interne</label>
        <input type="text" name="id" id="id" required>
      </div>
      <div style="grid-column: span 2;">
        <label>Média (photos & vidéos)</label>
        <div id="media-list" style="margin-bottom:10px;"></div>
        <div style="display:flex;gap:10px;margin-top:10px;">
          <button type="button" id="add-media-btn" style="background:#4b1a7f;color:#8ef58e;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600;border:1px solid #4b1a7f;">+ Ajouter un média</button>
        </div>
        <div style="margin-top:10px;">
          <label style="display:block;margin-bottom:5px;">Miniature (sera utilisée dans la grille et le panier)</label>
          <input type="hidden" id="thumbnail-select" name="thumbnail" value="">
          <div id="thumbnail-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;margin-top:8px;"></div>
        </div>
      </div>
      <div>
        <label for="categorie">Catégorie (ex: Artifices/Bison)</label>
        <input type="text" name="categorie" id="categorie" required>
        <button type="button" id="select-category-btn" style="margin-top:6px;background:#4b1a7f;color:#8ef58e;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600;border:1px solid #4b1a7f;" onclick="window.openCategoryExplorer()">Sélectionner catégorie</button>
      </div>
      <div>
        <label for="prix">Prix (€)</label>
        <input type="number" name="prix" id="prix" step="0.01" min="0" required>
      </div>
      <div style="grid-column: span 2;">
        <label for="description">Description</label>
        <textarea name="description" id="description" rows="2"></textarea>
      </div>
      <!-- La preview-box a été supprimée conformément à la demande -->
      <button type="submit" id="submit-btn">Ajouter</button>
    </form>
    <div class="article-list" id="articleList"></div>
      </div>
    </div>

    <!-- Section Offres -->
    <div id="offres-section" class="admin-section" style="display:none;">
      <div class="container">
        <h1>Admin - Offres</h1>
        <form id="addOffreForm">
          <div>
            <label for="nom-offre">Nom de l'offre</label>
            <input type="text" name="nom" id="nom-offre" required>
          </div>
          <div>
            <label for="id-offre">ID interne</label>
            <input type="text" name="id" id="id-offre" required>
          </div>
          <div>
            <label for="prix-offre">Prix (€)</label>
            <input type="number" name="prix" id="prix-offre" step="0.01" required>
          </div>
          <div style="grid-column: span 2;">
            <label for="description-offre">Description</label>
            <textarea name="description" id="description-offre"></textarea>
          </div>
          <div>
            <label for="categorie-offre">Catégorie</label>
            <input type="text" name="categorie" id="categorie-offre">
          </div>
          <button type="submit" id="submit-offre-btn">Ajouter Offre</button>
        </form>
        <div class="article-list" id="offresList"></div>
      </div>
    </div>

    <!-- Section Arnaques -->
    <div id="arnaques-section" class="admin-section" style="display:none;">
      <div class="container">
        <h1>Admin - Base de données Arnaques</h1>
        <form id="addArnaqueForm">
          <div>
            <label for="nom-arnaque">Nom affiché</label>
            <input type="text" name="nom" id="nom-arnaque" placeholder="Nom visible pour les utilisateurs">
          </div>
          <div>
            <label for="username-arnaque">Nom d'utilisateur</label>
            <input type="text" name="username" id="username-arnaque" placeholder="@username_ou_identifiant" required pattern="[^\s]*" title="Le nom d'utilisateur ne peut pas contenir d'espaces">
          </div>
          <div style="grid-column: span 2;">
            <label for="reseaux-arnaque">Réseaux sociaux</label>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <button type="button" class="reseau-btn" data-reseau="Snapchat">
                <img src="img/_technique/icon/Snapchat.png" alt="Snapchat" style="width:16px;height:16px;"> Snapchat
              </button>
              <button type="button" class="reseau-btn" data-reseau="Telegram">
                <img src="img/_technique/icon/telegram.png" alt="Telegram" style="width:16px;height:16px;"> Telegram
              </button>
              <button type="button" class="reseau-btn" data-reseau="Discord">
                <img src="img/_technique/icon/discord.ico" alt="Discord" style="width:16px;height:16px;"> Discord
              </button>
              <button type="button" class="reseau-btn" data-reseau="Instagram">
                <img src="img/_technique/icon/Instagram.png" alt="Instagram" style="width:16px;height:16px;"> Instagram
              </button>
              <button type="button" class="reseau-btn" data-reseau="Facebook">
                <img src="img/_technique/icon/facebook.png" alt="Facebook" style="width:16px;height:16px;"> Facebook
              </button>
              <button type="button" class="reseau-btn" data-reseau="WhatsApp">
                <img src="img/_technique/icon/whatsapp.png" alt="WhatsApp" style="width:16px;height:16px;"> WhatsApp
              </button>
            </div>
            <input type="hidden" name="reseaux" id="reseaux-arnaque">
          </div>
          <div style="grid-column: span 2;">
            <label for="techniques-arnaque">Techniques utilisées</label>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <button type="button" class="technique-btn" data-technique="Fausse verification">Fausse vérification</button>
              <button type="button" class="technique-btn" data-technique="Paiement a l'avance">Paiement à l'avance</button>
              <button type="button" class="technique-btn" data-technique="Donné personels">Données personnelles</button>
              <button type="button" class="technique-btn" data-technique="Autre">Autre</button>
              <button type="button" id="add-technique-btn" style="background:#28a745; border:1px solid #28a745;">+ Ajouter</button>
            </div>
            <input type="hidden" name="techniques" id="techniques-arnaque">
            <div id="selected-techniques" style="margin-top:8px; display:flex; gap:4px; flex-wrap:wrap;"></div>
          </div>
          <div style="grid-column: span 2;">
            <label for="medias-arnaque">Médias (preuves)</label>
            <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
              <button type="button" id="select-media-arnaque" style="background:#6f42c1; border:1px solid #6f42c1; padding:8px 12px;">📁 Sélectionner médias</button>
              <span id="media-count-arnaque" style="color:#ffd369; font-size:0.9em;">Aucun média sélectionné</span>
            </div>
            <input type="hidden" name="medias" id="medias-arnaque">
            <div id="media-preview-arnaque" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;"></div>
          </div>
          <div style="grid-column: span 2;">
            <label for="description-arnaque">Description supplémentaire</label>
            <textarea name="description" id="description-arnaque"></textarea>
          </div>
          <button type="submit" id="submit-arnaque-btn" style="grid-column: span 2;">Ajouter Arnaqueur</button>
          <button type="button" id="cancel-arnaque-btn" onclick="cancelEditArnaque()" style="grid-column: span 2; background-color: #dc3545; display: none;">Annuler Édition</button>
        </form>
        <div class="article-list" id="arnaquesList"></div>
      </div>
    </div>

    <!-- Section Avis & Preuves fusionnée -->
    <div id="avis-pending-section" class="admin-section" style="display:none;">
      <div class="container">
        <h1>Admin - Avis & Preuves</h1>
        
        <!-- Onglets pour naviguer entre avis en attente et preuves publiées -->
        <div style="margin-bottom: 2rem; display: flex; gap: 1rem;">
          <button id="tab-pending" class="tab-button active" style="background: #ff6b6b; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
            ⏳ Avis en attente
          </button>
          <button id="tab-published" class="tab-button" style="background: #4b1a7f; color: #8ef58e; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
            ✅ Preuves publiées
          </button>
          <button id="tab-archived" class="tab-button" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
            📦 Archivé
          </button>
        </div>
        
        <!-- Contenu des avis en attente -->
        <div id="pending-content" class="tab-content">
          <p style="color: #ffd369; margin-bottom: 2rem;">Les avis soumis par les visiteurs sont listés ici. Vous pouvez les valider (publier) ou les archiver.</p>
          <div class="article-list" id="avisPendingList"></div>
        </div>
        
        <!-- Contenu des preuves publiées -->
        <div id="published-content" class="tab-content" style="display: none;">
          <p style="color: #ffd369; margin-bottom: 2rem;">Toutes les preuves publiées et visibles sur le site. Vous pouvez les supprimer si nécessaire.</p>
          <div class="article-list" id="preuvesList"></div>
          
        </div>

        <!-- Contenu des avis archivés -->
        <div id="archived-content" class="tab-content" style="display: none;">
          <p style="color: #ffd369; margin-bottom: 2rem;">Avis archivés (non publiés). Ces avis ne sont plus visibles mais conservés pour référence.</p>
          <div class="article-list" id="archivedAvisList"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal ordre (pertinence) -->
  <div id="ordering-modal" class="modal" style="z-index:10000;">
    <div class="modal-content" style="max-width:800px;width:95%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 id="ordering-modal-title" style="margin:0;color:#ffd369;">Ordre des Articles</h2>
        <button id="close-ordering-modal" style="background:none;border:none;color:#ffd369;font-size:1.6em;cursor:pointer;">×</button>
      </div>
      
      <div style="display:flex;gap:20px;flex:1;min-height:500px;">
        <!-- Liste principale des éléments -->
        <div style="flex:2;display:flex;flex-direction:column;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
            <input type="text" id="ordering-search" placeholder="Rechercher..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #4b1a7f;background:#2e0052;color:#fff;">
            <button id="ordering-clear" style="background:#6d6d6d;border:none;color:#fff;padding:10px 15px;border-radius:8px;cursor:pointer;">Effacer</button>
          </div>
          
          <div id="ordering-items" style="flex:1;overflow-y:auto;padding:10px;background:#f8f9fa;border:1px solid #dee2e6;border-radius:10px;">
            <!-- Les éléments seront chargés dynamiquement ici -->
          </div>
        </div>
        
        <!-- Panel d'actions -->
        <div style="flex:1;display:flex;flex-direction:column;gap:15px;">
          <div style="background:#2e004f;padding:20px;border-radius:10px;color:#fff;">
            <h3 style="margin:0 0 15px 0;color:#ffd369;">Actions</h3>
            
            <button id="ordering-save" style="background:#8ef58e;color:#240038;font-weight:700;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;width:100%;margin-bottom:10px;">
              💾 Sauvegarder l'ordre
            </button>
            
            <button id="ordering-reset" style="background:#ffd369;color:#240038;font-weight:700;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;width:100%;margin-bottom:15px;">
              ♻️ Réinitialiser
            </button>
            
            <div style="font-size:0.9em;color:#8ef58e;line-height:1.5;padding:10px;background:rgba(142, 245, 142, 0.1);border-radius:6px;">
              <strong>💡 Aide :</strong><br>
              • Glissez les éléments pour les réorganiser<br>
              • Le premier élément sera le plus visible<br>
              • Sauvegardez pour appliquer les changements
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Aperçu modal style site -->
  <div id="product-modal" class="modal side-modal">
    <div class="modal-content" style="padding:0;display:flex;flex-direction:column;position:relative;background: linear-gradient(135deg, #2e003e, #6a0572);overflow-y:auto;">
      <button id="close-product-modal" class="close" style="position:absolute;top:10px;right:15px;background:none;border:none;color:#ffd369;font-size:28px;cursor:pointer;z-index:10;">✖</button>
      
      <div style="padding:24px;">
        <h2 id="product-title" style="margin:0 0 12px 0;color:#fff;font-size:24px;"></h2>
        <div id="product-description" style="color:#fff;margin-bottom:10px;"></div>
        <div id="product-categorie" style="color:#8ef58e;font-size:0.95em;"></div>
      </div>

      <div style="position:relative;margin-top:20px;display:flex;flex-direction:column;align-items:center;">
        <!-- Bouton + en position absolue -->
        <button id="add-to-cart-btn" style="position:absolute;top:20px;right:20px;background:#ffd369;color:#000;border:none;width:42px;height:42px;border-radius:8px;font-weight:bold;font-size:22px;cursor:pointer;z-index:5;display:flex;align-items:center;justify-content:center;">+</button>
        
        <!-- Image/vidéo centrée avec fond normal -->
        <div style="display:flex;align-items:center;justify-content:center;margin:20px 0;background:transparent;">
          <img id="product-media-img" style="max-width:100%;object-fit:contain;display:none;border-radius:8px;" />
          <video id="product-media-video" style="max-width:100%;object-fit:contain;display:none;border-radius:8px;" muted autoplay loop></video>
        </div>
      </div>
    </div>
  </div>

  <!-- La modale apercu-modal a été supprimée car elle est obsolète -->

    <!-- Nouvelle modal catégories simplifiée -->
    <div id="category-explorer-modal" class="modal">
      <div class="modal-content" style="width:100vw; height:100vh; max-width:100vw; max-height:100vh; margin:0; border-radius:0; position:fixed; top:0; left:0; z-index:10000;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px; flex-wrap:wrap; gap:10px; padding:20px;">
          <h2 style="color:#ffd369; margin:0; font-size:1.2em;">📁 Sélectionner une catégorie</h2>
          <button id="close-category-explorer" style="background:none;border:none;color:#ffd369;font-size:1.5em;cursor:pointer; min-width:40px; min-height:40px;">×</button>
        </div>
        
        <div style="padding:0 20px; height:calc(100vh - 120px); overflow-y:auto;">
          <!-- Breadcrumbs de navigation -->
          <div id="admin-cat-breadcrumbs" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;padding:10px;background:#3a0066;border-radius:8px;"></div>
          
          <!-- Liste des catégories du niveau courant -->
          <div id="admin-cat-list-container" style="max-height:none;overflow-y:visible;margin-bottom:20px;">
            <ul id="admin-cat-list" style="list-style:none;padding:0;margin:0;"></ul>
          </div>
        </div>
        
        <!-- Boutons d'action -->
        <div style="display:flex;justify-content:space-between;gap:10px; flex-wrap:wrap; padding:20px; background:#2e003e; position:absolute; bottom:0; left:0; right:0;">
          <button id="cancel-category-selection" style="background:#6d6d6d;color:white;border:none;padding:12px 16px;border-radius:6px;cursor:pointer; min-width:120px; font-size:0.9em;">Annuler</button>
          <button id="edit-categories-btn" style="background:#ffd369;color:#240038;border:none;padding:12px 16px;border-radius:6px;cursor:pointer;font-weight:bold; min-width:140px; font-size:0.9em;">✏️ Gérer</button>
          <button id="select-current-category" style="background:#4b1a7f;color:#8ef58e;border:none;padding:12px 16px;border-radius:6px;cursor:pointer;font-weight:bold; min-width:140px; font-size:0.9em;">Sélectionner</button>
        </div>
      </div>
    </div>
    
    <!-- Modal de gestion des catégories -->
    <div id="category-management-modal" class="modal">
      <div class="modal-content" style="max-width:800px;width:95%;max-height:90vh;overflow-y:auto;background: linear-gradient(135deg, #2e003e, #6a0572);">
        <div style="padding:15px;">
          <h2 style="color:#ffd369;margin-bottom:20px;text-align:center; font-size:1.3em;">🗂️ Gestion des Catégories</h2>
          
          <!-- Breadcrumb de navigation -->
          <div id="management-breadcrumbs" style="background:rgba(255,255,255,0.1);padding:10px;border-radius:8px;margin-bottom:20px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;"></div>
          
          <!-- Liste des catégories éditables -->
          <div id="management-category-list" style="margin-bottom:20px;"></div>
          
          <!-- Formulaire d'ajout -->
          <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:8px;margin-bottom:20px;">
            <h4 style="color:#8ef58e;margin-bottom:10px;">Ajouter une catégorie</h4>
            <div style="display:flex;gap:10px;align-items:center;">
              <input type="text" id="new-category-name" placeholder="Nom de la nouvelle catégorie" style="flex:1;padding:8px;border-radius:4px;border:1px solid #ccc;">
              <button id="add-category" style="background:#4caf50;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;font-weight:bold;">➕ Ajouter</button>
            </div>
          </div>
          
          <!-- Boutons de contrôle -->
          <div style="display:flex;justify-content:space-between;gap:10px; flex-wrap:wrap;">
            <button id="save-categories" style="background:#4caf50;color:white;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;font-weight:bold; min-width:140px; font-size:0.9em;">💾 Sauvegarder</button>
            <button class="close" style="background:#d72660;color:white;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;font-weight:bold; min-width:100px; font-size:0.9em;">Fermer</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Explorateur de fichiers -->
    <div id="file-explorer-modal" class="modal">
      <div class="modal-content" style="max-width:100vw; width:100vw; height:100vh; max-height:100vh; margin:0; border-radius:0; position:fixed; top:0; left:0; z-index:10000;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px; padding:20px 20px 0 20px;">
          <h2>Explorateur de fichiers</h2>
          <button id="close-file-explorer" class="close-btn" style="background:none;border:none;color:#ffd369;font-size:1.5em;cursor:pointer;">×</button>
        </div>
        
        <div style="display:flex; height:calc(100vh - 140px); overflow:hidden; padding:0 20px;">
          <!-- Grille de fichiers à plein écran -->
          <div style="width:70%; height:100%; overflow-y:auto; padding:16px;">
            <!-- Navigation -->
            <div id="file-path" style="margin-bottom:16px;color:#8ef58e;font-weight:500;">📁 /img</div>
            <!-- Contenu de l'explorateur en grille -->
            <div id="file-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:20px;"></div>
          </div>
          
          <!-- Panel des sélections -->
          <div style="width:30%; height:100%; border-left:2px solid #4b1a7f; padding:16px; background:rgba(75,26,127,0.2);">
            <h3 style="color:#ffd369; margin-top:0; margin-bottom:16px; font-size:1.1em;">📋 Sélections (<span id="selected-count">0</span>)</h3>
            <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
              <button id="select-all-media" style="background:#4b1a7f;color:#8ef58e;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:0.9em;">Tout sélectionner</button>
              <button id="clear-selection" style="background:#ff6b6b;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:0.9em;">Effacer</button>
            </div>
            <div id="selected-media-list" style="height:calc(100% - 80px); overflow-y:auto; border:1px solid rgba(255,255,255,0.1); border-radius:6px; padding:8px; background:rgba(0,0,0,0.2);"></div>
          </div>
          
          <!-- Input caché pour stocker les chemins de fichiers sélectionnés -->
          <input type="hidden" id="selected-file-paths" value="">
        </div>
        
        <div style="display:flex;justify-content:space-between;margin-top:20px; padding:0 20px 20px 20px;">
          <button id="cancel-file-selection" class="btn" style="background:#6d6d6d;padding:10px 20px;border-radius:6px;border:none;color:#fff;cursor:pointer;">Annuler</button>
          <div style="display:flex;align-items:center;gap:10px;">
            <span id="mobile-selection-count" style="color:#8ef58e;font-weight:bold;display:none;">0 sélection(s)</span>
            <button id="confirm-file-selection" class="btn" style="background:#8ef58e;padding:10px 20px;border-radius:6px;border:none;color:#240038;cursor:pointer;font-weight:bold;">Confirmer <span id="confirm-count">(0)</span> sélection(s)</button>
          </div>
        </div>
      </div>
    </div>

<!-- Modal détails avis -->
<div class="modal" id="review-detail-modal">
  <div class="modal-content">
    <button class="close" id="close-review-detail-modal">×</button>
    
    <div class="review-detail-header">
      <div class="review-avatar" id="review-detail-avatar">A</div>
      <div class="review-user-info">
        <h3 id="review-detail-username">@username</h3>
        <p id="review-detail-date">01/01/2025</p>
      </div>
    </div>

    <h2 id="review-detail-title">Titre de l’avis</h2>
    <p id="review-detail-text">Contenu de l’avis détaillé…</p>

    <div class="review-detail-gallery" id="review-detail-gallery">
      <!-- Les miniatures images/vidéos s’injectent ici -->
    </div>

    <div class="review-detail-main-media" id="review-detail-main-media">
      <!-- Le média principal sélectionné -->
    </div>

    <div class="review-detail-footer">
      <div class="review-detail-rating" id="review-detail-rating">★★★★★</div>
      <span class="review-detail-verified" id="review-detail-verified">✔️ Vérifié</span>
    </div>
  </div>
</div>

<script>
// Variables globales pour le fonctionnement de l'admin
let currentAdminSection = 'articles';
let articlesData = [];
let offresData = [];
let arnaquesData = [];
let avisPendingData = [];

// Fonction pour changer de section (globale pour être accessible aux événements onclick)
function showSection(sectionName) {
  // Masquer toutes les sections
  document.querySelectorAll('.admin-section').forEach(section => {
    section.style.display = 'none';
  });

  // Afficher la section demandée
  const targetSection = document.getElementById(sectionName + '-section');
  if (targetSection) {
    targetSection.style.display = 'block';
    currentAdminSection = sectionName;
    
    // Mettre à jour le bouton d'ordre selon la section
    const orderingBtnText = document.getElementById('ordering-btn-text');
    if (orderingBtnText) {
      const sectionNames = {
        'articles': 'Articles',
        'offres': 'Offres',
        'arnaques': 'Arnaques',
        'avis-pending': 'Avis & Preuves'
      };
      orderingBtnText.textContent = `Ordre (${sectionNames[sectionName] || 'Pertinence'})`;
    }
    
    // Charger les données selon la section
    if (sectionName === 'articles') {
      loadArticles();
    } else if (sectionName === 'offres') {
      loadOffres();
    } else if (sectionName === 'arnaques') {
      loadArnaques();
    } else if (sectionName === 'avis-pending') {
      loadAvisPending();
      loadPreuves(); // Charger aussi les preuves publiées
    }
  }

  // Fermer le menu
  const menuModal = document.getElementById('menu-modal');
  if (menuModal) menuModal.style.display = 'none';
}

// Fonction pour afficher la modale d'ordre filtrée par section (globale)
function showOrderingModal() {
  console.log('showOrderingModal appelée pour section:', currentAdminSection);
  console.log('Données disponibles:', {
    articles: articlesData?.length || 0,
    offres: offresData?.length || 0,
    arnaques: arnaquesData?.length || 0,
    avisPending: avisPendingData?.length || 0
  });
  
  const modal = document.getElementById('ordering-modal');
  const itemsList = document.getElementById('ordering-items');
  
  if (!modal || !itemsList) {
    console.error('Éléments modale ordre non trouvés');
    return;
  }

  // Vider la liste existante
  itemsList.innerHTML = '';
  
  console.log(`Chargement ordre pour section: ${currentAdminSection}`);
  
  // Déterminer quelles données utiliser selon la section
  let items = [];
  let itemType = '';
  
  switch(currentAdminSection) {
    case 'articles':
      items = articlesData || [];
      itemType = 'article';
      break;
    case 'offres':
      items = offresData || [];
      itemType = 'offre';
      break;
    case 'arnaques':
      items = arnaquesData || [];
      itemType = 'arnaque';
      break;
    case 'avis-pending':
      items = avisPendingData || [];
      itemType = 'avis';
      break;
    default:
      console.log(`Section non supportée pour l'ordre: ${currentAdminSection}`);
      return;
  }

  console.log(`Items trouvés pour ${currentAdminSection}:`, items.length);

  if (items.length === 0) {
    itemsList.innerHTML = '<div class="no-items">Aucun élément à ordonner</div>';
  } else {
    // Créer la liste des éléments avec ordre
    items.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'ordering-item';
      div.draggable = true;
      div.dataset.id = item.id;
      div.dataset.type = itemType;
      
      // Contenu selon le type
      let title = '';
      let subtitle = '';
      
      switch(itemType) {
        case 'article':
          title = item.nom || 'Sans nom';
          subtitle = `${item.prix || 0}€ - ${item.categorie || 'Sans catégorie'}`;
          break;
        case 'offre':
          title = item.nom || 'Sans nom';
          subtitle = `${item.prix || 0}€ - ${item.date || 'Sans date'}`;
          break;
        case 'arnaque':
          title = item.nom || 'Sans nom';
          subtitle = item.description ? item.description.substring(0, 50) + '...' : 'Sans description';
          break;
        case 'avis':
          title = item.nom || 'Avis anonyme';
          subtitle = item.note ? `Note: ${item.note}/5` : 'Sans note';
          break;
      }

      div.innerHTML = `
        <div class="ordering-handle">≡</div>
        <div class="ordering-content">
          <div class="ordering-title">${title}</div>
          <div class="ordering-subtitle">${subtitle}</div>
        </div>
        <div class="ordering-position">${index + 1}</div>
      `;

      // Événements de glisser-déposer
      div.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', JSON.stringify({
          id: item.id,
          type: itemType,
          index: index
        }));
        div.classList.add('dragging');
        console.log('Début drag:', item.id);
      });

      div.addEventListener('dragend', () => {
        div.classList.remove('dragging');
      });

      div.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      });

      div.addEventListener('drop', (e) => {
        e.preventDefault();
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        
        console.log('Drop de', data.id, 'sur', item.id);
        
        // Trouver les éléments source et target
        const sourceElement = document.querySelector(`[data-id="${data.id}"]`);
        const targetElement = div;
        
        if (sourceElement && targetElement && sourceElement !== targetElement) {
          const container = itemsList;
          const items = Array.from(container.querySelectorAll('.ordering-item'));
          const sourceIndex = items.indexOf(sourceElement);
          const targetIndex = items.indexOf(targetElement);
          
          if (sourceIndex < targetIndex) {
            // Insérer après l'élément target
            container.insertBefore(sourceElement, targetElement.nextSibling);
          } else {
            // Insérer avant l'élément target
            container.insertBefore(sourceElement, targetElement);
          }
          
          // Mettre à jour les numéros de position
          updateOrderingPositions();
        }
      });

      itemsList.appendChild(div);
    });
  }

  modal.classList.add('show');
  
  // Mettre à jour le titre de la modale
  const modalTitle = document.getElementById('ordering-modal-title');
  if (modalTitle) {
    const sectionNames = {
      'articles': 'Articles',
      'offres': 'Offres',
      'arnaques': 'Arnaques',
      'avis-pending': 'Avis & Preuves'
    };
    modalTitle.textContent = `Ordre des ${sectionNames[currentAdminSection] || 'Éléments'}`;
  }
}

// Fonction pour mettre à jour les numéros de position après réorganisation (globale)
function updateOrderingPositions() {
  const items = document.querySelectorAll('#ordering-items .ordering-item');
  items.forEach((item, index) => {
    const positionElement = item.querySelector('.ordering-position');
    if (positionElement) {
      positionElement.textContent = index + 1;
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {

  // Diagnostic médias manquants (console seulement, sans bannière)
  fetch('/api/check-media?detailed=1').then(r=>r.json()).then(rep=>{
    if(rep && rep.missingCount>0){
      console.warn('[DIAGNOSTIC MEDIAS] Fichiers manquants:', rep.missing);
    } else {
      console.log('[DIAGNOSTIC MEDIAS] Tous les médias référencés existent.');
    }
  }).catch(e=>console.error('Erreur diagnostic médias', e));

  // Gestion du menu hamburger admin
  const menuToggle = document.getElementById('menu-toggle');
  const menuModal = document.getElementById('menu-modal');

  if (menuToggle && menuModal) {
    menuToggle.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const currentDisplay = menuModal.style.display;
      if (currentDisplay === 'none' || currentDisplay === '') {
        menuModal.style.display = 'block';
      } else {
        menuModal.style.display = 'none';
      }
    });
  }

  // Event listeners pour les boutons de menu
  document.getElementById('menu-articles')?.addEventListener('click', () => showSection('articles'));
  document.getElementById('menu-offres')?.addEventListener('click', () => showSection('offres'));
  document.getElementById('menu-arnaques')?.addEventListener('click', () => showSection('arnaques'));
  document.getElementById('menu-avis-pending')?.addEventListener('click', () => showSection('avis-pending'));
  
  // Event listeners pour les onglets dans la section avis/preuves
  document.getElementById('tab-pending')?.addEventListener('click', function() {
    showTab('pending');
  });
  
  document.getElementById('tab-published')?.addEventListener('click', function() {
    showTab('published');
  });
  
  document.getElementById('tab-archived')?.addEventListener('click', function() {
    showTab('archived');
  });
  
  function showTab(tabName) {
    // Mettre à jour les boutons onglets
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // Mettre à jour le contenu
    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
    document.getElementById(`${tabName}-content`).style.display = 'block';
    
    // Charger les données selon l'onglet
    if (tabName === 'pending') {
      loadAvisPending();
    } else if (tabName === 'published') {
      loadPreuves();
    } else if (tabName === 'archived') {
      loadArchivedAvis();
    }
  }

  // Fermer le menu en cliquant ailleurs
  document.addEventListener('click', function(e) {
    if (menuModal && !menuModal.contains(e.target) && !menuToggle.contains(e.target)) {
      menuModal.style.display = 'none';
    }
  });

  // Gestion des boutons réseaux pour les arnaques
  document.querySelectorAll('.reseau-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      this.classList.toggle('selected');
      updateReseauxInput();
    });
  });

  function updateReseauxInput() {
    const selectedReseaux = Array.from(document.querySelectorAll('.reseau-btn.selected'))
      .map(btn => btn.getAttribute('data-reseau'));
    document.getElementById('reseaux-arnaque').value = selectedReseaux.join(', ');
  }

  // Rendre la fonction accessible globalement
  window.updateReseauxInput = updateReseauxInput;

  // Gestion des boutons techniques pour les arnaques
  let selectedTechniques = [];
  let availableTechniques = ['Fausse verification', 'Paiement a l\'avance', 'Donné personels', 'Autre'];

  document.querySelectorAll('.technique-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const technique = this.getAttribute('data-technique');
      if (technique && !selectedTechniques.includes(technique)) {
        selectedTechniques.push(technique);
        updateTechniquesDisplay();
        updateTechniquesInput();
      }
    });
  });

  document.getElementById('add-technique-btn')?.addEventListener('click', function() {
    const newTechnique = prompt('Ajouter une nouvelle technique :');
    if (newTechnique && newTechnique.trim()) {
      const technique = newTechnique.trim();
      if (!availableTechniques.includes(technique)) {
        availableTechniques.push(technique);
        // Créer un nouveau bouton
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'technique-btn';
        btn.setAttribute('data-technique', technique);
        btn.textContent = technique;
        btn.addEventListener('click', function() {
          if (!selectedTechniques.includes(technique)) {
            selectedTechniques.push(technique);
            updateTechniquesDisplay();
            updateTechniquesInput();
          }
        });
        // Insérer avant le bouton "Ajouter"
        this.parentNode.insertBefore(btn, this);
      }
      if (!selectedTechniques.includes(technique)) {
        selectedTechniques.push(technique);
        updateTechniquesDisplay();
        updateTechniquesInput();
      }
    }
  });

  function updateTechniquesDisplay() {
    const container = document.getElementById('selected-techniques');
    container.innerHTML = '';
    selectedTechniques.forEach(technique => {
      const tag = document.createElement('div');
      tag.className = 'selected-technique-tag';
      tag.innerHTML = `
        ${technique}
        <button type="button" class="remove-btn" onclick="removeTechnique('${technique}')">×</button>
      `;
      container.appendChild(tag);
    });
  }

  function updateTechniquesInput() {
    document.getElementById('techniques-arnaque').value = selectedTechniques.join(', ');
  }

  window.removeTechnique = function(technique) {
    selectedTechniques = selectedTechniques.filter(t => t !== technique);
    updateTechniquesDisplay();
    updateTechniquesInput();
  };

  // Gestion des médias pour les arnaques
  let selectedMediasArnaque = [];

  document.getElementById('select-media-arnaque')?.addEventListener('click', function() {
    openFileExplorer('img/arnaques', function(selectedFiles) {
      selectedMediasArnaque = selectedFiles;
      updateMediaDisplayArnaque();
    });
  });

  function updateMediaDisplayArnaque() {
    const countSpan = document.getElementById('media-count-arnaque');
    const previewDiv = document.getElementById('media-preview-arnaque');
    const hiddenInput = document.getElementById('medias-arnaque');
    
    if (selectedMediasArnaque.length === 0) {
      countSpan.textContent = 'Aucun média sélectionné';
      previewDiv.innerHTML = '';
    } else {
      countSpan.textContent = `${selectedMediasArnaque.length} média(s) sélectionné(s)`;
      previewDiv.innerHTML = '';
      
      selectedMediasArnaque.forEach((media, index) => {
        const preview = document.createElement('div');
        preview.style.cssText = 'position:relative; display:inline-block; margin:4px;';
        
        if (media.endsWith('.mp4') || media.endsWith('.webm') || media.endsWith('.mov')) {
          preview.innerHTML = `
            <video src="${media}" style="width:60px; height:60px; object-fit:cover; border-radius:4px;" muted></video>
            <button type="button" onclick="removeMediaArnaque(${index})" style="position:absolute; top:-5px; right:-5px; background:#ff4757; color:white; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer; font-size:12px;">×</button>
          `;
        } else {
          preview.innerHTML = `
            <img src="${media}" style="width:60px; height:60px; object-fit:cover; border-radius:4px;" alt="Preview">
            <button type="button" onclick="removeMediaArnaque(${index})" style="position:absolute; top:-5px; right:-5px; background:#ff4757; color:white; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer; font-size:12px;">×</button>
          `;
        }
        
        previewDiv.appendChild(preview);
      });
    }
    
    hiddenInput.value = JSON.stringify(selectedMediasArnaque);
  }

  window.removeMediaArnaque = function(index) {
    selectedMediasArnaque.splice(index, 1);
    updateMediaDisplayArnaque();
  };

  // Validation du username pour empêcher les espaces
  document.addEventListener('DOMContentLoaded', function() {
    const usernameInput = document.getElementById('username-arnaque');
    if (usernameInput) {
      usernameInput.addEventListener('input', function(e) {
        // Remplacer les espaces par des underscores automatiquement
        if (e.target.value.includes(' ')) {
          e.target.value = e.target.value.replace(/\s+/g, '_');
          // Afficher un message temporaire
          const label = document.querySelector('label[for="username-arnaque"]');
          const originalText = label.textContent;
          label.textContent = 'Nom d\'utilisateur (espaces remplacés par _)';
          label.style.color = '#ff6b6b';
          setTimeout(() => {
            label.textContent = originalText;
            label.style.color = '';
          }, 2000);
        }
      });
    }
  });
  
  // Les fonctions loadCategories et renderCategoryTree sont définies plus bas
  
  // fallback minimal function immediately available to buttons
  if (!window.showProductModal) {
    window.showProductModal = function(articleOrId){
      console.warn('showProductModal called before initialization', articleOrId);
    };
  }

  // Fonction pour formater le prix sans zéros inutiles
  function formatPrix(p) {
    if (typeof p === 'string') p = p.replace(',', '.');
    const n = Number(p);
    if (isNaN(n)) return '';
    // Affiche sans décimales si c'est un entier, sinon garde les décimales significatives
    return (Math.round(n * 100) % 100 === 0) ? String(n | 0) : n.toString();
  }

  // Liste des médias de l'article en cours
  let mediaList = [];
  let thumbnailPath = "";

  // Aperçu et gestion des médias dans le formulaire
  function updateMediaPreview() {
    const mediaListContainer = document.getElementById('media-list');
    const thumbnailSelect = document.getElementById('thumbnail-select');
    
    // Vider le conteneur et la liste déroulante
    mediaListContainer.innerHTML = '';
    thumbnailSelect.innerHTML = '<option value="">Sélectionner un média comme miniature</option>';
    
    if (mediaList.length === 0) {
      mediaListContainer.innerHTML = '<div style="padding:10px;border:1px dashed #8ef58e;border-radius:4px;text-align:center;color:#ffd369;">Aucun média</div>';
      return;
    }
    
    // Créer les cartes de média
    mediaList.forEach((media, index) => {
      const mediaCard = document.createElement('div');
      mediaCard.className = 'media-item';
      mediaCard.style.border = '1px solid #8ef58e';
      mediaCard.style.borderRadius = '8px';
      mediaCard.style.padding = '10px';
      mediaCard.style.marginBottom = '10px';
      mediaCard.style.display = 'flex';
      mediaCard.style.alignItems = 'center';
      mediaCard.style.justifyContent = 'space-between';
      
      // Prévisualisation du média
      const previewContainer = document.createElement('div');
      previewContainer.style.width = '80px';
      previewContainer.style.height = '80px';
      
      if (media.type === 'image') {
        const img = document.createElement('img');
        img.src = media.path;
        img.alt = 'Aperçu image';
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100%';
        img.style.objectFit = 'cover';
        previewContainer.appendChild(img);
      } else if (media.type === 'video') {
        const vid = document.createElement('video');
        vid.src = media.path;
        vid.style.maxWidth = '100%';
        vid.style.maxHeight = '100%';
        vid.style.objectFit = 'cover';
        vid.muted = true;
        vid.autoplay = true;
        vid.loop = true;
        previewContainer.appendChild(vid);
      }
      
      // Informations et contrôles
      const infoContainer = document.createElement('div');
      infoContainer.style.flex = '1';
      infoContainer.style.marginLeft = '10px';
      infoContainer.style.overflow = 'hidden';
      
      const pathText = document.createElement('div');
      pathText.textContent = media.path;
      pathText.style.whiteSpace = 'nowrap';
      pathText.style.overflow = 'hidden';
      pathText.style.textOverflow = 'ellipsis';
      pathText.style.color = '#ffd369';
      
      const typeText = document.createElement('div');
      typeText.textContent = media.type === 'image' ? 'Photo' : 'Vidéo';
      typeText.style.fontSize = '0.8em';
      typeText.style.color = '#8ef58e';
      
      infoContainer.appendChild(pathText);
      infoContainer.appendChild(typeText);
      
      // Boutons de contrôle
      const controlsContainer = document.createElement('div');
      controlsContainer.style.display = 'flex';
      controlsContainer.style.gap = '5px';
      
      // Bouton monter
      if (index > 0) {
        const upButton = document.createElement('button');
        upButton.textContent = '▲';
        upButton.title = 'Monter';
        upButton.style.background = '#2e0052';
        upButton.style.color = '#fff';
        upButton.style.border = 'none';
        upButton.style.borderRadius = '4px';
        upButton.style.cursor = 'pointer';
        upButton.style.padding = '4px 8px';
        upButton.onclick = () => {
          const temp = mediaList[index];
          mediaList[index] = mediaList[index-1];
          mediaList[index-1] = temp;
          updateMediaPreview();
        };
        controlsContainer.appendChild(upButton);
      }
      
      // Bouton descendre
      if (index < mediaList.length - 1) {
        const downButton = document.createElement('button');
        downButton.textContent = '▼';
        downButton.title = 'Descendre';
        downButton.style.background = '#2e0052';
        downButton.style.color = '#fff';
        downButton.style.border = 'none';
        downButton.style.borderRadius = '4px';
        downButton.style.cursor = 'pointer';
        downButton.style.padding = '4px 8px';
        downButton.onclick = () => {
          const temp = mediaList[index];
          mediaList[index] = mediaList[index+1];
          mediaList[index+1] = temp;
          updateMediaPreview();
        };
        controlsContainer.appendChild(downButton);
      }
      
      // Bouton supprimer
      const deleteButton = document.createElement('button');
      deleteButton.textContent = '✖';
      deleteButton.title = 'Supprimer';
      deleteButton.style.background = '#990000';
      deleteButton.style.color = '#fff';
      deleteButton.style.border = 'none';
      deleteButton.style.borderRadius = '4px';
      deleteButton.style.cursor = 'pointer';
      deleteButton.style.padding = '4px 8px';
      deleteButton.onclick = () => {
        mediaList.splice(index, 1);
        updateMediaPreview();
      };
      controlsContainer.appendChild(deleteButton);
      
      // Assembler la carte
      mediaCard.appendChild(previewContainer);
      mediaCard.appendChild(infoContainer);
      mediaCard.appendChild(controlsContainer);
      
      mediaListContainer.appendChild(mediaCard);
      
      // Ajouter à la liste déroulante des miniatures
      const option = document.createElement('option');
      option.value = media.path;
      option.textContent = `${media.type === 'image' ? '🖼️' : '🎬'} ${media.path.split('/').pop()}`;
      option.selected = media.path === thumbnailPath;
      thumbnailSelect.appendChild(option);
    });
  }

  // Charger les articles existants
  // Fonctions de chargement globales
  window.loadArticles = async function() {
    const res = await fetch("/articles.json");
    const articles = await res.json();
    
    // Stocker les données globalement pour l'ordre
    articlesData = articles || [];
    
    const list = document.getElementById("articleList");
    list.innerHTML = '';
    articles.forEach((article, idx) => {
      const card = document.createElement('div');
      card.className = 'article-card';

      // Thumb
      const thumb = document.createElement('div');
      thumb.className = 'product-card';
      
      let hasMedia = false;
      // Utiliser la miniature, l'image, la vidéo ou chercher dans les médias
      if (article.thumbnail) {
        hasMedia = true;
        if (article.thumbnail.endsWith('.mp4') || article.thumbnail.endsWith('.webm')) {
          const vid = document.createElement('video');
          vid.src = article.thumbnail;
          vid.muted = true;
          vid.autoplay = true;
          vid.loop = true;
          thumb.appendChild(vid);
        } else {
          const img = document.createElement('img');
          img.src = article.thumbnail;
          img.alt = article.nom;
          thumb.appendChild(img);
        }
      } else if (article.image) {
        hasMedia = true;
        const img = document.createElement('img');
        img.src = article.image;
        img.alt = article.nom;
        thumb.appendChild(img);
      } else if (article.video) {
        hasMedia = true;
        const vid = document.createElement('video');
        vid.src = article.video;
        vid.muted = true;
        vid.autoplay = true;
        vid.loop = true;
        thumb.appendChild(vid);
      } else if (article.medias && article.medias.length > 0) {
        hasMedia = true;
        const media = article.medias[0];
        if (media.type === 'image') {
          const img = document.createElement('img');
          img.src = media.path;
          img.alt = article.nom;
          thumb.appendChild(img);
        } else {
          const vid = document.createElement('video');
          vid.src = media.path;
          vid.muted = true;
          vid.autoplay = true;
          vid.loop = true;
          thumb.appendChild(vid);
        }
      }
      
      // Ne pas ajouter la carte thumb si pas de média
      if (hasMedia) {
        card.appendChild(thumb);
      }

      // Info
      const info = document.createElement('div');
      info.className = 'article-info';
      info.innerHTML = `
        <strong>${article.nom}</strong> <span style="color:#8ef58e;">${formatPrix(article.prix)}€</span><br>
        <span style="font-size:0.95em;">${article.description || ''}</span><br>
        <span style="font-size:0.85em; color:#ffd369;">${article.categorie || ''}</span>
      `;
      card.appendChild(info);

      // Actions
      const actions = document.createElement('div');
      actions.className = 'article-actions';

      // Modifier
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Modifier';
      editBtn.onclick = () => {
        editArticle(article, idx);
        // Remonter en haut de la page
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
      actions.appendChild(editBtn);

      // Supprimer
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Supprimer';
      delBtn.onclick = async () => {
        if (confirm("Supprimer cet article ?")) {
          await fetch(`/api/articles/${article.id}`, { method: "DELETE" });
          loadArticles();
        }
      };
      actions.appendChild(delBtn);

      // Aperçu
      const previewBtn = document.createElement('button');
      previewBtn.textContent = 'Aperçu';
      // pour la délégation/compatibilité, on ajoute une classe et un data-article
      previewBtn.className = 'preview-btn';
      try {
        previewBtn.setAttribute('data-article', JSON.stringify(article));
      } catch(e) {
        // si JSON échoue (circular), on attache l'id pour fallback
        if (article.id) previewBtn.setAttribute('data-preview-id', article.id);
      }
      // appel direct sécurisé (fonction exposée sur window)
      previewBtn.onclick = () => (window.showProductModal ? window.showProductModal(article) : null);
      actions.appendChild(previewBtn);

      card.appendChild(actions);
      list.appendChild(card);
    });
  }
  loadArticles();

  // Fonctions pour les Offres
  window.loadOffres = async function() {
    try {
      const res = await fetch("/offres.json");
      const offres = await res.json();
      
      // Stocker les données globalement pour l'ordre
      offresData = offres || [];
      
      const list = document.getElementById("offresList");
      list.innerHTML = '';
      offres.forEach((offre, idx) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        card.innerHTML = `
          <div class="article-card">
            <div class="product-card">
              <strong>${offre.nom}</strong> <span style="color:#8ef58e;">${offre.prix}€</span><br>
              <span style="font-size:0.95em;">${offre.description || 'Aucune description'}</span><br>
              <span style="font-size:0.85em; color:#ffd369;">${offre.categorie || 'Non définie'}</span>
            </div>
            <div class="article-actions">
              <button onclick="editOffre(${JSON.stringify(offre).replace(/"/g, '&quot;')}, ${idx})">Modifier</button>
              <button onclick="deleteOffre(${idx})" style="background:#e74c3c;">Supprimer</button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement offres:', e);
    }
  }

  // Fonctions pour les Arnaques  
  window.loadArnaques = async function() {
    try {
      const res = await fetch("/arnaques.json");
      const arnaques = await res.json();
      
      // Stocker les données globalement pour l'ordre
      arnaquesData = arnaques || [];
      
      const list = document.getElementById("arnaquesList");
      list.innerHTML = '';
      arnaques.forEach((arnaque, idx) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        card.innerHTML = `
          <div class="article-card">
            <div class="product-card">
              <strong>${arnaque.nom || arnaque.username}</strong> 
              ${arnaque.username && arnaque.nom ? `<span style="color:#8ef58e;font-size:0.9em;"> (@${arnaque.username})</span>` : ''} 
              <span style="color:#ff6b6b;">ARNAQUEUR</span><br>
              <span style="font-size:0.95em;">${arnaque.techniques || 'Techniques non spécifiées'}</span><br>
              <span style="font-size:0.85em; color:#ffd369;">${arnaque.reseaux || 'Réseaux non spécifiés'}</span>
            </div>
            <div class="article-actions">
              <button onclick="editArnaque(${JSON.stringify(arnaque).replace(/"/g, '&quot;')}, ${idx})">Modifier</button>
              <button onclick="deleteArnaque(${idx})" style="background:#e74c3c;">Supprimer</button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement arnaques:', e);
    }
  }

  // Fonctions pour les Preuves (globale)
  window.loadPreuves = async function() {
    try {
      const res = await fetch("/api/preuves");
      const preuves = await res.json();
      const list = document.getElementById("preuvesList");
      list.innerHTML = '';
      preuves.forEach((preuve, idx) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        card.innerHTML = `
          <div class="article-card">
            <div class="product-card">
              <strong>${preuve.titre}</strong> <span style="color:#8ef58e;">✅ VÉRIFIÉ</span> <span style="color:#ffd369;">${'★'.repeat(preuve.rating || 5)}</span><br>
              <span style="font-size:0.85em; color:#ffd369;">${preuve.realName || preuve.client || 'Client'} - ${new Date(preuve.dateSubmission).toLocaleString('fr-FR')}</span>
            </div>
            <div class="article-actions">
              <button onclick="archiverPreuve(${idx})" style="background:#ff6b6b;">Archiver</button>
            </div>
          </div>
        `;
        
        // === INSÈRE ICI, juste avant list.appendChild(card);
        card.addEventListener('click', () => {
          const normalized = {
            username: preuve.realName || preuve.client || preuve.username || 'Anonyme',
            date: preuve.date || (preuve.dateSubmission ? new Date(preuve.dateSubmission).toLocaleDateString('fr-FR') : ''),
            title: preuve.titre || preuve.title || '',
            text: preuve.description || preuve.commentaire || preuve.text || '',
            rating: preuve.rating || preuve.note || 5,
            verified: !!preuve.verified || !!preuve.validated,
            media: (preuve.medias && preuve.medias.length)
              ? preuve.medias.map(m => ({ type: m.type || (m.path && /\.(mp4|webm|mov)$/i.test(m.path) ? 'video' : 'img'), src: m.path || m }))
              : (Array.isArray(preuve.images) ? preuve.images.map(p => ({ type: /\.(mp4|webm|mov)$/i.test(p) ? 'video' : 'img', src: p })) : [])
          };
          showReviewModal(normalized);
        });
        
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement preuves:', e);
    }
  }

  // Charger les avis archivés
  window.loadArchivedAvis = async function() {
    try {
      const res = await fetch("/api/avis-archived");
      const avisArchived = await res.json();
      const list = document.getElementById("archivedAvisList");
      list.innerHTML = '';
      
      if (avisArchived.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#8ef58e;padding:40px;">Aucun avis archivé</div>';
        return;
      }
      
      avisArchived.forEach((avis) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        card.innerHTML = `
          <div class="article-card">
            <div class="product-card">
              <strong>${avis.titre}</strong> <span style="color:#ffd369;">${'★'.repeat(avis.rating || 5)}</span><br>
              <span style="font-size:0.95em;">${avis.description}</span><br>
              <span style="font-size:0.85em; color:#ffd369;">${avis.client} - ${new Date(avis.dateSubmission).toLocaleString('fr-FR')}</span><br>
              <span style="font-size:0.8em; color:#6c757d;">Archivé le ${new Date(avis.dateArchivage).toLocaleDateString('fr-FR')}</span>
            </div>
            <div class="article-actions">
              <button onclick="restaurerAvis(${avis.id})" style="background:#ffd369; color:#2e003e;">Restaurer</button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement avis archivés:', e);
    }
  }

  // Archiver une preuve publiée (fonction globale)
  window.archiverPreuve = async function(preuveId) {
    if (!confirm('Êtes-vous sûr de vouloir archiver cette preuve ?')) return;
    
    try {
      const res = await fetch("/preuves.json");
      const preuves = await res.json();
      
      // Filtrer la preuve à supprimer
      const preuvesFiltrees = preuves.filter((_, index) => index !== preuveId);
      
      // Sauvegarder la liste filtrée
      await fetch('/api/preuves', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(preuvesFiltrees)
      });
      
      alert('Preuve archivée !');
      loadPreuves(); // Recharger la liste
    } catch (error) {
      console.error('Erreur archivage preuve:', error);
      alert('Erreur lors de l\'archivage');
    }
  };

  // Fonctions pour les Avis en attente (globale)
  window.loadAvisPending = async function() {
    try {
      const res = await fetch("/api/avis-pending");
      const avisPending = await res.json();
      
      // Stocker les données globalement pour l'ordre
      avisPendingData = avisPending || [];
      
      const list = document.getElementById("avisPendingList");
      list.innerHTML = '';
      
      if (avisPending.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#8ef58e;padding:40px;">Aucun avis en attente</div>';
        return;
      }
      
      avisPending.forEach((avis) => {
        const card = document.createElement('div');
        card.className = 'article-card';
        card.innerHTML = `
          <div class="article-card">
            <div class="product-card">
              <strong>${avis.titre}</strong> <span style="color:#ffd369;">${'★'.repeat(avis.rating || 5)}</span><br>
              <span style="font-size:0.95em;">${avis.description}</span><br>
              <span style="font-size:0.85em; color:#ffd369;">${avis.client} - ${new Date(avis.dateSubmission).toLocaleString('fr-FR')}</span>
            </div>
            <div class="article-actions">
              <button onclick="validerAvis(${avis.id})" style="background:#8ef58e; color:#2e003e;">Valider</button>
              <button onclick="archiverAvis(${avis.id})" style="background:#ff6b6b;">Archiver</button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erreur chargement avis pending:', e);
    }
  }

  // Valider un avis (le publier dans preuves.json)
  async function validerAvis(avisId) {
    try {
      // Récupérer l'avis à valider
      const resAvis = await fetch("/api/avis-pending");
      const avisPending = await resAvis.json();
      const avis = avisPending.find(a => a.id === avisId);
      
      if (!avis) {
        alert('Avis non trouvé');
        return;
      }
      
      // Récupérer les preuves existantes
      const resPreuves = await fetch("/api/preuves");
      const preuves = await resPreuves.json();
      
      // Ajouter l'avis complet aux preuves (avec toutes les données)
      preuves.push({
        ...avis
      });
      
      // Sauvegarder les preuves mises à jour
      await fetch('/api/preuves', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(preuves)
      });
      
      // Supprimer l'avis de la liste pending
      const avisPendingFiltered = avisPending.filter(a => a.id !== avisId);
      await fetch('/api/avis-pending', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(avisPendingFiltered)
      });
      
      alert('Avis validé et publié !');
      loadAvisPending(); // Recharger la liste des avis en attente
      loadPreuves(); // Recharger la liste des preuves publiées
    } catch (error) {
      console.error('Erreur validation avis:', error);
      alert('Erreur lors de la validation: ' + error.message);
    }
  }

  // Archiver un avis (le supprimer de la liste d'attente) - Fonction globale
  window.archiverAvis = async function(avisId) {
    console.log('🗂️ Tentative d\'archivage avis ID:', avisId);
    
    if (!confirm('Êtes-vous sûr de vouloir archiver cet avis ?')) return;
    
    try {
      // Récupérer les avis en attente
      const resAvis = await fetch("/api/avis-pending");
      const avisPending = await resAvis.json();
      console.log('📋 Avis en attente:', avisPending);
      
      const avisToArchive = avisPending.find(a => a.id === avisId);
      console.log('📝 Avis à archiver:', avisToArchive);
      
      if (!avisToArchive) {
        console.error('❌ Avis non trouvé avec ID:', avisId);
        alert('Avis non trouvé');
        return;
      }
      
      // Récupérer les avis archivés existants
      const resArchived = await fetch("/api/avis-archived");
      const avisArchived = await resArchived.json();
      
      // Ajouter l'avis aux archives avec timestamp
      const archivedAvis = {
        ...avisToArchive,
        dateArchivage: new Date().toISOString(),
        archivedAt: new Date().toISOString()
      };
      avisArchived.push(archivedAvis);
      
      // Supprimer l'avis des avis en attente
      const avisPendingFiltered = avisPending.filter(a => a.id !== avisId);
      
      // Sauvegarder les deux fichiers
      const [pendingResponse, archivedResponse] = await Promise.all([
        fetch('/api/avis-pending', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(avisPendingFiltered)
        }),
        fetch('/api/avis-archived', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(avisArchived)
        })
      ]);
      
      if (!pendingResponse.ok || !archivedResponse.ok) {
        throw new Error('Erreur de sauvegarde sur le serveur');
      }
      
      console.log('✅ Avis archivé avec succès');
      
      // Afficher un message de succès
      const successMsg = document.createElement('div');
      successMsg.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        background: #4caf50; color: white; padding: 12px 20px;
        border-radius: 8px; font-weight: bold;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      successMsg.textContent = 'Avis archivé avec succès!';
      document.body.appendChild(successMsg);
      setTimeout(() => successMsg.remove(), 3000);
      
      // Recharger la liste
      loadAvisPending();
      
      // Si on est dans l'onglet archivé, le recharger aussi
      const archivedTab = document.getElementById('archived-content');
      if (archivedTab && !archivedTab.style.display !== 'none') {
        loadArchivedAvis();
      }
      
    } catch (error) {
      console.error('❌ Erreur lors de l\'archivage:', error);
      alert('Erreur lors de l\'archivage: ' + error.message);
    }
  }

  // Restaurer un avis archivé (le remettre en attente) - Fonction globale
  window.restaurerAvis = async function(avisId) {
    if (!confirm('Êtes-vous sûr de vouloir restaurer cet avis ?')) return;
    
    try {
      const resArchived = await fetch("/api/avis-archived");
      const avisArchived = await resArchived.json();
      const avisToRestore = avisArchived.find(a => a.id === avisId);
      
      if (!avisToRestore) {
        alert('Avis archivé non trouvé');
        return;
      }
      
      // Supprimer les données d'archivage
      const {dateArchivage, ...avisRestored} = avisToRestore;
      
      // Remettre l'avis en attente
      const resPending = await fetch("/api/avis-pending");
      const avisPending = await resPending.json();
      avisPending.push(avisRestored);
      
      await fetch('/api/avis-pending', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(avisPending)
      });
      
      // Supprimer l'avis des archives
      const avisArchivedFiltered = avisArchived.filter(a => a.id !== avisId);
      await fetch('/api/avis-archived', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(avisArchivedFiltered)
      });
      
      alert('Avis restauré avec succès');
      loadArchivedAvis();
    } catch (error) {
      console.error('Erreur restauration avis:', error);
      alert('Erreur lors de la restauration');
    }
  }

  // Rendre les fonctions accessibles globalement
  window.validerAvis = validerAvis;

  // Ajout ou édition d'article
  let editingIdx = null;
  function editArticle(article, idx) {
    editingIdx = idx;
    document.getElementById('nom').value = article.nom;
    document.getElementById('id').value = article.id;
    document.getElementById('categorie').value = article.categorie || '';
    document.getElementById('prix').value = article.prix;
    document.getElementById('description').value = article.description || '';
    
    // Gestion des médias
    mediaList = [];
    thumbnailPath = article.thumbnail || '';
    
    // Récupérer les médias existants
    if (article.medias && Array.isArray(article.medias)) {
      mediaList = [...article.medias];
    } else {
      // Compatibilité avec l'ancien format
      if (article.image) {
        mediaList.push({
          type: 'image',
          path: article.image
        });
        
        if (!thumbnailPath) {
          thumbnailPath = article.image;
        }
      }
      
      if (article.video) {
        mediaList.push({
          type: 'video',
          path: article.video
        });
        
        if (!thumbnailPath) {
          thumbnailPath = article.video;
        }
      }
    }
    
    updateMediaPreview();
    document.getElementById('submit-btn').textContent = "Modifier";
  }

  // Event listeners pour les nouveaux formulaires
  
  // Formulaire Offres
  document.getElementById("addOffreForm")?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    let offre = Object.fromEntries(formData.entries());
    offre.prix = Number(offre.prix);

    try {
      const response = await fetch('/api/offres', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(offre)
      });
      if (response.ok) {
        alert('Offre ajoutée !');
        e.target.reset();
        loadOffres();
      }
    } catch (error) {
      alert('Erreur lors de l\'ajout de l\'offre');
    }
  });

  // Formulaire Arnaques
  document.getElementById("addArnaqueForm")?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    let arnaque = Object.fromEntries(formData.entries());
    
    // Traiter les médias si présents
    if (arnaque.medias) {
      try {
        arnaque.medias = JSON.parse(arnaque.medias);
      } catch (e) {
        arnaque.medias = [];
      }
    } else {
      arnaque.medias = [];
    }
    
    // Générer l'ID automatiquement à partir du username (toujours)
    arnaque.id = arnaque.username.replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase();
    
    // Vérifier qu'il n'y a pas d'espaces dans le username
    if (arnaque.username.includes(' ')) {
      alert('Le nom d\'utilisateur ne peut pas contenir d\'espaces !');
      return;
    }

    try {
      let response;
      
      // Vérifier si on édite une arnaque existante
      if (window.editingArnaqueIdx !== undefined) {
        // Mode édition - PUT request
        const arnaques = await (await fetch('/api/arnaques')).json();
        arnaques[window.editingArnaqueIdx] = arnaque;
        
        response = await fetch('/api/arnaques', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(arnaques)
        });
        
        if (response.ok) {
          alert('Arnaqueur modifié !');
          window.editingArnaqueIdx = undefined;
          document.getElementById('submit-arnaque-btn').textContent = 'Ajouter Arnaqueur';
          document.getElementById('cancel-arnaque-btn').style.display = 'none';
        }
      } else {
        // Mode ajout - POST request
        response = await fetch('/api/arnaques', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(arnaque)
        });
        
        if (response.ok) {
          alert('Arnaqueur ajouté !');
        }
      }
      
      if (response.ok) {
        e.target.reset();
        // Reset boutons réseaux
        document.querySelectorAll('.reseau-btn').forEach(btn => btn.classList.remove('selected'));
        // Reset techniques
        selectedTechniques = [];
        updateTechniquesDisplay();
        updateTechniquesInput();
        // Reset médias
        selectedMediasArnaque = [];
        updateMediaDisplayArnaque();
        loadArnaques();
      }
    } catch (error) {
      alert('Erreur lors de l\'opération');
      console.error('Erreur:', error);
    }
  });

  // Formulaire Preuves
  document.getElementById("addPreuveForm")?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    let preuve = Object.fromEntries(formData.entries());

    try {
      const response = await fetch('/api/preuves', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(preuve)
      });
      if (response.ok) {
        alert('Preuve ajoutée !');
        e.target.reset();
        loadPreuves();
      }
    } catch (error) {
      alert('Erreur lors de l\'ajout de la preuve');
    }
  });

  document.getElementById("addArticleForm").onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    let article = Object.fromEntries(formData.entries());
    article.prix = Number(article.prix); // prix en nombre
    
    // Gestion des médias
    article.medias = [...mediaList]; // Copie de la liste des médias
    article.thumbnail = document.getElementById('thumbnail-select').value;
    
    // Pour la compatibilité avec l'ancien code
    if (mediaList.length > 0) {
      const firstImage = mediaList.find(m => m.type === 'image');
      const firstVideo = mediaList.find(m => m.type === 'video');
      
      if (firstImage) {
        article.image = firstImage.path;
      }
      
      if (firstVideo) {
        article.video = firstVideo.path;
      }
    }
    
    if (editingIdx !== null) {
      // Modifier
      const res = await fetch(`/api/articles/${article.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(article)
      });
      if (res.ok) {
        alert("Article modifié !");
        editingIdx = null;
        document.getElementById('submit-btn').textContent = "Ajouter";
        e.target.reset();
        mediaList = [];
        thumbnailPath = "";
        updateMediaPreview();
        loadArticles();
      } else {
        alert("Erreur lors de la modification !");
      }
    } else {
      // Ajouter
      const res = await fetch("/api/articles", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(article)
      });
      if (res.ok) {
        alert("Article ajouté !");
        e.target.reset();
        mediaList = [];
        thumbnailPath = "";
        updateMediaPreview();
        loadArticles();
      } else {
        alert("Erreur lors de l'ajout !");
      }
    }
  };

  // Explorateur médias (remplacement — logique et style identiques à index)
  let explorerTarget = null; // "image" ou "video"
  let explorerType = null;   // "image" ou "video"

  const IMAGE_EXT = ['.jpg', '.jpeg', '.png', '.webp', '.gif', '.bmp'];
  const VIDEO_EXT = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.mkv'];

  function getExtension(filename) {
    const i = filename.lastIndexOf('.');
    return i !== -1 ? filename.slice(i).toLowerCase() : '';
  }

  function openExplorer(target) {
    explorerTarget = target; // 'media' pour le nouveau bouton combiné
    explorerType = target;   // 'media' accepte à la fois les images et les vidéos
    
    // Utiliser le modal file-explorer
    const modal = document.getElementById('file-explorer-modal');
    if (modal) {
      // Réinitialiser l'état de sélection
      clearAllSelections();
      
      // Initialiser les compteurs à zéro
      const selectedCount = document.getElementById('selected-count');
      const confirmCount = document.getElementById('confirm-count');
      if (selectedCount) selectedCount.textContent = '0';
      if (confirmCount) confirmCount.textContent = '0';
      
      modal.classList.add('show');
      navigateTo(''); // Racine de /img
    } else {
      alert('Erreur : Modal explorateur introuvable!');
    }
  }

  // Fonction spécifique pour les arnaques avec callback
  function openFileExplorer(startPath, callback) {
    window.fileExplorerCallback = callback;
    explorerTarget = 'media';
    explorerType = 'media';
    
    const modal = document.getElementById('file-explorer-modal');
    if (modal) {
      clearAllSelections();
      
      const selectedCount = document.getElementById('selected-count');
      const confirmCount = document.getElementById('confirm-count');
      if (selectedCount) selectedCount.textContent = '0';
      if (confirmCount) confirmCount.textContent = '0';
      
      modal.classList.add('show');
      // Naviguer vers le dossier spécifié (enlever 'img/' du début si présent)
      const relativePath = startPath.replace(/^img\//, '');
      navigateTo(relativePath);
    } else {
      alert('Erreur : Modal explorateur introuvable!');
    }
  }

  async function showExplorer(relPath) {
    const pathDisplay = document.getElementById('explorer-path');
    const explorer = document.getElementById('explorer');
    explorer.innerHTML = '<div style="grid-column:1/-1;color:#ffd369;padding:8px">Chargement…</div>';
    if (pathDisplay) pathDisplay.textContent = relPath ? relPath : 'Racine';

    try {
      const res = await fetch(`/api/explorer?path=${encodeURIComponent(relPath || '')}`);
      const list = await res.json();
      explorer.innerHTML = '';

      // Ajouter bouton "retour" si on n'est pas à la racine
      if (relPath) {
        const up = document.createElement('div');
        up.style = 'background:#4b1a7f;color:#ffd369;padding:10px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
        up.textContent = '⬅️ Retour';
        up.onclick = () => {
          const parent = relPath.split('/').slice(0, -1).join('/');
          showExplorer(parent);
        };
        explorer.appendChild(up);
      }

      // Crée vignettes pour dossiers et fichiers
      list.forEach(item => {
        const card = document.createElement('div');
        card.style = 'background:#2e004f;color:#fff;padding:8px;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;text-align:center;min-height:84px;';
        if (item.isDir) {
          card.innerHTML = `📁<div style="margin-top:6px;font-size:0.9em;color:#ffd369;">${item.name}</div>`;
          card.onclick = () => showExplorer(relPath ? relPath + '/' + item.name : item.name);
        } else {
          const ext = getExtension(item.name);
          const allowed = (explorerType === 'image' && IMAGE_EXT.includes(ext)) || (explorerType === 'video' && VIDEO_EXT.includes(ext));
          if (!allowed) return; // skip non-matching files
          // miniature (image or video icon)
          if (IMAGE_EXT.includes(ext)) {
            card.innerHTML = `<img src="img/${relPath ? relPath + '/' : ''}${item.name}" style="max-width:100%;max-height:72px;border-radius:6px;background:#111;margin-bottom:6px;"><div style="font-size:0.85em;color:#8ef58e;">${item.name}</div>`;
          } else {
            card.innerHTML = `🎬<div style="margin-top:6px;font-size:0.85em;color:#8ef58e;">${item.name}</div>`;
          }
          card.onclick = () => {
            const filePath = 'img/' + (relPath ? relPath + '/' : '') + item.name;
            const input = document.getElementById(explorerTarget);
            if (input) input.value = filePath;
            updateMediaPreview();
          };
        }
        explorer.appendChild(card);
      });

      // Si aucun élément affiché (ex: aucun fichier autorisé), afficher info
      if (!explorer.hasChildNodes()) {
        explorer.innerHTML = '<div style="grid-column:1/-1;color:#ffd369;padding:8px">Aucun élément</div>';
      }
    } catch (err) {
      explorer.innerHTML = '<div style="grid-column:1/-1;color:#ffd369;padding:8px">Erreur de lecture</div>';
    }
  }

  // Liaisons pour les boutons d'ajout de média
  document.getElementById('add-media-btn').addEventListener('click', function() {
    openExplorer('media');
  });
  
  // Gérer la sélection de miniature
  document.getElementById('thumbnail-select').addEventListener('change', function(e) {
    thumbnailPath = e.target.value;
  });
  
  // Fermer l'explorateur de fichiers
  document.getElementById('close-file-explorer').addEventListener('click', function() {
    document.getElementById('file-explorer-modal').classList.remove('show');
  });
  
  document.getElementById('cancel-file-selection').addEventListener('click', function() {
    document.getElementById('file-explorer-modal').classList.remove('show');
    clearAllSelections();
  });
  
  // Nouveaux gestionnaires pour la sélection multiple
  document.getElementById('select-all-media').addEventListener('click', function() {
    selectAllVisibleMedia();
  });
  
  document.getElementById('clear-selection').addEventListener('click', function() {
    clearAllSelections();
  });
  
  document.getElementById('confirm-file-selection').addEventListener('click', function() {
    const selectedFilesData = document.getElementById('selected-file-paths').value;
    if (!selectedFilesData || selectedFilesData === '[]') {
      alert('Veuillez sélectionner au moins un média.');
      return;
    }
    
    try {
      const selectedFiles = JSON.parse(selectedFilesData);
      
      // Si on a un callback (pour les arnaques par exemple)
      if (typeof window.fileExplorerCallback === 'function') {
        const filePaths = selectedFiles.map(file => file.path);
        window.fileExplorerCallback(filePaths);
        window.fileExplorerCallback = null; // Nettoyer le callback
      }
      // Si on est dans un contexte d'ajout/modification d'article
      else if (typeof mediaList !== 'undefined') {
        // Ajouter tous les médias sélectionnés à la liste
        selectedFiles.forEach(file => {
          if (!mediaList.some(m => m.path === file.path)) {
            mediaList.push({ type: file.type, path: file.path });
          }
        });
        
        // Définir le premier comme thumbnail si pas encore défini
        if (!thumbnailPath && selectedFiles.length > 0) {
          thumbnailPath = selectedFiles[0].path;
        }
        
        // Mettre à jour l'aperçu
        if (typeof updateMediaPreview === 'function') {
          updateMediaPreview();
        }
      }
      
      // Message de confirmation
      const count = selectedFiles.length;
      console.log(`✓ ${count} média(s) sélectionné(s):`, selectedFiles);
      
      // Fermer la modale
      document.getElementById('file-explorer-modal').classList.remove('show');
      clearAllSelections();
      
    } catch (error) {
      console.error('Erreur lors de la confirmation de sélection:', error);
      alert('Erreur lors de la confirmation de la sélection.');
    }
  });

  // Ouvrir l'explorateur de fichiers - Cette fonction est définie ailleurs
  let currentMediaType = null;
  let currentPath = '';
  
  // Naviguer dans l'explorateur de fichiers
  async function navigateTo(path) {
    currentPath = path;
    const pathElement = document.getElementById('file-path');
    pathElement.textContent = `📁 /img${path ? '/' + path : ''}`;
  const previewBox = document.getElementById('file-preview');
  if (previewBox) { previewBox.style.display='none'; previewBox.innerHTML=''; }
    
    try {
      const response = await fetch(`/api/explorer?path=${encodeURIComponent(path)}`);
      if (!response.ok) throw new Error('Erreur lors de la récupération des fichiers');
      
      // Normaliser le format (serveur renvoie isDirectory)
      const raw = await response.json();
      const files = raw.map(f => ({
        name: f.name,
        isDir: f.isDir === true || f.isDirectory === true
      }));
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = '';
      
      // Configuration de la grille
      fileList.style.display = "grid";
      fileList.style.gridTemplateColumns = "repeat(auto-fill, minmax(180px, 1fr))";
      fileList.style.gap = "20px";
      fileList.style.padding = "10px";
      
      // Ajouter le lien vers le dossier parent si on n'est pas à la racine
      if (path) {
        const parentItem = document.createElement('div');
        parentItem.style.gridColumn = "1 / -1";
        parentItem.style.marginBottom = "10px";
        parentItem.innerHTML = `<div style="padding:10px;cursor:pointer;display:flex;align-items:center;background:#3a0066;border-radius:6px;">
          <span style="margin-right:8px;font-size:1.2em;">⬅️</span>
          <span>Retour</span>
        </div>`;
        parentItem.onclick = () => {
          const parentPath = path.split('/').slice(0, -1).join('/');
          navigateTo(parentPath);
        };
        fileList.appendChild(parentItem);
      }
      
      // Trier : dossiers d'abord, puis fichiers
      const sortedFiles = files.sort((a, b) => {
        if (a.isDir && !b.isDir) return -1;
        if (!a.isDir && b.isDir) return 1;
        return a.name.localeCompare(b.name, 'fr', { sensitivity: 'base' });
      });
      
      sortedFiles.forEach(file => {
        const fileItem = document.createElement('div');
        const isImage = !file.isDir && /\.(jpe?g|png|webp|gif)$/i.test(file.name);
        const isVideo = !file.isDir && /\.(mp4|webm|mov)$/i.test(file.name);
        
        fileItem.style.background = "#2e004f";
        fileItem.style.borderRadius = "6px";
        fileItem.style.padding = "8px";
        fileItem.style.textAlign = "center";
        fileItem.style.display = "flex";
        fileItem.style.flexDirection = "column";
        fileItem.style.alignItems = "center";
        fileItem.style.cursor = "pointer";
        
        fileItem.innerHTML = `
          <div style="font-size:2em;margin-bottom:5px;">${file.isDir ? '📁' : (isImage ? '🖼️' : (isVideo ? '🎬' : '📄'))}</div>
          <div style="word-break:break-word;font-size:0.9em;">${file.name}</div>
        `;
        
        if (file.isDir) {
          fileItem.onclick = () => {
            const newPath = path ? `${path}/${file.name}` : file.name;
            navigateTo(newPath);
          };
        } else {
          // Déterminer le type de média par l'extension
          const ext = getExtension(file.name).toLowerCase();
          const isImageExt = IMAGE_EXT.includes(ext);
          const isVideoExt = VIDEO_EXT.includes(ext);
          
          // Tous les fichiers média sont sélectionnables
      if (isImageExt || isVideoExt) {
            const filePath = `img/${path ? path + '/' : ''}${file.name}`;
            const mediaType = isImageExt ? 'image' : 'video';
            
            // Ajouter une case à cocher
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.style.cssText = 'position:absolute; top:8px; right:8px; width:18px; height:18px; cursor:pointer; z-index:10;';
            checkbox.dataset.filePath = filePath;
            checkbox.dataset.mediaType = mediaType;
            checkbox.dataset.fileName = file.name;
            
            fileItem.style.position = 'relative';
            fileItem.style.cursor = 'pointer';
            fileItem.appendChild(checkbox);
            
            // Gestionnaire de clic sur la case à cocher
            checkbox.addEventListener('click', (e) => {
              e.stopPropagation();
              updateMediaSelection();
            });
            
            // Clic sur l'item pour cocher/décocher
            fileItem.onclick = (e) => {
              if (e.target === checkbox) return; // Éviter double déclenchement
              checkbox.checked = !checkbox.checked;
              updateMediaSelection();
            };
            
            // Ajouter une prévisualisation à l'élément
            if (isImageExt) {
                const preview = document.createElement('img');
                preview.src = filePath;
                preview.style.width = '100%';
                preview.style.height = '120px';
                preview.style.objectFit = 'cover';
                preview.style.marginBottom = '5px';
                preview.style.borderRadius = '4px';
                
                // Remplacer l'icône par l'aperçu
                const iconElement = fileItem.querySelector('div:first-child');
                if (iconElement && !iconElement.querySelector('img')) {
                  iconElement.innerHTML = '';
                  iconElement.style.fontSize = '1em';
                  iconElement.style.height = '120px';
                  iconElement.style.marginBottom = '5px';
                  iconElement.appendChild(preview);
                }
              }
          } else {
            fileItem.style.opacity = '0.5';
            fileItem.style.cursor = 'not-allowed';
          }
        }
        
        fileList.appendChild(fileItem);
      });
      
    } catch (error) {
      console.error('Erreur lors de la navigation dans l\'explorateur :', error);
      document.getElementById('file-list').innerHTML = 
        `<li style="padding:10px;color:#ff6b6b;">Erreur : ${error.message}</li>`;
    }
  }
  
  // Variables pour la sélection multiple
  let selectedMediaFiles = new Set();
  
  // Mettre à jour la sélection de médias
  function updateMediaSelection() {
    const checkboxes = document.querySelectorAll('#file-list input[type="checkbox"]');
    const selectedList = document.getElementById('selected-media-list');
    const selectedCount = document.getElementById('selected-count');
    const confirmCount = document.getElementById('confirm-count');
    const mobileCount = document.getElementById('mobile-selection-count');
    
    selectedMediaFiles.clear();
    
    checkboxes.forEach(checkbox => {
      const item = checkbox.closest('div');
      if (checkbox.checked) {
        selectedMediaFiles.add({
          path: checkbox.dataset.filePath,
          type: checkbox.dataset.mediaType,
          name: checkbox.dataset.fileName
        });
        item.style.border = '3px solid #8ef58e';
        item.style.backgroundColor = '#3a0066';
      } else {
        item.style.border = 'none';
        item.style.backgroundColor = '#2e004f';
      }
    });
    
    // Mettre à jour l'affichage
    const count = selectedMediaFiles.size;
    if (selectedCount) selectedCount.textContent = count;
    if (confirmCount) confirmCount.textContent = count;
    
    // Affichage mobile
    if (mobileCount) {
      mobileCount.textContent = count + ' sélection(s)';
      mobileCount.style.display = count > 0 ? 'inline' : 'none';
    }
    
    // Afficher la liste des sélections (seulement sur desktop)
    if (selectedList) {
      selectedList.innerHTML = '';
      if (count === 0) {
        selectedList.innerHTML = '<div style="color:#888; font-style:italic; text-align:center; padding:20px;">Aucun média sélectionné</div>';
      } else {
        selectedMediaFiles.forEach(media => {
          const mediaDiv = document.createElement('div');
          mediaDiv.style.cssText = 'display:flex; align-items:center; margin-bottom:8px; padding:6px; background:rgba(255,255,255,0.05); border-radius:4px;';
          
          const icon = media.type === 'image' ? '🖼️' : '🎬';
          mediaDiv.innerHTML = `
            <span style="margin-right:8px; font-size:1.2em;">${icon}</span>
            <span style="flex:1; font-size:0.85em; color:#fff; word-break:break-word;">${media.name}</span>
            <button onclick="removeMediaFromSelection('${media.path}')" style="background:#ff6b6b; color:white; border:none; border-radius:3px; padding:2px 6px; cursor:pointer; font-size:0.8em;">✕</button>
          `;
          selectedList.appendChild(mediaDiv);
        });
      }
    }
    
    // Stocker dans l'input caché
    document.getElementById('selected-file-paths').value = JSON.stringify([...selectedMediaFiles]);
  }
  
  // Supprimer un média de la sélection (fonction globale)
  window.removeMediaFromSelection = function(filePath) {
    const checkbox = document.querySelector(`#file-list input[data-file-path="${filePath}"]`);
    if (checkbox) {
      checkbox.checked = false;
      updateMediaSelection();
    }
  };
  
  // Sélectionner tous les médias visibles
  function selectAllVisibleMedia() {
    const checkboxes = document.querySelectorAll('#file-list input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
    updateMediaSelection();
  }
  
  // Effacer toutes les sélections
  function clearAllSelections() {
    const checkboxes = document.querySelectorAll('#file-list input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
    updateMediaSelection();
  }
  
  // Gérer la sélection d'un fichier (fonction de compatibilité)
  function selectFile(path, mediaType) {
    // Cette fonction est maintenant gérée par updateMediaSelection
    // Garder pour compatibilité mais utiliser le nouveau système
  }

  // close button
  document.body.addEventListener('click', function(e){
    if (e.target && e.target.id === 'close-product-modal') {
      document.getElementById('product-modal').classList.remove('show');
    }
    // close when clicking outside modal-content
    if (e.target && e.target.id === 'product-modal') {
      document.getElementById('product-modal').classList.remove('show');
    }
  });

  // Delegated handler: buttons with data-preview-id or class .preview-btn
  document.body.addEventListener('click', function(e){
    const btn = (e.target && e.target.closest) ? e.target.closest('[data-preview-id], .preview-btn') : null;
    if (!btn) return;
    const id = btn.getAttribute('data-preview-id');
    if (id) {
      window.showProductModal(id);
      return;
    }
    const articleJson = btn.getAttribute && btn.getAttribute('data-article');
    if (articleJson) {
      try {
        const art = JSON.parse(articleJson);
        window.showProductModal(art);
        return;
      } catch(e){
        // fallback: try preview id attribute
        const fid = btn.getAttribute('data-preview-id');
        if (fid) window.showProductModal(fid);
      }
    }
  });

  // Define showProductModal (override the fallback above) - same implementation as before
  window.showProductModal = async function(articleOrId){
  if (!window.allArticles) {
    try {
      const r = await fetch('/articles.json');
      window.allArticles = await r.json();
    } catch(e) {
      window.allArticles = [];
    }
  }
  
  let article = null;
  if (!articleOrId) return;
  if (typeof articleOrId === 'string' || typeof articleOrId === 'number') {
    article = (window.allArticles || []).find(a => a.id == articleOrId || a.nom == articleOrId);
  } else if (typeof articleOrId === 'object') {
    article = articleOrId;
  }
  
  if (!article) {
    try {
      const r2 = await fetch('/articles.json');
      const list = await r2.json();
      article = list.find(a => a.id == articleOrId || a.nom == articleOrId) || null;
    } catch(e) { article = null; }
  }

  const modal = document.getElementById('product-modal');
  const imgEl = document.getElementById('product-media-img');
  const videoEl = document.getElementById('product-media-video');
  const titleEl = document.getElementById('product-title');
  const descEl = document.getElementById('product-description');
  const catEl = document.getElementById('product-categorie');
  const addBtn = document.getElementById('add-to-cart-btn');

  // Reset all elements
  imgEl.style.display = 'none';
  videoEl.style.display = 'none';
  videoEl.src = '';
  imgEl.src = '';
  titleEl.textContent = '';
  descEl.textContent = '';
  catEl.textContent = '';

  if (!article) {
    titleEl.textContent = 'Article introuvable';
    modal.classList.add('show');
    return;
  }

  // Format titre avec prix intégré (comme dans l'image 1)
  titleEl.textContent = article.nom + ' - ' + article.prix + '€';
  
  // Remplir les informations
  descEl.textContent = article.description || '';
  catEl.textContent = article.categorie ? ('Catégorie : ' + article.categorie) : '';

  // Gestion des médias - priorité à l'affichage des médias multiples
  if (article.medias && article.medias.length > 0) {
    // Si nous avons des médias multiples
    const primaryMedia = article.medias[0];
    if (primaryMedia.type === 'image') {
      imgEl.src = primaryMedia.path;
      imgEl.alt = article.nom || '';
      imgEl.style.display = 'block';
    } else if (primaryMedia.type === 'video') {
      videoEl.src = primaryMedia.path;
      videoEl.style.display = 'block';
    }
  } else if (article.image) {
    // Compatibilité avec l'ancien format
    imgEl.src = article.image;
    imgEl.alt = article.nom || '';
    imgEl.style.display = 'block';
  } else if (article.video) {
    // Compatibilité avec l'ancien format
    videoEl.src = article.video;
    videoEl.style.display = 'block';
  }

  // Simuler le bouton "+" (ferme la modale au clic)
  addBtn.onclick = () => {
    modal.classList.remove('show');
  };

  // Ouvrir la modale
  modal.classList.add('show');
};
});

// === NOUVELLE MODAL CATÉGORIES ADMIN ===
let adminCategoriesData = [];
let adminNavStack = []; // Navigation breadcrumbs: [{name, children}]

// Charger les catégories depuis l'API
window.loadAdminCategories = async function() {
  try {
    const response = await fetch('/api/categories');
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    adminCategoriesData = await response.json();
    console.log('� Catégories admin chargées:', adminCategoriesData.length);
    
    // Initialiser la navigation à la racine
    adminNavStack = [{ name: 'Racine', children: adminCategoriesData }];
    
    return true;
  } catch (error) {
    console.error('Erreur chargement catégories admin:', error);
    adminCategoriesData = [];
    adminNavStack = [{ name: 'Racine', children: [] }];
    return false;
  }
}

// Rendu des breadcrumbs
function renderAdminBreadcrumbs() {
  const breadcrumbsEl = document.getElementById('admin-cat-breadcrumbs');
  if (!breadcrumbsEl) return;
  
  breadcrumbsEl.innerHTML = '';
  
  adminNavStack.forEach((level, index) => {
    const crumb = document.createElement('span');
    crumb.className = 'admin-breadcrumb';
    crumb.style.cssText = `
      padding: 6px 12px;
      background: ${index === adminNavStack.length - 1 ? '#8ef58e' : '#4b1a7f'};
      color: ${index === adminNavStack.length - 1 ? '#240038' : '#8ef58e'};
      border-radius: 4px;
      cursor: ${index < adminNavStack.length - 1 ? 'pointer' : 'default'};
      font-weight: 600;
      font-size: 0.9em;
    `;
    crumb.textContent = level.name;
    
    if (index < adminNavStack.length - 1) {
      crumb.addEventListener('click', () => {
        adminNavStack = adminNavStack.slice(0, index + 1);
        renderAdminCategoryLevel();
      });
    }
    
    breadcrumbsEl.appendChild(crumb);
    
    if (index < adminNavStack.length - 1) {
      const separator = document.createElement('span');
      separator.textContent = '›';
      separator.style.color = 'rgba(255,255,255,0.6)';
      breadcrumbsEl.appendChild(separator);
    }
  });
}

// Rendu du niveau de catégories actuel
function renderAdminCategoryLevel() {
  const listEl = document.getElementById('admin-cat-list');
  if (!listEl) return;
  
  renderAdminBreadcrumbs();
  
  listEl.innerHTML = '';
  const currentLevel = adminNavStack[adminNavStack.length - 1];
  
  if (!currentLevel.children || currentLevel.children.length === 0) {
    listEl.innerHTML = '<li style="text-align:center;color:#8ef58e;padding:40px;font-style:italic;">Aucune sous-catégorie</li>';
    return;
  }
  
  currentLevel.children.forEach(category => {
    const li = document.createElement('li');
    li.style.cssText = `
      padding: 15px;
      margin-bottom: 8px;
      background: #3a0066;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    `;
    
    const hasChildren = category.children && category.children.length > 0;
    const childrenCount = hasChildren ? ` (${category.children.length})` : '';
    
    li.innerHTML = `
      <div style="flex:1;">
        <span style="color:#fff;font-weight:bold;font-size:1.1em;">📁 ${category.name}${childrenCount}</span>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="select-btn" style="background:#8ef58e;color:#240038;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-weight:bold;">Choisir</button>
      </div>
    `;
    
    // Hover effects
    li.addEventListener('mouseenter', () => {
      li.style.borderColor = '#ffd369';
      li.style.background = '#4b1a7f';
    });
    
    li.addEventListener('mouseleave', () => {
      li.style.borderColor = 'transparent';
      li.style.background = '#3a0066';
    });
    
    // Navigation vers sous-catégorie en cliquant sur la tuile (même si aucune sous-catégorie)
    li.addEventListener('click', () => {
      adminNavStack.push({ name: category.name, children: category.children || [] });
      renderAdminCategoryLevel();
    });
    
    // Sélection de catégorie
    const selectBtn = li.querySelector('.select-btn');
    selectBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      selectAdminCategory(category.name);
    });
    
    listEl.appendChild(li);
  });
}

// Sélectionner une catégorie
function selectAdminCategory(categoryName) {
  // Construire le chemin complet
  const pathParts = adminNavStack
    .map(level => level.name)
    .filter(name => name !== 'Racine')
    .concat(categoryName);
  
  const fullPath = pathParts.join('/');
  
  // Mettre à jour l'input du formulaire
  const categoryInput = document.getElementById('categorie');
  if (categoryInput) {
    categoryInput.value = fullPath;
    console.log('✅ Catégorie sélectionnée:', fullPath);
  }
  
  // Fermer la modal
  closeAdminCategoryModal();
}

// Sélectionner le niveau courant
function selectCurrentAdminCategory() {
  const pathParts = adminNavStack
    .map(level => level.name)
    .filter(name => name !== 'Racine');
  
  const fullPath = pathParts.length > 0 ? pathParts.join('/') : '';
  
  // Mettre à jour l'input du formulaire
  const categoryInput = document.getElementById('categorie');
  if (categoryInput) {
    categoryInput.value = fullPath;
    console.log('✅ Niveau sélectionné:', fullPath || 'Racine');
  }
  
  // Fermer la modal
  closeAdminCategoryModal();
}

// Ouvrir la modal
function openAdminCategoryModal() {
  const modal = document.getElementById('category-explorer-modal');
  if (!modal) return;
  
  loadAdminCategories().then(success => {
    if (success) {
      renderAdminCategoryLevel();
      modal.classList.add('show');
    } else {
      alert('Erreur lors du chargement des catégories');
    }
  });
}

// Fermer la modal
function closeAdminCategoryModal() {
  const modal = document.getElementById('category-explorer-modal');
  if (modal) {
    modal.classList.remove('show');
  }
}

// === INITIALISATION ADMIN MODAL CATÉGORIES ===
// Initialiser la modal des catégories au chargement
document.addEventListener('DOMContentLoaded', function() {
  console.log('🔧 Initialisation de la modal catégories admin...');
  
  // Remplacer les attributs onclick par des event listeners
  const categoryButtons = document.querySelectorAll('button[onclick*="openCategoryExplorer"]');
  categoryButtons.forEach(btn => {
    btn.removeAttribute('onclick');
    btn.addEventListener('click', openAdminCategoryModal);
  });
  
  // Bouton "Gérer les catégories"
  const editCategoriesBtn = document.getElementById('edit-categories-btn');
  if (editCategoriesBtn) {
    editCategoriesBtn.addEventListener('click', openCategoryManagement);
  }
  
  // Bouton de fermeture
  const closeBtn = document.querySelector('#category-explorer-modal .close');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeAdminCategoryModal);
  }
  
  // Bouton de fermeture par ID spécifique
  const closeCategoryBtn = document.getElementById('close-category-explorer');
  if (closeCategoryBtn) {
    closeCategoryBtn.addEventListener('click', closeAdminCategoryModal);
  }
  
  // Bouton annuler
  const cancelBtn = document.getElementById('cancel-category-selection');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', closeAdminCategoryModal);
  }
  
  // Bouton "Sélectionner ce niveau"
  const selectCurrentBtn = document.getElementById('select-current-category');
  if (selectCurrentBtn) {
    selectCurrentBtn.addEventListener('click', selectCurrentAdminCategory);
  }
  
  // Fermeture par clic sur l'overlay
  const modal = document.getElementById('category-explorer-modal');
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeAdminCategoryModal();
      }
    });
  }
  
  console.log('✅ Modal catégories admin initialisée');
});

// Fonction compatibility pour les anciens appels
function openCategoryExplorer() {
  console.log('⚠️ Appel legacy openCategoryExplorer -> ouverture modal admin');
  openAdminCategoryModal();
}

// Export window pour compatibilité
window.openCategoryExplorer = openCategoryExplorer;

// === GESTION DES CATÉGORIES ===
let managementNavStack = [];
let managementCategoriesData = [];

// Ouvrir la modal de gestion des catégories
function openCategoryManagement() {
  const modal = document.getElementById('category-management-modal');
  if (!modal) return;
  
  loadAdminCategories().then(success => {
    if (success) {
      managementCategoriesData = JSON.parse(JSON.stringify(adminCategoriesData)); // Deep copy
      managementNavStack = [{ name: 'Racine', children: managementCategoriesData }];
      renderManagementLevel();
      modal.classList.add('show');
    } else {
      alert('Erreur lors du chargement des catégories');
    }
  });
}

// Rendu du niveau de gestion des catégories
function renderManagementLevel() {
  const listEl = document.getElementById('management-category-list');
  const breadcrumbsEl = document.getElementById('management-breadcrumbs');
  if (!listEl || !breadcrumbsEl) return;
  
  // Rendu des breadcrumbs
  breadcrumbsEl.innerHTML = '';
  managementNavStack.forEach((level, index) => {
    const crumb = document.createElement('span');
    crumb.style.cssText = `
      padding: 6px 12px;
      background: ${index === managementNavStack.length - 1 ? '#8ef58e' : '#4b1a7f'};
      color: ${index === managementNavStack.length - 1 ? '#240038' : '#8ef58e'};
      border-radius: 4px;
      cursor: ${index < managementNavStack.length - 1 ? 'pointer' : 'default'};
      font-weight: 600;
      font-size: 0.9em;
    `;
    crumb.textContent = level.name;
    
    if (index < managementNavStack.length - 1) {
      crumb.addEventListener('click', () => {
        managementNavStack = managementNavStack.slice(0, index + 1);
        renderManagementLevel();
      });
    }
    
    breadcrumbsEl.appendChild(crumb);
    
    if (index < managementNavStack.length - 1) {
      const separator = document.createElement('span');
      separator.textContent = '›';
      separator.style.color = 'rgba(255,255,255,0.6)';
      breadcrumbsEl.appendChild(separator);
    }
  });
  
  // Rendu de la liste
  listEl.innerHTML = '';
  const currentLevel = managementNavStack[managementNavStack.length - 1];
  
  if (!currentLevel.children || currentLevel.children.length === 0) {
    listEl.innerHTML = '<div style="text-align:center;color:#8ef58e;padding:40px;font-style:italic;">Aucune catégorie</div>';
    return;
  }
  
  currentLevel.children.forEach((category, index) => {
    const div = document.createElement('div');
    div.style.cssText = `
      padding: 15px;
      margin-bottom: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 2px solid transparent;
    `;
    
    const hasChildren = category.children && category.children.length > 0;
    
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;flex:1;">
        <span style="color:#fff;font-weight:bold;font-size:1.1em;">📁 ${category.name}</span>
        ${hasChildren ? `<span style="color:#8ef58e;font-size:0.9em;">(${category.children.length} sous-catégories)</span>` : ''}
      </div>
      <div style="display:flex;gap:8px;">
        <button class="rename-btn" style="background:#ffd369;color:#240038;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:0.9em;">✏️</button>
        <button class="delete-btn" style="background:#ff6b6b;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:0.9em;">🗑️</button>
        <button class="move-up-btn" ${index === 0 ? 'disabled' : ''} style="background:${index === 0 ? '#ccc' : '#17a2b8'};color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:0.9em;">↑</button>
        <button class="move-down-btn" ${index === currentLevel.children.length - 1 ? 'disabled' : ''} style="background:${index === currentLevel.children.length - 1 ? '#ccc' : '#17a2b8'};color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:0.9em;">↓</button>
      </div>
    `;
    
    // Navigation vers sous-catégorie en cliquant sur la carte (même si aucune sous-catégorie)
    div.addEventListener('click', () => {
      managementNavStack.push({ name: category.name, children: category.children || [] });
      renderManagementLevel();
    });
    
    // Renommer
    const renameBtn = div.querySelector('.rename-btn');
    renameBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const newName = prompt('Nouveau nom pour la catégorie:', category.name);
      if (newName && newName.trim() && newName.trim() !== category.name) {
        category.name = newName.trim();
        renderManagementLevel();
      }
    });
    
    // Supprimer
    const deleteBtn = div.querySelector('.delete-btn');
    deleteBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (confirm(`Supprimer la catégorie "${category.name}" et toutes ses sous-catégories ?`)) {
        currentLevel.children.splice(index, 1);
        renderManagementLevel();
      }
    });
    
    // Déplacer vers le haut
    const moveUpBtn = div.querySelector('.move-up-btn');
    if (!moveUpBtn.disabled) {
      moveUpBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        [currentLevel.children[index], currentLevel.children[index - 1]] = [currentLevel.children[index - 1], currentLevel.children[index]];
        renderManagementLevel();
      });
    }
    
    // Déplacer vers le bas
    const moveDownBtn = div.querySelector('.move-down-btn');
    if (!moveDownBtn.disabled) {
      moveDownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        [currentLevel.children[index], currentLevel.children[index + 1]] = [currentLevel.children[index + 1], currentLevel.children[index]];
        renderManagementLevel();
      });
    }
    
    listEl.appendChild(div);
  });
}

// Initialiser les événements de gestion des catégories
document.addEventListener('DOMContentLoaded', function() {
  // Bouton d'ajout de catégorie
  const addCategoryBtn = document.getElementById('add-category');
  const newCategoryInput = document.getElementById('new-category-name');
  
  if (addCategoryBtn && newCategoryInput) {
    addCategoryBtn.addEventListener('click', () => {
      const name = newCategoryInput.value.trim();
      if (!name) return;
      
      const currentLevel = managementNavStack[managementNavStack.length - 1];
      if (currentLevel.children.some(cat => cat.name === name)) {
        alert('Une catégorie avec ce nom existe déjà');
        return;
      }
      
      currentLevel.children.push({
        name: name,
        children: []
      });
      
      newCategoryInput.value = '';
      renderManagementLevel();
    });
    
    newCategoryInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        addCategoryBtn.click();
      }
    });
  }
  
  // Bouton de sauvegarde
  const saveCategoriesBtn = document.getElementById('save-categories');
  if (saveCategoriesBtn) {
    saveCategoriesBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/categories', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(managementCategoriesData)
        });
        
        if (response.ok) {
          alert('Catégories sauvegardées avec succès !');
          adminCategoriesData = JSON.parse(JSON.stringify(managementCategoriesData));
          document.getElementById('category-management-modal').classList.remove('show');
        } else {
          throw new Error('Erreur de sauvegarde');
        }
      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        alert('Erreur lors de la sauvegarde');
      }
    });
  }
  
  // Fermeture de la modal de gestion
  const managementModal = document.getElementById('category-management-modal');
  if (managementModal) {
    const closeBtn = managementModal.querySelector('.close');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        managementModal.classList.remove('show');
      });
    }
    
    managementModal.addEventListener('click', (e) => {
      if (e.target === managementModal) {
        managementModal.classList.remove('show');
      }
    });
  }
});

// ================== LOGIQUE ORDRE (PERTINENCE) ==================
let orderingData = { order: [] };
let allArticlesCache = [];

window.loadOrdering = async function() {
  try {
    const r = await fetch('/api/ordering');
    orderingData = await r.json();
    if (!orderingData || !Array.isArray(orderingData.order)) orderingData = { order: [] };
  } catch(e){ orderingData = { order: [] }; }
}

window.loadAllArticlesForOrdering = async function(){
  try { const r = await fetch('/articles.json'); allArticlesCache = await r.json(); }
  catch(e){ allArticlesCache = []; }
}

function buildOrderingGrid(filter='') {
  const grid = document.getElementById('ordering-grid');
  if (!grid) return;
  const filterNorm = filter.trim().toLowerCase();
  // Construire une liste ordonnée: d'abord ceux dans orderingData.order (dans l'ordre), puis les autres.
  const idToArticle = new Map(allArticlesCache.map(a=>[String(a.id), a]));
  const ordered = [];
  const used = new Set();
  orderingData.order.forEach(id => { const art = idToArticle.get(String(id)); if (art){ ordered.push(art); used.add(String(id)); }});
  allArticlesCache.forEach(a => { if(!used.has(String(a.id))) ordered.push(a); });
  grid.innerHTML='';
  ordered.forEach((a, idx)=>{
    if(filterNorm && !(String(a.id).toLowerCase().includes(filterNorm) || (a.nom||'').toLowerCase().includes(filterNorm))) return;
    const card = document.createElement('div');
    card.className='ordering-item';
    card.setAttribute('data-id', a.id);
    card.setAttribute('draggable','true');
    card.style.cssText='background:#3a0066;border:2px solid #4b1a7f;border-radius:10px;padding:8px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:grab;';
    let mediaHtml='';
    let thumb = a.thumbnail || (a.medias && a.medias.length>0 ? a.medias[0].path : (a.image||''));
    if (thumb && /\.(mp4|webm)$/i.test(thumb)) {
      mediaHtml = `<video src="${thumb}" muted autoplay loop style="width:100%;height:90px;object-fit:cover;border-radius:6px;background:#111;"></video>`;
    } else if (thumb) {
      mediaHtml = `<img src="${thumb}" style="width:100%;height:90px;object-fit:cover;border-radius:6px;background:#111;"/>`;
    } else {
      mediaHtml = '';
    }
    card.innerHTML = `${mediaHtml}<div style="font-size:0.75em;text-align:center;line-height:1.2;word-break:break-word;flex:1;">${a.nom || a.id}</div><div style=\"font-size:0.65em;color:#8ef58e;\">${String(a.id)}</div>`;
    grid.appendChild(card);
  });
  initOrderingDrag();
}

function initOrderingDrag(){
  const items = document.querySelectorAll('.ordering-item');
  let dragEl=null;
  items.forEach(it=>{
    it.addEventListener('dragstart', e=>{ dragEl=it; it.style.opacity='0.4'; });
    it.addEventListener('dragend', e=>{ if(dragEl) dragEl.style.opacity='1'; dragEl=null; saveTempOrder(); });
    it.addEventListener('dragover', e=>{ e.preventDefault(); });
    it.addEventListener('drop', e=>{
      e.preventDefault();
      if(!dragEl || dragEl===it) return;
      const grid = document.getElementById('ordering-grid');
      const children = Array.from(grid.children);
      const dragIndex = children.indexOf(dragEl);
      const targetIndex = children.indexOf(it);
      if (dragIndex < targetIndex) grid.insertBefore(dragEl, it.nextSibling); else grid.insertBefore(dragEl, it);
    });
  });
}

function getCurrentGridOrder(){
  const grid = document.getElementById('ordering-grid');
  return Array.from(grid.children).map(c=>c.getAttribute('data-id'));
}

function saveTempOrder(){
  orderingData.order = getCurrentGridOrder().map(id=>String(id));
}

async function saveOrdering(){
  const btn = document.getElementById('ordering-save');
  const original = btn ? btn.textContent : '';
  if(btn){ btn.disabled=true; btn.textContent='⏳ Sauvegarde...'; }
  
  try {
    // Récupérer l'ordre actuel depuis les éléments DOM
    const items = document.querySelectorAll('#ordering-items .ordering-item');
    const newOrder = Array.from(items).map(item => ({
      id: item.dataset.id,
      type: item.dataset.type
    }));
    
    console.log(`Sauvegarde ordre pour ${currentAdminSection}:`, newOrder);
    
    // Préparer les données selon la section
    let endpoint = '';
    let dataToSend = {};
    
    switch(currentAdminSection) {
      case 'articles':
        endpoint = '/api/ordering';
        dataToSend = { order: newOrder.map(item => item.id) };
        break;
      case 'offres':
        endpoint = '/api/offres-ordering';
        dataToSend = { order: newOrder.map(item => item.id) };
        break;
      case 'arnaques':
        endpoint = '/api/arnaques-ordering';
        dataToSend = { order: newOrder.map(item => item.id) };
        break;
      case 'avis-pending':
        endpoint = '/api/avis-ordering';
        dataToSend = { order: newOrder.map(item => item.id) };
        break;
      default:
        console.error('Section non supportée pour l\'ordre:', currentAdminSection);
        if(btn){ btn.disabled=false; btn.textContent=original; }
        return;
    }
    
    // Envoyer au serveur
    const res = await fetch(endpoint, { 
      method:'PUT', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(dataToSend)
    });
    
    if(res.ok){
      const result = await res.json();
      console.log('Sauvegarde réussie:', result);
      if(btn){ btn.textContent='✅ Sauvegardé'; setTimeout(()=>{ btn.disabled=false; btn.textContent=original; },1300); }
      
      // Recharger les données de la section pour refléter les changements
      switch(currentAdminSection) {
        case 'articles':
          await loadArticles();
          break;
        case 'offres':
          await loadOffres();
          break;
        case 'arnaques':
          await loadArnaques();
          break;
        case 'avis-pending':
          await loadAvisPending();
          break;
      }
    } else {
      const error = await res.text();
      console.error('Erreur serveur:', error);
      if(btn){ btn.disabled=false; btn.textContent=original; }
      alert('Erreur sauvegarde: ' + error);
    }
  } catch(e){
    console.error('Erreur réseau:', e);
    if(btn){ btn.disabled=false; btn.textContent=original; }
    alert('Erreur réseau sauvegarde: ' + e.message);
  }
}

function resetOrdering(){
  orderingData.order = allArticlesCache.map(a=>String(a.id));
  buildOrderingGrid(document.getElementById('ordering-search').value);
}

// Ouverture / fermeture modal
document.addEventListener('DOMContentLoaded', () => {
  const openBtn = document.getElementById('open-ordering-btn');
  const modal = document.getElementById('ordering-modal');
  const closeBtn = document.getElementById('close-ordering-modal');
  const search = document.getElementById('ordering-search');
  
  if(openBtn && modal){
    openBtn.addEventListener('click', async ()=>{
      console.log('Ouverture modale ordre pour section:', currentAdminSection);
      
      // S'assurer que les données sont chargées pour la section courante
      try {
        switch(currentAdminSection) {
          case 'articles':
            if (articlesData.length === 0) {
              console.log('Chargement des articles...');
              await loadArticles();
            }
            break;
          case 'offres':
            if (offresData.length === 0) {
              console.log('Chargement des offres...');
              await loadOffres();
            }
            break;
          case 'arnaques':
            if (arnaquesData.length === 0) {
              console.log('Chargement des arnaques...');
              await loadArnaques();
            }
            break;
          case 'avis-pending':
            if (avisPendingData.length === 0) {
              console.log('Chargement des avis pending...');
              await loadAvisPending();
            }
            break;
        }
        
        showOrderingModal();
      } catch(e) {
        console.error('Erreur lors du chargement des données:', e);
        alert('Erreur lors du chargement des données: ' + e.message);
      }
    });
  }
  
  if(closeBtn){ 
    closeBtn.addEventListener('click', ()=> {
      modal.classList.remove('show');
    }); 
  }
  
  modal && modal.addEventListener('click', e=>{ 
    if(e.target===modal) modal.classList.remove('show'); 
  });
  
  if(search){ 
    search.addEventListener('input', (e)=> {
      const searchValue = e.target.value.toLowerCase();
      // Filtrer les éléments visibles
      const items = document.querySelectorAll('.ordering-item');
      items.forEach(item => {
        const title = item.querySelector('.ordering-title').textContent.toLowerCase();
        const subtitle = item.querySelector('.ordering-subtitle').textContent.toLowerCase();
        const matches = title.includes(searchValue) || subtitle.includes(searchValue);
        item.style.display = matches ? 'flex' : 'none';
      });
    }); 
  }
  
  const clearBtn = document.getElementById('ordering-clear');
  if(clearBtn){ 
    clearBtn.addEventListener('click', ()=>{
      search.value=''; 
      // Réafficher tous les éléments
      document.querySelectorAll('.ordering-item').forEach(item => {
        item.style.display = 'flex';
      });
    }); 
  }
  
  const saveBtn = document.getElementById('ordering-save');
  if(saveBtn){ 
    console.log('✅ Event listener attaché au bouton sauvegarde');
    saveBtn.addEventListener('click', () => {
      console.log('🔥 Bouton sauvegarde cliqué!');
      saveOrdering();
    }); 
  } else {
    console.error('❌ Bouton ordering-save introuvable');
  }
  const resetBtn = document.getElementById('ordering-reset');
  if(resetBtn){ resetBtn.addEventListener('click', ()=>{ if(confirm('Réinitialiser l\'ordre par défaut (liste actuelle)?')) resetOrdering(); }); }
});

// ================== ADAPTATION MINIATURES (grille) ==================
function refreshThumbnailGrid(){
  const grid = document.getElementById('thumbnail-grid');
  if(!grid) return;
  grid.innerHTML='';
  if(mediaList.length === 0){
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#8ef58e;padding:20px;border:1px dashed #4b1a7f;border-radius:8px;">Aucun média ajouté</div>';
    return;
  }
  mediaList.forEach(m=>{
    const cell = document.createElement('div');
    cell.style.cssText='position:relative;border:2px solid #2e0052;border-radius:8px;overflow:hidden;cursor:pointer;display:flex;align-items:center;justify-content:center;height:80px;';
    let inner='';
    if(m.type==='image') inner = `<img src="${m.path}" style="width:100%;height:100%;object-fit:cover;"/>`;
    else inner = `<video src="${m.path}" muted autoplay loop style="width:100%;height:100%;object-fit:cover;"></video>`;
    cell.innerHTML = inner + `<div style="position:absolute;bottom:2px;right:4px;font-size:18px;text-shadow:1px 1px 2px rgba(0,0,0,0.8);">${m.type==='image'?'🖼️':'🎬'}</div>`;
    if(m.path===thumbnailPath){ cell.style.border='2px solid #8ef58e'; }
    cell.addEventListener('click', ()=>{
      thumbnailPath = m.path;
      document.getElementById('thumbnail-select').value = thumbnailPath;
      refreshThumbnailGrid();
    });
    grid.appendChild(cell);
  });
}

// Override updateMediaPreview to inclure grille
(function(){
  // Vérifier que la fonction existe avant override
  if(typeof updateMediaPreview === 'function'){
    const _orig = updateMediaPreview;
    updateMediaPreview = function(){
      _orig();
      // supprimer l'ancien select (déjà remplacé) => juste MAJ de la grille
      refreshThumbnailGrid();
    };
  }

  // Fonctions globales pour l'édition et suppression

  // Fonctions pour les offres
  window.editOffre = function(offre, idx) {
    // S'assurer qu'on est dans la bonne section
    showSection('offres');
    
    // Attendre que la section soit visible
    setTimeout(() => {
      const elements = {
        nom: document.getElementById('nom-offre'),
        id: document.getElementById('id-offre'),
        prix: document.getElementById('prix-offre'),
        description: document.getElementById('description-offre'),
        categorie: document.getElementById('categorie-offre')
      };
      
      // Vérifier que tous les éléments existent
      for (const [key, element] of Object.entries(elements)) {
        if (!element) {
          console.error(`Élément ${key} non trouvé pour editOffre`);
          return;
        }
      }
      
      // Remplir les champs
      elements.nom.value = offre.nom || '';
      elements.id.value = offre.id || '';
      elements.prix.value = offre.prix || '';
      elements.description.value = offre.description || '';
      elements.categorie.value = offre.categorie || '';
    }, 100);
  };

  window.deleteOffre = async function(idx) {
    if (!confirm('Supprimer cette offre ?')) return;
    try {
      const res = await fetch('/api/offres');
      const offres = await res.json();
      offres.splice(idx, 1);
      await fetch('/api/offres', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(offres)
      });
      loadOffres();
    } catch (e) {
      alert('Erreur lors de la suppression');
    }
  };

  // Fonctions pour les arnaques
  window.editArnaque = function(arnaque, idx) {
    console.log('Édition arnaque:', arnaque);
    // S'assurer qu'on est dans la bonne section
    showSection('arnaques');
    
    // Attendre que la section soit chargée
    setTimeout(() => {
      const elements = {
        nom: document.getElementById('nom-arnaque'),
        username: document.getElementById('username-arnaque'),
        techniques: document.getElementById('techniques-arnaque'),
        description: document.getElementById('description-arnaque')
      };
      
      // Vérifier que tous les éléments existent
      for (const [key, element] of Object.entries(elements)) {
        if (!element) {
          console.error(`Élément ${key} non trouvé pour editArnaque`);
          console.log('Éléments disponibles dans le DOM:', 
            Array.from(document.querySelectorAll('[id*="arnaque"]')).map(el => el.id));
          return;
        }
      }
      
      // Remplir les champs
      elements.nom.value = arnaque.nom || '';
      elements.username.value = arnaque.username || '';
      elements.description.value = arnaque.description || '';
      
      // Gérer les techniques (nouveau système)
      selectedTechniques = [];
      if (arnaque.techniques) {
        if (typeof arnaque.techniques === 'string') {
          selectedTechniques = arnaque.techniques.split(', ').filter(t => t.trim());
        } else if (Array.isArray(arnaque.techniques)) {
          selectedTechniques = [...arnaque.techniques];
        }
      }
      updateTechniquesDisplay();
      updateTechniquesInput();
      
      // Gérer les médias
      if (arnaque.medias && Array.isArray(arnaque.medias)) {
        selectedMediasArnaque = [...arnaque.medias];
      } else {
        selectedMediasArnaque = [];
      }
      updateMediaDisplayArnaque();
      
      // Cocher les bons réseaux
      document.querySelectorAll('.reseau-btn').forEach(btn => btn.classList.remove('selected'));
      if (arnaque.reseaux) {
        let reseauxList = [];
        if (typeof arnaque.reseaux === 'string') {
          reseauxList = arnaque.reseaux.split(', ');
        } else if (Array.isArray(arnaque.reseaux)) {
          reseauxList = arnaque.reseaux;
        } else {
          reseauxList = [String(arnaque.reseaux)];
        }
        
        reseauxList.forEach(reseau => {
          const btn = document.querySelector(`[data-reseau="${reseau.trim()}"]`);
          if (btn) btn.classList.add('selected');
        });
        updateReseauxInput();
      }
      
      // Marquer qu'on édite cette arnaque
      window.editingArnaqueIdx = idx;
      console.log('Édition arnaque configurée, idx:', idx);
      
      // Changer l'interface pour l'édition
      document.getElementById('submit-arnaque-btn').textContent = 'Modifier Arnaqueur';
      document.getElementById('cancel-arnaque-btn').style.display = 'block';
    }, 200); // Délai plus long pour s'assurer que le DOM est chargé
  };

  window.cancelEditArnaque = function() {
    // Reset du mode édition
    window.editingArnaqueIdx = undefined;
    
    // Reset de l'interface
    document.getElementById('submit-arnaque-btn').textContent = 'Ajouter Arnaqueur';
    document.getElementById('cancel-arnaque-btn').style.display = 'none';
    
    // Reset du formulaire
    document.getElementById('addArnaqueForm').reset();
    document.querySelectorAll('.reseau-btn').forEach(btn => btn.classList.remove('selected'));
    updateReseauxInput();
    
    // Reset techniques
    selectedTechniques = [];
    updateTechniquesDisplay();
    updateTechniquesInput();
    
    // Reset médias
    selectedMediasArnaque = [];
    updateMediaDisplayArnaque();
  };

  window.deleteArnaque = async function(idx) {
    if (!confirm('Supprimer cet arnaqueur ?')) return;
    try {
      const res = await fetch('/api/arnaques');
      const arnaques = await res.json();
      arnaques.splice(idx, 1);
      await fetch('/api/arnaques', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(arnaques)
      });
      loadArnaques();
    } catch (e) {
      alert('Erreur lors de la suppression');
    }
  };

  // Fonctions pour les preuves
  window.editPreuve = function(preuve, idx) {
    document.getElementById('titre-preuve').value = preuve.titre;
    document.getElementById('id-preuve').value = preuve.id;
    document.getElementById('client-preuve').value = preuve.client || '';
    document.getElementById('date-preuve').value = preuve.date || '';
    document.getElementById('description-preuve').value = preuve.description;
  };

  window.deletePreuve = async function(idx) {
    if (!confirm('Supprimer cette preuve ?')) return;
    try {
      const res = await fetch('/api/preuves');
      const preuves = await res.json();
      preuves.splice(idx, 1);
      await fetch('/api/preuves', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(preuves)
      });
      loadPreuves();
    } catch (e) {
      alert('Erreur lors de la suppression');
    }
  };

  // Initialisation : ouvrir sur "Mes articles" avec menu visible
  setTimeout(() => {
    showSection('articles');
    const menuModal = document.getElementById('menu-modal');
    if (menuModal) {
      menuModal.style.display = 'block';
    }
  }, 100);

})();
function showReviewModal(preuve) {
  const modal = document.getElementById('review-detail-modal');
  modal.classList.add('show');

  // Remplir infos
  document.getElementById('review-detail-avatar').textContent = preuve.username[0].toUpperCase();
  document.getElementById('review-detail-username').textContent = preuve.username;
  document.getElementById('review-detail-date').textContent = preuve.date;
  document.getElementById('review-detail-title').textContent = preuve.title;
  document.getElementById('review-detail-text').textContent = preuve.text;
  document.getElementById('review-detail-rating').textContent = "★".repeat(preuve.rating);
  document.getElementById('review-detail-verified').style.display = preuve.verified ? 'inline-block' : 'none';

  // Galerie
  const gallery = document.getElementById('review-detail-gallery');
  gallery.innerHTML = '';
  const mainMedia = document.getElementById('review-detail-main-media');
  mainMedia.innerHTML = '';

  preuve.media.forEach((m, idx) => {
    let el;
    if (m.type === 'img') {
      el = document.createElement('img');
      el.src = m.src;
    } else {
      el = document.createElement('video');
      el.src = m.src;
      el.controls = true;
    }
    el.addEventListener('click', () => changeReviewMainMedia(m));
    if (idx === 0) changeReviewMainMedia(m);
    gallery.appendChild(el);
  });
}

function changeReviewMainMedia(media) {
  const container = document.getElementById('review-detail-main-media');
  container.innerHTML = '';
  let el;
  if (media.type === 'img') {
    el = document.createElement('img');
    el.src = media.src;
  } else {
    el = document.createElement('video');
    el.src = media.src;
    el.controls = true;
  }
  container.appendChild(el);
}

document.getElementById('close-review-detail-modal').addEventListener('click', () => {
  document.getElementById('review-detail-modal').classList.remove('show');
});
  </script>
</body>
</html>
