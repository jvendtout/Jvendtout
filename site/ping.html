<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ping - Maintien fichiers GoFile</title>
  <style>
    body {
      background: #0a0a0f;
      color: #e0e0e0;
      font-family: system-ui, sans-serif;
      padding: 20px;
    }
    h1 { color: #00d4ff; margin-bottom: 10px; }
    #status { 
      padding: 15px; 
      background: #12121a; 
      border-radius: 8px; 
      margin-bottom: 20px;
    }
    #media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }
    .media-item {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      background: #1a1a2e;
    }
    .media-item.error { opacity: 0.3; border: 2px solid #ef4444; }
    .media-item.loaded { border: 2px solid #22c55e; }
    #count { color: #22c55e; font-weight: bold; }
    #errors { color: #ef4444; }
  </style>
</head>
<body>
  <h1>üîÑ Ping GoFile</h1>
  <div id="status">
    Chargement des m√©dias... <span id="count">0</span> charg√©s, <span id="errors">0</span> erreurs
  </div>
  <div id="media-grid"></div>

  <script>
    const grid = document.getElementById('media-grid');
    const countEl = document.getElementById('count');
    const errorsEl = document.getElementById('errors');
    let loaded = 0, errors = 0;

    async function loadAllMedia() {
      try {
        // Charger depuis /images (GoFile root)
        const res = await fetch('/images');
        const files = await res.json();
        
        // Aussi charger le mapping pour les fichiers dans sous-dossiers
        let mappingFiles = [];
        try {
          const mapRes = await fetch('/gofile-mapping.json');
          const mapping = await mapRes.json();
          mappingFiles = Object.values(mapping);
        } catch(e) {}

        // Combiner et d√©dupliquer
        const allFiles = [...files, ...mappingFiles];
        const seen = new Set();
        
        allFiles.forEach(file => {
          if (!file || !file.id || seen.has(file.id)) return;
          if (file.type === 'folder') return;
          seen.add(file.id);
          
          const url = `/media/${file.id}`;
          const name = file.name || file.id;
          const isVideo = /\.(mp4|webm|mov)$/i.test(name);
          
          if (isVideo) {
            const video = document.createElement('video');
            video.className = 'media-item';
            video.src = url;
            video.muted = true;
            video.preload = 'metadata';
            video.onloadeddata = () => { loaded++; updateCount(); video.classList.add('loaded'); };
            video.onerror = () => { errors++; updateCount(); video.classList.add('error'); };
            grid.appendChild(video);
          } else {
            const img = document.createElement('img');
            img.className = 'media-item';
            img.src = url;
            img.alt = name;
            img.loading = 'eager';
            img.onload = () => { loaded++; updateCount(); img.classList.add('loaded'); };
            img.onerror = () => { errors++; updateCount(); img.classList.add('error'); };
            grid.appendChild(img);
          }
        });
        
        if (seen.size === 0) {
          grid.innerHTML = '<p>Aucun fichier trouv√©. Uploadez des m√©dias sur GoFile.</p>';
        }
      } catch (err) {
        grid.innerHTML = `<p style="color:#ef4444">Erreur: ${err.message}</p>`;
      }
    }
    
    function updateCount() {
      countEl.textContent = loaded;
      errorsEl.textContent = errors;
    }
    
    loadAllMedia();
  </script>
</body>
</html>
